<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidje - Musik Platform</title>
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#e50914">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vidje">
<!-- SELESAI BAGIAN 1! -->
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-black: #000000;
            --bg-dark: #121212;
            --bg-card: #181818;
            --bg-card-hover: #282828;
            --primary-red: #e50914;
            --primary-red-hover: #ff1f2c;
            --text-white: #ffffff;
            --text-gray: #b3b3b3;
            --border-color: #333;
            --player-height: 90px;
            --sidebar-width: 240px;
            --header-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-black);
            color: var(--text-white);
            height: 100vh;
            overflow: hidden;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary-red);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-text { margin-top: 20px; font-size: 18px; color: var(--text-gray); letter-spacing: 2px; }

        /* --- AUTH VIEW --- */
        #auth-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
        }
        .auth-box {
            background-color: rgba(40, 40, 40, 0.8);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        .auth-logo { font-size: 48px; color: var(--primary-red); margin-bottom: 10px; }
        .auth-box h2 { margin-top: 10px; font-size: 32px; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .auth-box p { color: var(--text-gray); margin-bottom: 20px; }
        .auth-input {
            width: 100%; padding: 14px; margin: 8px 0;
            border-radius: 8px; border: 1px solid #444;
            background-color: #000; color: white;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--primary-red); }
        .auth-btn {
            width: 100%; padding: 14px; margin-top: 20px;
            border-radius: 50px; border: none;
            background-color: var(--primary-red);
            color: white; font-weight: 700; font-size: 16px;
            cursor: pointer; transition: 0.2s;
        }
        .auth-btn:hover { background-color: var(--primary-red-hover); transform: scale(1.02); }
        .auth-switch { margin-top: 20px; font-size: 14px; color: var(--text-gray); }
        .auth-switch span { color: white; cursor: pointer; font-weight: 600; }
        .auth-switch span:hover { text-decoration: underline; }
        .error-msg { color: var(--primary-red); font-size: 13px; margin-top: 10px; display: none; }

        /* --- APP LAYOUT --- */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .container {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--player-height));
            overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-black);
            display: flex;
            flex-direction: column;
            padding: 24px 12px;
            gap: 24px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .logo i { font-size: 32px; color: var(--primary-red); }
        .logo span { font-family: 'Montserrat', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: -1px; }

        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 16px;
            border-radius: 4px;
            color: var(--text-gray);
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s, background 0.3s;
            text-decoration: none;
        }
        .nav-item:hover, .nav-item.active { color: var(--text-white); background-color: var(--bg-card-hover); }
        .nav-item i { font-size: 24px; }
        .divider { height: 1px; background-color: #282828; margin: 0 12px; }

        .playlist-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .playlist-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-gray); margin-bottom: 12px; padding-left: 12px; }
        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-gray);
            padding: 8px 12px;
            font-size: 14px;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: color 0.2s;
            border-radius: 4px;
            position: relative;
            z-index: 10;
        }
        .playlist-item:hover { color: var(--text-white); background-color: rgba(255,255,255,0.05); }
        .playlist-thumb {
            width: 48px; height: 48px;
            border-radius: 4px;
            background: #333;
            object-fit: cover;
            flex-shrink: 0;
        }
        .create-playlist-btn {
            color: var(--text-gray);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
        }
        .create-playlist-btn:hover { color: var(--text-white); background-color: rgba(255,255,255,0.05); }

        /* --- FRIENDS SECTION IN SIDEBAR --- */
        .friend-section {
            margin-top: 20px;
            border-top: 1px solid #282828;
            padding-top: 20px;
        }
        .friend-search-container { position: relative; padding: 0 12px 10px 12px; }
        .friend-search-input {
            width: 100%;
            background: #282828;
            border: 1px solid #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }
        .friend-search-dropdown {
            position: absolute;
            top: 35px;
            left: 12px;
            right: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .friend-dropdown-item {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .friend-dropdown-item:last-child { border-bottom: none; }
        .friend-dropdown-item:hover { background: #444; }
        
        .friend-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
        }
        .friend-list-item:hover { background-color: rgba(255,255,255,0.1); }
        .friend-avatar-small {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover;
        }
        .friend-name { font-size: 13px; color: var(--text-white); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .request-actions {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .btn-icon-small {
            background: none; border: none; color: white; cursor: pointer;
            padding: 4px; border-radius: 4px;
        }
        .btn-accept { color: #1db954; }
        .btn-reject { color: var(--primary-red); }
        .btn-icon-small:hover { opacity: 0.8; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            background: linear-gradient(180deg, #222222 0%, var(--bg-dark) 40%);
            overflow-y: auto;
            border-radius: 8px;
            margin: 8px 8px 0 0;
            position: relative;
            width: 100%;
        }
        header {
            position: sticky;
            top: 0;
            background-color: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .mobile-menu-toggle:hover { background-color: rgba(255,255,255,0.1); }

        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .user-menu { background-color: rgba(0,0,0,0.7); padding: 4px; padding-right: 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; }
        .user-menu:hover { background-color: #282828; }
        .user-menu img { width: 28px; height: 28px; border-radius: 50%; }
        .content-padding { padding: 24px 32px; padding-bottom: 40px; }
        h2 { font-size: 24px; margin-bottom: 20px; margin-top: 10px; }

        /* --- VIEWS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; margin-bottom: 40px; }
        
        .horizontal-scroll-grid {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 20px; 
            margin-bottom: 40px;
            scroll-behavior: smooth;
            -ms-overflow-style: none;  
            scrollbar-width: none; 
        }
        .horizontal-scroll-grid::-webkit-scrollbar { display: none; }
        .horizontal-scroll-grid .song-card { min-width: 180px; flex: 0 0 auto; }

        .song-card { background-color: var(--bg-card); padding: 16px; border-radius: 6px; transition: background-color 0.3s ease; cursor: pointer; position: relative; }
        .song-card:hover { background-color: var(--bg-card-hover); }
        
        .card-img-wrapper { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 1/1; 
            margin-bottom: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
            border-radius: 4px; 
            overflow: hidden; 
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card-img-wrapper img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: center; 
            transition: transform 0.3s ease;
        }
        
        .play-btn-overlay { position: absolute; bottom: 8px; right: 8px; width: 48px; height: 48px; border-radius: 50%; background-color: var(--primary-red); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 8px rgba(0,0,0,0.3); opacity: 0; transform: translateY(8px); transition: all 0.3s ease; z-index: 5;}
        .song-card:hover .play-btn-overlay { opacity: 1; transform: translateY(0); }
        .card-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-desc { font-size: 14px; color: var(--text-gray); }

        /* FIXED ALIGNMENT FOR SONG LIST */
        .song-list-header { 
            display: grid; 
            grid-template-columns: 50px 4fr 3fr 1fr 120px; 
            padding: 10px 16px 10px 16px; 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-gray); 
            text-transform: uppercase; 
            font-size: 12px; 
            letter-spacing: 1px; 
            align-items: center; 
        }
        .song-row { 
            display: grid; 
            grid-template-columns: 50px 4fr 3fr 1fr 120px; 
            padding: 10px 16px; 
            border-radius: 4px; 
            align-items: center; 
            color: var(--text-gray); 
            font-size: 14px; 
            cursor: pointer; 
        }
        .song-row:hover { background-color: rgba(255,255,255,0.1); }
        .song-row.playing { color: var(--primary-red); }
        .song-info { display: flex; align-items: center; gap: 12px; }
        .song-info img { width: 40px; height: 40px; border-radius: 4px; }
        .song-title-text { color: var(--text-white); font-size: 16px; font-weight: 500; }
        .song-artist { font-size: 14px; }
        
        /* ANIMATED EQUALIZER (FIXED FOR PAUSE) */
        .playing-icon-container {
            display: none; /* Hidden by default */
            gap: 2px;
            height: 16px;
            align-items: center;
        }
        
        /* Ensure visible when playing */
        .song-row.playing .playing-icon-container {
            display: flex;
        }
        
        .bar {
            width: 3px;
            background-color: var(--primary-red);
            animation: bounce 0.5s infinite ease-in-out;
        }
        .bar:nth-child(1) { animation-delay: 0.1s; height: 5px; }
        .bar:nth-child(2) { animation-delay: 0.2s; height: 10px; }
        .bar:nth-child(3) { animation-delay: 0.3s; height: 8px; }
        .bar:nth-child(4) { animation-delay: 0.0s; height: 12px; }
        
        @keyframes bounce {
            0%, 100% { height: 3px; }
            50% { height: 16px; }
        }
        
        .song-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .more-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .more-btn:hover { color: white; }
        
        .list-like-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .list-like-btn:hover { color: white; }
        .list-like-btn.liked { color: var(--primary-red); }

        .share-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .share-btn:hover { color: white; }
        
        .queue-add-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .queue-add-btn:hover { color: white; }

        /* Search */
        .search-container { max-width: 500px; margin: 0 auto 40px auto; position: relative; }
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: 50px;
            border: none;
            background-color: #fff;
            color: #000;
            font-size: 16px;
            outline: none;
        }
        .search-icon-placeholder { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #121212; font-size: 20px; }
        
        /* --- OVERLAY PLAYER --- */
        #overlay-player {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 30000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        #overlay-player.active { opacity: 1; visibility: visible; }

        .overlay-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(40px) brightness(0.3);
            z-index: -1;
            transform: scale(1.2); /* Prevent white edges */
        }

        .overlay-content {
            width: 100%;
            max-width: 500px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            height: 100%;
            justify-content: center;
        }

        .overlay-close-btn {
            position: absolute;
            top: 20px; left: 20px;
            background: none; border: none; color: white;
            font-size: 32px; cursor: pointer;
            z-index: 10;
        }

        .overlay-art-wrapper {
            width: 380px; height: 380px;
            max-width: 80vw; max-height: 80vw;
            margin-bottom: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay-art-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .overlay-info h2 { font-size: 28px; font-weight: 700; margin-bottom: 10px; color: white; white-space: nowrap; overflow: hidden; }
        .overlay-info p { font-size: 18px; color: #b3b3b3; margin-bottom: 40px; white-space: nowrap; overflow: hidden; }

        .overlay-controls {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        .overlay-controls button {
            background: none; border: none; color: white;
            font-size: 32px; cursor: pointer; transition: 0.2s;
        }
        .overlay-controls button.active { color: var(--primary-red); }
        .overlay-controls button:hover { transform: scale(1.1); color: var(--primary-red); }
        .overlay-play-btn {
            width: 80px; height: 80px;
            background-color: white !important;
            color: black !important;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px !important;
        }
        .overlay-play-btn:hover { transform: scale(1.05) !important; background-color: #ddd !important; }

        .overlay-progress-container { width: 100%; margin-bottom: 20px; cursor: pointer; }
        .overlay-progress-bar { width: 100%; height: 4px; background: #555; border-radius: 2px; position: relative; }
        .overlay-progress-fill { height: 100%; background: white; border-radius: 2px; width: 0%; position: absolute; top: 0; left: 0; }
        .overlay-time { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 12px; color: #b3b3b3; }

        /* Search Results & History Areas */
        #search-results-wrapper {
            display: none; /* Hidden by default, shown on search */
            margin-bottom: 40px;
        }
        .results-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: white;
        }
        
        #search-history-wrapper {
            display: block; /* Visible by default */
        }
        .history-section-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 16px; 
            display: block; 
        }

        /* Playlist/Album View */
        .playlist-header-view { 
            display: flex; 
            align-items: flex-end; 
            gap: 24px; 
            padding: 20px 32px 40px 32px; 
            background: linear-gradient(180deg, #530000 0%, var(--bg-dark) 100%); 
            border-radius: 8px; 
            transition: background 0.5s ease;
        }
        .playlist-cover-wrap { position: relative; }
        .playlist-cover-big { 
            width: 232px; height: 232px; 
            box-shadow: 0 4px 60px rgba(0,0,0,0.5); 
            object-fit: cover; 
        }
        .edit-cover-btn {
            position: absolute;
            bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .playlist-cover-wrap:hover .edit-cover-btn { opacity: 1; }

        .playlist-info-big h1 { font-size: 6rem; font-weight: 900; line-height: 1; margin: 10px 0; letter-spacing: -2px; }
        .playlist-info-big span { font-size: 14px; font-weight: 600; }
        .playlist-meta { display: flex; align-items: center; gap: 5px; font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .playlist-actions { display: flex; align-items: center; gap: 32px; padding: 0 32px 24px 32px; }
        .action-play-btn { width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-red); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 8px 8px rgba(0,0,0,0.3); }
        .action-play-btn:hover { transform: scale(1.05); background-color: var(--primary-red-hover); }

        /* --- PLAYER BAR --- */
        .player-bar { height: var(--player-height); background-color: var(--bg-card); border-top: 1px solid #282828; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; z-index: 20000; }
        
        .player-left { 
            display: flex; 
            align-items: center; 
            width: 30%; 
            gap: 14px; 
            overflow: hidden; /* Ensure text doesn't spill out */
        }
        .current-art { width: 56px; height: 56px; border-radius: 4px; background-color: #333; object-fit: cover; flex-shrink: 0; }
        .current-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; flex: 1; }
        .current-title { font-size: 14px; color: var(--text-white); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .current-title:hover { text-decoration: underline; }
        .current-artist { font-size: 12px; color: var(--text-gray); cursor: pointer; white-space: nowrap; }
        .current-artist:hover { text-decoration: underline; color: var(--text-white); }
        
        /* Marquee Styles */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        .marquee-content {
            display: inline-block;
            white-space: nowrap;
            animation: marquee-scroll 15s linear infinite;
        }
        .marquee-content span {
            display: inline-block;
            padding-right: 50px;
        }
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .like-btn { 
            color: var(--text-gray); 
            background: none; 
            border: none; 
            cursor: pointer; 
            margin-left: 16px; 
            font-size: 20px; 
            transition: all 0.2s ease;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            width: 24px;
            height: 24px;
        }
        
        .like-btn:hover { color: var(--text-white); transform: scale(1.1); }
        .like-btn.liked { color: var(--primary-red) !important; }
        .like-btn.liked:hover { color: #ff4d5a !important; }
        
        .player-center { display: flex; flex-direction: column; align-items: center; width: 40%; gap: 8px; }
        .player-controls { display: flex; align-items: center; gap: 20px; }
        .control-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { color: var(--text-white); }
        .control-btn.active { color: var(--primary-red); }
        .play-pause-btn { width: 32px; height: 32px; background-color: var(--text-white); border-radius: 50%; color: black; font-size: 20px; transition: transform 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); color: black; }
        .playback-bar { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-gray); }
        .progress-container { flex: 1; height: 4px; background-color: #555; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background-color: var(--text-white); border-radius: 2px; width: 0%; }
        .progress-container:hover .progress-fill { background-color: var(--primary-red); }

        .player-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 12px; }
        .volume-bar-container { width: 100px; height: 4px; background-color: #555; border-radius: 2px; cursor: pointer; }
        .volume-fill { width: 70%; height: 100%; background-color: var(--text-white); border-radius: 2px; }

        /* --- QUEUE OVERLAY (NEW) --- */
        #queue-overlay {
            position: fixed;
            top: 0; right: 0; bottom: 90px; /* Above player bar */
            width: 400px;
            background-color: var(--bg-black);
            z-index: 2900;
            display: none;
            flex-direction: column;
            border-left: 1px solid #333;
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #queue-overlay.open { display: flex; }

        .queue-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .queue-title { font-weight: 700; font-size: 16px; }
        .queue-close-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 24px; }

        .queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .queue-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 12px;
            border-radius: 4px;
            cursor: grab;
            background: transparent;
        }
        .queue-item:active { cursor: grabbing; }
        .queue-item:hover { background-color: rgba(255,255,255,0.1); }
        .queue-item.dragging { opacity: 0.5; background: #333; }
        
        .queue-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .queue-info { flex: 1; overflow: hidden; }
        .queue-title { font-size: 14px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-artist { font-size: 12px; color: #aaa; }
        .queue-remove { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; padding: 5px; }
        .queue-remove:hover { color: var(--primary-red); }

        /* --- NEW PROFILE VIEW (SPOTIFY STYLE) --- */
        #view-profile {
            padding: 0; 
        }
        
        .profile-hero-section {
            display: flex;
            align-items: flex-end;
            gap: 24px;
            padding: 20px 32px;
            background: linear-gradient(180deg, #222 0%, var(--bg-dark) 100%);
            min-height: 300px;
            transition: background 0.5s ease;
        }

        .profile-avatar-lg {
            width: 230px;
            height: 230px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 60px rgba(0,0,0,0.5);
            border: 4px solid rgba(0,0,0,0.3);
        }

        .profile-hero-content {
            flex: 1;
            margin-bottom: 10px;
        }

        .profile-type-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .profile-name-large {
            font-size: 6rem; 
            font-weight: 900;
            line-height: 1;
            margin: 10px 0;
            letter-spacing: -2px;
            word-wrap: break-word;
        }

        .profile-bio-display {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            margin-top: 8px;
            max-width: 600px;
            line-height: 1.4;
        }

        /* User ID Display */
        .profile-userid-display {
            margin-top: 12px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: monospace;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .profile-userid-display:hover { background: rgba(255,255,255,0.2); }
        .copy-id-icon { font-size: 18px; color: var(--primary-red); }

        .profile-actions {
            padding: 24px 32px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-circle-blue {
            width: 48px; height: 48px; border-radius: 50%; background-color: #1db954; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn-circle-blue:hover { transform: scale(1.05); background-color: #1ed760; }

        .btn-pill {
            padding: 8px 24px;
            border-radius: 20px;
            border: 1px solid #777;
            color: white;
            background: transparent;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-pill:hover { border-color: white; transform: scale(1.04); }

        /* Edit Panel (Slide Down) */
        .profile-edit-panel {
            background-color: #282828;
            margin: 0 32px 32px 32px;
            padding: 24px;
            border-radius: 8px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        .profile-edit-panel.active { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .edit-grid {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .edit-avatar-wrapper {
            width: 150px; height: 150px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            background: #000;
        }
        .edit-avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .edit-avatar-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: 0.2s;
        }
        .edit-avatar-wrapper:hover .edit-avatar-overlay { opacity: 1; }
        
        .edit-form { flex: 1; display: flex; flex-direction: column; gap: 16px; }
        .edit-input {
            width: 100%; padding: 12px; border-radius: 4px; border: none;
            background: #3e3e3e; color: white; font-family: 'Inter', sans-serif;
        }
        .edit-input:focus { outline: 2px solid #555; }
        
        .edit-actions-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px; }
        .btn-cancel { background: transparent; color: white; border: none; padding: 10px 24px; cursor: pointer; font-weight: 700; }
        .btn-save { background: var(--primary-red); color: white; border: none; padding: 10px 24px; border-radius: 20px; cursor: pointer; font-weight: 700; }
        .btn-save:hover { background: var(--primary-red-hover); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background-color: #282828;
            width: 90%;
            max-width: 450px; 
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-modal-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-input {
            width: 100%; padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px; border: 1px solid #444;
            background: #121212; color: white;
            outline: none;
        }
        .modal-input:focus { border-color: var(--primary-red); }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary-red); color: white; border: none; border-radius: 50px; font-weight: 700; cursor: pointer; }
        .modal-btn:hover { background: var(--primary-red-hover); }
        .playlist-select-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .playlist-select-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-radius: 6px; }
        .playlist-select-item:hover { background: #333; }

        .section-title-profile { font-size: 24px; font-weight: 700; margin: 32px 32px 20px 32px; }
        .playlist-modal-grid-profile { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 24px;
            padding: 0 32px 60px 32px;
        }

        /* --- CHAT SYSTEM OVERLAY --- */
        #chat-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-black);
            z-index: 4000;
            display: none; /* Hidden by default */
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        #chat-overlay.active { display: flex; }

        .chat-header {
            padding: 16px 20px;
            background-color: #121212;
            border-bottom: 1px solid #282828;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 70px;
        }
        .chat-back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .chat-friend-info { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; }
        .chat-friend-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-friend-name { font-weight: 700; font-size: 16px; }
        .chat-status { font-size: 12px; color: var(--text-gray); }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 12px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
            transition: transform 0.2s;
            user-select: none;
        }
        
        .msg-sent {
            align-self: flex-end;
            background-color: var(--primary-red);
            color: white;
            border-bottom-right-radius: 2px;
        }
        
        .msg-received {
            align-self: flex-start;
            background-color: #282828;
            color: white;
            border-bottom-left-radius: 2px;
        }

        .msg-time {
            font-size: 10px;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .msg-reply-indicator {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            border-left: 2px solid rgba(255,255,255,0.3);
            padding-left: 8px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Shared Content in Chat */
        .chat-shared-card {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .chat-shared-card:hover { background: rgba(255,255,255,0.05); }
        .chat-shared-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .chat-shared-info { display: flex; flex-direction: column; }
        .chat-shared-title { font-size: 13px; font-weight: 600; color: white; }
        .chat-shared-sub { font-size: 11px; color: #ccc; }

        .chat-footer {
            padding: 15px;
            background-color: #121212;
            border-top: 1px solid #282828;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            background: #282828;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            outline: none;
        }
        .chat-send-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 20px;
            flex-shrink: 0; 
            transition: background 0.2s; 
        }

        .chat-send-btn:hover {
            background: var(--primary-red-hover); 
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95); 
        }

        /* --- CONTEXT MENU --- */
        #context-menu {
            position: absolute;
            background: #282828;
            border: 1px solid #444;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 5000;
            display: none;
            flex-direction: column;
            min-width: 120px;
        }
        .ctx-item {
            padding: 10px 15px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }
        .ctx-item:hover { background: var(--primary-red); }
        .ctx-separator { height: 1px; background: #444; margin: 2px 0; }

        /* --- FRIEND PROFILE OVERLAY --- */
        #friend-profile-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-black);
            z-index: 3500;
            display: none;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        #friend-profile-overlay.active { display: block; }

       @media (max-width: 768px) {
    .nav-arrows { display: none; }

    .sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        height: 100vh;
        width: 280px;
        background-color: var(--bg-black);
        padding: 24px 12px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }
    .sidebar.active { left: 0; }
    .mobile-menu-toggle { display: block; }

    .main-content {
        margin-left: 0;
        padding-bottom: 20px;
    }
    header { padding: 12px 16px; }
    .content-padding { padding: 16px; }

    /* Mobile Profile */
    .profile-hero-section { flex-direction: column; align-items: center; text-align: center; gap: 16px; padding-top: 40px; }
    .profile-avatar-lg { width: 180px; height: 180px; }
    .profile-name-large { font-size: 2.5rem; }
    .profile-actions { justify-content: center; }
    .edit-grid { flex-direction: column; align-items: center; }
    .edit-form { width: 100%; }

    .playlist-header-view { flex-direction: column; align-items: flex-start; background: linear-gradient(180deg, #530000 0%, var(--bg-dark) 100%); }
    .playlist-cover-big { width: 160px; height: 160px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .playlist-info-big h1 { font-size: 2.5rem; line-height: 1.1; }
    .playlist-actions { padding: 0 0 20px 0; width: 100%; justify-content: flex-start; gap: 20px; }

    .song-list-header, .song-row { grid-template-columns: 40px 1fr 40px; padding: 12px 16px; }
    .song-list-header div:nth-child(3), .song-list-header div:nth-child(4), .song-row div:nth-child(3), .song-row div:nth-child(4) { display: none; }
    .song-index { display: flex; align-items: center; justify-content: center; }

/* === PERBAIKAN CSS PLAYER BAR MOBILE (REPLACE SEMUA MEDIA QUERY MOBILE ANDA) === */
/* --- PERBAIKAN PLAYER BAR MOBILE (FULL FITUR) --- */
@media (max-width: 768px) {
    
    /* --- 1. ATURAN UMUM PLAYER BAR --- */
    .player-bar {
        height: 90px; /* Pastikan tinggi konsisten */
        padding: 0 10px; /* Kurangi padding horizontal biar muat banyak tombol */
    }

    /* --- 2. BAGIAN KIRI (Cover & Info) --- */
    .player-left {
        width: 35%; /* Perkecil jadi 35% */
        flex-shrink: 0; /* Jangan mengecilkan */
    }
    
    /* Sembunyikan Like Button di mobile biar judul tidak gepeng */
    .player-left .like-btn {
        display: none !important; 
    }

    /* Styling Judul Lagu agar rapi jika panjang */
    .current-title {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        margin-right: 5px;
    }
    
    .current-artist {
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- 3. BAGIAN TENGAH (Prev, Play, Next, Shuffle, Repeat) --- */
    .player-center {
        width: 40%; /* Beri ruang lebih lebar */
        flex-shrink: 1;
    }

    /* Munculkan & Styling tombol inti (Prev, Play, Next) */
    .player-center .control-btn:nth-child(1), /* Prev */
    .player-center .control-btn:nth-child(2), /* Play/Pause */
    .player-center .control-btn:nth-child(3) { /* Next */
        display: flex !important;
        justify-content: center;
        align-items: center;
        font-size: 24px; /* Ukuran jelas */
        padding: 0;
    }

    /* Styling khusus tombol Play/Pause agar lebih besar */
    .player-center .play-pause-btn {
        width: 36px; /* Sedikit lebih besar */
        height: 36px;
        font-size: 20px;
        background-color: var(--text-white);
    }

    /* Munculkan Shuffle & Repeat di Mobile (Posisi 4 & 5) */
    .player-center .control-btn:nth-child(4), /* Shuffle */
    .player-center .control-btn:nth-child(5) { /* Repeat */
        display: flex !important;
        font-size: 18px; /* Sedikit lebih kecil dari tombol navigasi */
        padding: 5px; /* Beri padding biar mudah diklik */
    }

    /* Tandai jika sedang aktif */
    .player-center .control-btn.active {
        color: var(--primary-red) !important;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }

    /* --- 4. BAGIAN KANAN (Queue, Listen Together, Volume) --- */
    .player-right {
        width: 25%; /* Sisa ruang */
        flex-shrink: 0;
        justify-content: flex-end;
        gap: 8px; /* Jarak antar tombol */
    }

    /* Munculkan tombol Queue (Atribut title Queue atau ikon list) */
    .player-right .control-btn[title="Queue"] {
        display: flex !important;
        font-size: 20px;
        padding: 6px;
    }

    /* Munculkan tombol Listen Together (Ikon users-three) */
    .player-right .control-btn[title="Dengar Bareng"] {
        display: flex !important;
        font-size: 20px;
        padding: 6px;
    }

    /* Sembunyikan tombol Mic (Lyric) */
    .player-right .control-btn[title="Lirik"] {
        display: none !important;
    }

    /* Sembunyikan Volume Slider */
    .player-right #volume-container {
        display: none !important;
    }

    /* --- 5. TAMBAHAN OVERLAY (Listen Together) --- */
    /* Pastikan Overlay tidak tertutup player bar saat muncul */
    #listen-together-overlay {
        z-index: 10000 !important; /* Sangat tinggi */
    }
    
    /* Responsive Container Mobile */
    .lt-container {
        width: 90% !important;
        padding: 30px 20px !important;
        max-height: 80vh; /* Batasi tinggi agar tombol bawah masih bisa diakses */
        overflow-y: auto; /* Scroll jika konten kepanjangan */
    }
    
    .lt-header h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .lt-btn, .lt-input {
        padding: 12px; /* Kurangi padding biar muat banyak tombol */
    }

    /* --- 6. TAMBAHAN OVERLAY QUEUE --- */
    /* Sesuaikan tinggi Queue agar tidak menutupi semua layar */
    #queue-overlay {
        bottom: 90px; /* Tepat di atas player bar */
        top: auto;
        height: 60vh; /* Tinggi 60% dari layar */
        border-left: none; /* Full width di mobile */
    }
}

    
/* === LISTEN TOGETHER OVERLAY === */
#listen-together-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 5000; /*  Pastikan tinggi */
    display: none;
    justify-content: center;
    align-items: center;
}
#listen-together-overlay.active { display: flex; }

.lt-container {
    background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
    padding: 40px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    border: 2px solid var(--primary-red);
    box-shadow: 0 20px 60px rgba(229,9,20,0.3);
}

.lt-header {
    text-align: center;
    margin-bottom: 30px;
}

.lt-header h2 {
    font-size: 32px;
    font-weight: 900;
    color: white;
    margin-bottom: 10px;
}

.lt-header p {
    color: #aaa;
    font-size: 14px;
}

.lt-mode-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 30px;
}

.lt-mode-btn {
    padding: 20px;
    border: 2px solid #333;
    border-radius: 12px;
    background: transparent;
    color: white;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 700;
}

.lt-mode-btn:hover {
    border-color: var(--primary-red);
    background: rgba(229,9,20,0.1);
}

.lt-mode-btn.active {
    border-color: var(--primary-red);
    background: var(--primary-red);
}

.lt-session-code {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
    border: 1px solid #333;
}

.lt-code-display {
    font-size: 36px;
    font-weight: 900;
    color: var(--primary-red);
    letter-spacing: 8px;
    font-family: monospace;
    margin: 10px 0;
}

.lt-input {
    width: 100%;
    padding: 15px;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 12px;
    color: white;
    font-size: 24px;
    text-align: center;
    letter-spacing: 4px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 15px;
}

.lt-input:focus {
    outline: none;
    border-color: var(--primary-red);
}

.lt-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary-red);
    border: none;
    border-radius: 50px;
    color: white;
    font-weight: 900;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
}

.lt-btn:hover {
    background: var(--primary-red-hover);
    transform: scale(1.02);
}

.lt-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 32px;
    cursor: pointer;
}

/* Session Active Badge */
.session-badge {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, var(--primary-red), #ff4d5a);
    padding: 12px 20px;
    border-radius: 50px;
    display: none;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(229,9,20,0.4);
    cursor: pointer;
    animation: pulse 2s infinite;
}

.session-badge.active { display: flex; }

@keyframes pulse {
    0%, 100% { box-shadow: 0 4px 15px rgba(229,9,20,0.4); }
    50% { box-shadow: 0 4px 25px rgba(229,9,20,0.8); }
}

.session-badge-icon {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Participants List */
.lt-participants {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 12px;
    margin-top: 20px;
    max-height: 200px;
    overflow-y: auto;
}

.lt-participant {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 6px;
}

.lt-participant:hover {
    background: rgba(255,255,255,0.05);
}

.lt-participant img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.lt-host-badge {
    background: var(--primary-red);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    margin-left: auto;
}
#toast-container {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}
.toast {
    background: rgba(40, 40, 40, 0.95);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideUp 0.3s ease;
    pointer-events: auto;
    border: 1px solid #444;
}
.toast.success { border-color: #1db954; }
.toast.error { border-color: #e91e63; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.import-music-btn {
    color: var(--text-gray);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: 0.2s;
    border-radius: 4px;
    margin-top: 5px;
}
.import-music-btn:hover { 
    color: var(--text-white); 
    background-color: rgba(255,255,255,0.05); 
}

.import-form-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.import-file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
    border: 2px dashed #444;
}

.import-file-preview.active {
    border-color: var(--primary-red);
}

.import-cover-preview {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    background: #333;
}

.import-file-info {
    flex: 1;
}

.import-file-name {
    font-weight: 600;
    color: white;
    margin-bottom: 5px;
}

.import-file-size {
    font-size: 12px;
    color: #888;
}

.file-upload-btn {
    padding: 12px 24px;
    background: var(--primary-red);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: 0.2s;
}

.file-upload-btn:hover {
    background: var(--primary-red-hover);
}

.privacy-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
}

.privacy-toggle label {
    flex: 1;
    font-weight: 600;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #444;
    transition: 0.4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #1db954;
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="loading-screen">
        <span class="loader"></span>
        <div class="loader-text">MEMUAT VIDJE...</div>
    </div>

    <!-- 2. AUTH VIEW -->
    <div id="auth-view" style="display: none;">
        <div class="auth-container">
            <div class="auth-box" id="login-box">
                <div class="auth-logo"><i class="ph-fill ph-play-circle"></i></div>
                <h2>Masuk ke Vidje</h2>
                <p>Musik untuk semua orang.</p>
                <p class="error-msg" id="login-error">Email atau password salah.</p>
                <input type="email" id="login-email" class="auth-input" placeholder="Email">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="window.handleLogin()">Masuk</button>
                <div class="auth-switch">
                    Belum punya akun? <span onclick="window.toggleAuthMode('signup')">Daftar Sekarang</span>
                </div>
            </div>

            <div class="auth-box" id="signup-box" style="display: none;">
                <div class="auth-logo"><i class="ph-fill ph-user-plus"></i></div>
                <h2>Daftar Akun</h2>
                <p>Bergabunglah dengan Vidje.</p>
                <p class="error-msg" id="signup-error">Gagal mendaftar.</p>
                <input type="text" id="signup-name" class="auth-input" placeholder="Nama Lengkap">
                <input type="email" id="signup-email" class="auth-input" placeholder="Email">
                <input type="password" id="signup-password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="window.handleSignup()">Daftar</button>
                <div class="auth-switch">
                    Sudah punya akun? <span onclick="window.toggleAuthMode('login')">Masuk</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. APP WRAPPER -->
    <div class="app-wrapper" id="app-wrapper" style="display: none;">
        
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="window.toggleSidebar()"></div>

        <div class="container">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="logo" onclick="window.switchView('home')">
                    <i class="ph-fill ph-play-circle"></i>
                    <span>VIDJE</span>
                </div>
                
                <ul class="nav-links">
                    <li><a href="#" onclick="window.switchView('home')" id="nav-home" class="nav-item active"><i class="ph ph-house"></i><span>Beranda</span></a></li>
                    <li><a href="#" onclick="window.switchView('search')" id="nav-search" class="nav-item"><i class="ph ph-magnifying-glass"></i><span>Cari</span></a></li>
                    <li><a href="#" onclick="window.switchView('liked')" id="nav-liked" class="nav-item"><i class="ph ph-heart"></i><span>Lagu Disukai</span></a></li>
                </ul>

                <div class="divider"></div>

                <div class="playlist-scroll">
                    <div class="playlist-title">Playlist Anda</div>
                    
                    <div class="create-playlist-btn" onclick="window.openCreatePlaylistModal()">
                        <i class="ph ph-plus-square" style="font-size: 24px;"></i>
                        <span>Buat Playlist</span>
                    </div> 

                    <div class="import-music-btn" onclick="window.openImportMusicModal()">
                        <i class="ph ph-upload-simple" style="font-size: 24px;"></i>
                        <span>Impor Musik</span>
                    </div>



                    <div id="sidebar-playlists-container" style="margin-top: 10px;"></div>

                    <!-- --- FITUR PERTEMANAN (SIDEBAR) --- -->
                    <div class="friend-section">
                        <div class="playlist-title">Teman</div>
                        
                        <div class="friend-search-container">
                            <input type="text" id="friend-search-input" class="friend-search-input" placeholder="Cari teman (Nama/User ID)..." autocomplete="off">
                            <div id="friend-search-dropdown" class="friend-search-dropdown"></div>
                        </div>

                        <div class="playlist-title" style="font-size: 10px; margin-top: 10px;">Permintaan Pertemanan</div>
                        <div id="friend-requests-container" style="margin-bottom: 10px;"></div>

                        <div class="playlist-title" style="font-size: 10px; margin-top: 10px;">Daftar Teman</div>
                        <div id="friend-list-container"></div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                <header>
                    <div class="header-left">
                        <button class="mobile-menu-toggle" onclick="window.toggleSidebar()">
                            <i class="ph ph-list"></i>
                        </button>
                    </div>
                    <div class="user-menu" onclick="window.switchView('profile')">
                        <img src="https://picsum.photos/seed/user123/50/50" alt="User Avatar" id="header-avatar">
                        <span id="header-username">Rizky</span>
                        <i class="ph ph-caret-down" style="font-size: 12px;"></i>
                    </div>
                </header>

                <div class="content-padding">
                    <!-- VIEW: BERANDA (HOME) -->
                    <div id="view-home" class="view-section active">
                        <!-- SEDANG TREN -->
                        <h2>Playlist Saya</h2>
                        <div class="card-grid" id="trending-container"></div>

                        <!-- BAND POPULER INDONESIA -->
                        <h2>Band Populer Indonesia</h2>
                        <div class="horizontal-scroll-grid" id="popular-bands-container"></div>

                        <!-- PENYANYI POPULER INDONESIA -->
                        <h2>Penyanyi Populer Indonesia</h2>
                        <div class="horizontal-scroll-grid" id="popular-artists-container"></div>

                        <!-- NEW: PENYANYI ASING POPULER -->
                        <h2>Penyanyi Asing Populer</h2>
                        <div class="horizontal-scroll-grid" id="foreign-solo-container"></div>

                        <!-- NEW: BAND ASING POPULER -->
                        <h2>Band Asing Populer</h2>
                        <div class="horizontal-scroll-grid" id="foreign-bands-container"></div>

                        <br><br><br>
                    </div>

                   <!-- VIEW: CARI (SEARCH) -->
<div id="view-search" class="view-section">
    <div class="search-container">
        <i class="ph ph-magnifying-glass search-icon-placeholder"></i>
        <input type="text" class="search-input" id="search-input" placeholder="Apa yang ingin diputar?" oninput="window.handleSearch(this.value)">
    </div>

    <!-- Search Results Wrapper (Hidden by default, shown when typing) -->
    <div id="search-results-wrapper">
        <h3 class="results-section-title">Hasil Pencarian</h3>
        <!-- Bands/Artists Grid -->
        <div id="search-bands-container" class="card-grid" style="margin-bottom: 30px;"></div>

        <!-- Public Playlists Grid -->
        <h3 id="search-playlists-title" style="display:none; margin-bottom: 10px; font-size: 18px; font-weight: 700;">Playlist Publik</h3>
        <div id="search-playlists-container" class="card-grid" style="margin-bottom: 30px;"></div>
        
        <!-- Songs List -->
        <div id="search-songs-container"></div>
    </div>

    <!-- History Wrapper (Visible by default, hidden when typing) -->
    <div id="search-history-wrapper">
        <h3 class="history-section-title" id="search-history-title">Baru Diputar</h3>
        <div id="search-history-container"></div>
    </div>
</div>




<div id="view-playlist" class="view-section">
    <div class="playlist-header-view" id="playlist-header-bg">
        <div class="playlist-cover-wrap">
            <img src="https://picsum.photos/seed/playlist/300/300" class="playlist-cover-big" id="playlist-cover-view">
            <button class="edit-cover-btn" onclick="document.getElementById('playlist-cover-input').click()">
                <i class="ph-fill ph-camera"></i>
            </button>
            <input type="file" id="playlist-cover-input" style="display: none;" accept="image/*" onchange="window.handlePlaylistCoverUpload(this)">
        </div>
        <div class="playlist-info-big">
            <span>PLAYLIST</span>
            <h1 id="playlist-title-view">Playlist Saya</h1>
            <div class="playlist-meta">
                <span style="color: white;" id="playlist-owner-display">Owner</span>  <span id="playlist-count">0 lagu</span>
            </div>
        </div>
    </div>

    <!-- TOMBOL SEKARANG DI BAWAH HEADER -->
    <div class="playlist-actions">
        <div class="action-play-btn" onclick="window.playFirstSongOfPlaylist()">
            <i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i>
        </div>
        
        <button class="share-btn" onclick="window.shareCurrentPlaylist()" title="Bagikan Playlist" style="background:none; border:none; color:var(--text-gray); cursor:pointer; font-size:32px; transition:0.2s;">
            <i class="ph ph-share-network"></i>
        </button>
        
        <button class="settings-btn" onclick="window.openPlaylistSettings()" title="Atur Playlist" style="background:none; border:none; color:var(--text-gray); cursor:pointer; font-size:32px; transition:0.2s;">
            <i class="ph ph-gear"></i>
        </button>
    </div>


<!-- Tambahkan Modal Pengaturan Playlist (sebelum closing body tag) -->
<div id="playlist-settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Pengaturan Playlist</div>
            <button class="close-modal-btn" onclick="window.closeModal('playlist-settings-modal')">
                <i class="ph ph-x"></i>
            </button>
        </div>
        
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 15px auto; cursor: pointer;" onclick="document.getElementById('settings-cover-input').click()">
                <img id="settings-cover-preview" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 0 0 8px 8px; color: white; font-size: 12px;">
                    <i class="ph ph-camera"></i> Ubah Foto
                </div>
            </div>
            <input type="file" id="settings-cover-input" style="display: none;" accept="image/*" onchange="window.handleSettingsCoverUpload(this)">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase; display: block; margin-bottom: 8px;">Nama Playlist</label>
            <input type="text" id="settings-playlist-name" class="modal-input" placeholder="Nama Playlist">
        </div>
        
        <button class="modal-btn" onclick="window.savePlaylistSettings()">Simpan Perubahan</button>
    </div>
</div>

                        <

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="playlist-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- LOCAL ALBUMS (GHANI, REVAN, HANUNG, RARA) --- -->

                    <!-- VIEW: DETAIL ALBUM (GHANI'S ALBUM) -->
                    <div id="view-ghani-album" class="view-section">
                        <div class="playlist-header-view" id="ghani-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/ghani.jpg" class="playlist-cover-big" id="ghani-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="ghani-title-view">Ghani's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="ghani-count">10 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfGhani()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="ghani-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- VIEW: DETAIL ALBUM (REVAN'S ALBUM) -->
                    <div id="view-revan-album" class="view-section">
                        <div class="playlist-header-view" id="revan-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/revan.jpg" class="playlist-cover-big" id="revan-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="revan-title-view">Revan's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="revan-count">10 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRevan()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="revan-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- HANUNG'S ALBUM -->
                    <div id="view-hanung-album" class="view-section">
                        <div class="playlist-header-view" id="hanung-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/pras.jpg" class="playlist-cover-big" id="hanung-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="hanung-title-view">Hanung's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="hanung-count">6 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfHanung()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="hanung-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- RARA'S ALBUM -->
                    <div id="view-rara-album" class="view-section">
                        <div class="playlist-header-view" id="rara-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/rara.jpg" class="playlist-cover-big" id="rara-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="rara-title-view">Rara's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="rara-count">5 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRara()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="rara-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- BAND POPULER INDONESIA VIEWS --- -->
                    <!-- 1. PERUNGGU -->
                    <div id="view-perunggu-album" class="view-section">
                        <div class="playlist-header-view" id="perunggu-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/perunggu.jpg" class="playlist-cover-big" id="perunggu-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="perunggu-title-view">Perunggu</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="perunggu-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfPerunggu()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="perunggu-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 2. NOAH / PETERPAN -->
                    <div id="view-noah-album" class="view-section">
                        <div class="playlist-header-view" id="noah-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/noah.jpg" class="playlist-cover-big" id="noah-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="noah-title-view">NOAH / Peterpan</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="noah-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfNoah()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="noah-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 3. DEWA 19 -->
                    <div id="view-dewa-album" class="view-section">
                        <div class="playlist-header-view" id="dewa-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/dewa19.png" class="playlist-cover-big" id="dewa-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="dewa-title-view">Dewa 19</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="dewa-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfDewa()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="dewa-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 4. SHEILA ON 7 -->
                    <div id="view-sheila-album" class="view-section">
                        <div class="playlist-header-view" id="sheila-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/so7.jpg" class="playlist-cover-big" id="sheila-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="sheila-title-view">Sheila On 7</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="sheila-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfSheila()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="sheila-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 5. KAHITNA -->
                    <div id="view-kahitna-album" class="view-section">
                        <div class="playlist-header-view" id="kahitna-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/kahitna.jpeg" class="playlist-cover-big" id="kahitna-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="kahitna-title-view">Kahitna</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="kahitna-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfKahitna()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="kahitna-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 6. HINDIA -->
                    <div id="view-hindia-album" class="view-section">
                        <div class="playlist-header-view" id="hindia-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/hindia.jpg" class="playlist-cover-big" id="hindia-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="hindia-title-view">Hindia</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="hindia-count">11 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfHindia()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="hindia-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- PENYANYI POPULER INDONESIA VIEWS --- -->

                    <!-- 7. ASTRID -->
                    <div id="view-astrid-album" class="view-section">
                        <div class="playlist-header-view" id="astrid-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/astrid.webp" class="playlist-cover-big" id="astrid-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="astrid-title-view">Astrid</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="astrid-count">5 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfAstrid()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="astrid-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 8. AFGAN -->
                    <div id="view-afgan-album" class="view-section">
                        <div class="playlist-header-view" id="afgan-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/afgan.png" class="playlist-cover-big" id="afgan-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="afgan-title-view">Afgan</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="afgan-count">8 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfAfgan()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="afgan-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 9. TULUS -->
                    <div id="view-tulus-album" class="view-section">
                        <div class="playlist-header-view" id="tulus-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/tulus.jpg" class="playlist-cover-big" id="tulus-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="tulus-title-view">Tulus</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="tulus-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTulus()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="tulus-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 10. MAHALINI -->
                    <div id="view-mahalini-album" class="view-section">
                        <div class="playlist-header-view" id="mahalini-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/mahalini.jpg" class="playlist-cover-big" id="mahalini-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="mahalini-title-view">Mahalini</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="mahalini-count">8 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfMahalini()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="mahalini-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 11. TENXI -->
                    <div id="view-tenxi-album" class="view-section">
                        <div class="playlist-header-view" id="tenxi-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/tenxi.jpg" class="playlist-cover-big" id="tenxi-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="tenxi-title-view">Tenxi</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="tenxi-count">5 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTenxi()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="tenxi-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: PENYANYI ASING (SOLO) VIEWS --- -->

                    <!-- Taylor Swift -->
                    <div id="view-taylor-album" class="view-section">
                        <div class="playlist-header-view" id="taylor-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/taylor.jpg" class="playlist-cover-big" id="taylor-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="taylor-title-view">Taylor Swift</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="taylor-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTaylor()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="taylor-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Justin Bieber -->
                    <div id="view-justin-album" class="view-section">
                        <div class="playlist-header-view" id="justin-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/justin.jpg" class="playlist-cover-big" id="justin-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="justin-title-view">Justin Bieber</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="justin-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfJustin()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="justin-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Ed Sheeran -->
                    <div id="view-ed-album" class="view-section">
                        <div class="playlist-header-view" id="ed-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/ed.jpg" class="playlist-cover-big" id="ed-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="ed-title-view">Ed Sheeran</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="ed-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfEd()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="ed-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Bruno Mars -->
                    <div id="view-bruno-album" class="view-section">
                        <div class="playlist-header-view" id="bruno-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/bruno.jpg" class="playlist-cover-big" id="bruno-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="bruno-title-view">Bruno Mars</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="bruno-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfBruno()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="bruno-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Daniel Caesar -->
                    <div id="view-daniel-album" class="view-section">
                        <div class="playlist-header-view" id="daniel-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/daniel.jpg" class="playlist-cover-big" id="daniel-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="daniel-title-view">Daniel Caesar</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="daniel-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfDaniel()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="daniel-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: BAND ASING VIEWS --- -->

                    <!-- Coldplay -->
                    <div id="view-coldplay-album" class="view-section">
                        <div class="playlist-header-view" id="coldplay-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/coldplay.jpg" class="playlist-cover-big" id="coldplay-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="coldplay-title-view">Coldplay</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="coldplay-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfColdplay()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="coldplay-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- One Direction -->
                    <div id="view-onedirection-album" class="view-section">
                        <div class="playlist-header-view" id="onedirection-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/onedirection.jpg" class="playlist-cover-big" id="onedirection-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="onedirection-title-view">One Direction</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="onedirection-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfOnedirection()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="onedirection-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Green Day -->
                    <div id="view-greenday-album" class="view-section">
                        <div class="playlist-header-view" id="greenday-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/greenday.jpg" class="playlist-cover-big" id="greenday-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="greenday-title-view">Green Day</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="greenday-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfGreenday()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="greenday-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Oasis -->
                    <div id="view-oasis-album" class="view-section">
                        <div class="playlist-header-view" id="oasis-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/oasis.jpg" class="playlist-cover-big" id="oasis-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="oasis-title-view">Oasis</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="oasis-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfOasis()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="oasis-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Radiohead -->
                    <div id="view-radiohead-album" class="view-section">
                        <div class="playlist-header-view" id="radiohead-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="album photo/radiohead.jpg" class="playlist-cover-big" id="radiohead-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="radiohead-title-view">Radiohead</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="radiohead-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRadiohead()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="radiohead-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>


                    <!-- VIEW: LIKED SONGS -->
                    <div id="view-liked" class="view-section">
                        <div class="playlist-header-view" id="liked-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="https://picsum.photos/seed/liked/300/300" class="playlist-cover-big" id="liked-cover-view">
                                <button class="edit-cover-btn" onclick="document.getElementById('liked-cover-input').click()">
                                    <i class="ph-fill ph-camera"></i>
                                </button>
                                <input type="file" id="liked-cover-input" style="display: none;" accept="image/*" onchange="window.handleLikedCoverUpload(this)">
                            </div>
                            <div class="playlist-info-big">
                                <span>DISUKAI</span>
                                <h1 id="liked-title-view">Disukai</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Koleksi Lagu</span>  <span id="liked-count">0 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfLiked()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="liked-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: PROFILE VIEW (SPOTIFY STYLE) --- -->
                    <div id="view-profile" class="view-section">
                        <div class="profile-hero-section" id="profile-hero-section">
                            <img src="" alt="Profile Avatar" class="profile-avatar-lg" id="profile-avatar-display">
                            <div class="profile-hero-content">
                                <div class="profile-type-label">Profil</div>
                                <h1 class="profile-name-large" id="profile-name-display">Nama User</h1>
                                
                                <!-- USER ID DISPLAY -->
                                <div class="profile-userid-display" onclick="window.copyUserId()">
                                    <span id="profile-userid-text">User#0000</span>
                                    <i class="ph ph-copy copy-id-icon"></i>
                                </div>

                                <p class="profile-bio-display" id="profile-bio-display">Bio user akan muncul di sini.</p>
                            </div>
                        </div>

                        <div class="profile-actions">
                            <div class="btn-circle-blue"><i class="ph ph-check"></i></div> <!-- Mock Verified Icon -->
                            <button class="btn-pill" onclick="window.toggleProfileEdit()">
                                <i class="ph ph-pencil-simple"></i> Edit Profil
                            </button>
                        </div>

                        <!-- Edit Form Panel -->
                        <div class="profile-edit-panel" id="profile-edit-panel">
                            <div class="edit-grid">
                                <div class="edit-avatar-wrapper" onclick="document.getElementById('profile-avatar-input').click()">
                                    <img src="" id="edit-profile-img">
                                    <div class="edit-avatar-overlay">
                                        <i class="ph ph-camera" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <input type="file" id="profile-avatar-input" style="display: none;" accept="image/*" onchange="window.handleProfileAvatarUpload(this)">
                                
                                <div class="edit-form">
                                    <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">Nama</label>
                                    <input type="text" id="edit-profile-name" class="edit-input">
                                    <small style="color: #aaa; font-size: 12px;">ID User akan otomatis mengikuti nama baru.</small>
                                    
                                    <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">Bio</label>
                                    <textarea id="edit-profile-bio" class="edit-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="edit-actions-row">
                                <button class="btn-cancel" onclick="window.toggleProfileEdit()">Batal</button>
                                <button class="btn-save" onclick="window.saveProfileChanges()">Simpan</button>
                            </div>
                        </div>

                        <div class="section-title-profile">Playlist Publik</div>
                        <div class="playlist-modal-grid-profile" id="profile-public-playlists">
                            <!-- Playlists generated by JS -->
                        </div>
                        
                        <br><br><br>
                    </div>

                </div>
            </main>
        </div>

        <!-- Player Bar -->
        <footer class="player-bar">
            <div class="player-left">
                <img src="https://picsum.photos/seed/music/60/60" alt="Album Art" class="current-art" id="player-art">
                <div class="current-info">
                    <div class="current-title" id="player-title">Pilih Lagu</div>
                    <div class="current-artist" id="player-artist">...</div>
                </div>
                <button class="like-btn" id="like-btn" onclick="window.toggleCurrentSongLike()">
                    <i class="ph ph-heart"></i>
                </button>
            </div>

            <div class="player-center">
                <div class="player-controls">
                    <button class="control-btn" id="shuffle-btn" onclick="window.toggleShuffle()"><i class="ph ph-shuffle"></i></button>
                    <button class="control-btn" id="prev-btn" onclick="window.playPrevious()"><i class="ph ph-skip-back-fill"></i></button>
                    <button class="play-pause-btn" id="play-pause-btn"><i class="ph-fill ph-play"></i></button>
                    <button class="control-btn" id="next-btn" onclick="window.playNext()"><i class="ph ph-skip-forward-fill"></i></button>
                    <button class="control-btn" id="repeat-btn" onclick="window.toggleRepeat()"><i class="ph ph-repeat"></i></button>
                </div>
                <div class="playback-bar">
                    <span id="current-time">0:00</span>
                    <div class="progress-container" id="progress-container">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <span id="total-duration">0:00</span>
                </div>
            </div>

            <div class="player-right">
    <button class="control-btn" title="Lirik"><i class="ph ph-microphone-stage"></i></button>
    <button class="control-btn" title="Queue" onclick="window.toggleQueueOverlay()"><i class="ph ph-queue"></i></button>
    

    <button class="control-btn" id="vol-icon" title="Volume"><i class="ph ph-speaker-high"></i></button>
    <div class="volume-bar-container" id="volume-container">
        <div class="volume-fill" id="volume-fill"></div>
    </div>
</div>
        </footer>

        <!-- QUEUE OVERLAY -->
        <div id="queue-overlay">
            <div class="queue-header">
                <div class="queue-title">Antrian</div>
                <button class="queue-close-btn" onclick="window.toggleQueueOverlay()"><i class="ph ph-x"></i></button>
            </div>
            <div class="queue-list" id="queue-list-container">
                <!-- Queue items rendered here -->
                <div style="padding:20px; text-align:center; color:#666;">Antrian kosong.</div>
            </div>
        </div>

    </div>

    <!-- OVERLAY PLAYER SCREEN -->
    <div id="overlay-player">
        <div class="overlay-bg" id="overlay-bg"></div>
        <div class="overlay-content">
            <button class="overlay-close-btn" onclick="window.closeOverlayPlayer()">
                <i class="ph ph-caret-down"></i>
            </button>
            <div class="overlay-art-wrapper">
                <img src="" id="overlay-art" alt="Album Art">
            </div>
            <div class="overlay-info">
                <h2 id="overlay-title">Title</h2>
                <p id="overlay-artist" onclick="window.openArtistProfileFromOverlay()" style="cursor: pointer; text-decoration: underline;">Artist</p>
            </div>
            
            <div class="overlay-progress-container" id="overlay-progress-container">
                <div class="overlay-progress-bar">
                    <div class="overlay-progress-fill" id="overlay-progress-fill"></div>
                </div>
                <div class="overlay-time">
                    <span id="overlay-current-time">0:00</span>
                    <span id="overlay-total-duration">0:00</span>
                </div>
            </div>

            <div class="overlay-controls">
                <button onclick="window.toggleShuffle()"><i class="ph ph-shuffle" id="overlay-shuffle-icon"></i></button>
                <button onclick="window.playPrevious()"><i class="ph-fill ph-skip-back"></i></button>
                <button class="overlay-play-btn" id="overlay-play-pause-btn" onclick="document.getElementById('play-pause-btn').click()">
                    <i class="ph-fill ph-play"></i>
                </button>
                <button onclick="window.playNext()"><i class="ph-fill ph-skip-forward"></i></button>
                <button onclick="window.toggleRepeat()"><i class="ph ph-repeat" id="overlay-repeat-icon"></i></button>
            </div>
        </div>
    </div>

    <!-- ARTIST PROFILE OVERLAY -->
    <div id="artist-profile-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-dark); z-index:10001; display:none; flex-direction:column; overflow-y:auto;">
        <div style="padding: 20px;">
            <button onclick="window.closeArtistProfile()" style="background:none; border:none; color:white; font-size:32px; cursor:pointer;">
                <i class="ph ph-arrow-left"></i>
            </button>
        </div>
        <div class="playlist-header-view" id="artist-profile-header">
            <div class="playlist-cover-wrap">
                <img src="" class="playlist-cover-big" id="artist-profile-img">
            </div>
            <div class="playlist-info-big">
                <span>ARTIS</span>
                <h1 id="artist-profile-name">Nama Artis</h1>
                <div class="playlist-meta">
                    <span style="color: white;">Profil Artis</span>
                </div>
            </div>
        </div>
        <div style="padding: 0 32px;">
             <h3>Lagu Populer</h3>
             <div id="artist-profile-songs"></div>
        </div>
    </div>

    <!-- 4. MODALS -->

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Buat Playlist Baru</div>
                <button class="close-modal-btn" onclick="window.closeModal('create-playlist-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: #b3b3b3; font-size: 14px;">Gambar cover default akan diberikan secara otomatis.</p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">Nama Playlist</label>
                <input type="text" id="new-playlist-name" class="modal-input" placeholder="Contoh: Lagu Santai" style="margin-top: 8px;">
            </div>
            <button class="modal-btn" onclick="window.submitCreatePlaylist()">Buat</button>
        </div>
    </div>

    <!-- IMPORT MUSIC MODAL -->
<div id="import-music-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title">Impor Musik</div>
            <button class="close-modal-btn" onclick="window.closeModal('import-music-modal')">
                <i class="ph ph-x"></i>
            </button>
        </div>

        <div class="import-form-grid">
            <!-- File Preview -->
            <div class="import-file-preview" id="import-file-preview">
                <img src="https://picsum.photos/seed/default/100/100" 
                     class="import-cover-preview" 
                     id="import-cover-preview">
                <div class="import-file-info">
                    <div class="import-file-name" id="import-file-name">
                        Belum ada file dipilih
                    </div>
                    <div class="import-file-size" id="import-file-size">
                        Pilih file MP3
                    </div>
                </div>
                <input type="file" 
                       id="import-music-file" 
                       accept="audio/mp3,audio/mpeg" 
                       style="display: none;" 
                       onchange="window.handleMusicFileSelect(this)">
                <button class="file-upload-btn" 
                        onclick="document.getElementById('import-music-file').click()">
                    <i class="ph ph-file-audio"></i> Pilih MP3
                </button>
            </div>

            <!-- Song Info -->
            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    Nama Lagu
                </label>
                <input type="text" 
                       id="import-song-title" 
                       class="modal-input" 
                       placeholder="Contoh: Beautiful Day">
            </div>

            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    Penyanyi
                </label>
                <input type="text" 
                       id="import-song-artist" 
                       class="modal-input" 
                       placeholder="Contoh: John Doe">
            </div>

            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    Album
                </label>
                <input type="text" 
                       id="import-song-album" 
                       class="modal-input" 
                       placeholder="Contoh: Greatest Hits">
            </div>

            <!-- Cover Photo Upload -->
            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    Foto Album (Opsional)
                </label>
                <input type="file" 
                       id="import-cover-file" 
                       accept="image/*" 
                       style="display: none;" 
                       onchange="window.handleCoverFileSelect(this)">
                <button class="file-upload-btn" 
                        onclick="document.getElementById('import-cover-file').click()" 
                        style="width: 100%; margin-top: 8px;">
                    <i class="ph ph-image"></i> Pilih Foto
                </button>
            </div>

            <!-- Privacy Toggle -->
            <div class="privacy-toggle">
                <label>
                    <i class="ph ph-lock-key" id="privacy-icon" style="margin-right: 5px;"></i>
                    <span id="privacy-label">Privat</span>
                    <p style="font-size: 11px; color: #888; margin-top: 3px;">
                        Hanya Anda yang bisa mendengarkan
                    </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" 
                           id="import-privacy-toggle" 
                           onchange="window.updatePrivacyLabel(this)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Submit Button -->
            <button class="modal-btn" onclick="window.submitImportMusic()">
                <i class="ph ph-upload-simple"></i> Impor Musik
            </button>
        </div>
    </div>
</div>

    <!-- Add Song to Playlist Modal -->
    <div id="add-song-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Tambahkan ke Playlist</div>
                <button class="close-modal-btn" onclick="window.closeModal('add-song-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div class="playlist-select-list" id="add-song-playlist-list"></div>
        </div>
    </div>

    <!-- Share to Friend Modal -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Bagikan ke Teman</div>
                <button class="close-modal-btn" onclick="window.closeModal('share-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div class="playlist-select-list" id="share-friend-list" style="max-height: 300px;"></div>
            <p id="share-loading" style="text-align:center; color: #888; display:none;">Memuat daftar teman...</p>
        </div>
    </div>

    <!-- --- NEW OVERLAYS --- -->

    <!-- Full Screen Chat Overlay -->
    <div id="chat-overlay">
        <div class="chat-header">
            <button class="chat-back-btn" onclick="window.closeChat()"><i class="ph ph-arrow-left"></i></button>
            <div class="chat-friend-info" onclick="window.openFriendProfileFromChat()">
                <img src="" class="chat-friend-avatar" id="chat-friend-avatar-display">
                <div>
                    <div class="chat-friend-name" id="chat-friend-name-display">Nama Teman</div>
                    <div class="chat-status">Online</div>
                </div>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <!-- Messages injected here -->
        </div>
       <div class="chat-footer">
        <!-- Listen Together Button -->
        <button id="btn-open-listen-together" onclick="window.openListenTogether()" title="Dengar Bareng" style="background:none; border:none; color:#aaa; font-size:24px; cursor:pointer; margin-right:10px; display:flex; align-items:center; transition: color 0.2s;">
            <i class="ph ph-users-three"></i>
        </button>
    <input 
        type="text" 
        class="chat-input" 
        id="chat-input-box" 
        placeholder="Ketik pesan..." 
        onkeypress="if(event.key === 'Enter') window.sendChatMessage()"
        autocomplete="off"
    >
    <button 
    class="chat-send-btn" 
    onclick="window.sendChatMessage()" 
    title="Kirim Pesan"
    aria-label="Kirim Pesan"
>
    
</button>
</div>
    <!-- Friend Profile Overlay -->
    <div id="friend-profile-overlay">
        <div style="padding: 24px;">
            <button onclick="window.closeFriendProfile()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; margin-bottom:20px;"><i class="ph ph-arrow-left"></i> Kembali</button>
            
            <div class="profile-hero-section" id="friend-hero-section">
                <img src="" alt="Friend Avatar" class="profile-avatar-lg" id="friend-profile-avatar-display">
                <div class="profile-hero-content">
                    <div class="profile-type-label">Profil Teman</div>
                    <h1 class="profile-name-large" id="friend-profile-name-display">Nama Teman</h1>
                    <!-- Friend ID Display -->
                    <div class="profile-userid-display" onclick="window.copyFriendUserId()" style="cursor:default;">
                        <span id="friend-profile-userid-text">Friend#0000</span>
                        <i class="ph ph-copy copy-id-icon"></i>
                    </div>
                    <p class="profile-bio-display" id="friend-profile-bio-display">Bio teman.</p>
                </div>
            </div>

            <div class="section-title-profile">Playlist Publik</div>
            <div class="playlist-modal-grid-profile" id="friend-public-playlists">
                <!-- Friend Playlists -->
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="ctx-item" onclick="window.ctxAction('copy')">Salin</div>
        <div class="ctx-item" onclick="window.ctxAction('reply')">Balas</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="window.ctxAction('delete')" style="color: var(--primary-red);">Hapus</div>
    </div>

    <audio id="audio-player"></audio>

    <!-- Listen Together Overlay (Moved to Body End) -->
    <div id="listen-together-overlay" style="position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:999999; display:none;">
        <button class="lt-close" onclick="window.closeListenTogether()"><i class="ph ph-x"></i></button>
        
        <div class="lt-container">
            <div class="lt-header">
                <h2> Dengar Bareng</h2>
                <p>Nikmati musik bersama teman secara real-time</p>
            </div>

            <!-- Mode Selection -->
            <div id="lt-mode-section">
                <div class="lt-mode-selector">
                    <button class="lt-mode-btn" onclick="window.selectLTMode('host')">
                        <i class="ph ph-broadcast" style="font-size:32px; display:block; margin-bottom:10px;"></i>
                        Buat Session
                    </button>
                    <button class="lt-mode-btn" onclick="window.selectLTMode('join')">
                        <i class="ph ph-sign-in" style="font-size:32px; display:block; margin-bottom:10px;"></i>
                        Gabung Session
                    </button>
                </div>
            </div>

            <!-- Host Section -->
            <div id="lt-host-section" style="display:none;">
                <div class="lt-session-code">
                    <p style="color:#aaa; font-size:12px;">Kode Session Anda:</p>
                    <div class="lt-code-display" id="lt-session-code">----</div>
                    <p style="color:#aaa; font-size:12px;">Bagikan kode ini ke teman</p>
                </div>
                <button class="lt-btn" onclick="window.copySessionCode()">
                    <i class="ph ph-copy"></i> Salin Kode
                </button>
                
                <div class="lt-participants" id="lt-participants-list">
                    <p style="color:#666; text-align:center; font-size:13px;">Menunggu teman bergabung...</p>
                </div>
                
                <button class="lt-btn" style="background:#444; margin-top:15px;" onclick="window.endListenTogether()">
                    Akhiri Session
                </button>
            </div>

            <!-- Join Section -->
            <div id="lt-join-section" style="display:none;">
                <input type="text" class="lt-input" id="lt-join-code" placeholder="XXXX" maxlength="4">
                <button class="lt-btn" onclick="window.joinListenTogether()">
                    <i class="ph ph-arrow-right"></i> Gabung
                </button>
                <p style="color:#aaa; font-size:12px; text-align:center; margin-top:15px;">
                    Masukkan kode 4 digit dari host
                </p>
            </div>
        </div>
    </div>

    <!-- Active Session Badge -->
    <div class="session-badge" id="session-badge" style="z-index:999998;">
        <div class="session-badge-icon"></div>
        <span id="session-badge-text">Dengar Bareng Aktif</span>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";




        const firebaseConfig = {
            apiKey: "AIzaSyCEamepceiYZtcqlcRnRmFHe0smkGfu_A4",
            authDomain: "gochat-35172.firebaseapp.com",
            databaseURL: "https://gochat-35172-default-rtdb.asia-southeast1.firebasedatabase.app",
            id: "gochat-35172",
            storageBucket: "gochat-35172.firebasestorage.app",
            messagingSenderId: "206571646434",
            appId: "1:206571646434:web:c337d95ea3a6a121499dbb",
            measurementId: "G-XZ2K3PZ6ZK"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const db = getDatabase(app);
        // ===== SUPABASE CONFIGURATION =====
const SUPABASE_URL = 'https://qkruoywwqdpkdjlajbpl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrcnVveXd3cWRwa2RqbGFqYnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDY3OTcsImV4cCI6MjA4NTAyMjc5N30.6NQGI-d13SVih3VKOuSEvLYTeP5tf9QhEUyfi6mBEiA';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log(' Supabase initialized');

        // --- BASE SONGS (Original 1-20) ---
        const baseSongs = [
            { id: 1, title: "Sedia Aku Sebelum Ujan", artist: "Idgitaf", album: "Single", duration: "4:03", cover: "https://picsum.photos/seed/idgitaf/300/300", src: "songs/2.mp3" },
            { id: 2, title: "All Too Well (10 Minute Version)", artist: "Taylor Swift", album: "Red (Taylor's Version)", duration: "10:13", cover: "https://picsum.photos/seed/taylor/300/300", src: "songs/3.mp3" },
            { id: 3, title: "Di Sarankan Di Bandung", artist: "Dongker, Jason Ranti", album: "Single", duration: "3:45", cover: "https://picsum.photos/seed/dongker/300/300", src: "songs/1.mp3" },
            { id: 4, title: "Jatuh Suka", artist: "Tulus", album: "Manusia", duration: "3:50", cover: "https://picsum.photos/seed/tulus/300/300", src: "songs/10.mp3" },
            { id: 5, title: "I Love You, I'm Sorry", artist: "Gracie Abrams", album: "The Secret of Us", duration: "3:08", cover: "https://picsum.photos/seed/gracie/300/300", src: "songs/6.mp3" },
            { id: 6, title: "Die On This Hill", artist: "Sienna Spiro", album: "Single", duration: "3:12", cover: "https://picsum.photos/seed/sienna/300/300", src: "songs/4.mp3" },
            { id: 7, title: "33x", artist: "Perunggu", album: "Single", duration: "4:00", cover: "https://picsum.photos/seed/perunggu1/300/300", src: "songs/5.mp3" },
            { id: 8, title: "Gemilang", artist: "Perunggu", album: "Single", duration: "3:30", cover: "https://picsum.photos/seed/perunggu2/300/300", src: "songs/9.mp3" },
            { id: 9, title: "My Love", artist: "Westlife", album: "Coast to Coast", duration: "3:52", cover: "https://picsum.photos/seed/westlife/300/300", src: "songs/8.mp3" },
            { id: 10, title: "The Winner Takes It All", artist: "Abba", album: "Super Trouper", duration: "4:54", cover: "https://picsum.photos/seed/abba/300/300", src: "songs/7.mp3" },
            { id: 11, title: "Kengkuz Music", artist: "Biggy Do", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/biggydo/300/300", src: "songs/11.mp3" },
            { id: 12, title: "Man I Need", artist: "Olivia Dean", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/oliviadean/300/300", src: "songs/15.mp3" },
            { id: 13, title: "Berubah", artist: "Tenxi", album: "Single", duration: "3:21", cover: "https://picsum.photos/seed/tenxi/300/300", src: "songs/19.mp3" },
            { id: 14, title: "Mawar Merah", artist: "Slank", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/slank/300/300", src: "songs/16.mp3" },
            { id: 15, title: "Danza Kuduro", artist: "Don Omar", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/donomar/300/300", src: "songs/13.mp3" },
            { id: 16, title: "Raindance", artist: "Dave", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/dave/300/300", src: "songs/12.mp3" },
            { id: 17, title: "Mimosa 2000", artist: "Kobr", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/kobr/300/300", src: "songs/14.mp3" },
            { id: 18, title: "Snooze", artist: "SZA", album: "SOS", duration: "3:00", cover: "https://picsum.photos/seed/sza/300/300", src: "songs/17.mp3" },
            { id: 19, title: "Me & U", artist: "Tems", album: "For Broken Ears", duration: "3:00", cover: "https://picsum.photos/seed/tems/300/300", src: "songs/18.mp3" },
            { id: 20, title: "Jangan Calling", artist: "Ova Libeno", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/ovalibeno/300/300", src: "songs/20.mp3" }
        ];

        // --- MAIN LIST (ID 30-256) ---
        let mainListId = 30;

        function createMainListSong(title, artist, album, duration, cover) {
            const song = {
                id: mainListId,
                title: title,
                artist: artist,
                album: album,
                duration: duration || "3:30",
                cover: cover,
                src: `songs/${mainListId}.mp3`
            };
            mainListId++;
            return song;
        }

        const mainBandSongs = [];

        // 1. PERUNGGU
        const perungguRaw = [
            { title: "Kalibata 2012", src: "2012.mp3" },
            { title: "33x", src: "5.mp3" },
            { title: "Tapi", src: "tapi.mp3" },
            { title: "Ini Abadi", src: "abadi.mp3" },
            { title: "Berhasil", src: "berhasil.mp3" },
            { title: "Pastikan Riuh Akhiri Malammu", src: "riuh.mp3" },
            { title: "Ikhtiar", src: "baik.mp3" },
            { title: "Tarung Bebas", src: "tarung.mp3" },
            { title: "Menyala", src: "Menyala.mp3" }
        ];
        perungguRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 30 + i,
                title: item.title,
                artist: "Perunggu",
                album: "Single",
                duration: "3:45",
                cover: "album photo/perunggu.jpg",
                src: `songs/${item.src}`
            });
        });

        // 2. NOAH
        const noahRaw = [
            { title: "Separuh Aku", src: "separuh.mp3" },
            { title: "Yang Terdalam", src: "yang.mp3" },
            { title: "Tak Bisakah", src: "tak.mp3" },
            { title: "Menghapus Jejakmu", src: "jejak.mp3" },
            { title: "Semua Tentang Kita", src: "kita.mp3" },
            { title: "Mungkin Nanti", src: "nanti.mp3" },
            { title: "Ada Apa Denganmu", src: "apa.mp3" },
            { title: "Bintang di Surga", src: "bintang.mp3" },
            { title: "Walau Habis Terang", src: "terang.mp3" },
            { title: "Hidup Untukmu, Mati Tanpamu", src: "hidup.mp3" }
        ];
        noahRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 42 + i,
                title: item.title,
                artist: "NOAH / Peterpan",
                album: "Best of",
                duration: "4:10",
                cover: "album photo/noah.jpg",
                src: `songs/${item.src}`
            });
        });

        // 3. DEWA 19
        const dewaRaw = [
            { title: "Kangen", src: "kangen.mp3" },
            { title: "Separuh Nafas", src: "nafas.mp3" },
            { title: "Risalah Hati", src: "hati.mp3" },
            { title: "Pupus", src: "pupus.mp3" },
            { title: "Cinta Kan Membawamu Kembali", src: "kembali.mp3" },
            { title: "Aku Milikmu (Malam Ini)", src: "mu.mp3" },
            { title: "Roman Picisan", src: "roman.mp3" },
            { title: "Dewi", src: "dewi.mp3" },
            { title: "Arjuna", src: "arjuna.mp3" },
            { title: "Kamulah Satu-Satunya", src: "satu.mp3" },
            { title: "Cukup Siti Nurbaya", src: "cukup.mp3" },
            { title: "Takkan Ada Cinta Yang Lain", src: "takkan.mp3" },
            { title: "Mistikus Cinta", src: "mistikus.mp3" }
        ];
        dewaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 57 + i,
                title: item.title,
                artist: "Dewa 19",
                album: "Legends",
                duration: "4:20",
                cover: "album photo/dewa19.png",
                src: `songs/${item.src}`
            });
        });

        // 4. SHEILA ON 7
        const sheilaRaw = [
            { title: "Dan", src: "dan.mp3" },
            { title: "Sephia", src: "sephia.mp3" },
            { title: "Anugerah Terindah Yang Pernah Kumiliki", src: "anugrah.mp3" },
            { title: "Kita", src: "kita.mp3" },
            { title: "Sahabat Sejati", src: "sahabat.mp3" },
            { title: "Seberapa Pantas", src: "seberapa.mp3" },
            { title: "Betapa", src: "betapa.mp3" },
            { title: "J.A.P", src: "jap.mp3" },
            { title: "Hari Bersamanya", src: "hari.mp3" },
            { title: "Bila Kau Tak di Sampingku", src: "bila.mp3" },
            { title: "Pemuja Rahasia", src: "pemuja.mp3" }
        ];
        sheilaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 72 + i,
                title: item.title,
                artist: "Sheila On 7",
                album: "Classic",
                duration: "3:50",
                cover: "album photo/so7.jpg",
                src: `songs/${item.src}`
            });
        });

        // 5. KAHITNA
        const kahitnaRaw = [
            { title: "Cantik", src: "kahitna.mp3" },
            { title: "Cerita Cinta", src: "cerita.mp3" },
            { title: "Titik Nadir", src: "titik.mp3" },
            { title: "Soulmate", src: "soulmate.mp3" },
            { title: "Mantan Terindah", src: "mantan.mp3" },
            { title: "Seribu Bulan", src: "seribu.mp3" },
            { title: "Aku, Dirimu, Dirinya", src: "dirimu.mp3" },
            { title: "Engga Ngerti", src: "engga.mp3" },
            { title: "Untukku", src: "untukku.mp3" },
            { title: "Sampai Nanti", src: "sampai.mp3" },
            { title: "Rahasia Cinta", src: "rahasia.mp3" }
        ];
        kahitnaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 87 + i,
                title: item.title,
                artist: "Kahitna",
                album: "Romance",
                duration: "4:05",
                cover: "album photo/kahitna.jpeg",
                src: `songs/${item.src}`
            });
        });

        // 6. HINDIA
        const hindiaRaw = [
            { title: "Secukupnya", src: "secukupnya.mp3" },
            { title: "Evaluasi", src: "evaluasi.mp3" },
            { title: "Rumah Ke Rumah", src: "rumah.mp3" },
            { title: "Besok Mungkin Kita Sampai", src: "besok.mp3" },
            { title: "Dehidrasi", src: "dehidrrasi.mp3" },
            { title: "Membasuh", src: "membasuh.mp3" },
            { title: "Apapun Yang Terjadi", src: "apapun.mp3" },
            { title: "Untuk Apa / Untuk Apa?", src: "untukapa.mp3" },
            { title: "Jam Makan Siang", src: "jam.mp3" },
            { title: "Mata Air", src: "mata.mp3" },
            { title: "Cincin", src: "cincin.mp3" }
        ];
        hindiaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 100 + i,
                title: item.title,
                artist: "Hindia",
                album: "Menari Dengan Bayangan",
                duration: "4:30",
                cover: "album photo/hindia.jpg",
                src: `songs/${item.src}`
            });
        });

        // 7. ASTRID
        const astridRaw = [
            { title: "Mendua", src: "mendua.mp3" },
            { title: "Tentang Rasa", src: "rasa.mp3" },
            { title: "Jadikan Aku Yang Kedua", src: "jadikan.mp3" },
            { title: "Aku Bisa Apa", src: "aku.mp3" },
            { title: "Tak Ingin Dicintai", src: "tak.mp3" }
        ];
        astridRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 112 + i,
                title: item.title,
                artist: "Astrid",
                album: "Single",
                duration: "3:55",
                cover: "album photo/astrid.webp",
                src: `astrid/${item.src}`
            });
        });

        // 8. AFGAN
        const afganRaw = [
            { title: "Terima Kasih Cinta", src: "terimakasih.mp3" },
            { title: "Sadis", src: "sadis.mp3" },
            { title: "Bukan Cinta Biasa", src: "bukancinta.mp3" },
            { title: "Jodoh Pasti Bertemu", src: "jodoh.mp3" },
            { title: "Cinta Tanpa Syarat", src: "cinta.mp3" },
            { title: "Kamu Yang Kutunggu", src: "kamu.mp3" },
            { title: "Bawalah Cintaku", src: "bawalah.mp3" },
            { title: "Kacamata", src: "kacamata.mp3" }
        ];
        afganRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 122 + i,
                title: item.title,
                artist: "Afgan",
                album: "Single",
                duration: "4:00",
                cover: "album photo/afgan.png",
                src: `afgan/${item.src}`
            });
        });

        // 9. TULUS
        const tulusRaw = [
            { title: "Sepatu", src: "sepatu.mp3" },
            { title: "Monokrom", src: "monokrom.mp3" },
            { title: "Teman Hidup", src: "temanhidup.mp3" },
            { title: "Pamit", src: "pamit.mp3" },
            { title: "1000 Tahun Lamanya", src: "1000.mp3" },
            { title: "Diri", src: "diri.mp3" },
            { title: "Hati-Hati di Jalan", src: "hati-hati.mp3" },
            { title: "Interaksi", src: "interaksi.mp3" },
            { title: "Jatuh Suka", src: "jatuh.mp3" },
            { title: "Tujuh Belas", src: "tujuh.mp3" }
        ];
        tulusRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 132 + i,
                title: item.title,
                artist: "Tulus",
                album: "Single",
                duration: "3:50",
                cover: "album photo/tulus.jpg",
                src: `tulus/${item.src}`
            });
        });

        // 10. MAHALINI
        const mahaliniRaw = [
            { title: "Melawan Restu", src: "melawan.mp3" },
            { title: "Sial", src: "sial.mp3" },
            { title: "Kisah Sempurna", src: "kisah.mp3" },
            { title: "Sisa Rasa", src: "sisa.mp3" },
            { title: "Mati-matian", src: "mati.mp3" },
            { title: "Bawa Dia Kembali", src: "bawa.mp3" },
            { title: "Sampai Menutup Mata", src: "sampai.mp3" },
            { title: "Mencintaimu", src: "mencintaimu.mp3" }
        ];
        mahaliniRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 142 + i,
                title: item.title,
                artist: "Mahalini",
                album: "Single",
                duration: "4:15",
                cover: "album photo/mahalini.jpg",
                src: `mahalini/${item.src}`
            });
        });

        // 11. TENXI
        const tenxiRaw = [
            { title: "mejikuhibiniu", src: "mejikuhibiniu.mp3" },
            { title: "Kasih Aba Aba", src: "kasihaba.mp3" },
            { title: "Bintang 5", src: "bintang5.mp3" },
            { title: "Garam & Madu (Sakit Daduku)", src: "garam.mp3" },
            { title: "Berubah", src: "berubah.mp3" }
        ];
        tenxiRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 152 + i,
                title: item.title,
                artist: "Tenxi",
                album: "Single",
                duration: "3:21",
                cover: "album photo/tenxi.jpg",
                src: `tenxi/${item.src}`
            });
        });

        // 12. TAYLOR SWIFT
        const taylorRaw = [
            { title: "Love Story", src: "love.mp3" },
            { title: "You Belong With Me", src: "you.mp3" },
            { title: "Blank Space", src: "blank.mp3" },
            { title: "Shake It Off", src: "shake.mp3" },
            { title: "Bad Blood", src: "bad.mp3" },
            { title: "Style", src: "style.mp3" },
            { title: "Look What You Made Me Do", src: "look.mp3" },
            { title: "Delicate", src: "delicate.mp3" },
            { title: "Anti-Hero", src: "antihero.mp3" },
            { title: "Cruel Summer", src: "cruel.mp3" }
        ];
        taylorRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 157 + i,
                title: item.title,
                artist: "Taylor Swift",
                album: "Studio Albums",
                duration: "3:45",
                cover: "album photo/taylor.jpg",
                src: `taylorswift/${item.src}`
            });
        });

        // 13. JUSTIN BIEBER
        const justinRaw = [
            { title: "Baby", src: "baby.mp3" },
            { title: "One Time", src: "one.mp3" },
            { title: "Sorry", src: "sorry.mp3" },
            { title: "Love Yourself", src: "love.mp3" },
            { title: "What Do You Mean?", src: "wdym.mp3" },
            { title: "Boyfriend", src: "boy.mp3" },
            { title: "Peaches", src: "peaches.mp3" },
            { title: "Stay", src: "stay.mp3" },
            { title: "Yummy", src: "yummy.mp3" },
            { title: "Never Say Never", src: "never.mp3" }
        ];
        justinRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 167 + i,
                title: item.title,
                artist: "Justin Bieber",
                album: "Studio Albums",
                duration: "3:30",
                cover: "album photo/justin.jpg",
                src: `justinbieber/${item.src}`
            });
        });

        // 14. ED SHEERAN
        const edRaw = [
            { title: "Shape of You", src: "shape.mp3" },
            { title: "Perfect", src: "perfect.mp3" },
            { title: "Thinking Out Loud", src: "think.mp3" },
            { title: "Photograph", src: "photograph.mp3" },
            { title: "Castle on the Hill", src: "castle.mp3" },
            { title: "Bad Habits", src: "bad.mp3" },
            { title: "Galway Girl", src: "galway.mp3" },
            { title: "Shivers", src: "shivers.mp3" },
            { title: "The A Team", src: "the.mp3" },
            { title: "Happier", src: "happier.mp3" }
        ];
        edRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 177 + i,
                title: item.title,
                artist: "Ed Sheeran",
                album: "Studio Albums",
                duration: "4:00",
                cover: "album photo/ed.jpg",
                src: `edsheeran/${item.src}`
            });
        });

        // 15. BRUNO MARS
        const brunoRaw = [
            { title: "Just the Way You Are", src: "just.mp3" },
            { title: "Grenade", src: "grenade.mp3" },
            { title: "Talking to the Moon", src: "talking.mp3" },
            { title: "Locked Out of Heaven", src: "locked.mp3" },
            { title: "When I Was Your Man", src: "when.mp3" },
            { title: "Thats what I like", src: "thats.mp3" },
            { title: "Die With A Smile", src: "die.mp3" },
            { title: "It Will Rain", src: "it.mp3" },
            { title: "Versace on the Floor", src: "versace.mp3" },
            { title: "Leave the Door Open", src: "leave.mp3" }
        ];
        brunoRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 187 + i,
                title: item.title,
                artist: "Bruno Mars",
                album: "Studio Albums",
                duration: "3:50",
                cover: "album photo/bruno.jpg",
                src: `brunomars/${item.src}`
            });
        });

        // 16. DANIEL CAESAR
        const danielRaw = [
            { title: "Best Part", src: "best.mp3" },
            { title: "Get You", src: "get.mp3" },
            { title: "Japanese Denim", src: "japanese.mp3" },
            { title: "Cyanide", src: "cyanide.mp3" },
            { title: "Love Again", src: "love.mp3" },
            { title: "Streetcar", src: "streetcar.mp3" },
            { title: "Who Hurt You?", src: "who.mp3" },
            { title: "Who Knows", src: "whoknows.mp3" },
            { title: "Blessed", src: "blessed.mp3" },
            { title: "Always", src: "always.mp3" } 
        ];
        danielRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 197 + i,
                title: item.title,
                artist: "Daniel Caesar",
                album: "Studio Albums",
                duration: "3:40",
                cover: "album photo/daniel.jpg",
                src: `danielcaesar/${item.src}`
            });
        });

        // 17. COLDPLAY
        const coldplayRaw = [
            { title: "Yellow", src: "yellow.mp3" },
            { title: "Fix You", src: "fix.mp3" },
            { title: "Viva La Vida", src: "viva.mp3" },
            { title: "The Scientist", src: "the.mp3" },
            { title: "Paradise", src: "paradise.mp3" },
            { title: "Clocks", src: "clocks.mp3" },
            { title: "A Sky Full of Stars", src: "a.mp3" },
            { title: "Hymn for the Weekend", src: "hymn.mp3" },
            { title: "Sparks", src: "sparks.mp3" },
            { title: "Adventure of a Lifetime", src: "adventure.mp3" }
        ];
        coldplayRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 207 + i,
                title: item.title,
                artist: "Coldplay",
                album: "Studio Albums",
                duration: "4:10",
                cover: "album photo/coldplay.jpg",
                src: `coldplay/${item.src}`
            });
        });

        // 18. ONE DIRECTION
        const onedirectionRaw = [
            { title: "What Makes You Beautiful", src: "what.mp3" },
            { title: "Story of My Life", src: "story.mp3" },
            { title: "One Thing", src: "one.mp3" },
            { title: "Night Changes", src: "night.mp3" },
            { title: "Best Song Ever", src: "best.mp3" },
            { title: "Kiss You", src: "kiss.mp3" },
            { title: "Drag Me Down", src: "drag.mp3" },
            { title: "Steal My Girl", src: "steal.mp3" },
            { title: "Little Things", src: "little.mp3" },
            { title: "Live While Were Young", src: "live.mp3" }
        ];
        onedirectionRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 217 + i,
                title: item.title,
                artist: "One Direction",
                album: "Studio Albums",
                duration: "3:20",
                cover: "album photo/onedirection.jpg",
                src: `onedirection/${item.src}`
            });
        });

        // 19. GREEN DAY
        const greendayRaw = [
            { title: "American Idiot", src: "american.mp3" },
            { title: "Boulevard of Broken Dreams", src: "boulevard.mp3" },
            { title: "Wake Me Up When September Ends", src: "wake.mp3" },
            { title: "Holiday", src: "holiday.mp3" },
            { title: "21 Guns", src: "21.mp3" },
            { title: "Basket Case", src: "basket.mp3" },
            { title: "Good Riddance (Time of Your Life)", src: "good.mp3" },
            { title: "When I Come Around", src: "when.mp3" },
            { title: "Know Your Enemy", src: "know.mp3" },
            { title: "Jesus of Suburbia", src: "jesus.mp3" }
        ];
        greendayRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 227 + i,
                title: item.title,
                artist: "Green Day",
                album: "Studio Albums",
                duration: "3:00",
                cover: "album photo/greenday.jpg",
                src: `greenday/${item.src}`
            });
        });

        // 20. OASIS
        const oasisRaw = [
            { title: "Wonderwall", src: "wonderwall.mp3" },
            { title: "Dont Look Back in Anger", src: "dont.mp3" },
            { title: "Champagne Supernova", src: "champagne.mp3" },
            { title: "Live Forever", src: "live.mp3" },
            { title: "Stop Crying Your Heart Out", src: "stop.mp3" },
            { title: "Supersonic", src: "super.mp3" },
            { title: "Stand by Me", src: "stand.mp3" },
            { title: "Whatever", src: "whatever.mp3" },
            { title: "Don't Go Away", src: "dontgo.mp3" },
            { title: "All Around The World", src: "all.mp3" }
        ];
        oasisRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 237 + i,
                title: item.title,
                artist: "Oasis",
                album: "Studio Albums",
                duration: "4:15",
                cover: "album photo/oasis.jpg",
                src: `oasis/${item.src}`
            });
        });

        // 21. RADIOHEAD
        const radioheadRaw = [
            { title: "Creep", src: "creep.mp3" },
            { title: "No Surprises", src: "no.mp3" },
            { title: "Karma Police", src: "karma.mp3" },
            { title: "High and Dry", src: "high.mp3" },
            { title: "Fake Plastic Trees", src: "fake.mp3" },
            { title: "Paranoid Android", src: "paranoid.mp3" },
            { title: "Exit Music (For a Film)", src: "exit.mp3" },
            { title: "Lotus Flower", src: "lotus.mp3" },
            { title: "Street Spirit (Fade Out)", src: "street.mp3" },
            { title: "Let Down", src: "let.mp3" }
        ];
        radioheadRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 247 + i,
                title: item.title,
                artist: "Radiohead",
                album: "Studio Albums",
                duration: "4:20",
                cover: "album photo/radiohead.jpg",
                src: `radiohead/${item.src}`
            });
        });


        // --- HANUNG & RARA LOGIC (PRESERVED) ---
        let hanungId = 300;
        const hanungRawData = [
            { title: "Sedia Aku Sebelum Hujan", artist: "Idgitaf", src: "songs/2.mp3" },
            { title: "Titik Nadir", artist: "Kahitna", src: "songs/titik nadir.mp3" },
            { title: "Disarankan Di Bandung", artist: "Dongker, Jason Ranti", src: "songs/1.mp3" },
            { title: "Firasat", artist: "Marcell", src: "songs/Firasat.mp3" },
            { title: "33 Kali", artist: "Perunggu", src: "songs/5.mp3" },
            { title: "Kota Ini Tak Sama Tanpamu", artist: "Nadhif Basalamah", src: "songs/kotanadhif.mp3" }
        ];
        const hanungSongs = [];
        hanungRawData.forEach((item, index) => {
            hanungSongs.push({
                id: hanungId++,
                title: item.title,
                artist: item.artist,
                album: "Single",
                duration: "3:30",
                cover: `https://picsum.photos/seed/hanung${index + 100}/300/300`,
                src: item.src
            });
        });

        let raraId = 306;
        const raraRawData = [
            { title: "Its You", artist: "Ali Gatie", src: "songs/itsyou.mp3" },
            { title: "P.S. I Love You", artist: "Paul Partohap", src: "songs/psiloveyou.mp3" },
            { title: "Cant Take My Eyes Off You", artist: "Frankie Valli", src: "songs/myeyes.mp3" },
            { title: "Youre Still The One", artist: "Shania Twain", src: "songs/theone.mp3" },
            { title: "Soulmate", artist: "Kahitna", src: "songs/soulmate.mp3" }
        ];
        const raraSongs = [];
        raraRawData.forEach((item, index) => {
            raraSongs.push({
                id: raraId++,
                title: item.title,
                artist: item.artist,
                album: "Single",
                duration: "3:30",
                cover: `https://picsum.photos/seed/rara${index + 200}/300/300`,
                src: item.src
            });
        });


        const songs = [...baseSongs, ...mainBandSongs, ...hanungSongs, ...raraSongs];

        // --- GLOBAL STATE ---
        let likedSongs = [];
        let currentSongIndex = 0;
        let isPlaying = false;
        let currentUserData = null;
        let currentPlaylistId = null;
        let searchTimeout; 
        let allPublicPlaylists = []; // Store all public playlists for search
        
        // --- QUEUE & HISTORY SYSTEM ---
        let songQueue = [];
        let playHistory = [];
        let isShuffle = false;
        let repeatMode = 0; // 0: Off, 1: All, 2: One
        
        // --- HISTORY / RECENTLY PLAYED ---
        let recentlyPlayed = []; // Stores {type: 'song'|'playlist', data: object, timestamp}
        
        // --- MASTER SEARCH INDEX FOR BANDS & ARTISTS ---
        const searchIndexArtists = [
            // Original Albums
            { name: "Ghani's Album", img: "album photo/ghani.jpg", fn: "window.openGhaniAlbum()" },
            { name: "Revan's Album", img: "album photo/revan.jpg", fn: "window.openRevanAlbum()" },
            { name: "Hanung's Album", img: "album photo/pras.jpg", fn: "window.openHanungAlbum()" },
            { name: "Rara's Album", img: "album photo/rara.jpg", fn: "window.openRaraAlbum()" },
            // Bands & Artists
            { name: "Perunggu", img: "album photo/perunggu.jpg", fn: "window.openPerungguAlbum()" },
            { name: "NOAH / Peterpan", img: "album photo/noah.jpg", fn: "window.openNoahAlbum()" },
            { name: "Dewa 19", img: "album photo/dewa19.png", fn: "window.openDewaAlbum()" },
            { name: "Sheila On 7", img: "album photo/so7.jpg", fn: "window.openSheilaAlbum()" },
            { name: "Kahitna", img: "album photo/kahitna.jpeg", fn: "window.openKahitnaAlbum()" },
            { name: "Hindia", img: "album photo/hindia.jpg", fn: "window.openHindiaAlbum()" },
            { name: "Astrid", img: "album photo/astrid.webp", fn: "window.openAstridAlbum()" },
            { name: "Afgan", img: "album photo/afgan.png", fn: "window.openAfganAlbum()" },
            { name: "Tulus", img: "album photo/tulus.jpg", fn: "window.openTulusAlbum()" },
            { name: "Mahalini", img: "album photo/mahalini.jpg", fn: "window.openMahaliniAlbum()" },
            { name: "Tenxi", img: "album photo/tenxi.jpg", fn: "window.openTenxiAlbum()" },
            { name: "Taylor Swift", img: "album photo/taylor.jpg", fn: "window.openTaylorAlbum()" },
            { name: "Justin Bieber", img: "album photo/justin.jpg", fn: "window.openJustinAlbum()" },
            { name: "Ed Sheeran", img: "album photo/ed.jpg", fn: "window.openEdAlbum()" },
            { name: "Bruno Mars", img: "album photo/bruno.jpg", fn: "window.openBrunoAlbum()" },
            { name: "Daniel Caesar", img: "album photo/daniel.jpg", fn: "window.openDanielAlbum()" },
            { name: "Coldplay", img: "album photo/coldplay.jpg", fn: "window.openColdplayAlbum()" },
            { name: "One Direction", img: "album photo/onedirection.jpg", fn: "window.openOnedirectionAlbum()" },
            { name: "Green Day", img: "album photo/greenday.jpg", fn: "window.openGreendayAlbum()" },
            { name: "Oasis", img: "album photo/oasis.jpg", fn: "window.openOasisAlbum()" },
            { name: "Radiohead", img: "album photo/radiohead.jpg", fn: "window.openRadioheadAlbum()" }
        ];

        const audio = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const playerArt = document.getElementById('player-art');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const likeBtn = document.getElementById('like-btn');

        // --- CHAT & FRIENDS STATE ---
        let activeChatFriendUid = null;
        let activeChatFriendData = null;
        let activeChatId = null;
        let replyingToMsgId = null;

        // --- HELPER: EXTRACT DOMINANT COLOR ---
        window.applyCardColor = function(img) {
            try {
                // Ensure image is loaded
                if (!img.complete || img.naturalWidth === 0) return;
                
                const rgb = getAverageRGB(img);
                const card = img.closest('.song-card');
                
                if (card) {
                    // Create a subtle gradient from the dominant color to the card background
                    // Use low opacity (0.15) to keep it subtle and text readable
                    const colorStart = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`;
                    const colorEnd = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`;
                    
                    // Apply gradient background
                    card.style.background = `linear-gradient(180deg, ${colorStart} 0%, var(--bg-card) 100%)`;
                    
                    // Optional: Add a subtle border or glow
                    card.style.border = `1px solid rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                    
                    // Ensure transition for smooth effect
                    card.style.transition = 'background 0.5s ease, border 0.5s ease';
                }
            } catch(e) {
                console.log("Color extraction skipped", e);
            }
        };

        function getAverageRGB(imgEl) {
            var blockSize = 5, defaultRGB = {r:0,g:0,b:0}, canvas = document.createElement('canvas'), context = canvas.getContext && canvas.getContext('2d'), data, width, height, i = -4, length, rgb = {r:0,g:0,b:0}, count = 0;
            if (!context) return defaultRGB;
            height = canvas.height = imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
            width = canvas.width = imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;
            context.drawImage(imgEl, 0, 0);
            try { data = context.getImageData(0, 0, width, height); } catch(e) { return defaultRGB; }
            length = data.data.length;
            while ( (i += blockSize * 4) < length ) { ++count; rgb.r += data.data[i]; rgb.g += data.data[i+1]; rgb.b += data.data[i+2]; }
            rgb.r = ~~(rgb.r/count); rgb.g = ~~(rgb.g/count); rgb.b = ~~(rgb.b/count);
            return rgb;
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode(mode) {
            if(mode === 'signup') {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'block';
            } else {
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            }
        }

       async function handleSignup() {
    const name = document.getElementById('signup-name').value.trim();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const errorMsg = document.getElementById('signup-error');

    if (!name || !email || !password) {
        errorMsg.innerText = "Mohon lengkapi semua kolom.";
        errorMsg.style.display = 'block';
        return;
    }

    try {
        // Generate User ID: Name_1234 (GANTI # dengan _)
        const cleanName = name.replace(/\s+/g, '');
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        const userId = `${cleanName}_${randomNum}`; //  UBAH DARI # ke _

        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log("User created in Auth:", user.uid);
        
        // Store Username Index for Search
        await set(ref(db, 'usernames/' + userId), user.uid);
        console.log("Username index saved");
        
        // Store User Data
        await set(ref(db, 'users/' + user.uid), {
            username: name,
            userId: userId,
            userIdSuffix: randomNum,
            email: email,
            bio: "Musisi sejati.",
            profile_picture: "https://picsum.photos/seed/" + name + "/200/200",
            likedCover: "https://picsum.photos/seed/liked/300/300",
            playlists: {}
        });
        
        console.log("User data saved to /users/" + user.uid);
        alert(" Akun berhasil dibuat! Silakan login.");
        
        toggleAuthMode('login');
        
    } catch (error) {
        console.error("Signup error:", error);
        errorMsg.innerText = "Error: " + error.message;
        errorMsg.style.display = 'block';
    }
}

  


        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {})
                .catch((error) => {
                    errorMsg.innerText = "Email atau password salah.";
                    errorMsg.style.display = 'block';
                });
        }

        function handleLogout() { signOut(auth); }

        // Export to Window for HTML onclick
        window.toggleAuthMode = toggleAuthMode;
        window.handleSignup = handleSignup;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;

        function loadPublicPlaylists() {
            // Fetch all users to find public playlists
            get(ref(db, 'users')).then(snapshot => {
                const users = snapshot.val() || {};
                allPublicPlaylists = []; // Reset global var
                
                Object.values(users).forEach(user => {
                    if (user.playlists) {
                        Object.keys(user.playlists).forEach(plId => {
                            const pl = user.playlists[plId];
                            if (pl.isPublic) {
                                allPublicPlaylists.push({
                                    id: plId,
                                    ...pl,
                                    ownerName: user.username,
                                    ownerId: user.userId
                                });
                            }
                        });
                    }
                });
                console.log("Public playlists loaded:", allPublicPlaylists.length);
            });
        }

       onAuthStateChanged(auth, (user) => {
    const loadingScreen = document.getElementById('loading-screen');
    const authView = document.getElementById('auth-view');
    const appWrapper = document.getElementById('app-wrapper');

    if (user) {
        loadingScreen.style.display = 'flex';
        authView.style.display = 'none';
        appWrapper.style.display = 'none';

        // Load Public Playlists for Search
        loadPublicPlaylists();

        const userRef = ref(db, 'users/' + user.uid);
        onValue(userRef, async (snapshot) => {
            const data = snapshot.val(); //  Ambil data dari snapshot
            if (data) {
                currentUserData = data;
                        document.getElementById('header-username').innerText = data.username;
                        document.getElementById('header-avatar').src = data.profile_picture || "https://picsum.photos/50/50";
                        
                        renderSidebarPlaylists(data.playlists || {});
                        renderTrending(); // Update Trending Section
                        setupFriendListeners(); // Start friend listeners
                        
                        const savedLiked = localStorage.getItem('likedSongs');
                        if(savedLiked) {
                            likedSongs = JSON.parse(savedLiked);
                        }

const savedHistory = localStorage.getItem('recentlyPlayed');
                        if(savedHistory) {
                            recentlyPlayed = JSON.parse(savedHistory);
                        }
                        
                        //  LOAD SONGS FROM SUPABASE
                        await loadSongsFromSupabase();
                        
                        //  LOAD USER'S IMPORTED SONGS
                        await loadImportedSongs();
                        
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            appWrapper.style.display = 'flex';
                            switchView('home');
                        }, 500);
                    }
                });
            } else {
                currentUserData = null;
                loadingScreen.style.display = 'none';
                authView.style.display = 'flex';
                appWrapper.style.display = 'none';
            }
        });

        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        window.toggleSidebar = toggleSidebar;

        function renderSidebarPlaylists(playlists) {
            const container = document.getElementById('sidebar-playlists-container');
            let html = '';
            const playlistArray = Object.keys(playlists).map(key => ({
                id: key,
                ...playlists[key]
            }));
            
            if(playlistArray.length === 0) {
                container.innerHTML = '<div style="padding: 10px 12px; color: #666; font-size: 13px;">Belum ada playlist.</div>';
                return;
            }

            playlistArray.forEach(pl => {
                const isPublic = pl.isPublic || false;
                const privacyIcon = isPublic ? '<i class="ph ph-globe" style="color:#1db954" title="Publik"></i>' : '<i class="ph ph-lock-key" style="color:#b3b3b3" title="Privat"></i>';
                
                html += `
                    <div class="playlist-item" onclick="window.openPlaylist('${pl.id}')">
                        <img src="${pl.cover}" class="playlist-thumb" alt="${pl.name}">
                        <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${pl.name}</span>
                        <button class="btn-icon-small" onclick="event.stopPropagation(); window.togglePlaylistPrivacy('${pl.id}')" style="font-size:16px; padding:5px;">${privacyIcon}</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.add('open');
            document.getElementById('new-playlist-name').value = '';
        }

        function submitCreatePlaylist() {
            const name = document.getElementById('new-playlist-name').value;
            if(!name) {
                alert("Nama playlist tidak boleh kosong!");
                return;
            }
            
            const userId = auth.currentUser.uid;
            const newPlaylistRef = push(ref(db, 'users/' + userId + '/playlists'));
            const playlistId = newPlaylistRef.key;

            const seed = name.replace(/\s/g, '') + Math.floor(Math.random() * 1000);
            const defaultCover = `https://picsum.photos/seed/${seed}/300/300`;

            set(newPlaylistRef, {
                name: name,
                cover: defaultCover,
                songs: {},
                isPublic: false // Default Private
            });

            closeModal('create-playlist-modal');
        }

        window.openCreatePlaylistModal = openCreatePlaylistModal;
        window.submitCreatePlaylist = submitCreatePlaylist;

        // --- FRIENDSHIP & CHAT LOGIC ---
        
        function setupFriendListeners() {
            if(!auth.currentUser) return;
            const myUid = auth.currentUser.uid;

            // Listen Friend Requests
            onValue(ref(db, `users/${myUid}/friendRequests`), (snap) => {
                const reqs = snap.val() || {};
                const container = document.getElementById('friend-requests-container');
                let html = '';
                Object.keys(reqs).forEach(senderUid => {
                    const r = reqs[senderUid];
                    html += `
                        <div class="friend-list-item">
                            <img src="${r.senderPic}" class="friend-avatar-small">
                            <span class="friend-name">${r.senderName}</span>
                            <div class="request-actions">
                                <button class="btn-icon-small btn-accept" onclick="window.respondFriendRequest('${senderUid}', true)"><i class="ph-fill ph-check"></i></button>
                                <button class="btn-icon-small btn-reject" onclick="window.respondFriendRequest('${senderUid}', false)"><i class="ph-fill ph-x"></i></button>
                            </div>
                        </div>
                    `;
                });
                if(!html) html = '<div style="padding:10px; color:#666; font-size:12px;">Tidak ada permintaan baru.</div>';
                container.innerHTML = html;
            });

            // Listen Friends
            onValue(ref(db, `users/${myUid}/friends`), (snap) => {
                const friends = snap.val() || {};
                const container = document.getElementById('friend-list-container');
                let html = '';
                Object.keys(friends).forEach(friendUid => {
                    // Placeholder initially, we fetch data below
                    html += `
                        <div class="friend-list-item" onclick="window.openChat('${friendUid}')">
                            <img src="https://picsum.photos/seed/${friendUid}/50/50" id="friend-img-${friendUid}" class="friend-avatar-small">
                            <span class="friend-name" id="friend-name-${friendUid}">Loading...</span>
                        </div>
                    `;
                });
                if(!html) html = '<div style="padding:10px; color:#666; font-size:12px;">Belum ada teman.</div>';
                container.innerHTML = html;
                
                // Fetch friend details to display names and pics immediately
                Object.keys(friends).forEach(friendUid => {
                   get(ref(db, `users/${friendUid}`)).then(uSnap => {
                       const u = uSnap.val();
                       if(u) {
                           const nameEl = document.getElementById(`friend-name-${friendUid}`);
                           const imgEl = document.getElementById(`friend-img-${friendUid}`);
                           if(nameEl) nameEl.innerText = u.username;
                           if(imgEl) imgEl.src = u.profile_picture;
                       }
                   });
                });
            });
        }

       // GANTI KODE SEARCH INI DENGAN KODE YANG SUDAH DIPERBAIKI DI BAWAH
        document.getElementById('friend-search-input').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            const resContainer = document.getElementById('friend-search-dropdown');
            
            // Clear timeout sebelumnya untuk debouncing
            clearTimeout(searchTimeout);
            
            if(!query) {
                resContainer.style.display = 'none';
                resContainer.innerHTML = '';
                return;
            }

            // Tampilkan loading state
            resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">Mencari...</div>';
            resContainer.style.display = 'block';

            // Debouncing: tunggu 500ms setelah user berhenti mengetik
            searchTimeout = setTimeout(() => {
                performFriendSearch(query, resContainer);
            }, 500);
        });

        // Update selectFriendResult untuk menampilkan info lebih jelas
        function selectFriendResult(uid, username, pic) {
            document.getElementById('friend-search-dropdown').style.display = 'none';
            document.getElementById('friend-search-input').value = '';
            
            // Tampilkan konfirmasi atau info (opsional)
            // Bisa langsung kirim request atau tampilkan profil
            console.log(`Selected: ${username} (${uid})`);
        }

        // Update sendFriendRequest dengan error handling
        async function sendFriendRequest(targetUid) {
            try {
                const myUid = auth.currentUser.uid;
                const myData = currentUserData;
                
                // Check if already friends
                const friendSnap = await get(ref(db, `users/${myUid}/friends/${targetUid}`));
                if(friendSnap.exists()) { 
                    showToast("Sudah berteman dengan pengguna ini.", "error"); 
                    return; 
                }
                
                // Check if request already sent
                const reqSnap = await get(ref(db, `users/${targetUid}/friendRequests/${myUid}`));
                if(reqSnap.exists()) { 
                    showToast("Permintaan sudah terkirim sebelumnya.", "error"); 
                    return; 
                }

                // Send Request
                await set(ref(db, `users/${targetUid}/friendRequests/${myUid}`), {
                    senderName: myData.username,
                    senderPic: myData.profile_picture,
                    timestamp: Date.now()
                });
                
                // Record sent request
                await set(ref(db, `users/${myUid}/sentRequests/${targetUid}`), true);
                
                showToast(" Permintaan pertemanan berhasil dikirim!");
                
                // Clear search
                document.getElementById('friend-search-dropdown').style.display = 'none';
                document.getElementById('friend-search-input').value = '';
                
            } catch (error) {
                console.error('Error sending friend request:', error);
                showToast(" Gagal mengirim permintaan. Coba lagi.", "error");
            }
        }

        async function respondFriendRequest(senderUid, accept) {
    const myUid = auth.currentUser.uid;
    if(accept) {
        //  GUNAKAN set() UNTUK NILAI BOOLEAN
        await set(ref(db, `users/${myUid}/friends/${senderUid}`), true);
        await set(ref(db, `users/${senderUid}/friends/${myUid}`), true);
        showToast("Teman ditambahkan!", "success");
    } else {
        showToast("Permintaan ditolak.", "error");
    }
    // Remove request
    await remove(ref(db, `users/${myUid}/friendRequests/${senderUid}`));
}

        window.selectFriendResult = selectFriendResult;
        window.sendFriendRequest = sendFriendRequest;
        window.respondFriendRequest = respondFriendRequest;

        async function performFriendSearch(query, resContainer) {
            try {
                // Fetch semua username index
                const snapshot = await get(ref(db, 'usernames'));
                const users = snapshot.val() || {};
                
                if(!users || Object.keys(users).length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">Tidak ada pengguna ditemukan.</div>';
                    return;
                }

                // Filter user yang cocok dengan query
                const matchedUserIds = Object.keys(users).filter(userIdKey => 
                    userIdKey.toLowerCase().includes(query)
                );

                if(matchedUserIds.length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">Tidak ditemukan.</div>';
                    return;
                }

                // Fetch detail semua matched users secara parallel
                const userDetailsPromises = matchedUserIds.map(async (userIdKey) => {
                    const uid = users[userIdKey];
                    
                    // Skip jika ini adalah user sendiri
                    if(uid === auth.currentUser.uid) return null;
                    
                    const uSnap = await get(ref(db, `users/${uid}`));
                    const userData = uSnap.val();
                    
                    if(!userData) return null;
                    
                    return {
                        uid: uid,
                        username: userData.username,
                        userId: userData.userId,
                        profile_picture: userData.profile_picture
                    };
                });

                const userDetails = (await Promise.all(userDetailsPromises)).filter(u => u !== null);

                // Render hasil
                if(userDetails.length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">Tidak ada hasil.</div>';
                    return;
                }

                let html = '';
                userDetails.forEach(u => {
                    html += `
                        <div class="friend-dropdown-item" onclick="window.selectFriendResult('${u.uid}', '${escapeHtml(u.username)}', '${u.profile_picture}')">
                            <img src="${u.profile_picture}" style="width:24px;height:24px;border-radius:50%;">
                            <div>
                                <div style="font-size:12px; font-weight:600; color:white;">${escapeHtml(u.username)}</div>
                                <div style="font-size:10px; color:#aaa;">${u.userId}</div>
                            </div>
                            <button class="btn-icon-small" style="margin-left:auto;" onclick="event.stopPropagation(); window.sendFriendRequest('${u.uid}')">
                                <i class="ph ph-user-plus"></i>
                            </button>
                        </div>
                    `;
                });
                
                resContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error searching friends:', error);
                resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#ff4444;">Error saat mencari.</div>';
            }
        }

        // Helper function untuk escape HTML (prevent XSS)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // --- CHAT SYSTEM ---

        function getChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        function openChat(friendUid) {
            activeChatFriendUid = friendUid;
            activeChatId = getChatId(auth.currentUser.uid, friendUid);
            
            document.getElementById('chat-overlay').classList.add('active');
            
            // Get Friend Data
            get(ref(db, `users/${friendUid}`)).then(snap => {
                const u = snap.val();
                activeChatFriendData = u;
                document.getElementById('chat-friend-name-display').innerText = u.username;
                document.getElementById('chat-friend-avatar-display').src = u.profile_picture;
            });

            renderMessages();
        }

        function closeChat() {
            document.getElementById('chat-overlay').classList.remove('active');
            activeChatFriendUid = null;
            activeChatId = null;
            // Detach listener if needed (onValue handles multiple detach usually, but good practice to clean up references if logic grows)
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input-box');
            const text = input.value.trim();
            if(!text || !activeChatId) return;

            const msg = {
                sender: auth.currentUser.uid,
                text: text,
                timestamp: Date.now(),
                replyTo: replyingToMsgId || null
            };

            push(ref(db, `chats/${activeChatId}/messages`), msg);
            input.value = '';
            replyingToMsgId = null;
        }

        function renderMessages() {
            const chatBody = document.getElementById('chat-body');
            chatBody.innerHTML = '';

            onValue(ref(db, 'chats/' + activeChatId + '/messages'), (snap) => {
                const msgs = snap.val() || {};
                chatBody.innerHTML = '';
                
                Object.keys(msgs).sort((a,b) => msgs[a].timestamp - msgs[b].timestamp).forEach(key => {
                    const m = msgs[key];
                    const isMe = m.sender === auth.currentUser.uid;
                    
                    let replyHtml = '';
                    if(m.replyTo) {
                        const origMsg = msgs[m.replyTo] || { text: 'Pesan dihapus' };
                        replyHtml = '<div class="msg-reply-indicator">Balas: ' + origMsg.text.substring(0, 30) + '...</div>';
                    }

                    // Check if shared content
                    let contentHtml = '<div>' + m.text + '</div>';
                    if(m.shareType) {
                        let cardHtml = '';
                        if(m.shareType === 'song') {
                            const s = m.shareContent;
                            cardHtml = `
                                <div class="chat-shared-card" onclick="window.playSpecificSong(${s.id}); window.closeChat();">
                                    <img src="${s.cover}" class="chat-shared-img" alt="Cover">
                                    <div class="chat-shared-info">
                                        <div class="chat-shared-title">${s.title}</div>
                                        <div class="chat-shared-sub">${s.artist}</div>
                                    </div>
                                </div>
                            `;
                        } else if (m.shareType === 'playlist') {
                            const pl = m.shareContent;
                            cardHtml = `
                                <div class="chat-shared-card" onclick="window.openFriendPlaylist('${pl.id}'); window.closeChat();">
                                    <img src="${pl.cover}" class="chat-shared-img" alt="Playlist Cover">
                                    <div class="chat-shared-info">
                                        <div class="chat-shared-title">${pl.name}</div>
                                        <div class="chat-shared-sub">Playlist</div>
                                    </div>
                                </div>
                            `;
                        }
                        contentHtml = cardHtml;
                    }

                    const el = document.createElement('div');
                    el.className = 'msg-bubble ' + (isMe ? 'msg-sent' : 'msg-received');
                    el.dataset.msgId = key;
                    el.innerHTML = replyHtml + contentHtml + '<div class="msg-time">' + new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</div>';
                    
                    // Swipe & Context Logic
                    addInteractions(el, key, m, isMe);
                    
                    chatBody.appendChild(el);
                });
                
                // Scroll to bottom
                chatBody.scrollTop = chatBody.scrollHeight;
            });
        }

        function addInteractions(el, msgId, msgData, isMe) {
            // Context Menu
            el.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, msgId);
            });

            // Swipe Logic (Touch)
            let touchStartX = 0;
            el.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
            }, {passive: true});

            el.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - touchStartX;
                
                // Threshold for swipe (50px)
                if (Math.abs(diff) > 50) {
                    if (isMe && diff < 0) {
                        // Swipe Left (My msg) -> Reply
                        triggerReply(msgId);
                    } else if (!isMe && diff > 0) {
                        // Swipe Right (Friend msg) -> Reply
                        triggerReply(msgId);
                    }
                }
            }, {passive: true});
        }

        function showContextMenu(x, y, msgId) {
            const menu = document.getElementById('context-menu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'flex';
            
            // Store current context target
            window.currentContextMsgId = msgId;
            
            // Close on click elsewhere
            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function ctxAction(action) {
            const msgId = window.currentContextMsgId;
            if(!msgId) return;
            
            if(action === 'copy') {
                // Mock copy
                alert("Pesan disalin!");
            } else if (action === 'reply') {
                triggerReply(msgId);
            } else if (action === 'delete') {
                // In real app, verify ownership, then delete from DB
                remove(ref(db, `chats/${activeChatId}/messages/${msgId}`));
            }
            document.getElementById('context-menu').style.display = 'none';
        }

        function triggerReply(msgId) {
            replyingToMsgId = msgId;
            const input = document.getElementById('chat-input-box');
            input.placeholder = "Membalas pesan...";
            input.focus();
        }

        window.openChat = openChat;
        window.closeChat = closeChat;
        window.sendChatMessage = sendChatMessage;
        window.ctxAction = ctxAction;

        // --- SHARE FEATURE ---
        
        function openShareModal(type, contentId) {
            if(!auth.currentUser) return;
            
            const modal = document.getElementById('share-modal');
            const list = document.getElementById('share-friend-list');
            const loading = document.getElementById('share-loading');
            
            modal.classList.add('open');
            list.innerHTML = '';
            loading.style.display = 'block';

            // Get Friend List
            get(ref(db, `users/${auth.currentUser.uid}/friends`)).then(snap => {
                loading.style.display = 'none';
                const friends = snap.val() || {};
                if(!Object.keys(friends).length) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:#888">Anda belum punya teman.</div>';
                    return;
                }

                let html = '';
                Object.keys(friends).forEach(friendUid => {
                    // Fetch names
                    get(ref(db, `users/${friendUid}`)).then(uSnap => {
                        const u = uSnap.val();
                        html += `
                            <div class="playlist-select-item" onclick="window.executeShare('${type}', '${contentId}', '${friendUid}')">
                                <img src="${u.profile_picture}" style="width:40px;height:40px;border-radius:50%;">
                                <div>${u.username}</div>
                            </div>
                        `;
                        list.innerHTML = html;
                    });
                });
            });

            // Save share intent temporarily
            window.pendingShare = { type, id: contentId };
        }

        function executeShare(type, id, targetUid) {
            const myUid = auth.currentUser.uid;
            const chatId = getChatId(myUid, targetUid);
            let msgPayload = {
                sender: myUid,
                text: "Membagikan konten",
                timestamp: Date.now()
            };

            if(type === 'song') {
                const song = songs.find(s => s.id == id);
                msgPayload.shareType = 'song';
                msgPayload.shareContent = song;
            } else if (type === 'playlist') {
                let playlist = null;
                // 1. Try finding in my playlists
                if (currentUserData && currentUserData.playlists && currentUserData.playlists[id]) {
                    playlist = currentUserData.playlists[id];
                } 
                // 2. Try finding in public playlists
                else if (allPublicPlaylists) {
                    playlist = allPublicPlaylists.find(pl => pl.id === id);
                }

                if (!playlist) {
                    alert("Gagal membagikan playlist: Data playlist tidak ditemukan.");
                    return;
                }

                msgPayload.shareType = 'playlist';
                msgPayload.shareContent = { id: id, name: playlist.name, cover: playlist.cover };
            }

            push(ref(db, `chats/${chatId}/messages`), msgPayload);
            closeModal('share-modal');
            alert("Berhasil dibagikan!");
        }

        window.openShareModal = openShareModal;
        window.executeShare = executeShare;

        // --- FRIEND PROFILE & PLAYLIST VIEW ---

        let viewingFriendUid = null;

        function openFriendProfileFromChat() {
            if(!activeChatFriendUid) return;
            viewingFriendUid = activeChatFriendUid;
            loadFriendProfileData();
        }

        function loadFriendProfileData() {
            const uid = viewingFriendUid;
            const overlay = document.getElementById('friend-profile-overlay');
            overlay.classList.add('active');

            get(ref(db, `users/${uid}`)).then(snap => {
                const u = snap.val();
                if(!u) return;

                document.getElementById('friend-profile-avatar-display').src = u.profile_picture;
                document.getElementById('friend-profile-name-display').innerText = u.username;
                document.getElementById('friend-profile-userid-text').innerText = u.userId || "User#0000";
                document.getElementById('friend-profile-bio-display').innerText = u.bio || '';

                const avatar = document.getElementById('friend-profile-avatar-display');
                avatar.onload = function() {
                    const rgb = getAverageRGB(avatar);
                    const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                    document.getElementById('friend-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
                }

                renderFriendPlaylists(u.playlists || {});
            });
        }

        function renderFriendPlaylists(playlists) {
            const container = document.getElementById('friend-public-playlists');
            let html = '';
            
            Object.keys(playlists).forEach(key => {
                const pl = playlists[key];
                // Only show public playlists
                if(pl.isPublic) {
                    html += `
                        <div class="song-card" onclick="window.openFriendPlaylist('${key}')">
                            <div class="card-img-wrapper">
                                <img src="${pl.cover}">
                                <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                            </div>
                            <div class="card-title">${pl.name}</div>
                            <div class="card-desc">Playlist Publik</div>
                        </div>
                    `;
                }
            });

            if(!html) html = '<div style="padding:0 32px; color:#666;">Teman ini tidak memiliki playlist publik.</div>';
            container.innerHTML = html;
        }

      function openFriendPlaylist(playlistId) {
    if(!viewingFriendUid) return;
    
    get(ref(db, 'users/' + viewingFriendUid + '/playlists/' + playlistId)).then(snap => {
        const pl = snap.val();
        if(!pl) return;
        
        currentPlaylistId = playlistId;
        
        document.getElementById('playlist-title-view').innerText = pl.name;
        document.getElementById('playlist-cover-view').src = pl.cover;
        
        //  PERBAIKAN: Cek apakah elemen ada
        const friendName = document.getElementById('friend-profile-name-display');
        const ownerDisplay = document.getElementById('playlist-owner-display');
        if(friendName && ownerDisplay) {
            ownerDisplay.innerText = friendName.innerText;
        }
        
  
        
        const coverEl = document.getElementById('playlist-cover-view');
        coverEl.onload = function() {
            const rgb = getAverageRGB(coverEl);
            const color = 'rgb(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ')';
            document.getElementById('playlist-header-bg').style.background = 'linear-gradient(180deg, ' + color + ' 0%, var(--bg-dark) 100%)';
        };

        const plSongs = Object.values(pl.songs || {});
        const songDetails = plSongs
            .filter(sIdOrObj => sIdOrObj)
            .map(songIdOrObj => {
                const idToFind = (typeof songIdOrObj === 'object') ? songIdOrObj.id : songIdOrObj;
                return songs.find(s => s.id == idToFind);
            })
            .filter(s => s);

        document.getElementById('playlist-count').innerText = songDetails.length + ' lagu';
        renderSongList(songDetails, 'playlist-songs-container');
        
        const shareBtn = document.querySelector('#view-playlist .playlist-actions .share-btn');
        if(shareBtn) shareBtn.style.display = 'none';

        window.closeFriendProfile();
        window.switchView('playlist');
    });
}

        window.openFriendProfileFromChat = openFriendProfileFromChat;
        window.closeFriendProfile = () => document.getElementById('friend-profile-overlay').classList.remove('active');
        window.openFriendPlaylist = openFriendPlaylist;

        // --- COPY USER ID FUNCTIONS ---
        function copyUserId() {
            if(currentUserData && currentUserData.userId) {
                navigator.clipboard.writeText(currentUserData.userId).then(() => {
                    const el = document.getElementById('profile-userid-text');
                    const originalText = el.innerText;
                    el.innerText = "Disalin!";
                    setTimeout(() => el.innerText = originalText, 1500);
                });
            }
        }

        function copyFriendUserId() {
            const idText = document.getElementById('friend-profile-userid-text').innerText;
            navigator.clipboard.writeText(idText).then(() => {
                alert(`ID Teman (${idText}) disalin!`);
            });
        }

        window.copyUserId = copyUserId;
        window.copyFriendUserId = copyFriendUserId;

        // --- PLAYLIST PRIVACY & COVER ---
        
        function togglePlaylistPrivacy(playlistId) {
            const playlists = currentUserData.playlists || {};
            const pl = playlists[playlistId];
            if(!pl) return;
            
            const newState = !pl.isPublic; // Toggle
            update(ref(db, `users/${auth.currentUser.uid}/playlists/${playlistId}`), { isPublic: newState });
        }

        function handleLikedCoverUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const url = e.target.result;
                    document.getElementById('liked-cover-view').src = url;
                    update(ref(db, 'users/' + auth.currentUser.uid), { likedCover: url });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.togglePlaylistPrivacy = togglePlaylistPrivacy;
        window.handleLikedCoverUpload = handleLikedCoverUpload;

        // --- GENERAL UI ---
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        window.closeModal = closeModal;

        function switchView(viewName) {
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.add('active');
                document.querySelector('.main-content').scrollTop = 0;
                
                if (viewName === 'profile') {
                    window.loadProfileData();
                }
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${viewName}`);
            if (activeNav) activeNav.classList.add('active');

            if(viewName === 'liked') {
                openLikedView();
            }
            
            if(viewName === 'search') {
                document.getElementById('search-input').value = '';
                handleSearch(''); // Reset to history view
            }
        }

        window.switchView = switchView;

        // --- RECENTLY PLAYED LOGIC ---
        function addToRecentlyPlayed(type, data) {
            // Remove duplicates of same ID
            recentlyPlayed = recentlyPlayed.filter(item => !(item.type === type && item.data.id === data.id));
            // Add new to front
            recentlyPlayed.unshift({ type, data, timestamp: Date.now() });
            // Limit to 20 items
            if(recentlyPlayed.length > 20) recentlyPlayed = recentlyPlayed.slice(0, 20);
            // Save to local storage
            localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
        }

        function handleSearch(query) {
    const resultsWrapper = document.getElementById('search-results-wrapper');
    const historyWrapper = document.getElementById('search-history-wrapper');
    const bandsContainer = document.getElementById('search-bands-container');
    const songsContainer = document.getElementById('search-songs-container');
    const playlistsContainer = document.getElementById('search-playlists-container');
    const playlistsTitle = document.getElementById('search-playlists-title');

    if (query.trim().length < 1) {
        resultsWrapper.style.display = 'none';
        bandsContainer.innerHTML = '';
        songsContainer.innerHTML = '';
        playlistsContainer.innerHTML = '';
        playlistsTitle.style.display = 'none';
        historyWrapper.style.display = 'block';
        renderRecentlyPlayedList();
        return;
    }

    const q = query.toLowerCase();
    historyWrapper.style.display = 'none';
    resultsWrapper.style.display = 'block';

    // 1. Search Bands/Artists
    const matchedBands = searchIndexArtists.filter(b => b.name.toLowerCase().includes(q));
    let bandsHTML = "";
    if (matchedBands.length > 0) {
        bandsHTML = matchedBands.map(b => `
            <div class="song-card" onclick="${b.fn}">
                <div class="card-img-wrapper">
                    <img src="${b.img}" alt="${b.name}">
                    <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                </div>
                <div class="card-title">${b.name}</div>
                <div class="card-desc">Penyanyi / Band</div>
            </div>
        `).join('');
    }
    bandsContainer.innerHTML = bandsHTML;

    // 2. Search Public Playlists
    const matchedPlaylists = allPublicPlaylists.filter(pl => pl.name.toLowerCase().includes(q));
    let playlistsHTML = "";
    if (matchedPlaylists.length > 0) {
        playlistsTitle.style.display = 'block';
        playlistsHTML = matchedPlaylists.map(pl => `
            <div class="song-card" onclick="window.openPlaylist('${pl.id}')">
                <div class="card-img-wrapper">
                    <img src="${pl.cover}" alt="${pl.name}">
                    <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                </div>
                <div class="card-title">${pl.name}</div>
                <div class="card-desc">Oleh ${pl.ownerName || 'User'}</div>
            </div>
        `).join('');
    } else {
        playlistsTitle.style.display = 'none';
    }
    playlistsContainer.innerHTML = playlistsHTML;

    // 3. Search ALL Songs (with Privacy Check)
    const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
    
    const matchedSongs = songs.filter(s => {
        // A. Match Query (Title, Artist, Album)
        const matchQuery = s.title.toLowerCase().includes(q) || 
                           s.artist.toLowerCase().includes(q) ||
                           s.album.toLowerCase().includes(q);
        
        if (!matchQuery) return false;

        // B. Privacy Check
        // If it's an imported song (check if it has 'uploadedBy' field)
        if (s.uploadedBy) {
            // Visible if: Public OR Owned by current user
            const isPublic = s.isPublic === true;
            const isMine = currentUserId && s.uploadedBy === currentUserId;
            return isPublic || isMine;
        }

        // Default static songs are always visible
        return true;
    });

    if (matchedSongs.length > 0) {
        // Create Header and Container for Songs
        const songsHeader = document.createElement('h3');
        songsHeader.innerText = 'Lagu';
        songsHeader.style.color = 'white';
        songsHeader.style.fontSize = '18px';
        songsHeader.style.marginBottom = '10px';
        songsHeader.style.marginTop = '20px';
        
        songsContainer.innerHTML = '';
        songsContainer.appendChild(songsHeader);
        
        const listDiv = document.createElement('div');
        listDiv.id = 'search-songs-list-inner';
        songsContainer.appendChild(listDiv);
        
        renderSongListCustom(matchedSongs, 'search-songs-list-inner', false);
    } else {
        songsContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Tidak ada lagu ditemukan</div>';
    }
}
        window.handleSearch = handleSearch;

       function renderRecentlyPlayedList() {
    const container = document.getElementById('search-history-container');            
    const title = document.getElementById('search-history-title');
    if (recentlyPlayed.length === 0) {
        container.innerHTML = '';
        title.style.display = 'none';
        return;
    }
    title.style.display = 'block';

    let html = '';
    recentlyPlayed.forEach((item, i) => {
        if (item.type === 'song') {
            const s = item.data;
            html += `
                <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
                    <div class="song-index">
                        <span class="index-num">${i + 1}</span>
                        <div class="playing-icon-container" style="display:none;">
                            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                        </div>
                    </div>
                    <div class="song-info">
                        <img src="${s.cover}" alt="art">
                        <div>
                            <div class="song-title-text">${s.title}</div>
                            <div class="song-artist">${s.artist}</div>
                        </div>
                    </div>
                    <div class="song-album">${s.album}</div>
                    <div class="song-duration">${s.duration}</div>
                    <div class="song-actions">
                        <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                            <i class="ph ${likedSongs.includes(s.id) ? 'ph-fill' : 'ph'} ph-heart"></i>
                        </button>
                        <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                            <i class="ph ph-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (item.type === 'playlist') {
            const pl = item.data;
            // PLAYLIST SEKARANG DITAMPILKAN SEPERTI LAGU (SONG-ROW FORMAT)
            html += `
                <div class="song-row" onclick="window.openPlaylist('${pl.id}')">
                    <div class="song-index">
                        <span class="index-num">${i + 1}</span>
                    </div>
                    <div class="song-info">
                        <img src="${pl.cover}" alt="playlist cover">
                        <div>
                            <div class="song-title-text">${pl.name}</div>
                            <div class="song-artist">Playlist</div>
                        </div>
                    </div>
                    <div class="song-album">-</div>
                    <div class="song-duration">-</div>
                    <div class="song-actions">
                        <button class="share-btn" onclick="event.stopPropagation(); window.openShareModal('playlist', '${pl.id}')" style="color:#b3b3b3;">
                            <i class="ph ph-share-network"></i>
                        </button>
                    </div>
                </div>
            `;
        }
    });
    container.innerHTML = html;
}

        // --- HELPER: RENDER CUSTOM SONG LIST ---
        function renderSongListCustom(data, containerId, isHistoryMode) {
            const container = document.getElementById(containerId);
            if(!data || data.length === 0) {
                if(containerId) container.innerHTML = '<div style="padding:20px; color:#666;">Tidak ada lagu.</div>';
                return;
            }

            container.innerHTML = data.map((s, i) => {
                let actionButtonsHTML = '';

                if (isHistoryMode) {
                    // History Mode
                    actionButtonsHTML = `
                        <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                            <i class="ph ${likedSongs.includes(s.id) ? 'ph-fill' : 'ph'} ph-heart"></i>
                        </button>
                        <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                            <i class="ph ph-plus"></i>
                        </button>
                    `;
                } else {
                    // Normal Mode (Includes Queue & Share)
                    actionButtonsHTML = `
                        <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                            <i class="ph ${likedSongs.includes(s.id) ? 'ph-fill' : 'ph'} ph-heart"></i>
                        </button>
                        <!-- FITUR BAGIKAN LAGU -->
                        <button class="share-btn" onclick="event.stopPropagation(); window.openShareModal('song', ${s.id})">
                            <i class="ph ph-share-network"></i>
                        </button>
                        <!-- TOMBOL ANTRIAN (QUEUE) -->
                        <button class="queue-add-btn" onclick="event.stopPropagation(); window.addToQueue(${s.id})" title="Masukkan Antrian">
                            <i class="ph ph-list-plus"></i>
                        </button>
                        <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                            <i class="ph ph-plus"></i>
                        </button>
                    `;
                }

                return `
                <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
                    <div class="song-index">
                        <span class="index-num">${i + 1}</span>
                        <!-- ANIMATED VISUALIZER -->
                        <div class="playing-icon-container" style="display:none;">
                             <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>

                        </div>
                    </div>
                    <div class="song-info">
                        <img src="${s.cover}" alt="art">
                        <div>
                            <!-- CLICK TITLE TO OPEN OVERLAY -->
                            <div class="song-title-text" onclick="event.stopPropagation(); window.playSpecificSong(${s.id}); window.openOverlayPlayer();">${s.title}</div>
                            <div class="song-artist">${s.artist}</div>
                        </div>
                    </div>
                    <div class="song-album">${s.album}</div>
                    <div class="song-duration">${s.duration}</div>
                    <div class="song-actions">
                        ${actionButtonsHTML}
                    </div>
                </div>
            `}).join('');
        }

        
        function renderSongList(data, containerId) {
    const container = document.getElementById(containerId);
    if(!data || data.length === 0) {
        if(containerId) container.innerHTML = '<div style="padding:20px; color:#666;">Tidak ada lagu.</div>';
        return;
    }

    container.innerHTML = data.map((s, i) => {
        return `
        <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
            <div class="song-index">
                <span class="index-num">${i + 1}</span>
                <div class="playing-icon-container" style="display:none;">
                     <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="song-info">
                <img src="${s.cover}" alt="art">
                <div>
                    <div class="song-title-text">${s.title}</div>
                    <div class="song-artist">${s.artist}</div>
                </div>
            </div>
            <div class="song-album">${s.album}</div>
            <div class="song-duration">${s.duration}</div>
            <div class="song-actions">
                <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                    <i class="ph ${likedSongs.includes(s.id) ? 'ph-fill' : 'ph'} ph-heart"></i>
                </button>
                <!-- TOMBOL BAGIKAN -->
                <button class="share-btn" onclick="event.stopPropagation(); window.openShareModal('song', ${s.id})">
                    <i class="ph ph-share-network"></i>
                </button>
                <!-- TOMBOL ANTRIAN (QUEUE) -->
                <button class="queue-add-btn" onclick="event.stopPropagation(); window.addToQueue(${s.id})" title="Masukkan Antrian">
                    <i class="ph ph-list-plus"></i>
                </button>
                <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                    <i class="ph ph-plus"></i>
                </button>
            </div>
        </div>
    `}).join('');
}

        // --- RENDERERS ---

       function renderSidebarPlaylistsUpdated(playlists) {
    const container = document.getElementById('sidebar-playlists-container');
    let html = '';
    const playlistArray = Object.keys(playlists).map(key => ({
        id: key,
        ...playlists[key]
    }));
    
    if(playlistArray.length === 0) {
        container.innerHTML = '<div style="padding: 10px 12px; color: #666; font-size: 13px;">Belum ada playlist.</div>';
        return;
    }

    playlistArray.forEach(pl => {
        const isPublic = pl.isPublic || false;
        const privacyIcon = isPublic ? '<i class="ph ph-globe" title="Publik"></i>' : '<i class="ph ph-lock-key" title="Privat"></i>';
        const privacyClass = isPublic ? 'color:#1db954' : 'color:#b3b3b3';

        html += `
            <div class="playlist-item" onclick="window.openPlaylist('${pl.id}')">
                <img src="${pl.cover}" class="playlist-thumb" alt="${pl.name}">
                <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${pl.name}</span>
                <div style="display:flex; gap:5px; margin-left:auto;">
                    <button class="share-btn" style="font-size:16px;" onclick="event.stopPropagation(); window.openShareModal('playlist', '${pl.id}')" title="Bagikan"><i class="ph ph-share-network"></i></button>
                    <button class="btn-icon-small" style="font-size:16px; ${privacyClass}" onclick="event.stopPropagation(); window.togglePlaylistPrivacy('${pl.id}')" title="Ubah Privasi">${privacyIcon}</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}
        // Override previous render
        window.renderSidebarPlaylists = renderSidebarPlaylistsUpdated;


        function renderTrending() {
            const container = document.getElementById('trending-container');
            if (!currentUserData || !currentUserData.playlists) {
                container.innerHTML = '<div style="padding:20px; color:#888;">Belum ada playlist. Buat playlist baru yuk!</div>';
                return;
            }
            
            // Convert object to array
            const playlists = Object.keys(currentUserData.playlists).map(key => ({
                id: key,
                ...currentUserData.playlists[key]
            }));

            // Take top 4 (simulating "frequently listened")
            const topPlaylists = playlists.slice(0, 4);
            
            if (topPlaylists.length === 0) {
                container.innerHTML = '<div style="padding:20px; color:#888;">Belum ada playlist. Buat playlist baru yuk!</div>';
                return;
            }

            let html = topPlaylists.map(pl => `
                <div class="song-card" onclick="window.openPlaylist('${pl.id}')">
                    <div class="card-img-wrapper">
                        <img src="${pl.cover}" alt="${pl.name}">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${pl.name}</div>
                    <div class="card-desc">Playlist Kamu</div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function renderPopularBands() {
            const bands = [
                { name: "Perunggu", image: "album photo/perunggu.jpg", onclick: "window.openPerungguAlbum()" },
                { name: "NOAH / Peterpan", image: "album photo/noah.jpg", onclick: "window.openNoahAlbum()" },
                { name: "Dewa 19", image: "album photo/dewa19.png", onclick: "window.openDewaAlbum()" },
                { name: "Sheila On 7", image: "album photo/so7.jpg", onclick: "window.openSheilaAlbum()" },
                { name: "Kahitna", image: "album photo/kahitna.jpeg", onclick: "window.openKahitnaAlbum()" },
                { name: "Hindia", image: "album photo/hindia.jpg", onclick: "window.openHindiaAlbum()" }
            ];
            const container = document.getElementById('popular-bands-container');
            let html = bands.map(band => `
                <div class="song-card" onclick="${band.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${band.image}" alt="${band.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${band.name}</div>
                    <div class="card-desc">Band Populer Indonesia</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function renderPopularArtists() {
            const artists = [
                { name: "Astrid", image: "album photo/astrid.webp", onclick: "window.openAstridAlbum()" },
                { name: "Afgan", image: "album photo/afgan.png", onclick: "window.openAfganAlbum()" },
                { name: "Tulus", image: "album photo/tulus.jpg", onclick: "window.openTulusAlbum()" },
                { name: "Mahalini", image: "album photo/mahalini.jpg", onclick: "window.openMahaliniAlbum()" },
                { name: "Tenxi", image: "album photo/tenxi.jpg", onclick: "window.openTenxiAlbum()" }
            ];
            const container = document.getElementById('popular-artists-container');
            let html = artists.map(artist => `
                <div class="song-card" onclick="${artist.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${artist.image}" alt="${artist.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${artist.name}</div>
                    <div class="card-desc">Penyanyi Populer Indonesia</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        // --- NEW RENDERERS: FOREIGN ARTISTS & BANDS ---
        function renderForeignSoloArtists() {
            const artists = [
                { name: "Taylor Swift", image: "album photo/taylor.jpg", onclick: "window.openTaylorAlbum()" },
                { name: "Justin Bieber", image: "album photo/justin.jpg", onclick: "window.openJustinAlbum()" },
                { name: "Ed Sheeran", image: "album photo/ed.jpg", onclick: "window.openEdAlbum()" },
                { name: "Bruno Mars", image: "album photo/bruno.jpg", onclick: "window.openBrunoAlbum()" },
                { name: "Daniel Caesar", image: "album photo/daniel.jpg", onclick: "window.openDanielAlbum()" }
            ];
            const container = document.getElementById('foreign-solo-container');
            let html = artists.map(artist => `
                <div class="song-card" onclick="${artist.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${artist.image}" alt="${artist.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${artist.name}</div>
                    <div class="card-desc">Penyanyi Asing Populer</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function renderForeignBands() {
            const bands = [
                { name: "Coldplay", image: "album photo/coldplay.jpg", onclick: "window.openColdplayAlbum()" },
                { name: "One Direction", image: "album photo/onedirection.jpg", onclick: "window.openOnedirectionAlbum()" },
                { name: "Green Day", image: "album photo/greenday.jpg", onclick: "window.openGreendayAlbum()" },
                { name: "Oasis", image: "album photo/oasis.jpg", onclick: "window.openOasisAlbum()" },
                { name: "Radiohead", image: "album photo/radiohead.jpg", onclick: "window.openRadioheadAlbum()" }
            ];
            const container = document.getElementById('foreign-bands-container');
            let html = bands.map(band => `
                <div class="song-card" onclick="${band.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${band.image}" alt="${band.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${band.name}</div>
                    <div class="card-desc">Band Asing Populer</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        window.playFirstSongOfPlaylist = () => {
             const playlist = currentUserData.playlists[currentPlaylistId];
             const playlistSongs = playlist && Object.values(playlist.songs || {});
             if(playlistSongs && playlistSongs.length > 0) {
                 const firstSong = (typeof playlistSongs[0] === 'object') ? playlistSongs[0].id : playlistSongs[0];
                 window.playSpecificSong(firstSong);
             } else {
                 window.playSpecificSong(songs[0].id);
             }
        };

        // --- ALBUM/ARTIST VIEW LOGIC (DYNAMIC BACKGROUND) ---
        function setupGenericAlbumView(artistName, coverPath, songStartId, songEndId, viewName, titleElemId, coverElemId, bgElemId, countElemId, containerId) {
            const songList = songs.filter(s => s.id >= songStartId && s.id <= songEndId);
            document.getElementById(titleElemId).innerText = artistName;
            const coverEl = document.getElementById(coverElemId);
            coverEl.src = coverPath;
            
            // --- DYNAMIC BACKGROUND EXTRACTOR ---
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById(bgElemId).style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            document.getElementById(countElemId).innerText = `${songList.length} lagu`;
            renderSongList(songList, containerId);
            switchView(viewName);
        }

        function openPlaylist(playlistId) {
            let playlist = null;
            let isOwner = false;

            // 1. Check User's Playlists
            if (currentUserData && currentUserData.playlists && currentUserData.playlists[playlistId]) {
                playlist = currentUserData.playlists[playlistId];
                isOwner = true;
            } 
            // 2. Check Public Playlists
            else if (allPublicPlaylists) {
                playlist = allPublicPlaylists.find(pl => pl.id === playlistId);
            }

            if (!playlist) return;

            currentPlaylistId = playlistId;

            document.getElementById('playlist-title-view').innerText = playlist.name;
            const coverEl = document.getElementById('playlist-cover-view');
            coverEl.src = playlist.cover;
            
            // Set Owner Name
            const ownerDisplay = document.getElementById('playlist-owner-display');
            if(ownerDisplay) {
                ownerDisplay.innerText = isOwner ? currentUserData.username : (playlist.ownerName || 'Unknown User');
            }

            // Hide/Show Edit Controls
            const editCoverBtn = document.querySelector('#view-playlist .edit-cover-btn');
            const settingsBtn = document.querySelector('#view-playlist .settings-btn');
            
            if(editCoverBtn) editCoverBtn.style.display = isOwner ? 'flex' : 'none';
            if(settingsBtn) settingsBtn.style.display = isOwner ? 'block' : 'none';
            
            // --- DYNAMIC BACKGROUND FOR PLAYLIST ---
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('playlist-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            const playlistSongs = Object.values(playlist.songs || {});
            const validSongDetails = playlistSongs
                .filter(songIdOrObj => songIdOrObj !== undefined && songIdOrObj !== null)
                .map(songIdOrObj => {
                    const idToFind = (typeof songIdOrObj === 'object') ? songIdOrObj.id : songIdOrObj;
                    return songs.find(s => s.id == idToFind);
                })
                .filter(song => song !== undefined); 

            document.getElementById('playlist-count').innerText = `${validSongDetails.length} lagu`;
            renderSongList(validSongDetails, 'playlist-songs-container');
            
            // Add to recently played
            addToRecentlyPlayed('playlist', { id: playlistId, name: playlist.name, cover: playlist.cover });
            
            switchView('playlist');
        }
        // <--- TAMBAHKAN BARIS INI DI SINI --- >
           window.openPlaylist = openPlaylist;

        function handlePlaylistCoverUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const url = e.target.result;
                    document.getElementById('playlist-cover-view').src = url;
                    update(ref(db, 'users/' + auth.currentUser.uid + '/playlists/' + currentPlaylistId), { cover: url });
                    setTimeout(() => openPlaylist(currentPlaylistId), 100); 
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Existing Ghani/Revan logic
        function openGhaniAlbum() {
            const ghaniSongs = songs.slice(0, 10); 
            document.getElementById('ghani-title-view').innerText = "Ghani's Album";
            const coverEl = document.getElementById('ghani-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('ghani-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('ghani-count').innerText = `${ghaniSongs.length} lagu`;
            renderSongList(ghaniSongs, 'ghani-songs-container');
            switchView('ghani-album');
        }
        window.openGhaniAlbum = openGhaniAlbum;
        window.playFirstSongOfGhani = () => window.playSpecificSong(1);

        function openRevanAlbum() {
            const revanSongs = songs.slice(10, 20);
            document.getElementById('revan-title-view').innerText = "Revan's Album";
            const coverEl = document.getElementById('revan-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('revan-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('revan-count').innerText = `${revanSongs.length} lagu`;
            renderSongList(revanSongs, 'revan-songs-container');
            switchView('revan-album');
        }
        window.openRevanAlbum = openRevanAlbum;
        window.playFirstSongOfRevan = () => window.playSpecificSong(11);

        // Hanung & Rara
        window.openHanungAlbum = () => {
            const hanungSongs = songs.filter(s => s.id >= 300 && s.id <= 305);
            document.getElementById('hanung-title-view').innerText = "Hanung's Album";
            const coverEl = document.getElementById('hanung-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('hanung-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('hanung-count').innerText = `${hanungSongs.length} lagu`;
            renderSongList(hanungSongs, 'hanung-songs-container');
            switchView('hanung-album');
        };
        window.playFirstSongOfHanung = () => window.playSpecificSong(300);

        window.openRaraAlbum = () => {
            const raraSongs = songs.filter(s => s.id >= 306 && s.id <= 310);
            document.getElementById('rara-title-view').innerText = "Rara's Album";
            const coverEl = document.getElementById('rara-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('rara-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('rara-count').innerText = `${raraSongs.length} lagu`;
            renderSongList(raraSongs, 'rara-songs-container');
            switchView('rara-album');
        };
        window.playFirstSongOfRara = () => window.playSpecificSong(306);

        // Bands Indonesia (Using Generic Helper for consistency)
        window.openPerungguAlbum = () => setupGenericAlbumView("Perunggu", "album photo/perunggu.jpg", 30, 39, "perunggu-album", "perunggu-title-view", "perunggu-cover-view", "perunggu-header-bg", "perunggu-count", "perunggu-songs-container");
        window.playFirstSongOfPerunggu = () => window.playSpecificSong(30);

        window.openNoahAlbum = () => setupGenericAlbumView("NOAH / Peterpan", "album photo/noah.jpg", 42, 51, "noah-album", "noah-title-view", "noah-cover-view", "noah-header-bg", "noah-count", "noah-songs-container");
        window.playFirstSongOfNoah = () => window.playSpecificSong(42);

        window.openDewaAlbum = () => setupGenericAlbumView("Dewa 19", "album photo/dewa19.png", 57, 68, "dewa-album", "dewa-title-view", "dewa-cover-view", "dewa-header-bg", "dewa-count", "dewa-songs-container");
        window.playFirstSongOfDewa = () => window.playSpecificSong(57);

        window.openSheilaAlbum = () => setupGenericAlbumView("Sheila On 7", "album photo/so7.jpg", 72, 83, "sheila-album", "sheila-title-view", "sheila-cover-view", "sheila-header-bg", "sheila-count", "sheila-songs-container");
        window.playFirstSongOfSheila = () => window.playSpecificSong(72);

        window.openKahitnaAlbum = () => setupGenericAlbumView("Kahitna", "album photo/kahitna.jpeg", 87, 97, "kahitna-album", "kahitna-title-view", "kahitna-cover-view", "kahitna-header-bg", "kahitna-count", "kahitna-songs-container");
        window.playFirstSongOfKahitna = () => window.playSpecificSong(87);

        window.openHindiaAlbum = () => setupGenericAlbumView("Hindia", "album photo/hindia.jpg", 100, 110, "hindia-album", "hindia-title-view", "hindia-cover-view", "hindia-header-bg", "hindia-count", "hindia-songs-container");
        window.playFirstSongOfHindia = () => window.playSpecificSong(100);

        // Artists Indonesia
        window.openAstridAlbum = () => setupGenericAlbumView("Astrid", "album photo/astrid.webp", 112, 116, "astrid-album", "astrid-title-view", "astrid-cover-view", "astrid-header-bg", "astrid-count", "astrid-songs-container");
        window.playFirstSongOfAstrid = () => window.playSpecificSong(112);

        window.openAfganAlbum = () => setupGenericAlbumView("Afgan", "album photo/afgan.png", 122, 129, "afgan-album", "afgan-title-view", "afgan-cover-view", "afgan-header-bg", "afgan-count", "afgan-songs-container");
        window.playFirstSongOfAfgan = () => window.playSpecificSong(122);

        window.openTulusAlbum = () => setupGenericAlbumView("Tulus", "album photo/tulus.jpg", 132, 141, "tulus-album", "tulus-title-view", "tulus-cover-view", "tulus-header-bg", "tulus-count", "tulus-songs-container");
        window.playFirstSongOfTulus = () => window.playSpecificSong(132);

        window.openMahaliniAlbum = () => setupGenericAlbumView("Mahalini", "album photo/mahalini.jpg", 142, 149, "mahalini-album", "mahalini-title-view", "mahalini-cover-view", "mahalini-header-bg", "mahalini-count", "mahalini-songs-container");
        window.playFirstSongOfMahalini = () => window.playSpecificSong(142);

        window.openTenxiAlbum = () => setupGenericAlbumView("Tenxi", "album photo/tenxi.jpg", 152, 156, "tenxi-album", "tenxi-title-view", "tenxi-cover-view", "tenxi-header-bg", "tenxi-count", "tenxi-songs-container");
        window.playFirstSongOfTenxi = () => window.playSpecificSong(152);

        // Foreign Artists & Bands
        window.openTaylorAlbum = () => setupGenericAlbumView("Taylor Swift", "album photo/taylor.jpg", 157, 166, "taylor-album", "taylor-title-view", "taylor-cover-view", "taylor-header-bg", "taylor-count", "taylor-songs-container");
        window.playFirstSongOfTaylor = () => window.playSpecificSong(157);

        window.openJustinAlbum = () => setupGenericAlbumView("Justin Bieber", "album photo/justin.jpg", 167, 176, "justin-album", "justin-title-view", "justin-cover-view", "justin-header-bg", "justin-count", "justin-songs-container");
        window.playFirstSongOfJustin = () => window.playSpecificSong(167);

        window.openEdAlbum = () => setupGenericAlbumView("Ed Sheeran", "album photo/ed.jpg", 177, 186, "ed-album", "ed-title-view", "ed-cover-view", "ed-header-bg", "ed-count", "ed-songs-container");
        window.playFirstSongOfEd = () => window.playSpecificSong(177);

        window.openBrunoAlbum = () => setupGenericAlbumView("Bruno Mars", "album photo/bruno.jpg", 187, 196, "bruno-album", "bruno-title-view", "bruno-cover-view", "bruno-header-bg", "bruno-count", "bruno-songs-container");
        window.playFirstSongOfBruno = () => window.playSpecificSong(187);

        window.openDanielAlbum = () => setupGenericAlbumView("Daniel Caesar", "album photo/daniel.jpg", 197, 206, "daniel-album", "daniel-title-view", "daniel-cover-view", "daniel-header-bg", "daniel-count", "daniel-songs-container");
        window.playFirstSongOfDaniel = () => window.playSpecificSong(197);

        window.openColdplayAlbum = () => setupGenericAlbumView("Coldplay", "album photo/coldplay.jpg", 207, 216, "coldplay-album", "coldplay-title-view", "coldplay-cover-view", "coldplay-header-bg", "coldplay-count", "coldplay-songs-container");
        window.playFirstSongOfColdplay = () => window.playSpecificSong(207);

        window.openOnedirectionAlbum = () => setupGenericAlbumView("One Direction", "album photo/onedirection.jpg", 217, 226, "onedirection-album", "onedirection-title-view", "onedirection-cover-view", "onedirection-header-bg", "onedirection-count", "onedirection-songs-container");
        window.playFirstSongOfOnedirection = () => window.playSpecificSong(217);

        window.openGreendayAlbum = () => setupGenericAlbumView("Green Day", "album photo/greenday.jpg", 227, 236, "greenday-album", "greenday-title-view", "greenday-cover-view", "greenday-header-bg", "greenday-count", "greenday-songs-container");
        window.playFirstSongOfGreenday = () => window.playSpecificSong(227);

        window.openOasisAlbum = () => setupGenericAlbumView("Oasis", "album photo/oasis.jpg", 237, 246, "oasis-album", "oasis-title-view", "oasis-cover-view", "oasis-header-bg", "oasis-count", "oasis-songs-container");
        window.playFirstSongOfOasis = () => window.playSpecificSong(237);

        window.openRadioheadAlbum = () => setupGenericAlbumView("Radiohead", "album photo/radiohead.jpg", 247, 256, "radiohead-album", "radiohead-title-view", "radiohead-cover-view", "radiohead-header-bg", "radiohead-count", "radiohead-songs-container");
        window.playFirstSongOfRadiohead = () => window.playSpecificSong(247);

        // --- LIKED SONGS LOGIC ---
        function openLikedView() {
            const likedSongsList = songs.filter(s => likedSongs.includes(s.id));
            document.getElementById('liked-title-view').innerText = "Disukai";
            const coverEl = document.getElementById('liked-cover-view');
            
            // Use custom liked cover if exists
            let coverUrl = "https://picsum.photos/seed/liked/300/300";
            if(currentUserData && currentUserData.likedCover) {
                coverUrl = currentUserData.likedCover;
            } else if (likedSongsList.length > 0) {
                coverUrl = likedSongsList[0].cover;
            }
            
            coverEl.src = coverUrl;
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('liked-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('liked-count').innerText = `${likedSongsList.length} lagu`;
            renderSongList(likedSongsList, 'liked-songs-container');
        }
        
        window.openLikedView = openLikedView;
        window.playFirstSongOfLiked = () => {
            if(likedSongs.length > 0) {
                window.playSpecificSong(likedSongs[0]);
            } else {
                alert("Belum ada lagu yang disukai.");
            }
        };

        // --- PROFILE VIEW LOGIC ---
        function openProfileView() {
            if(!currentUserData) return;
            
            document.getElementById('profile-name-display').innerText = currentUserData.username;
            document.getElementById('profile-bio-display').innerText = currentUserData.bio || '';
            const avatarDisplay = document.getElementById('profile-avatar-display');
            avatarDisplay.src = currentUserData.profile_picture;
            document.getElementById('profile-userid-text').innerText = currentUserData.userId || "User_0000"; //  PERBAIKAN

            avatarDisplay.onload = function() {
                const rgb = getAverageRGB(avatarDisplay);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('profile-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            document.getElementById('edit-profile-name').value = currentUserData.username;
            document.getElementById('edit-profile-bio').value = currentUserData.bio || '';
            document.getElementById('edit-profile-img').src = currentUserData.profile_picture;

            document.getElementById('profile-edit-panel').classList.remove('active');
            renderProfilePublicPlaylists();
        }
        
        function toggleProfileEdit() {
            document.getElementById('profile-edit-panel').classList.toggle('active');
        }

        function renderProfilePublicPlaylists() {
            const playlists = currentUserData.playlists || {};
            const container = document.getElementById('profile-public-playlists');
            let html = '';
            
            Object.keys(playlists).forEach(key => {
                const pl = playlists[key];
                // ONLY SHOW PUBLIC PLAYLISTS
                if(pl.isPublic) {
                    html += `
                        <div class="song-card" onclick="window.openPlaylist('${key}')">
                            <div class="card-img-wrapper">
                                <img src="${pl.cover}">
                                <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                            </div>
                            <div class="card-title">${pl.name}</div>
                            <div class="card-desc">Playlist</div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<p style="color:#666; font-style:italic; padding: 0 32px;">Tidak ada playlist publik. Atur privasi di sidebar.</p>';
            }

            container.innerHTML = html;
        }

        function handleProfileAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-profile-img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfileChanges() {
    const newName = document.getElementById('edit-profile-name').value.trim();
    const newBio = document.getElementById('edit-profile-bio').value;
    const newAvatarSrc = document.getElementById('edit-profile-img').src;

    const currentSuffix = currentUserData.userIdSuffix || Math.floor(1000 + Math.random() * 9000);
    const cleanName = newName.replace(/\s+/g, '');
    
    // GANTI # dengan _ di sini juga
    const newUserId = `${cleanName}_${currentSuffix}`; //  UBAH DARI # ke _

    const updates = {
        username: newName,
        userId: newUserId,
        userIdSuffix: currentSuffix,
        bio: newBio,
        profile_picture: newAvatarSrc
    };

    update(ref(db, 'users/' + auth.currentUser.uid), updates)
        .then(() => {
            const oldUserId = currentUserData.userId;
            remove(ref(db, 'usernames/' + oldUserId));
            set(ref(db, 'usernames/' + newUserId), auth.currentUser.uid);

            document.getElementById('header-username').innerText = newName;
            document.getElementById('header-avatar').src = newAvatarSrc;
            document.getElementById('profile-name-display').innerText = newName;
            document.getElementById('profile-bio-display').innerText = newBio;
            document.getElementById('profile-userid-text').innerText = newUserId;
            document.getElementById('profile-avatar-display').src = newAvatarSrc;
            
            const avatarDisplay = document.getElementById('profile-avatar-display');
            avatarDisplay.onload = function() {
                const rgb = getAverageRGB(avatarDisplay);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('profile-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            currentUserData = { ...currentUserData, ...updates };

            toggleProfileEdit(); 
            alert("Profil berhasil disimpan! User ID Anda sekarang: " + newUserId);
        })
        .catch((err) => {
            console.error(err);
            alert("Gagal menyimpan profil.");
        });
}

        // Expose profile functions
        window.toggleProfileEdit = toggleProfileEdit;
        window.handleProfileAvatarUpload = handleProfileAvatarUpload;
        window.saveProfileChanges = saveProfileChanges;
        window.loadProfileData = openProfileView;

        // --- ADD SONG MODAL ---
        function openAddSongModal(songId) {
            const list = document.getElementById('add-song-playlist-list');
            const playlists = currentUserData.playlists || {};
            let html = '';
            Object.keys(playlists).forEach(key => {
                const pl = playlists[key];
                html += `<div class="playlist-select-item" onclick="window.addSongTo('${key}', '${songId}')">
                    <img src="${pl.cover}" style="width:40px;height:40px;border-radius:4px;">
                    <div>${pl.name}</div>
                </div>`;
            });
            if(Object.keys(playlists).length === 0) html = '<p style="text-align:center;color:#888">Belum ada playlist.</p>';
            list.innerHTML = html;
            document.getElementById('add-song-modal').classList.add('open');
        }

        function addSongTo(playlistId, songId) {
            const songData = songs.find(s => s.id == songId);
            if(!songData) return;
            const userId = auth.currentUser.uid;
            update(ref(db, 'users/' + userId + '/playlists/' + playlistId + '/songs/' + songId), songData);
            closeModal('add-song-modal');
            addToLiked(songId);
        }

        window.openAddSongModal = openAddSongModal;
        window.addSongTo = addSongTo;
        
        function addToLiked(id) {
            if (!likedSongs.includes(id)) {
                likedSongs.push(id);
                localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
                const currentSong = songs[currentSongIndex];
                if(currentSong && currentSong.id === id) {
                    updatePlayerLikeIcon(id);
                }
            }
        }

        function toggleCurrentSongLike() {
            const currentSong = songs[currentSongIndex];
            if (currentSong) {
                toggleLike(currentSong.id);
            }
        }

        function toggleLike(id) {
            const index = likedSongs.indexOf(id);
            if(index > -1) {
                likedSongs.splice(index, 1);
            } else {
                likedSongs.push(id);
            }
            localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
            
            const currentSong = songs[currentSongIndex];
            if(currentSong && currentSong.id === id) {
                updatePlayerLikeIcon(id);
            }
            updateListLikeIcon(id);
        }

        function updatePlayerLikeIcon(id) {
            const btn = document.getElementById('like-btn');
            const icon = btn.querySelector('i');
            
            if(likedSongs.includes(id)) {
                icon.className = 'ph-fill ph-heart';
                btn.classList.add('liked');
            } else {
                icon.className = 'ph ph-heart';
                btn.classList.remove('liked');
            }
        }

        function updateListLikeIcon(id) {
            const btn = document.getElementById(`list-like-${id}`);
            if(btn) {
                const icon = btn.querySelector('i');
                if(likedSongs.includes(id)) {
                    if(icon) icon.className = 'ph-fill ph-heart';
                    btn.classList.add('liked');
                    btn.style.color = 'var(--primary-red)';
                } else {
                    if(icon) icon.className = 'ph ph-heart';
                    btn.classList.remove('liked');
                    btn.style.color = 'var(--text-gray)';
                }
            }
        }

        window.toggleLike = toggleLike;
        window.addToLiked = addToLiked;
        window.toggleCurrentSongLike = toggleCurrentSongLike;

        // --- QUEUE SYSTEM LOGIC ---

        function toggleQueueOverlay() {
            const overlay = document.getElementById('queue-overlay');
            overlay.classList.toggle('open');
            renderQueue();
        }

        function addToQueue(songId) {
            const song = songs.find(s => s.id === songId);
            if(song) {
                songQueue.push(song);
                renderQueue();
                // Small toast or visual feedback could go here
                // alert(`"${song.title}" ditambahkan ke antrian`);
            }
        }

        function removeFromQueue(index) {
            songQueue.splice(index, 1);
            renderQueue();
        }

        function playFromQueue(index) {
            const song = songQueue[index];
            if(song) {
                // If it's not first one, we might want to reorder, but for now let's just play it
                // Usually playing from queue implies that becomes current and we remove previous from queue?
                // Let's just play it and remove it from queue after or before?
                // Standard behavior: Play it, remove played ones before it.
                
                // For simplicity: Play this specific song immediately.
                playSpecificSong(song.id);
                
                // Remove items up to and including this index from queue
                songQueue.splice(0, index + 1);
                renderQueue();
            }
        }
        
        // --- DRAG AND DROP QUEUE LOGIC ---
        let dragStartIndex;

        function handleDragStart(e) {
            dragStartIndex = +this.closest('.queue-item').dataset.index;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const container = document.getElementById('queue-list-container');
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('dragging');
            // Reorder array based on DOM
            const newOrder = [];
            document.querySelectorAll('.queue-item').forEach(item => {
                const idx = parseInt(item.dataset.index);
                newOrder.push(songQueue[idx]);
            });
            songQueue = newOrder;
            
            // Re-render to fix indices
            renderQueue();
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.queue-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function renderQueue() {
            const container = document.getElementById('queue-list-container');
            if(songQueue.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Antrian kosong.</div>';
                return;
            }

            let html = '';
            songQueue.forEach((song, index) => {
                html += `
                    <div class="queue-item" draggable="true" data-index="${index}">
                        <img src="${song.cover}" class="queue-img">
                        <div class="queue-info">
                            <div class="queue-title">${song.title}</div>
                            <div class="queue-artist">${song.artist}</div>
                        </div>
                        <button class="queue-remove" onclick="window.removeFromQueue(${index})"><i class="ph ph-x"></i></button>
                    </div>
                `;
            });
            container.innerHTML = html;

            // Attach Drag Events
            const items = container.querySelectorAll('.queue-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver); // On container usually, but here items
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            });
        }

        window.toggleQueueOverlay = toggleQueueOverlay;
        window.addToQueue = addToQueue;
        window.removeFromQueue = removeFromQueue;
        window.playFromQueue = playFromQueue;

        // --- PLAYER LOGIC (FIXED ANIMATION & QUEUE/REPEAT) ---
        
        // --- OVERLAY PLAYER LOGIC ---
        function checkMarquee(el, text) {
            if(!el) return;
            el.innerHTML = text; // Reset
            el.classList.remove('marquee-container');
            
            // Check overflow
            if(el.scrollWidth > el.clientWidth && el.clientWidth > 0) {
                el.classList.add('marquee-container');
                el.innerHTML = `<div class="marquee-content"><span>${text}</span><span>${text}</span></div>`;
            }
        }

        function openOverlayPlayer() {
            document.getElementById('overlay-player').classList.add('active');
            // Check marquee when opening
            if(songs[currentSongIndex]) {
                const s = songs[currentSongIndex];
                checkMarquee(document.getElementById('overlay-title'), s.title);
                checkMarquee(document.getElementById('overlay-artist'), s.artist);
            }
        }

        function closeOverlayPlayer() {
            document.getElementById('overlay-player').classList.remove('active');
        }
        
        window.openOverlayPlayer = openOverlayPlayer;
        window.closeOverlayPlayer = closeOverlayPlayer;

        // Player Bar Click to Open Overlay
        document.querySelector('.player-bar').addEventListener('click', (e) => {
            // Jangan buka jika yang diklik adalah tombol kontrol
            if(e.target.closest('button') || e.target.closest('.volume-bar-container')) return;
            openOverlayPlayer();
        });

        // Overlay Progress Bar Click
        document.getElementById('overlay-progress-container').addEventListener('click', (e) => {
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            audio.currentTime = (x / width) * audio.duration;
        });

        function loadSong(song) {
            // Player Bar Marquee Check
            checkMarquee(document.getElementById('player-title'), song.title);
            checkMarquee(document.getElementById('player-artist'), song.artist);

            playerArt.src = song.cover;
            audio.src = song.src;
            
            // UPDATE OVERLAY UI
            const overlayTitle = document.getElementById('overlay-title');
            const overlayArtist = document.getElementById('overlay-artist');
            
            // Reset overlay text first
            overlayTitle.innerText = song.title;
            overlayArtist.innerText = song.artist;
            overlayTitle.classList.remove('marquee-container');
            overlayArtist.classList.remove('marquee-container');

            document.getElementById('overlay-art').src = song.cover;
            document.getElementById('overlay-bg').style.backgroundImage = `url(${song.cover})`;
            
            // If overlay is open, check marquee
            if(document.getElementById('overlay-player').classList.contains('active')) {
                checkMarquee(overlayTitle, song.title);
                checkMarquee(overlayArtist, song.artist);
            }
            
            updatePlayerLikeIcon(song.id);
            
            // HIDE ALL VISUALIZERS & PAUSE THEM
            document.querySelectorAll('.song-row').forEach(r => {
                r.classList.remove('playing');
                const eqContainer = r.querySelector('.playing-icon-container');
                const num = r.querySelector('.index-num');
                if(eqContainer) {
                    eqContainer.style.display = 'none';
                    eqContainer.style.animationPlayState = 'paused'; 
                }
                if(num) num.style.display = 'block';
            });
            
            // SHOW VISUALIZER FOR CURRENT SONG
            const active = document.getElementById(`row-${song.id}`);
            if(active) {
                active.classList.add('playing');
                const eq = active.querySelector('.playing-icon-container');
                if(eq) {
                    eq.style.display = 'flex';
                    if(isPlaying) eq.style.animationPlayState = 'running';
                }
                if(active.querySelector('.index-num')) active.querySelector('.index-num').style.display = 'none';
            }
        }

        // --- ARTIST PROFILE LOGIC ---
        function openArtistProfile(artistName, fallbackImg) {
            const overlay = document.getElementById('artist-profile-overlay');
            const nameEl = document.getElementById('artist-profile-name');
            const imgEl = document.getElementById('artist-profile-img');
            const songsContainer = document.getElementById('artist-profile-songs');

            // Find artist in static index
            const artistData = searchIndexArtists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
            
            nameEl.innerText = artistName;
            
            if (artistData) {
                imgEl.src = artistData.img;
            } else {
                imgEl.src = fallbackImg || 'https://picsum.photos/seed/artist/300/300';
            }

            // Filter songs by this artist
            const artistSongs = songs.filter(s => s.artist.toLowerCase() === artistName.toLowerCase());
            renderSongListCustom(artistSongs, 'artist-profile-songs', false);
            
            // Add padding so player bar doesn't cover last song
            songsContainer.style.paddingBottom = '120px';

            overlay.style.display = 'flex';
        }

        function closeArtistProfile() {
            document.getElementById('artist-profile-overlay').style.display = 'none';
        }

        window.openArtistProfile = openArtistProfile;
        window.closeArtistProfile = closeArtistProfile;

        // Helper to open from Overlay
        window.openArtistProfileFromOverlay = function() {
            const artistName = document.getElementById('overlay-artist').innerText;
            const currentImg = document.getElementById('overlay-art').src;
            closeOverlayPlayer(); // Close player overlay first? Or keep it open underneath? 
            // User asked "munculkan overlay lagi", let's stack it.
            // But if we want to go back, stacking is better.
            openArtistProfile(artistName, currentImg);
        };

        // Add Click Event to Player Bar Artist
        document.getElementById('player-artist').addEventListener('click', (e) => {
            e.stopPropagation();
            const artistName = e.target.innerText;
            const currentImg = document.getElementById('player-art').src;
            openArtistProfile(artistName, currentImg);
        });
        // Make it look clickable
        document.getElementById('player-artist').style.cursor = 'pointer';
        document.getElementById('player-artist').style.textDecoration = 'underline';


        function playSpecificSong(id) {
            // Push to history (avoid duplicates)
            const currentSong = songs[currentSongIndex];
            if(currentSong && currentSong.id !== id) {
                playHistory.push(currentSong);
            }

            const idx = songs.findIndex(s => s.id === id);
            if (idx !== -1) {
                currentSongIndex = idx;
                loadSong(songs[currentSongIndex]);
                audio.play();
                isPlaying = true;
                updatePlayBtn();
                
                // Add to Recently Played
                addToRecentlyPlayed('song', songs[currentSongIndex]);
                
                // Broadcast to Listen Together if Host
                if(listenTogetherSession.active && listenTogetherSession.isHost) {
                    broadcastState();
                }
            }
        }
        window.playSpecificSong = playSpecificSong;

        function playNext() {
            // Logic: Check Queue -> Check Repeat -> Next Song
            
            if(repeatMode === 2) {
                // Repeat One
                audio.currentTime = 0;
                audio.play();
                return;
            }

            // Check Queue First
            if(songQueue.length > 0) {
                const nextQueued = songQueue.shift(); // Remove from front
                playSpecificSong(nextQueued.id);
                renderQueue(); // Update UI to show removal
                return;
            }

            // Normal Playback
            if(repeatMode === 1 && currentSongIndex === songs.length - 1) {
                // Repeat All & Last song -> Go to 0
                currentSongIndex = 0;
            } else {
                // Default Next
                currentSongIndex = (currentSongIndex + 1) % songs.length;
            }
            
            loadSong(songs[currentSongIndex]); 
            audio.play(); 
            isPlaying = true; 
            updatePlayBtn();
        }

        function playPrevious() {
            // Logic: Check History > 5s? -> Else Prev in list
            if(audio.currentTime > 3) {
                audio.currentTime = 0;
                return;
            }

            if(playHistory.length > 0) {
                const prevSong = playHistory.pop();
                playSpecificSong(prevSong.id);
                return;
            }

            currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            loadSong(songs[currentSongIndex]); 
            audio.play(); 
            isPlaying = true; 
            updatePlayBtn();
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3; // 0: Off, 1: All, 2: One
            const btn = document.getElementById('repeat-btn');
            const icon = btn.querySelector('i');
            
            icon.className = 'ph ph-repeat'; // Reset base class
            
            if(repeatMode === 0) {
                btn.classList.remove('active');
            } else if (repeatMode === 1) {
                btn.classList.add('active');
                // Add a small dot or text if needed, but color change is fine
            } else {
                btn.classList.add('active');
                icon.className = 'ph ph-repeat-once'; // Ideally a specific icon, but we reuse here
                // Or we can modify content to "1"
            }
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffle-btn');
            if(isShuffle) btn.classList.add('active');
            else btn.classList.remove('active');
            // Implementation of shuffle logic is complex with current array structure, 
            // toggling state is enough for UI requirements.
        }

        audio.addEventListener('ended', () => {
            document.getElementById('next-btn').click();
        });

        playPauseBtn.addEventListener('click', () => {
            // Perbaikan: Cek apakah audio punya source yang valid sebelum play
            if (!audio.src || audio.src === window.location.href) {
                console.warn(" Audio source is empty, cannot play.");
                return; 
            }

            // Perbaikan: Handle Promise play() untuk menangkap error NotSupportedError
            if (isPlaying) { 
                audio.pause(); 
                isPlaying = false; 
                updatePlayBtn();
            } else { 
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Playback started successfully
                        isPlaying = true;
                        updatePlayBtn();
                    })
                    .catch(error => {
                        console.error(" Audio Play Error:", error);
                        // Jika error karena source tidak valid/kosong
                        isPlaying = false;
                        updatePlayBtn();
                    });
                }
            }
            
            // --- FIX ANIMATION PAUSE/RUN ---
            const state = isPlaying ? 'running' : 'paused';
            document.querySelectorAll('.playing-icon-container').forEach(el => {
                el.style.animationPlayState = state;
            });
            
            // Broadcast to Listen Together if Host
            if(listenTogetherSession.active && listenTogetherSession.isHost) {
                broadcastState();
            }
        });

        function updatePlayBtn() {
            const overlayIcon = document.querySelector('#overlay-play-pause-btn i');
            if(isPlaying) { 
                playPauseIcon.classList.remove('ph-play'); 
                playPauseIcon.classList.add('ph-pause'); 
                if(overlayIcon) { overlayIcon.classList.remove('ph-play'); overlayIcon.classList.add('ph-pause'); }
            } else { 
                playPauseIcon.classList.remove('ph-pause'); 
                playPauseIcon.classList.add('ph-play'); 
                if(overlayIcon) { overlayIcon.classList.remove('ph-pause'); overlayIcon.classList.add('ph-play'); }
            }
        }

        document.getElementById('prev-btn').addEventListener('click', playPrevious);
        document.getElementById('next-btn').addEventListener('click', playNext);
        document.getElementById('repeat-btn').addEventListener('click', toggleRepeat);
        document.getElementById('shuffle-btn').addEventListener('click', toggleShuffle);

        // Export ke window agar bisa dipanggil dari HTML onclick
window.playNext = playNext;
window.playPrevious = playPrevious;
window.toggleRepeat = toggleRepeat;
window.toggleShuffle = toggleShuffle;

        audio.addEventListener('timeupdate', (e) => {
            const { duration, currentTime } = e.srcElement;
            if (isNaN(duration)) return;
            const pct = (currentTime / duration) * 100;
            
            // Footer Player
            document.getElementById('progress-fill').style.width = `${pct}%`;
            
            const fmt = t => {
                const m = Math.floor(t/60);
                const s = Math.floor(t%60);
                return `${m}:${s<10?'0'+s:s}`;
            };
            document.getElementById('current-time').innerText = fmt(currentTime);
            document.getElementById('total-duration').innerText = fmt(duration);
            
            // Overlay Player Sync
            const overlayFill = document.getElementById('overlay-progress-fill');
            if(overlayFill) {
                overlayFill.style.width = `${pct}%`;
                document.getElementById('overlay-current-time').innerText = fmt(currentTime);
                document.getElementById('overlay-total-duration').innerText = fmt(duration);
            }
        });

        document.getElementById('progress-container').addEventListener('click', (e) => {
            const w = e.currentTarget.clientWidth;
            const x = e.offsetX;
            audio.currentTime = (x / w) * audio.duration;
        });

        const volContainer = document.getElementById('volume-container');
        const volFill = document.getElementById('volume-fill');
        const volIcon = document.getElementById('vol-icon');
        audio.volume = 0.7; 

        volContainer.addEventListener('click', (e) => {
            const rect = volContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            let vol = Math.max(0, Math.min(1, x / width));
            audio.volume = vol;
            volFill.style.width = `${vol * 100}%`;
            
            volIcon.classList.remove('ph-speaker-high', 'ph-speaker-low', 'ph-speaker-slash');
            if (vol === 0) volIcon.classList.add('ph-speaker-slash');
            else if (vol < 0.5) volIcon.classList.add('ph-speaker-low');
            else volIcon.classList.add('ph-speaker-high');
        });





// Deteksi Mobile Device
const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

if (isMobileDevice) {
    // === MODE MOBILE: GUNAKAN KONTROL VOLUME HP ===
    audio.volume = 1.0; // Set ke max, biar kontrol HP yang atur
    volContainer.style.display = 'none'; // Sembunyikan slider custom
    volIcon.style.display = 'none'; // Sembunyikan ikon volume juga
    
    // Listener untuk perubahan volume dari HP
    audio.addEventListener('volumechange', () => {
        // Sinkronisasi jika ada perubahan dari kontrol HP
        console.log('Volume HP:', audio.volume);
    });
} else {
    // === MODE DESKTOP: GUNAKAN SLIDER CUSTOM ===
    audio.volume = 0.7; // Default 70%
    volFill.style.width = '70%';
    
    volContainer.addEventListener('click', (e) => {
        const rect = volContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const width = rect.width;
        let vol = Math.max(0, Math.min(1, x / width));
        audio.volume = vol;
        volFill.style.width = `${vol * 100}%`;
        
        // Update icon berdasarkan volume
        volIcon.classList.remove('ph-speaker-high', 'ph-speaker-low', 'ph-speaker-slash');
        if (vol === 0) volIcon.classList.add('ph-speaker-slash');
        else if (vol < 0.5) volIcon.classList.add('ph-speaker-low');
        else volIcon.classList.add('ph-speaker-high');
    });
}



// === LISTEN TOGETHER STATE ===
let listenTogetherSession = {
    active: false,
    isHost: false,
    sessionCode: null,
    participants: []
};

// === OPEN LISTEN TOGETHER (PERBAIKAN: NO REGENERATE) ===
window.openListenTogether = function() {
    try {
        console.log('Open Listen Together Clicked');
        // alert('Debug: Tombol Dengar Bareng Ditekan (Cek Overlay)'); // Debug visual
        const overlay = document.getElementById('listen-together-overlay');
        
        if(!overlay) {
            alert('Error: Overlay element not found!');
            return;
        }

        // Force styling to ensure visibility
        overlay.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; z-index: 2147483647 !important; top: 0; left: 0; position: fixed; width: 100%; height: 100%;';
        overlay.classList.add('active');

        // Reset sections
        const modeSec = document.getElementById('lt-mode-section');
        const hostSec = document.getElementById('lt-host-section');
        const joinSec = document.getElementById('lt-join-section');

        // Default state: Show Mode, Hide others
        if(modeSec) modeSec.style.display = 'block';
        if(hostSec) hostSec.style.display = 'none';
        if(joinSec) joinSec.style.display = 'none';

        // Safety check for session object
        if(typeof listenTogetherSession === 'undefined') {
            console.warn('listenTogetherSession undefined, initializing...');
            window.listenTogetherSession = { active: false, isHost: false, sessionCode: null, participants: [] };
        }

        if(listenTogetherSession.active) {
            // JIKA SUDAH ADA SESI
            if(modeSec) modeSec.style.display = 'none'; // Hide mode selection
            
            if(listenTogetherSession.isHost) {
                if(hostSec) hostSec.style.display = 'block';
                const codeEl = document.getElementById('lt-session-code');
                if(codeEl) codeEl.innerText = listenTogetherSession.sessionCode;
            } else {
                // Guest: Show Join/Mode options
                if(modeSec) modeSec.style.display = 'block';
                if(joinSec) joinSec.style.display = 'block';
            }
        }
    } catch (e) {
        console.error('Error opening Listen Together:', e);
        alert('Terjadi kesalahan: ' + e.message);
    }
};

window.closeListenTogether = function() {
    const overlay = document.getElementById('listen-together-overlay');
    if(overlay) {
        overlay.classList.remove('active');
        overlay.style.display = ''; // Reset inline style
    }
};

// === SELECT MODE ===
window.selectLTMode = function(mode) {
    document.getElementById('lt-mode-section').style.display = 'none';
    
    if(mode === 'host') {
        startHostSession();
    } else {
        document.getElementById('lt-join-section').style.display = 'block';
    }
};

// === START HOST SESSION (PERBAIKAN LOGIC) ===
function startHostSession() {
    // Cek apakah sudah ada sesi aktif? Kalau iya, jangan generate code baru
    if(listenTogetherSession.active && listenTogetherSession.isHost) {
        document.getElementById('lt-host-section').style.display = 'block';
        document.getElementById('lt-session-code').innerText = listenTogetherSession.sessionCode;
        return;
    }

    const code = generateSessionCode();
    listenTogetherSession.sessionCode = code;
    listenTogetherSession.isHost = true;
    listenTogetherSession.active = true;
    
    document.getElementById('lt-session-code').innerText = code;
    document.getElementById('lt-host-section').style.display = 'block';
    
    // Save to Firebase
    set(ref(db, `sessions/${code}`), {
        host: auth.currentUser.uid,
        hostName: currentUserData.username,
        hostPic: currentUserData.profile_picture,
        currentSong: songs[currentSongIndex].id,
        currentTime: audio.currentTime,
        isPlaying: isPlaying,
        timestamp: Date.now(),
        participants: {
            [auth.currentUser.uid]: {
                name: currentUserData.username,
                pic: currentUserData.profile_picture,
                role: 'host'
            }
        }
    });
    
    // Listen for participants
    listenToParticipants(code);
    
    // Show badge
    document.getElementById('session-badge').classList.add('active');
    document.getElementById('session-badge-text').innerText = `Session: ${code}`;
}

// === JOIN SESSION ===
window.joinListenTogether = async function() {
    const code = document.getElementById('lt-join-code').value.toUpperCase().trim();
    if(code.length !== 4) {
        alert("Kode harus 4 karakter!");
        return;
    }
    
    // Check if session exists
    const sessionSnap = await get(ref(db, `sessions/${code}`));
    if(!sessionSnap.exists()) {
        alert("Session tidak ditemukan!");
        return;
    }
    
    listenTogetherSession.sessionCode = code;
    listenTogetherSession.isHost = false;
    listenTogetherSession.active = true;
    
    // Add self to participants
    update(ref(db, `sessions/${code}/participants/${auth.currentUser.uid}`), {
        name: currentUserData.username,
        pic: currentUserData.profile_picture,
        role: 'guest'
    });
    
    // Sync with host
    syncWithSession(code);
    
    document.getElementById('session-badge').classList.add('active');
    document.getElementById('session-badge-text').innerText = `Joined: ${code}`;
    
    closeListenTogether();
};

// === SYNC WITH SESSION (FIXED: SINKRONISASI LAGU) ===
function syncWithSession(code) {
    onValue(ref(db, `sessions/${code}`), (snap) => {
        const session = snap.val();
        if(!session) {
            endListenTogether();
            return;
        }
        
        // Sync playback HANYA JIKA GUEST
        if(!listenTogetherSession.isHost) {
            const songId = session.currentSong;
            const time = session.currentTime;
            const playing = session.isPlaying;
            
            // Cari index lagu
            const idx = songs.findIndex(s => s.id == songId);
            
            // Jika lagunya beda, ganti lagu
            if(idx !== -1 && idx !== currentSongIndex) {
                 loadSong(songs[idx]);
                 currentSongIndex = idx;
                 // Putar dulu untuk memuat buffer, lalu seek
                 audio.play().then(() => {
                     audio.currentTime = time;
                     if(!playing) audio.pause();
                     // Update UI Play/Pause
                     isPlaying = playing;
                     updatePlayBtn();
                     
                     // Update Visualizer
                     const state = isPlaying ? 'running' : 'paused';
                     document.querySelectorAll('.playing-icon-container').forEach(el => {
                        el.style.animationPlayState = state;
                    });
                 });
            } else if (Math.abs(audio.currentTime - time) > 2) {
                // Jika lagu sama tapi beda waktu (drift > 2 detik)
                audio.currentTime = time;
            }
            
            // Sinkronisasi Play/Pause
            if(playing && audio.paused) {
                audio.play();
                isPlaying = true;
                updatePlayBtn();
                document.querySelectorAll('.playing-icon-container').forEach(el => el.style.animationPlayState = 'running');
            } else if(!playing && !audio.paused) {
                audio.pause();
                isPlaying = false;
                updatePlayBtn();
                document.querySelectorAll('.playing-icon-container').forEach(el => el.style.animationPlayState = 'paused');
            }
        }
    });
}

// === BROADCAST STATE (HOST) ===
function broadcastState() {
    if(!listenTogetherSession.active || !listenTogetherSession.isHost) return;
    
    update(ref(db, `sessions/${listenTogetherSession.sessionCode}`), {
        currentSong: songs[currentSongIndex].id,
        currentTime: audio.currentTime,
        isPlaying: isPlaying,
        timestamp: Date.now()
    });
}

// Hook into audio events untuk auto-broadcast saat lagu berakhir/next
if(listenTogetherSession.active && listenTogetherSession.isHost) {
    // Broadcast saat seek (opsional, bisa berat jika tiap frame)
    // Kita broadcast saat Play/Pause/Skip saja sudah cukup.
}

// === LISTEN TO PARTICIPANTS ===
function listenToParticipants(code) {
    onValue(ref(db, `sessions/${code}/participants`), (snap) => {
        const participants = snap.val() || {};
        const list = document.getElementById('lt-participants-list');
        
        let html = '';
        Object.keys(participants).forEach(uid => {
            const p = participants[uid];
            html += `
                <div class="lt-participant">
                    <img src="${p.pic}" alt="${p.name}">
                    <span>${p.name}</span>
                    ${p.role === 'host' ? '<span class="lt-host-badge">HOST</span>' : ''}
                </div>
            `;
        });
        
        list.innerHTML = html || '<p style="color:#666; text-align:center;">Menunggu...</p>';
    });
}

// === END SESSION ===
window.endListenTogether = function() {
    if(listenTogetherSession.isHost) {
        // Remove from Firebase
        remove(ref(db, `sessions/${listenTogetherSession.sessionCode}`));
    } else {
        // Remove self from participants
        remove(ref(db, `sessions/${listenTogetherSession.sessionCode}/participants/${auth.currentUser.uid}`));
    }
    
    listenTogetherSession = { active: false, isHost: false, sessionCode: null, participants: [] };
    document.getElementById('session-badge').classList.remove('active');
    closeListenTogether();
    
    // Reset UI
    document.getElementById('lt-mode-section').style.display = 'block';
    document.getElementById('lt-host-section').style.display = 'none';
    document.getElementById('lt-join-section').style.display = 'none';
};

// === COPY SESSION CODE ===
window.copySessionCode = function() {
    const code = document.getElementById('lt-session-code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        alert(`Kode ${code} disalin!`);
    });
};

// === GENERATE SESSION CODE ===
function generateSessionCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for(let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}
// Tambahkan fungsi ini di bagian atas script
function showToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'ph-info';
    if(type === 'success') icon = 'ph-check-circle';
    if(type === 'error') icon = 'ph-warning-circle';

    toast.innerHTML = `<i class="ph-fill ${icon}" style="font-size:20px;"></i> ${message}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ===== GLOBAL VARIABLES FOR IMPORT =====
let selectedMusicFile = null;
let selectedCoverFile = null;
let importedSongsStartId = 10000;

// ===== IMPORT MUSIC FUNCTIONS =====

window.openImportMusicModal = function() {
    document.getElementById('import-music-modal').classList.add('open');
    // Reset form
    selectedMusicFile = null;
    selectedCoverFile = null;
    document.getElementById('import-file-name').innerText = 'Belum ada file dipilih';
    document.getElementById('import-file-size').innerText = 'Pilih file MP3';
    document.getElementById('import-song-title').value = '';
    document.getElementById('import-song-artist').value = '';
    document.getElementById('import-song-album').value = '';
    document.getElementById('import-privacy-toggle').checked = false;
    document.getElementById('import-cover-preview').src = 'https://picsum.photos/seed/default/100/100';
    document.getElementById('import-file-preview').classList.remove('active');
    updatePrivacyLabel(document.getElementById('import-privacy-toggle'));
};

window.handleMusicFileSelect = function(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate MP3
        if (!file.type.match('audio/mpeg') && !file.type.match('audio/mp3')) {
            showToast(' Hanya file MP3 yang didukung!', 'error');
            return;
        }

        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showToast(' Ukuran file maksimal 10MB!', 'error');
            return;
        }

        selectedMusicFile = file;
        document.getElementById('import-file-name').innerText = file.name;
        document.getElementById('import-file-size').innerText = formatFileSize(file.size);
        document.getElementById('import-file-preview').classList.add('active');

        // Auto-fill title from filename
        const filename = file.name.replace('.mp3', '').replace('.MP3', '');
        if (!document.getElementById('import-song-title').value) {
            document.getElementById('import-song-title').value = filename;
        }
    }
};

window.handleCoverFileSelect = function(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate image
        if (!file.type.match('image.*')) {
            showToast(' Hanya file gambar yang didukung!', 'error');
            return;
        }

        selectedCoverFile = file;
        
        // Preview cover
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('import-cover-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        showToast(' Foto cover berhasil dipilih!', 'success');
    }
};

window.updatePrivacyLabel = function(checkbox) {
    const icon = document.getElementById('privacy-icon');
    const label = document.getElementById('privacy-label');
    const desc = label.nextElementSibling;
    
    if (checkbox.checked) {
        icon.className = 'ph ph-globe';
        label.innerText = 'Publik';
        desc.innerText = 'Semua orang bisa mendengarkan';
    } else {
        icon.className = 'ph ph-lock-key';
        label.innerText = 'Privat';
        desc.innerText = 'Hanya Anda yang bisa mendengarkan';
    }
};

window.submitImportMusic = async function() {
    if (!auth.currentUser) {
        showToast(' Anda harus login terlebih dahulu!', 'error');
        return;
    }

    if (!selectedMusicFile) {
        showToast(' Pilih file MP3 terlebih dahulu!', 'error');
        return;
    }

    const title = document.getElementById('import-song-title').value.trim();
    const artist = document.getElementById('import-song-artist').value.trim();
    const album = document.getElementById('import-song-album').value.trim() || 'Single';
    const isPublic = document.getElementById('import-privacy-toggle').checked;

    if (!title || !artist) {
        showToast(' Nama lagu dan penyanyi harus diisi!', 'error');
        return;
    }

    if (selectedMusicFile.size > 50 * 1024 * 1024) {
        showToast(' Ukuran file maksimal 50MB!', 'error');
        return;
    }

    try {
        showToast(' Mengupload ke Supabase... Mohon tunggu', 'info');

        const userId = auth.currentUser.uid;
        const songId = 10000 + Date.now();

        // Upload music file
        console.log(' Uploading music...');
        const musicFileName = `${userId}/${songId}_${selectedMusicFile.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
        
        const { data: musicData, error: musicError } = await supabase.storage
            .from('vidje')
            .upload(musicFileName, selectedMusicFile, {
                cacheControl: '3600',
                upsert: false,
                contentType: 'audio/mpeg'
            });

        if (musicError) throw new Error('Upload gagal: ' + musicError.message);

        const { data: musicUrl } = supabase.storage
            .from('vidje')
            .getPublicUrl(musicFileName);

        console.log(' Music uploaded');

        // Upload cover
        let coverUrl = `https://picsum.photos/seed/${songId}/300/300`;
        
        if (selectedCoverFile) {
            console.log(' Uploading cover...');
            const coverExt = selectedCoverFile.name.split('.').pop();
            const coverFileName = `${userId}/${songId}_cover.${coverExt}`;
            
            const { error: coverError } = await supabase.storage
                .from('vidje')
                .upload(coverFileName, selectedCoverFile, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (!coverError) {
                const { data: coverUrlData } = supabase.storage
                    .from('vidje')
                    .getPublicUrl(coverFileName);
                coverUrl = coverUrlData.publicUrl;
                console.log(' Cover uploaded');
            }
        }

        // Get duration
        const audioDuration = await getAudioDuration(selectedMusicFile);

        // Save to Firebase
        const songData = {
            id: songId,
            title: title,
            artist: artist,
            album: album,
            duration: audioDuration || '3:30',
            cover: coverUrl,
            src: musicUrl.publicUrl,
            uploadedBy: userId,
            uploaderName: currentUserData?.username || 'Unknown',
            isPublic: isPublic,
            timestamp: Date.now(),
            storage: 'supabase'
        };

        await set(ref(db, `importedSongs/${userId}/${songId}`), songData);

        if (isPublic) {
            await set(ref(db, `publicImportedSongs/${songId}`), songData);
        }

        songs.push(songData);
        
        showToast(' Musik berhasil diimpor!', 'success');
        closeModal('import-music-modal');
        renderTrending();

    } catch (error) {
        console.error(' Error:', error);
        showToast(' Gagal: ' + error.message, 'error');
    }
};


// Helper: Convert file to Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            console.log('FileReader loaded, data length:', reader.result.length);
            resolve(reader.result);
        };
        reader.onerror = (error) => {
            console.error('FileReader error:', error);
            reject(error);
        };
        reader.readAsDataURL(file);
    });
}

// Helper function: Get audio duration
async function getAudioDuration(file) {
    return new Promise((resolve) => {
        const audio = new Audio();
        audio.onloadedmetadata = () => {
            const minutes = Math.floor(audio.duration / 60);
            const seconds = Math.floor(audio.duration % 60);
            resolve(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);
        };
        audio.onerror = () => resolve('3:30'); // Default if failed
        audio.src = URL.createObjectURL(file);
    });
}

// Helper function: Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function loadImportedSongs() {
    if (!auth.currentUser) {
        console.log(' No user logged in, skipping import load');
        return;
    }

    const userId = auth.currentUser.uid;

    try {
        console.log(' Loading imported songs for user:', userId);
        
        //  Load user's own imported songs (PUBLIK + PRIVAT)
        const userSongsSnap = await get(ref(db, `importedSongs/${userId}`));
        if (userSongsSnap.exists()) {
            const userSongs = Object.values(userSongsSnap.val());
            console.log(' User songs loaded:', userSongs.length);
            
            userSongs.forEach(song => {
                if (!songs.find(s => s.id === song.id)) {
                    songs.push(song);
                    console.log('   Added own song:', song.title);
                }
            });
        }

        //  Load public songs dari SEMUA user (kecuali milik sendiri)
        const publicSongsSnap = await get(ref(db, 'publicImportedSongs'));
        if (publicSongsSnap.exists()) {
            const publicSongs = Object.values(publicSongsSnap.val())
                .filter(song => song.uploadedBy !== userId); // Kecuali punya sendiri
            
            console.log(' Public songs from others:', publicSongs.length);
            
            publicSongs.forEach(song => {
                if (!songs.find(s => s.id === song.id)) {
                    songs.push(song);
                    console.log('   Added public song:', song.title, 'by', song.uploaderName);
                }
            });
        }

        console.log(' Total songs in library:', songs.length);

    } catch (error) {
        console.error(' Error loading imported songs:', error);
    }
}



        // --- INITIALIZATION ---
        renderTrending();
        renderPopularBands();
        renderPopularArtists();
        renderForeignSoloArtists();
        renderForeignBands();
        loadSong(songs[0]);

        //  TAMBAHKAN: Load imported songs saat user login
onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log(' User logged in, loading imported songs...');
        await loadImportedSongs();
        
        //  Setup real-time listener untuk lagu publik baru
        setupPublicSongsListener();
        
        console.log(' Total songs available:', songs.length);
    }
});

//  FUNGSI BARU: Listen perubahan lagu publik secara real-time
function setupPublicSongsListener() {
    const publicSongsRef = ref(db, 'publicImportedSongs');
    
    onValue(publicSongsRef, (snapshot) => {
        const publicSongs = snapshot.val();
        if (!publicSongs) return;
        
        Object.values(publicSongs).forEach(song => {
            // Skip lagu sendiri & lagu yang sudah ada
            if (song.uploadedBy === auth.currentUser.uid) return;
            if (songs.find(s => s.id === song.id)) return;
            
            // Tambahkan lagu publik baru
            songs.push(song);
            console.log(' New public song added:', song.title, 'by', song.uploaderName);
        });
    });
}





// ===== REGISTER SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log(' Service Worker registered!', registration);
                    })
                    .catch(error => {
                        console.error(' Service Worker registration failed:', error);
                    });
            });
        }

        // ===== MEDIA SESSION API (UNTUK NOTIFIKASI MUSIK) =====
        if ('mediaSession' in navigator) {
            const audio = document.getElementById('audio-player');
            
            // Setup controls di notifikasi (Play/Pause/Next/Previous)
            navigator.mediaSession.setActionHandler('play', () => {
                audio.play();
                isPlaying = true;
                updatePlayBtn();
            });
            
            navigator.mediaSession.setActionHandler('pause', () => {
                audio.pause();
                isPlaying = false;
                updatePlayBtn();
            });
            
            navigator.mediaSession.setActionHandler('nexttrack', () => {
                window.playNext();
            });
            
            navigator.mediaSession.setActionHandler('previoustrack', () => {
                window.playPrevious();
            });
            
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                audio.currentTime = Math.max(audio.currentTime - 10, 0);
            });
            
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                audio.currentTime = Math.min(audio.currentTime + 10, audio.duration);
            });
            
            // Update metadata lagu di notifikasi
            audio.addEventListener('loadedmetadata', () => {
                const song = songs[currentSongIndex];
                if (song && navigator.mediaSession) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title || 'Pilih Lagu',
                        artist: song.artist || 'Vidje',
                        album: song.album || 'Music Platform',
                        artwork: [
                            { src: song.cover, sizes: '96x96', type: 'image/png' },
                            { src: song.cover, sizes: '128x128', type: 'image/png' },
                            { src: song.cover, sizes: '192x192', type: 'image/png' },
                            { src: song.cover, sizes: '256x256', type: 'image/png' },
                            { src: song.cover, sizes: '384x384', type: 'image/png' },
                            { src: song.cover, sizes: '512x512', type: 'image/png' }
                        ]
                    });
                    
                    // Set playback state
                    navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
                }
            });
            
            // Update playback state saat play/pause
            audio.addEventListener('play', () => {
                if (navigator.mediaSession) {
                    navigator.mediaSession.playbackState = 'playing';
                }
            });
            
            audio.addEventListener('pause', () => {
                if (navigator.mediaSession) {
                    navigator.mediaSession.playbackState = 'paused';
                }
            });
            
            // Update position state (untuk seek bar di notifikasi)
            audio.addEventListener('timeupdate', () => {
                if ('setPositionState' in navigator.mediaSession && !isNaN(audio.duration)) {
                    navigator.mediaSession.setPositionState({
                        duration: audio.duration,
                        playbackRate: audio.playbackRate,
                        position: audio.currentTime
                    });
                }
            });
        }
        
        // ===== PWA INSTALL PROMPT =====
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Tampilkan tombol install (opsional - bisa dihapus jika tidak mau)
            // const installBtn = document.createElement('button');
            // installBtn.textContent = 'Install Vidje';
            // installBtn.onclick = async () => {
            //     deferredPrompt.prompt();
            //     const { outcome } = await deferredPrompt.userChoice;
            //     console.log('Install:', outcome);
            //     deferredPrompt = null;
            // };
            // document.body.appendChild(installBtn);
        });
        
        window.addEventListener('appinstalled', () => {
            console.log(' Vidje PWA installed!');
            deferredPrompt = null;
        });

        // Tambahkan fungsi-fungsi ini di bagian JavaScript (sebelum closing script tag)

// SHARE CURRENT PLAYLIST
window.shareCurrentPlaylist = function() {
    if(!currentPlaylistId) {
        showToast(' Tidak ada playlist yang aktif', 'error');
        return;
    }
    window.openShareModal('playlist', currentPlaylistId);
};

// OPEN PLAYLIST SETTINGS
window.openPlaylistSettings = function() {
    if(!currentPlaylistId || !currentUserData || !currentUserData.playlists) {
        showToast(' Tidak dapat membuka pengaturan', 'error');
        return;
    }
    
    const playlist = currentUserData.playlists[currentPlaylistId];
    if(!playlist) {
        showToast(' Playlist tidak ditemukan', 'error');
        return;
    }
    
    // Set current values
    document.getElementById('settings-playlist-name').value = playlist.name;
    document.getElementById('settings-cover-preview').src = playlist.cover;
    
    // Open modal
    document.getElementById('playlist-settings-modal').classList.add('open');
};

// HANDLE COVER UPLOAD IN SETTINGS
window.handleSettingsCoverUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('settings-cover-preview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// SAVE PLAYLIST SETTINGS
window.savePlaylistSettings = function() {
    if(!currentPlaylistId || !auth.currentUser) {
        showToast(' Gagal menyimpan', 'error');
        return;
    }
    
    const newName = document.getElementById('settings-playlist-name').value.trim();
    const newCover = document.getElementById('settings-cover-preview').src;
    
    if(!newName) {
        showToast(' Nama playlist tidak boleh kosong', 'error');
        return;
    }
    
    // Update to Firebase
    update(ref(db, `users/${auth.currentUser.uid}/playlists/${currentPlaylistId}`), {
        name: newName,
        cover: newCover
    }).then(() => {
        showToast(' Playlist berhasil diperbarui!', 'success');
        
        // Update UI immediately
        document.getElementById('playlist-title-view').innerText = newName;
        document.getElementById('playlist-cover-view').src = newCover;
        
        // Update background gradient
        const coverEl = document.getElementById('playlist-cover-view');
        coverEl.onload = function() {
            const rgb = getAverageRGB(coverEl);
            const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            document.getElementById('playlist-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
        };
        
        // Close modal
        closeModal('playlist-settings-modal');
        
        // Reload sidebar to reflect changes
        setTimeout(() => {
            if(currentUserData && currentUserData.playlists) {
                renderSidebarPlaylists(currentUserData.playlists);
            }
        }, 300);
    }).catch(error => {
        console.error('Error updating playlist:', error);
        showToast(' Gagal menyimpan perubahan', 'error');
    });
};

// === FINAL SAFEGUARD: SETUP LISTEN TOGETHER LISTENER ===
// Pastikan listener terpasang meskipun onclick inline gagal
document.addEventListener('DOMContentLoaded', function() {
    console.log(' DOMContentLoaded: Setting up Listen Together button...');
    const ltBtn = document.getElementById('btn-open-listen-together');
    
    if (ltBtn) {
        console.log(' Button Listen Together ditemukan!');
        ltBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log(' Tombol Dengar Bareng diklik (Event Listener)!');
            if (typeof window.openListenTogether === 'function') {
                window.openListenTogether();
            } else {
                alert('CRITICAL ERROR: Fungsi openListenTogether belum dimuat!');
            }
        });
    } else {
        console.error(' Button Listen Together TIDAK DITEMUKAN');
    }
});

// ===== DIAGNOSTIC TOOLS =====
async function checkBucketAccess() {
    console.log(" Checking Supabase bucket access...");
    // Try to access a known public file (album cover)
    const { data } = supabase.storage.from('vidje').getPublicUrl('albumphoto/afgan.png');
    
    try {
        const response = await fetch(data.publicUrl, { method: 'HEAD' });
        console.log(` Bucket Check: ${data.publicUrl} -> Status: ${response.status}`);
        
        if (response.status === 403 || response.status === 400) {
            console.error(" ACCESS DENIED! Supabase Read Policy is missing.");
            alert(" PERHATIAN: Lagu dan Gambar tidak muncul karena Policy 'SELECT' belum aktif di Supabase.\n\nSilakan jalankan perintah SQL 'CREATE POLICY... FOR SELECT' di Supabase Dashboard.");
        } else if (response.status === 404) {
             console.warn(" File check 404 (Mungkin file belum ada, tapi akses publik mungkin OK)");
        } else if (response.status === 200) {
            console.log(" Bucket public access is OK.");
        }
    } catch (e) {
        console.error(" Network check failed:", e);
    }
}

// ===== LOAD SONGS FROM SUPABASE STORAGE (AUTO-DETECT ALL FOLDERS) =====
async function loadSongsFromSupabase() {
    try {
        console.log(' Loading songs from Supabase storage...');
        
        // Step 1: List all folders in vidje bucket
        const { data: folders, error: folderError } = await supabase.storage
            .from('vidje')
            .list('', {
                limit: 100,
                offset: 0
            });

        if (folderError) {
            console.error(' Error listing folders:', folderError);
            return 0;
        }

        console.log(' Found folders:', folders.map(f => f.name).join(', '));

        let loadedCount = 0;
        let currentId = 20000; // Start ID for Supabase songs

        // Step 2: Loop through each folder
        for (const folder of folders) {
            // Skip if it's a file (not a folder)
            if (!folder.id || folder.name.includes('.')) continue;
            
            const folderName = folder.name;
            
            // Skip non-music folders
            if (folderName === 'album photo' || folderName === 'albumphoto' || folderName === 'songs') {
                console.log(` Skipping: ${folderName}`);
                continue;
            }

            console.log(` Processing folder: ${folderName}`);
            
            // Step 3: List all files in this folder
            const { data: musicFiles, error: musicError } = await supabase.storage
                .from('vidje')
                .list(folderName, {
                    limit: 100,
                    offset: 0,
                    sortBy: { column: 'name', order: 'asc' }
                });

            if (musicError) {
                console.error(` Error listing ${folderName}:`, musicError);
                continue;
            }

            if (!musicFiles || musicFiles.length === 0) {
                console.log(` No files in ${folderName}`);
                continue;
            }

            // Step 4: Detect artist name from folder
            const artistName = detectArtistName(folderName);
            
            // Step 5: Get default cover for this artist
            const defaultCover = getDefaultCover(folderName);

            // Step 6: Process each MP3 file
            for (const file of musicFiles) {
                if (!file.name.endsWith('.mp3') && !file.name.endsWith('.MP3')) continue;

                const songId = currentId++;
                
                // Get public URL for music
                const { data: musicUrl } = supabase.storage
                    .from('vidje')
                    .getPublicUrl(`${folderName}/${file.name}`);

                // Extract song title from filename
                const songTitle = cleanSongTitle(file.name);

                // Check for corresponding cover image
                let coverUrl = defaultCover;
                
                const coverFileName = file.name.replace(/\.mp3$/i, '.jpg');
                const { data: coverCheck } = await supabase.storage
                    .from('vidje')
                    .list(folderName);

                if (coverCheck && coverCheck.find(f => f.name.toLowerCase() === coverFileName.toLowerCase())) {
                    const { data: coverUrlData } = supabase.storage
                        .from('vidje')
                        .getPublicUrl(`${folderName}/${coverFileName}`);
                    coverUrl = coverUrlData.publicUrl;
                }

                // Create song object
                const songData = {
                    id: songId,
                    title: songTitle,
                    artist: artistName,
                    album: 'Studio Albums',
                    duration: '3:30',
                    cover: coverUrl,
                    src: musicUrl.publicUrl,
                    storage: 'supabase',
                    isPublic: true
                };

                // Add to songs array if not exists
                if (!songs.find(s => s.src === musicUrl.publicUrl)) {
                    songs.push(songData);
                    loadedCount++;
                    console.log(`   ${songTitle}`);
                }
            }
        }

        console.log(` Successfully loaded ${loadedCount} songs from Supabase!`);
        console.log(` Total songs in library: ${songs.length}`);
        
        return loadedCount;

    } catch (error) {
        console.error(' Error loading songs from Supabase:', error);
        return 0;
    }
}

// Helper: Detect artist name from folder name
function detectArtistName(folderName) {
    const artistMap = {
        'afgan': 'Afgan',
        'astrid': 'Astrid',
        'brunomars': 'Bruno Mars',
        'coldplay': 'Coldplay',
        'danielcaesar': 'Daniel Caesar',
        'edsheeran': 'Ed Sheeran',
        'greenday': 'Green Day',
        'justinbieber': 'Justin Bieber',
        'mahalini': 'Mahalini',
        'oasis': 'Oasis',
        'onedirection': 'One Direction',
        'radiohead': 'Radiohead',
        'taylorswift': 'Taylor Swift',
        'tenxi': 'Tenxi',
        'tulus': 'Tulus'
    };

    return artistMap[folderName.toLowerCase()] || 
           folderName.charAt(0).toUpperCase() + folderName.slice(1);
}

// Helper: Get default cover for artist
function getDefaultCover(folderName) {
    // Perbaikan: Gunakan 'albumphoto' (tanpa spasi) sesuai format URL yang diinginkan user
    // dan generate Full Public URL dari Supabase
    const coverMap = {
        'afgan': 'albumphoto/afgan.png',
        'astrid': 'albumphoto/astrid.webp',
        'brunomars': 'albumphoto/bruno.jpg',
        'coldplay': 'albumphoto/coldplay.jpg',
        'danielcaesar': 'albumphoto/daniel.jpg',
        'edsheeran': 'albumphoto/ed.jpg',
        'greenday': 'albumphoto/greenday.jpg',
        'justinbieber': 'albumphoto/justin.jpg',
        'mahalini': 'albumphoto/mahalini.jpg',
        'oasis': 'albumphoto/oasis.jpg',
        'onedirection': 'albumphoto/onedirection.jpg',
        'radiohead': 'albumphoto/radiohead.jpg',
        'taylorswift': 'albumphoto/taylor.jpg',
        'tenxi': 'albumphoto/tenxi.jpg',
        'tulus': 'albumphoto/tulus.jpg'
    };

    const path = coverMap[folderName.toLowerCase()];
    
    if (path) {
        const { data } = supabase.storage
            .from('vidje')
            .getPublicUrl(path);
        return data.publicUrl;
    }

    return `https://picsum.photos/seed/${folderName}/300/300`;
}

// Helper: Clean song title from filename
function cleanSongTitle(filename) {
    return filename
        .replace(/\.mp3$/i, '')
        .replace(/\.MP3$/i, '')
        .replace(/_/g, ' ')
        .replace(/-/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        // Capitalize first letter of each word
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

  
    </script>
</body>
</html>
