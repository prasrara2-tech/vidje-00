<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Vidje - Musik Platform</title>
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="assets/vidje-icon.jpg">
    <link rel="apple-touch-icon" href="assets/vidje-icon.jpg">
    <meta name="theme-color" content="#e50914">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vidje">
    <!-- Prevent zoom on input focus (mobile) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
<!-- SELESAI BAGIAN 1! -->
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-black: #000000;
            --bg-dark: #121212;
            --bg-card: #181818;
            --bg-card-hover: #282828;
            --primary-red: #e50914;
            --primary-red-hover: #ff1f2c;
            --text-white: #ffffff;
            --text-gray: #b3b3b3;
            --border-color: #333;
            --player-height: 90px;
            --mobile-nav-height: 0px;
            --sidebar-width: 240px;
            --header-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* --- BACK BUTTON STYLE --- */
        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            transition: color 0.2s ease;
            padding: 8px 8px;
            width: 44px;
            height: 44px;
        }
        
        .back-button:hover {
            color: var(--primary-red);
        }
        
        .back-button-text {
            display: none;
        }

        /* Mobile back button positioning */
        @media (max-width: 768px) {
            .back-button[style*="position: absolute"] {
                top: 8px !important;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-black);
            color: var(--text-white);
            height: 100vh;
            overflow: hidden;
            padding-bottom: calc(var(--player-height) + var(--mobile-nav-height));
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Mobile bottom navigation (hidden by default) */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            left: 12px;
            right: 12px;
            bottom: calc(var(--player-height, 72px) + 10px);
            height: 56px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.25));
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 20010;
            align-items: center;
            justify-content: space-around;
            gap: 6px;
            padding: 6px 10px;
            backdrop-filter: blur(6px);
        }

        .mobile-bottom-nav .mb-nav-item {
            color: var(--text-gray);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            gap: 4px;
            width: 72px;
        }

        .mobile-bottom-nav .mb-nav-item i { font-size: 20px; }
        .mobile-bottom-nav .mb-nav-item.active { color: var(--primary-red); }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.25s ease;
            will-change: opacity;
        }
        .loader {
            display: none; /* hidden when using centered logo */
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-text { display: none; }

        @keyframes dots {
            0% { opacity: 0.18 }
            50% { opacity: 1 }
            100% { opacity: 0.18 }
        }

        @keyframes logo-pulse {
            0% { transform: scale(1) }
            100% { transform: scale(1.06) }
        }

        /* Centered loading logo + title */
        .loading-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 10px;
        }
        .loading-center .logo { display:flex; align-items:center; justify-content:center; }
        .app-logo { display:inline-block; }
        .centered-logo { width: 240px; height: auto; }
        .logo .app-logo { width: 34px; height: 34px; margin-right:8px; }
        .loading-center .loading-title { font-size: 44px; font-weight: 900; color: #fff; letter-spacing: -1px; }

        /* --- AUTH VIEW --- */
        #auth-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
        }
        .auth-box {
            background-color: rgba(40, 40, 40, 0.8);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        .auth-logo { font-size: 48px; color: var(--primary-red); margin-bottom: 10px; }
        .auth-box h2 { margin-top: 10px; font-size: 32px; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .auth-box p { color: var(--text-gray); margin-bottom: 20px; }
        .auth-input {
            width: 100%; padding: 14px; margin: 8px 0;
            border-radius: 8px; border: 1px solid #444;
            background-color: #000; color: white;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--primary-red); }
        .auth-btn {
            width: 100%; padding: 14px; margin-top: 20px;
            border-radius: 50px; border: none;
            background-color: var(--primary-red);
            color: white; font-weight: 700; font-size: 16px;
            cursor: pointer; transition: 0.2s;
        }
        .auth-btn:hover { background-color: var(--primary-red-hover); transform: scale(1.02); }
        .auth-switch { margin-top: 20px; font-size: 14px; color: var(--text-gray); }
        .auth-switch span { color: white; cursor: pointer; font-weight: 600; }
        .auth-switch span:hover { text-decoration: underline; }
        .error-msg { color: var(--primary-red); font-size: 13px; margin-top: 10px; display: none; }

        /* --- APP LAYOUT --- */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .container {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--player-height));
            overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-black);
            display: flex;
            flex-direction: column;
            padding: 24px 12px;
            gap: 24px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 20000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .logo i { font-size: 32px; color: var(--primary-red); }
        .logo span { font-family: 'Montserrat', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: -1px; }

        /* Language Switcher */
        .language-switcher {
            display: flex;
            gap: 3px;
            padding: 6px 12px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        /* Hide language switcher on mobile */
        @media (max-width: 768px) {
            .language-switcher {
                display: none;
            }
        }
        
        .lang-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: var(--text-gray);
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        .lang-btn:hover {
            color: var(--primary-red);
            border-color: var(--primary-red);
            background: rgba(229, 9, 20, 0.1);
        }
        .lang-btn.active {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            font-weight: 700;
        }

        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 16px;
            border-radius: 4px;
            color: var(--text-gray);
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s, background 0.3s;
            text-decoration: none;
        }
        .nav-item:hover, .nav-item.active { color: var(--text-white); background-color: var(--bg-card-hover); }
        .nav-item i { font-size: 24px; }
        .divider { height: 1px; background-color: #282828; margin: 0 12px; }

        .playlist-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .playlist-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-gray); margin-bottom: 12px; padding-left: 12px; }
        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-gray);
            padding: 8px 12px;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            border-radius: 4px;
            position: relative;
            z-index: 10;
            min-width: 0; /* Enable text truncation in flex containers */
        }
        
        .playlist-item-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .playlist-item:hover { color: var(--text-white); background-color: rgba(255,255,255,0.05); }
        .playlist-thumb {
            width: 48px; height: 48px;
            border-radius: 4px;
            background: #333;
            object-fit: cover;
            flex-shrink: 0;
        }
        .create-playlist-btn {
            color: var(--text-gray);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
            /* Make full-width and consistent spacing on wider screens */
            width: calc(100% - 24px);
            box-sizing: border-box;
        }
        .create-playlist-btn:hover { color: var(--text-white); background-color: rgba(255,255,255,0.05); }

        /* --- FRIENDS SECTION IN SIDEBAR --- */
        .friend-section {
            margin-top: 20px;
            border-top: 1px solid #282828;
            padding-top: 20px;
        }
        .friend-search-container { position: relative; padding: 0 12px 10px 12px; }
        .friend-search-input {
            width: 100%;
            background: #282828;
            border: 1px solid #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }
        .friend-search-dropdown {
            position: absolute;
            top: 35px;
            left: 12px;
            right: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .friend-dropdown-item {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .friend-dropdown-item:last-child { border-bottom: none; }
        .friend-dropdown-item:hover { background: #444; }
        
        .friend-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
        }
        .friend-list-item:hover { background-color: rgba(255,255,255,0.1); }
        .friend-avatar-small {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover;
        }
        .friend-name { font-size: 13px; color: var(--text-white); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .request-actions {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .btn-icon-small {
            background: none; border: none; color: white; cursor: pointer;
            padding: 4px; border-radius: 4px;
        }
        .btn-accept { color: #1db954; }
        .btn-reject { color: var(--primary-red); }
        .btn-icon-small:hover { opacity: 0.8; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            background: linear-gradient(180deg, #222222 0%, var(--bg-dark) 40%);
            overflow-y: auto;
            border-radius: 8px;
            margin: 8px 8px 0 0;
            position: relative;
            width: 100%;
        }
        header {
            position: sticky;
            top: 0;
            background-color: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .mobile-menu-toggle:hover { background-color: rgba(255,255,255,0.1); }

        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 60000; /* sit above player bar and overlays */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .user-menu { background-color: rgba(0,0,0,0.7); padding: 4px; padding-right: 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; }
        .user-menu:hover { background-color: #282828; }
        .user-menu img { width: 28px; height: 28px; border-radius: 50%; }
        .content-padding { padding: 24px 32px; padding-bottom: 40px; }
        h2 { font-size: 24px; margin-bottom: 20px; margin-top: 10px; }

        /* --- VIEWS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; margin-bottom: 40px; }
        
        .horizontal-scroll-grid {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 20px; 
            margin-bottom: 40px;
            scroll-behavior: smooth;
            -ms-overflow-style: none;  
            scrollbar-width: none; 
        }
        .horizontal-scroll-grid::-webkit-scrollbar { display: none; }
        .horizontal-scroll-grid .song-card { min-width: 180px; flex: 0 0 auto; }

        /* Show a thin visible horizontal scrollbar on laptop/desktop */
        @media (min-width: 769px) {
            /* Keep scrolling behavior but hide OS scrollbar on desktop */
            .horizontal-scroll-grid {
                -ms-overflow-style: none; /* IE */
                scrollbar-width: none; /* Firefox */
            }
            .horizontal-scroll-grid::-webkit-scrollbar { display: none; height: 0; }
        }

        .song-card { background-color: var(--bg-card); padding: 16px; border-radius: 6px; transition: background-color 0.3s ease; cursor: pointer; position: relative; }
        .song-card:hover { background-color: var(--bg-card-hover); }
        
        .card-img-wrapper { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 1/1; 
            margin-bottom: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
            border-radius: 4px; 
            overflow: hidden; 
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card-img-wrapper img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: center; 
            transition: transform 0.3s ease;
        }
        
        .play-btn-overlay { position: absolute; bottom: 8px; right: 8px; width: 48px; height: 48px; border-radius: 50%; background-color: var(--primary-red); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 8px rgba(0,0,0,0.3); opacity: 0; transform: translateY(8px); transition: all 0.3s ease; z-index: 5;}
        .song-card:hover .play-btn-overlay { opacity: 1; transform: translateY(0); }
        .card-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-desc { font-size: 14px; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* FIXED ALIGNMENT FOR SONG LIST */
        .song-list-header { 
            display: grid; 
            grid-template-columns: 50px 4fr 3fr 1fr 120px; 
            padding: 10px 16px 10px 16px; 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-gray); 
            text-transform: uppercase; 
            font-size: 12px; 
            letter-spacing: 1px; 
            align-items: center; 
        }
        .song-row { 
            display: grid; 
            grid-template-columns: 50px 4fr 3fr 1fr 120px; 
            padding: 10px 16px; 
            border-radius: 4px; 
            align-items: center; 
            color: var(--text-gray); 
            font-size: 14px; 
            cursor: pointer;
            position: relative;
            overflow: visible;
        }
        .song-row:hover { background-color: rgba(255,255,255,0.1); }
        .song-row.playing { color: var(--primary-red); }
        /* Stronger visual cue for playing rows (used in profile and lists) */
        .song-row.playing {
            box-shadow: inset 4px 0 0 var(--primary-red);
            background: linear-gradient(90deg, rgba(229,9,20,0.04), transparent 60%);
        }
        .song-info { display: flex; align-items: center; gap: 12px; min-width: 0; flex: 1; }
        .song-info img { width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0; }
        .song-info > div { display: flex; flex-direction: column; min-width: 0; flex: 1; }
        .song-title-text {
            color: var(--text-white);
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-artist {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ANIMATED EQUALIZER (FIXED FOR PAUSE) */
        .playing-icon-container {
            display: none; /* Hidden by default */
            gap: 2px;
            height: 16px;
            align-items: center;
        }
        
        /* Ensure visible when playing */
        .song-row.playing .playing-icon-container {
            display: flex;
        }
        
        .bar {
            width: 3px;
            background-color: var(--primary-red);
            animation: bounce 0.5s infinite ease-in-out;
        }
        .bar:nth-child(1) { animation-delay: 0.1s; height: 5px; }
        .bar:nth-child(2) { animation-delay: 0.2s; height: 10px; }
        .bar:nth-child(3) { animation-delay: 0.3s; height: 8px; }
        .bar:nth-child(4) { animation-delay: 0.0s; height: 12px; }
        
        @keyframes bounce {
            0%, 100% { height: 3px; }
            50% { height: 16px; }
        }
        
        /* Marquee/Running Text Animation for Long Titles */
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        @keyframes marquee-reverse {
            0% { transform: translateX(100%); }
            100% { transform: translateX(0); }
        }
        
        .song-actions { display: flex; justify-content: flex-end; gap: 12px; position: relative; z-index: 100; }
        .song-actions-menu { position: relative; z-index: 101; }
        .more-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .more-btn:hover { color: white; }
        
        .list-like-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .list-like-btn:hover { color: white; }
        .list-like-btn.liked { color: var(--primary-red); }

        .share-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .share-btn:hover { color: white; }
        
        .queue-add-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .queue-add-btn:hover { color: white; }

        /* Song Actions Menu Dropdown */
        .song-menu-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
            border-radius: 4px;
        }

        .song-menu-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .song-menu-dropdown {
            position: absolute;
            top: auto;
            bottom: 100%;
            right: -16px;
            background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 50%, #1f1f1f 100%);
            border: 1px solid rgba(229, 9, 20, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 200px;
            z-index: 2000;
            overflow: hidden;
            margin-bottom: 12px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .song-menu-dropdown:hover {
            border-color: rgba(229, 9, 20, 0.4);
            box-shadow: 0 12px 40px rgba(229, 9, 20, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        @media (max-width: 768px) {
            .song-menu-dropdown {
                position: absolute !important;
                top: auto !important;
                bottom: 100% !important;
                right: -16px !important;
                left: auto !important;
                width: auto !important;
                max-width: 220px !important;
                height: auto !important;
                border-radius: 12px !important;
                margin: 0 0 12px 0 !important;
                z-index: 9999 !important;
                background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 50%, #1f1f1f 100%);
                border: 1px solid rgba(229, 9, 20, 0.25);
                box-shadow: 0 12px 40px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                transform: none !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: none !important;
                opacity: 1 !important;
                padding: 0 !important;
                min-width: 200px !important;
                backdrop-filter: blur(10px);
            }
            .song-menu-dropdown.active-slide {
                display: block !important;
                opacity: 1 !important;
                animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(8px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }
                    <script>
                    // Dropdown mobile: selalu muncul di atas playbar, dan visible
                    function adjustDropdownPosition(e) {
                        var allMenus = document.querySelectorAll('.song-menu-dropdown');
                        allMenus.forEach(function(menu) {
                            menu.classList.remove('higher-mobile');
                            if(window.innerWidth <= 600 && menu.style.display !== 'none') {
                                menu.style.display = 'block';
                                menu.style.opacity = '1';
                            }
                        });
                        if(window.innerWidth <= 600 && e && e.target && e.target.closest && e.target.closest('.song-menu-btn')) {
                            var btn = e.target.closest('.song-menu-btn');
                            var rect = btn.getBoundingClientRect();
                            if(rect.bottom > window.innerHeight - 220) {
                                setTimeout(function() {
                                    var openMenu = btn.parentElement.querySelector('.song-menu-dropdown');
                                    if(openMenu && openMenu.style.display !== 'none') {
                                        openMenu.classList.add('higher-mobile');
                                    }
                                }, 50);
                            }
                        }
                    }
                    document.addEventListener('click', adjustDropdownPosition, true);
                    window.addEventListener('resize', function(){
                        var allMenus = document.querySelectorAll('.song-menu-dropdown');
                        allMenus.forEach(function(menu) {
                            menu.classList.remove('higher-mobile');
                            if(window.innerWidth <= 600 && menu.style.display !== 'none') {
                                menu.style.display = 'block';
                                menu.style.opacity = '1';
                            }
                        });
                    });
                    </script>

        .menu-item {
            width: 100%;
            padding: 14px 18px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(229, 9, 20, 0.08);
            position: relative;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, rgba(229, 9, 20, 0.8), rgba(229, 9, 20, 0));
            opacity: 0;
            transition: opacity 0.2s;
        }

        .menu-item:hover {
            background: rgba(229, 9, 20, 0.08);
            padding-left: 22px;
        }

        .menu-item:hover::before {
            opacity: 1;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .song-menu-dropdown {
            position: absolute;
            top: auto;
            bottom: 100%;
            right: -16px;
            background: #1f1f1f;
            border: 1px solid rgba(229, 9, 20, 0.15);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            transition: all 0.2s ease;
            min-width: 200px;
            z-index: 2000;
            overflow: hidden;
            margin-bottom: 8px;
            display: none;
        }

        .dropdown-cover {
    display: none !important;
}

.dropdown-cover-img {
    display: none !important;
}

        @media (max-width: 1024px) {
            .dropdown-cover {
                display: block !important;
                width: 100% !important;
                height: 140px !important;
                overflow: hidden !important;
            }
            .dropdown-cover-img {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
            }
            .song-menu-dropdown {
                position: absolute !important;
                top: auto !important;
                bottom: 100% !important;
                right: -16px !important;
                left: auto !important;
                width: auto !important;
                max-width: 200px !important;
                height: auto !important;
                border-radius: 8px !important;
                margin: 0 0 8px 0 !important;
                z-index: 9999 !important;
                background: #1f1f1f;
                border: 1px solid rgba(229, 9, 20, 0.15);
                box-shadow: 0 8px 24px rgba(0,0,0,0.6);
                transform: none !important;
                transition: all 0.2s ease;
                display: none !important;
                opacity: 1 !important;
                padding: 0 !important;
                min-width: 180px !important;
            }
            .song-menu-dropdown.active-slide {
                display: block !important;
                opacity: 1 !important;
            }
            .dropdown-cover {
                display: block !important;
            }
        }

        .menu-item {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(229, 9, 20, 0.08);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(229, 9, 20, 0.1);
        }

        .menu-emoji {
            display: inline-block;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .menu-item i {
            font-size: 20px;
            flex-shrink: 0;
            color: var(--text-gray);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: color 0.2s ease;
        }

        .menu-item:hover i {
            color: var(--primary-red);
        }

        .menu-item span {
            flex: 1;
        }

            .icon-fallback {
                display: inline-block;
                min-width: 20px;
                min-height: 20px;
                text-align: center;
                font-size: 18px;
                line-height: 1.2;
                vertical-align: middle;
                color: var(--text-gray);
            }

        @media (max-width: 768px) {
            .song-menu-dropdown {
                min-width: 180px;
                left: 50%;
                right: auto;
                transform: translateX(-60%);
                bottom: 110%;
                margin-bottom: 12px;
            }

            .menu-emoji {
                font-size: 20px;
                width: 26px;
                height: 26px;
            }

            .menu-item {
                padding: 12px 14px;
                font-size: 14px;
                gap: 12px;
                min-height: 44px;
            }

            .menu-item i {
                font-size: 22px;
                width: 26px;
                height: 26px;
            }

            .menu-item span {
                flex: 1;
            }
        }

        .menu-item span {
            flex: 1;
        }

        /* Search */
        .search-container { max-width: 500px; margin: 0 auto 40px auto; position: relative; }
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: 50px;
            border: none;
            background-color: #fff;
            color: #000;
            font-size: 16px;
            outline: none;
        }
        .search-icon-placeholder { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #121212; font-size: 20px; }
        
        /* --- OVERLAY PLAYER --- */
        #overlay-player {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 30000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        #overlay-player.active { opacity: 1; visibility: visible; }

        .overlay-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(40px) brightness(0.3);
            z-index: -1;
            transform: scale(1.2); /* Prevent white edges */
        }

        .overlay-content {
            width: 100%;
            max-width: 500px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            height: 100%;
            justify-content: center;
        }

        .overlay-close-btn {
            position: absolute;
            top: 20px; left: 20px;
            background: none; border: none; color: white;
            font-size: 32px; cursor: pointer;
            z-index: 10;
        }

        .overlay-art-wrapper {
            width: 380px; height: 380px;
            max-width: 80vw; max-height: 80vw;
            margin-bottom: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay-art-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .overlay-info {
            width: 100%;
            max-width: 500px;
            padding: 0 20px;
            overflow: hidden;
        }
        
        .overlay-info h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .overlay-info h2.marquee {
            animation: marquee 20s linear infinite;
            width: max-content;
            text-overflow: clip;
            padding-left: 100%;
        }
        
        .overlay-info p {
            font-size: 18px;
            color: #b3b3b3;
            margin-bottom: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
        }
        
        .overlay-info p.marquee {
            animation: marquee 25s linear infinite;
            width: max-content;
            text-overflow: clip;
            padding-left: 100%;
        }

        .overlay-controls {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }
            .overlay-controls button {
                background: none; border: none; color: white;
                font-size: 32px; cursor: pointer; transition: 0.2s;
            }

            .mobile-bottom-nav .mb-nav-item span { font-size: 11px; }
        .overlay-controls button.active { color: var(--primary-red); }
        .overlay-controls button:hover { transform: scale(1.1); color: var(--primary-red); }
        /* Hide overlay shuffle/repeat icons (remove these controls from overlay player) */
        #overlay-shuffle-icon, #overlay-repeat-icon { display: none !important; }
        .overlay-play-btn {
            width: 80px; height: 80px;
            background-color: white !important;
            color: black !important;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px !important;
        }
        .overlay-play-btn:hover { transform: scale(1.05) !important; background-color: #ddd !important; }

        .overlay-progress-container { width: 100%; margin-bottom: 20px; cursor: pointer; }
        .overlay-progress-bar { width: 100%; height: 4px; background: #555; border-radius: 2px; position: relative; }
        .overlay-progress-fill { height: 100%; background: white; border-radius: 2px; width: 0%; position: absolute; top: 0; left: 0; }
        .overlay-time { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 12px; color: #b3b3b3; }

        /* Mobile bottom navigation (hidden by default) */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            left: 12px;
            right: 12px;
            bottom: calc(var(--player-height, 72px) + 10px);
            height: 56px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.25));
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 20010;
            align-items: center;
            justify-content: space-around;
            gap: 6px;
            padding: 6px 10px;
            backdrop-filter: blur(6px);
        }

        .mobile-bottom-nav .mb-nav-item {
            color: var(--text-gray);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            gap: 4px;
            width: 72px;
        }

        .mobile-bottom-nav .mb-nav-item i { font-size: 20px; }
        .mobile-bottom-nav .mb-nav-item.active { color: var(--primary-red); }

        /* Search Results & History Areas */
        #search-results-wrapper {
            display: none; /* Hidden by default, shown on search */
            margin-bottom: 40px;
        }
        .results-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: white;
        }
        
        #search-history-wrapper {
            display: block; /* Visible by default */
        }
        .history-section-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 16px; 
            display: block; 
        }

        /* Playlist/Album View */
        .playlist-header-view { 
            display: flex; 
            align-items: flex-end; 
            gap: 24px; 
            padding: 60px 32px 40px 32px; 
            background: linear-gradient(180deg, #530000 0%, var(--bg-dark) 100%); 
            border-radius: 0;
            transition: background 0.5s ease;
            position: relative;
        }
        .playlist-cover-big { 
            width: 232px; height: 232px; 
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
            object-fit: cover; 
            flex-shrink: 0;
        }
        .edit-cover-btn {
            position: absolute;
            bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .playlist-cover-wrap:hover .edit-cover-btn { opacity: 1; }

        .playlist-info-big h1 { font-size: 3.5rem; font-weight: 900; line-height: 1.1; margin: 10px 0; letter-spacing: -1px; color: var(--text-white); }
        .playlist-info-big span { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-gray); }
        .playlist-meta { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-gray); margin-top: 8px; }
        .playlist-actions { display: flex; align-items: center; gap: 32px; padding: 20px 32px 24px 32px; border-top: 1px solid var(--border-color); }
        .action-play-btn { width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-red); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 8px 16px rgba(229,9,20,0.3); }
        .action-play-btn:hover { transform: scale(1.08); background-color: var(--primary-red-hover); }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: var(--player-height);
            background-color: var(--bg-card);
            border-top: 1px solid #282828;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20000;
        }

        /* On larger screens keep player-bar to the right of the sidebar */
        @media (min-width: 769px) {
            .player-bar {
                left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
            }
        }

        /* Make import button align perfectly under create playlist */
        @media (min-width: 769px) {
            .create-playlist-btn, .import-music-btn {
                padding: 10px 14px;
                border-radius: 6px;
                margin-left: 6px;
                margin-right: 6px;
            }
            .import-music-btn { margin-top: 8px; }
        }
        
        .player-left { 
            display: flex; 
            align-items: center; 
            width: 30%; 
            gap: 14px; 
            overflow: hidden; /* Ensure text doesn't spill out */
        }
        .current-art { width: 56px; height: 56px; border-radius: 4px; background-color: #333; object-fit: cover; flex-shrink: 0; }
        .current-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; flex: 1; }
        .current-title { font-size: 14px; color: var(--text-white); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .current-title:hover { text-decoration: underline; }
        .current-artist { font-size: 12px; color: var(--text-gray); cursor: pointer; white-space: nowrap; }
        .current-artist:hover { text-decoration: underline; color: var(--text-white); }

        /* === ARTIST PROFILE OVERLAY === */
        .artist-profile-overlay-container {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            width: calc(100% - var(--sidebar-width));
            height: 100%;
            background: var(--bg-dark);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .artist-profile-overlay-container.active {
            display: flex;
        }

        @media (max-width: 768px) {
            .artist-profile-overlay-container {
                left: 0;
                width: 100%;
            }
        }

        .artist-profile-header-top {
            padding: 24px 32px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(83, 0, 0, 0.3) 0%, transparent 100%);
            position: sticky;
            top: 0;
            z-index: 10001;
        }

        .artist-profile-back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            border-radius: 50%;
        }

        .artist-profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--primary-red);
        }

        .artist-profile-content {
            padding: 32px;
            flex: 1;
        }

        .artist-profile-section-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Marquee Styles */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        .marquee-content {
            display: inline-block;
            white-space: nowrap;
            animation: marquee-scroll 15s linear infinite;
        }
        .marquee-content span {
            display: inline-block;
            padding-right: 50px;
        }
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .like-btn { 
            color: var(--text-gray); 
            background: none; 
            border: none; 
            cursor: pointer; 
            margin-left: 16px; 
            font-size: 20px; 
            transition: all 0.2s ease;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            width: 24px;
            height: 24px;
        }
        
        .like-btn:hover { color: var(--text-white); transform: scale(1.1); }
        .like-btn.liked { color: var(--primary-red) !important; }
        .like-btn.liked:hover { color: #ff4d5a !important; }
        
        .player-center { display: flex; flex-direction: column; align-items: center; width: 40%; gap: 8px; }
        .player-controls { display: flex; align-items: center; gap: 20px; }
        .control-btn { background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 20px; transition: color 0.2s; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { color: var(--text-white); }
        .control-btn.active { color: var(--primary-red); }
        .play-pause-btn { width: 32px; height: 32px; background-color: var(--text-white); border-radius: 50%; color: black; font-size: 20px; transition: transform 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); color: black; }
        .playback-bar { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-gray); }
        .progress-container { flex: 1; height: 4px; background-color: #555; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background-color: var(--text-white); border-radius: 2px; width: 0%; }
        .progress-container:hover .progress-fill { background-color: var(--primary-red); }

        .player-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 12px; }
        .volume-bar-container { width: 100px; height: 4px; background-color: #555; border-radius: 2px; cursor: pointer; }
        .volume-fill { width: 70%; height: 100%; background-color: var(--text-white); border-radius: 2px; }

        /* --- QUEUE OVERLAY (NEW) --- */
        #queue-overlay {
            position: fixed;
            top: 0; right: 0; bottom: 90px; /* Above player bar */
            width: 400px;
            background-color: var(--bg-black);
            z-index: 2900;
            display: none;
            flex-direction: column;
            border-left: 1px solid #333;
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #queue-overlay.open { display: flex; }

        .queue-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .queue-title { font-weight: 700; font-size: 16px; }
        .queue-close-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 24px; }

        .queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .queue-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 12px;
            border-radius: 4px;
            cursor: grab;
            background: transparent;
        }
        .queue-item:active { cursor: grabbing; }
        .queue-item:hover { background-color: rgba(255,255,255,0.1); }
        .queue-item.dragging { opacity: 0.5; background: #333; }
        
        .queue-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .queue-info { flex: 1; overflow: hidden; }
        .queue-title { font-size: 14px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-artist { font-size: 12px; color: #aaa; }
        .queue-remove { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; padding: 5px; }
        .queue-remove:hover { color: var(--primary-red); }

        /* --- NEW PROFILE VIEW (SPOTIFY STYLE) --- */
        #view-profile {
            padding: 0; 
        }
        
        .profile-hero-section {
            display: flex;
            align-items: flex-end;
            gap: 24px;
            padding: 20px 32px;
            background: linear-gradient(180deg, #222 0%, var(--bg-dark) 100%);
            min-height: 300px;
            transition: background 0.5s ease;
        }

        .profile-avatar-lg {
            width: 230px;
            height: 230px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 60px rgba(0,0,0,0.5);
            border: 4px solid rgba(0,0,0,0.3);
        }

        .profile-hero-content {
            flex: 1;
            margin-bottom: 10px;
        }

        .profile-type-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .profile-name-large {
            font-size: 6rem; 
            font-weight: 900;
            line-height: 1;
            margin: 10px 0;
            letter-spacing: -2px;
            word-wrap: break-word;
        }

        .profile-bio-display {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            margin-top: 8px;
            max-width: 600px;
            line-height: 1.4;
        }

        /* User ID Display */
        .profile-userid-display {
            margin-top: 12px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: monospace;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .profile-userid-display:hover { background: rgba(255,255,255,0.2); }
        .copy-id-icon { font-size: 18px; color: var(--primary-red); }

        .profile-actions {
            padding: 24px 32px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-circle-blue {
            width: 48px; height: 48px; border-radius: 50%; background-color: #1db954; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn-circle-blue:hover { transform: scale(1.05); background-color: #1ed760; }

        .btn-pill {
            padding: 8px 24px;
            border-radius: 20px;
            border: 1px solid #777;
            color: white;
            background: transparent;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-pill:hover { border-color: white; transform: scale(1.04); }

        /* Edit Panel (Slide Down) */
        .profile-edit-panel {
            background-color: #282828;
            margin: 0 32px 32px 32px;
            padding: 24px;
            border-radius: 8px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        .profile-edit-panel.active { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .edit-grid {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        .edit-avatar-wrapper {
            width: 150px; height: 150px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            background: #000;
        }
        .edit-avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .edit-avatar-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: 0.2s;
        }
        .edit-avatar-wrapper:hover .edit-avatar-overlay { opacity: 1; }
        
        .edit-form { flex: 1; display: flex; flex-direction: column; gap: 16px; }
        .edit-input {
            width: 100%; padding: 12px; border-radius: 4px; border: none;
            background: #3e3e3e; color: white; font-family: 'Inter', sans-serif;
        }
        .edit-input:focus { outline: 2px solid #555; }
        
        .edit-actions-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px; }
        .btn-cancel { background: transparent; color: white; border: none; padding: 10px 24px; cursor: pointer; font-weight: 700; }
        .btn-save { background: var(--primary-red); color: white; border: none; padding: 10px 24px; border-radius: 20px; cursor: pointer; font-weight: 700; }
        .btn-save:hover { background: var(--primary-red-hover); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 30000; /* above player-bar */
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background-color: #282828;
            width: 90%;
            max-width: 450px; 
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            position: relative;
            max-height: calc(100vh - 160px); /* avoid being hidden behind UI */
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-modal-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-input {
            width: 100%; padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px; border: 1px solid #444;
            background: #121212; color: white;
            outline: none;
        }
        .modal-input:focus { border-color: var(--primary-red); }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary-red); color: white; border: none; border-radius: 50px; font-weight: 700; cursor: pointer; }
        .modal-btn:hover { background: var(--primary-red-hover); }
        .playlist-select-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .playlist-select-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-radius: 6px; }
        .playlist-select-item:hover { background: #333; }

        .section-title-profile { font-size: 24px; font-weight: 700; margin: 32px 32px 20px 32px; }
        .playlist-modal-grid-profile { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 24px;
            padding: 0 32px 60px 32px;
        }

        /* --- CHAT SYSTEM OVERLAY --- */
        #chat-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-black);
            z-index: 100001; /* sit above all other app elements */
            display: none; /* Hidden by default */
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        #chat-overlay.active { display: flex; }

        .chat-header {
            padding: calc(12px + env(safe-area-inset-top, 0)) 16px 16px;
            background-color: #121212;
            border-bottom: 1px solid #282828;
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 56px;
            height: auto;
            box-sizing: border-box;
        }
        .chat-back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .chat-friend-info { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; }
        .chat-friend-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-friend-name {
            font-weight: 700;
            font-size: 16px;
            line-height: 1.1;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
        }
        .chat-status { font-size: 12px; color: var(--text-gray); }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 12px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
            transition: transform 0.2s;
            user-select: none;
        }
        
        .msg-sent {
            align-self: flex-end;
            background-color: var(--primary-red);
            color: white;
            border-bottom-right-radius: 2px;
        }
        
        .msg-received {
            align-self: flex-start;
            background-color: #282828;
            color: white;
            border-bottom-left-radius: 2px;
        }

        .msg-time {
            font-size: 10px;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .msg-reply-indicator {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            border-left: 2px solid rgba(255,255,255,0.3);
            padding-left: 8px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Shared Content in Chat */
        .chat-shared-card {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .chat-shared-card:hover { background: rgba(255,255,255,0.05); }
        .chat-shared-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .chat-shared-info { display: flex; flex-direction: column; }
        .chat-shared-title { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-shared-sub { font-size: 11px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-footer {
            padding: 15px;
            background-color: #121212;
            border-top: 1px solid #282828;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            background: #282828;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            outline: none;
        }
        .chat-send-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 20px;
            flex-shrink: 0; 
            transition: background 0.2s; 
        }

        .chat-send-btn:hover {
            background: var(--primary-red-hover); 
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95); 
        }

        /* --- CONTEXT MENU --- */
        #context-menu {
            position: absolute;
            background: #282828;
            border: 1px solid #444;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 5000;
            display: none;
            flex-direction: column;
            min-width: 120px;
        }
        .ctx-item {
            padding: 10px 15px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }
        .ctx-item:hover { background: var(--primary-red); }
        .ctx-separator { height: 1px; background: #444; margin: 2px 0; }

        /* --- FRIEND PROFILE OVERLAY --- */
        #friend-profile-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-black);
            z-index: 100003;
            display: none;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        #friend-profile-overlay.active { display: block; }

       @media (max-width: 768px) {
    .nav-arrows { display: none; }

    .sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        height: 100vh;
        width: 280px;
        background-color: var(--bg-black);
        padding: 24px 12px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            z-index: 60010; /* ensure sidebar sits above overlay and player */
    }
    .sidebar.active { left: 0; }
    .mobile-menu-toggle { display: block; }

    .main-content {
        margin-left: 0;
        padding-bottom: 20px;
    }
    header { padding: 12px 16px; }
    .content-padding { padding: 16px; }

    /* Mobile Profile */
    .profile-hero-section { flex-direction: column; align-items: center; text-align: center; gap: 16px; padding-top: 40px; }
    .profile-avatar-lg { width: 180px; height: 180px; }
    .profile-name-large { font-size: 2.5rem; }
    .profile-actions { justify-content: center; }
    .edit-grid { flex-direction: column; align-items: center; }
    .edit-form { width: 100%; }

    .playlist-header-view { flex-direction: column; align-items: flex-start; background: linear-gradient(180deg, #530000 0%, var(--bg-dark) 100%); }
    .playlist-cover-big { width: 160px; height: 160px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .playlist-info-big h1 { font-size: 2.5rem; line-height: 1.1; }
    .playlist-actions { padding: 0 0 20px 0; width: 100%; justify-content: flex-start; gap: 20px; }

    .song-list-header, .song-row { grid-template-columns: 40px 1fr 40px; padding: 12px 16px; }
    .song-list-header div:nth-child(3), .song-list-header div:nth-child(4), .song-row div:nth-child(3), .song-row div:nth-child(4) { display: none; }
    .song-index { display: flex; align-items: center; justify-content: center; }

/* === PERBAIKAN CSS PLAYER BAR MOBILE (REPLACE SEMUA MEDIA QUERY MOBILE ANDA) === */
/* --- PERBAIKAN PLAYER BAR MOBILE (FULL FITUR) --- */
@media (max-width: 768px) {
    /* --- SIDEBAR MOBILE STYLES --- */
    .logo {
        justify-content: center;
        flex-direction: column;
        gap: 6px;
        padding: 12px;
        margin-bottom: 16px;
        margin-top: 8px;
    }
    
    /* Mobile Language Dropdown */
    .language-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #1a1a1a;
        border: 1px solid var(--primary-red);
        border-radius: 8px;
        margin-top: 8px;
        z-index: 100;
    }
    
    .language-dropdown.active {
        display: flex;
        flex-direction: column;
    }
    
    .language-dropdown button {
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: white;
        cursor: pointer;
        text-align: left;
        font-weight: 600;
        transition: 0.2s;
    }
    
    .language-dropdown button:hover {
        background: rgba(229, 9, 20, 0.2);
    }
    
    .language-dropdown button.active {
        color: var(--primary-red);
        background: rgba(229, 9, 20, 0.1);
    }
    
    /* Show mobile language section only on mobile */
    .mobile-language-section {
        display: block !important;
    }
    
    .logo .app-logo {
        display: none !important;
    }
    
    .logo span {
        font-size: 18px;
        margin-left: 0 !important;
    }

    /* Language Switcher Mobile */
    .language-switcher {
        padding: 5px 8px;
        margin-bottom: 12px;
        gap: 2px;
    }
    .lang-btn {
        padding: 5px 8px;
        font-size: 10px;
    }

    /* --- 1. ATURAN UMUM PLAYER BAR --- */
    .player-bar {
        height: 90px; /* Pastikan tinggi konsisten */
        padding: 0 10px; /* Kurangi padding horizontal biar muat banyak tombol */
    }

    /* --- 2. BAGIAN KIRI (Cover & Info) --- */
    .player-left {
        width: 35%; /* Perkecil jadi 35% */
        flex-shrink: 0; /* Jangan mengecilkan */
    }
    
    /* Sembunyikan Like Button di mobile biar judul tidak gepeng */
    .player-left .like-btn {
        display: none !important; 
    }

    /* Styling Judul Lagu agar rapi jika panjang */
    .current-title {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        margin-right: 5px;
    }
    
    .current-artist {
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- 3. BAGIAN TENGAH (Prev, Play, Next, Shuffle, Repeat) --- */
    .player-center {
        width: 40%; /* Beri ruang lebih lebar */
        flex-shrink: 1;
    }

    /* Munculkan & Styling tombol inti (Prev, Play, Next) */
    .player-center .control-btn:nth-child(1), /* Prev */
    .player-center .control-btn:nth-child(2), /* Play/Pause */
    .player-center .control-btn:nth-child(3) { /* Next */
        display: flex !important;
        justify-content: center;
        align-items: center;
        font-size: 24px; /* Ukuran jelas */
        padding: 0;
    }

    /* Styling khusus tombol Play/Pause agar lebih besar */
    .player-center .play-pause-btn {
        width: 36px; /* Sedikit lebih besar */
        height: 36px;
        font-size: 20px;
        background-color: var(--text-white);
    }

    /* Munculkan Shuffle & Repeat di Mobile (Posisi 4 & 5) */
    .player-center .control-btn:nth-child(4), /* Shuffle */
    .player-center .control-btn:nth-child(5) { /* Repeat */
        display: flex !important;
        font-size: 18px; /* Sedikit lebih kecil dari tombol navigasi */
        padding: 5px; /* Beri padding biar mudah diklik */
    }

    /* Tandai jika sedang aktif */
    .player-center .control-btn.active {
        color: var(--primary-red) !important;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }

    /* --- 4. BAGIAN KANAN (Queue, Listen Together, Volume) --- */
    .player-right {
        width: 25%; /* Sisa ruang */
        flex-shrink: 0;
        justify-content: flex-end;
        gap: 8px; /* Jarak antar tombol */
    }

    /* Munculkan tombol Queue (Atribut title Queue atau ikon list) */
    .player-right .control-btn[title="Queue"] {
        display: flex !important;
        font-size: 20px;
        padding: 6px;
    }

    /* Munculkan tombol Listen Together (Ikon users-three) */
    .player-right .control-btn[title="Dengar Bareng"] {
        display: flex !important;
        font-size: 20px;
        padding: 6px;
    }

    /* Sembunyikan tombol Mic (Lyric) */
    .player-right .control-btn[title="Lirik"] {
        display: none !important;
    }

    /* Sembunyikan Volume Slider */
    .player-right #volume-container {
        display: none !important;
    }

    /* --- 5. TAMBAHAN OVERLAY (Listen Together) --- */
    /* Pastikan Overlay tidak tertutup player bar saat muncul */
    #listen-together-overlay {
        z-index: 10000 !important; /* Sangat tinggi */
    }
    
    /* Responsive Container Mobile */
    .lt-container {
        width: 90% !important;
        padding: 30px 20px !important;
        max-height: 80vh; /* Batasi tinggi agar tombol bawah masih bisa diakses */
        overflow-y: auto; /* Scroll jika konten kepanjangan */
    }
    
    .lt-header h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .lt-btn, .lt-input {
        padding: 12px; /* Kurangi padding biar muat banyak tombol */
    }

    /* --- 6. TAMBAHAN OVERLAY QUEUE --- */
    /* Sesuaikan tinggi Queue agar tidak menutupi semua layar */
    #queue-overlay {
        bottom: 90px; /* Tepat di atas player bar */
        top: auto;
        height: 60vh; /* Tinggi 60% dari layar */
        border-left: none; /* Full width di mobile */
    }
}

    
/* === LISTEN TOGETHER OVERLAY === */
#listen-together-overlay {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 999999;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
}
#listen-together-overlay.active { 
    display: flex; 
}

/* Hide Listen Together on desktop - AGGRESSIVE */
@media (min-width: 769px) {
    #listen-together-overlay,
    #listen-together-overlay.active {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        position: fixed !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
    }
    
    #btn-open-listen-together {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
    }
}

.lt-container {
    background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
    padding: 30px;
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    border: 2px solid var(--primary-red);
    box-shadow: 0 20px 60px rgba(229,9,20,0.3);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

@media (min-width: 769px) {
    .lt-container {
        max-width: 950px;
        padding: 40px;
    }
}

.lt-header {
    text-align: center;
    margin-bottom: 0;
}

.lt-header h2 {
    font-size: 28px;
    font-weight: 900;
    color: white;
    margin: 0 0 10px 0;
}

.lt-header p {
    color: #aaa;
    font-size: 13px;
    margin: 0;
}

#lt-mode-section,
#lt-host-section,
#lt-join-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: 100%;
}

#lt-host-section.hidden,
#lt-join-section.hidden,
#lt-mode-section.hidden {
    display: none !important;
}

@media (min-width: 769px) {
    #lt-host-section {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
    }
}

.lt-mode-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    width: 100%;
}

.lt-mode-btn {
    padding: 20px;
    border: 2px solid #333;
    border-radius: 12px;
    background: transparent;
    color: white;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 700;
}

.lt-mode-btn:hover {
    border-color: var(--primary-red);
    background: rgba(229,9,20,0.1);
}

.lt-mode-btn.active {
    border-color: var(--primary-red);
    background: var(--primary-red);
}

.lt-session-code {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid #333;
    width: 100%;
    box-sizing: border-box;
}

.lt-code-display {
    font-size: 36px;
    font-weight: 900;
    color: var(--primary-red);
    letter-spacing: 8px;
    font-family: monospace;
    margin: 10px 0;
}

.lt-input {
    width: 100%;
    padding: 15px;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 12px;
    color: white;
    font-size: 24px;
    text-align: center;
    letter-spacing: 4px;
    font-weight: 700;
    text-transform: uppercase;
    box-sizing: border-box;
}

.lt-input:focus {
    outline: none;
    border-color: var(--primary-red);
}

.lt-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary-red);
    border: none;
    border-radius: 50px;
    color: white;
    font-weight: 900;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
    box-sizing: border-box;
}

@media (min-width: 769px) {
    #lt-host-section .lt-session-code {
        grid-column: 1;
        grid-row: 1;
        padding: 25px;
    }
    
    #lt-host-section > .lt-btn:nth-of-type(2) {
        grid-column: 1;
        grid-row: 2;
    }
    
    #lt-host-section .lt-participants {
        grid-column: 2;
        grid-row: 1 / 4;
    }
    
    #lt-host-section > .lt-btn:nth-of-type(3) {
        grid-column: 1;
        grid-row: 3;
    }
}

.lt-btn:hover {
    background: var(--primary-red-hover);
    transform: scale(1.02);
}

.lt-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 32px;
    cursor: pointer;
}

/* Session Active Badge */
.session-badge {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, var(--primary-red), #ff4d5a);
    padding: 12px 20px;
    border-radius: 50px;
    display: none;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(229,9,20,0.4);
    cursor: pointer;
    animation: pulse 2s infinite;
}

.session-badge.active { display: flex; }

/* Hide session badge on desktop */
@media (min-width: 769px) {
    .session-badge,
    .session-badge.active {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
    }
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 4px 15px rgba(229,9,20,0.4); }
    50% { box-shadow: 0 4px 25px rgba(229,9,20,0.8); }
}

.session-badge-icon {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Participants List */
.lt-participants {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 12px;
    max-height: 200px;
    overflow-y: auto;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    box-sizing: border-box;
    flex-direction: column;
    border: 1px solid #333;
}

@media (min-width: 769px) {
    .lt-participants {
        padding: 20px;
        min-height: 350px;
        border: 2px solid var(--primary-red);
        max-height: none;
        align-items: flex-start;
        justify-content: flex-start;
    }
}

.lt-participant {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 6px;
    width: 100%;
}

.lt-participant:hover {
    background: rgba(255,255,255,0.05);
}

.lt-participant img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.lt-host-badge {
    background: var(--primary-red);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    margin-left: auto;
    color: white;
}

.lt-participants p {
    color: #666;
    text-align: center;
    font-size: 13px;
    margin: 0;
}

#lt-join-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

@media (min-width: 769px) {
    #lt-join-section {
        max-width: 500px;
        margin: 0 auto;
    }
}

#lt-join-section p {
    color: #aaa;
    font-size: 12px;
    text-align: center;
    margin: 0;
}

#toast-container {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}
.toast {
    background: rgba(40, 40, 40, 0.95);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideUp 0.3s ease;
    pointer-events: auto;
    border: 1px solid #444;
}
.toast.success { border-color: #1db954; }
.toast.error { border-color: #e91e63; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.import-music-btn {
    color: var(--text-gray);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: 0.2s;
    border-radius: 4px;
    margin-top: 5px;
}
.import-music-btn:hover { 
    color: var(--text-white); 
    background-color: rgba(255,255,255,0.05); 
}

.import-form-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.import-file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
    border: 2px dashed #444;
}

.import-file-preview.active {
    border-color: var(--primary-red);
}

.import-cover-preview {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    background: #333;
}

.import-file-info {
    flex: 1;
}

.import-file-name {
    font-weight: 600;
    color: white;
    margin-bottom: 5px;
}

.import-file-size {
    font-size: 12px;
    color: #888;
}

.file-upload-btn {
    padding: 12px 24px;
    background: var(--primary-red);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: 0.2s;
}

.file-upload-btn:hover {
    background: var(--primary-red-hover);
}

.privacy-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
}

.privacy-toggle label {
    flex: 1;
    font-weight: 600;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #444;
    transition: 0.4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #1db954;
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* === ULTRA MOBILE: iPhone 12 Mini & Small Devices (max-width: 390px) === */
@media (max-width: 414px) {
    /* Root adjustments */
    :root {
        --sidebar-width: 240px;
        --header-height: 56px;
        --player-height: 64px;
        --mobile-nav-height: 60px;
    }

    /* Header adjustments */
    header {
        padding: 8px 12px;
        gap: 8px;
    }

    .logo i {
        font-size: 24px;
    }

    .header-search {
        padding: 8px 12px;
        font-size: 12px;
    }

    .search-icon {
        font-size: 16px;
    }

    /* Main content */
    .main-content {
        padding-bottom: calc(var(--player-height) + var(--mobile-nav-height));
    }

    .content-padding {
        padding: 12px;
    }

    /* --- MOBILE: Tidy images for albums, playlists, bands/artists --- */
    .playlist-cover-big {
        width: 64px !important;
        height: 64px !important;
        border-radius: 6px;
        box-shadow: none;
        object-fit: cover;
    }

    .playlist-thumb {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        object-fit: cover;
    }

    /* Cards used across home/profile (compact for very small devices) */
    .card-grid .card,
    .band-grid .band-card,
    .horizontal-list-mobile .card,
    .horizontal-list-mobile .band-card {
        width: 72px !important;
        height: 72px !important;
        flex: 0 0 72px !important;
    }

    .card-grid .card img,
    .band-card img,
    .horizontal-list-mobile .card img,
    .horizontal-list-mobile .band-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Artist / band list thumbnails in lists */
    .playlist-item .playlist-thumb,
    .friend-avatar,
    .chat-shared-img {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        object-fit: cover;
    }

    /* Tighter grids on mobile: allow more columns with smaller cards */
    .card-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 8px; }
    .band-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }

    /* Compact album/playlist images on ultra-small screens */
    .playlist-cover-big {
        width: 96px !important;
        height: 96px !important;
        margin-bottom: 8px;
        box-shadow: none;
        object-fit: cover;
        border-radius: 8px;
    }

    .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
    }

    .card-grid .card img,
    .band-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .band-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 0 8px;
    }

    .playlist-actions .action-play-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
    }

    /* show mobile bottom nav on ultra-small screens */
    .mobile-bottom-nav { display: flex; }

    .mobile-bottom-nav .mb-nav-item span { font-size: 11px; }
    .mobile-bottom-nav { left: 8px; right: 8px; height: var(--mobile-nav-height); bottom: 0; }

    /* place player bar above mobile nav */
    .player-bar { bottom: var(--mobile-nav-height); }

    /* Compact the four "popular" horizontal lists (bands/artists, local & foreign)
       so thumbnails are smaller on ultra-small screens */
    #popular-bands-container .song-card,
    #popular-artists-container .song-card,
    #foreign-solo-container .song-card,
    #foreign-bands-container .song-card {
        min-width: 140px !important;
        flex: 0 0 140px !important;
        padding: 8px !important;
    }

    #popular-bands-container .card-img-wrapper,
    #popular-artists-container .card-img-wrapper,
    #foreign-solo-container .card-img-wrapper,
    #foreign-bands-container .card-img-wrapper {
        aspect-ratio: 1/1;
        margin-bottom: 8px;
        overflow: hidden;
    }

    #popular-bands-container .card-img-wrapper img,
    #popular-artists-container .card-img-wrapper img,
    #foreign-solo-container .card-img-wrapper img,
    #foreign-bands-container .card-img-wrapper img {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
        border-radius: 8px;
    }
    /* place chat footer above player bar */
        .chat-footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: calc(var(--player-height) + var(--mobile-nav-height) + 8px);
            z-index: 100002; /* ensure footer sits above player/nav when chat is open */
            padding: 12px 16px;
            backdrop-filter: blur(6px);
    }

        /* When the full-screen chat overlay is open, place the footer inside the overlay
           so users can type at the bottom of the chat content (not fixed to viewport). */
        #chat-overlay .chat-footer {
            position: relative !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
            width: 100%;
            z-index: 100002;
            background: transparent;
            padding: 12px 16px;
        }

        /* Add space at the end of the chat body so last messages are not hidden behind the footer */
        #chat-overlay .chat-body {
            padding-bottom: 84px !important;
        }

    /* Sidebar adjustments */
    .sidebar {
        width: 240px;
        padding: 16px 8px;
    }

    .nav-links {
        gap: 4px;
    }

    .nav-item {
        padding: 8px 12px;
        font-size: 13px;
    }

    .nav-item i {
        font-size: 18px;
    }

    .playlist-item {
        padding: 8px 12px;
        font-size: 12px;
    }

    /* Player bar ultra compact untuk iPhone 12 mini */
    .player-bar {
        height: var(--player-height);
        padding: 0 8px;
        gap: 6px;
        flex-wrap: nowrap;
    }

    /* Player left - minimal */
    .player-left {
        width: 28%;
        gap: 4px;
        flex-shrink: 0;
    }

    .player-left .current-art {
        width: 44px;
        height: 44px;
        border-radius: 4px;
        flex-shrink: 0;
    }

    .player-left .current-info {
        flex: 1;
        min-width: 0;
    }

    .current-title {
        font-size: 10px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 0;
        padding: 0;
    }

    .current-artist {
        font-size: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 0;
        padding: 0;
    }

    /* Hide like button on ultra-small screens */
    .player-left .like-btn {
        display: none !important;
    }

    /* Player center - controls only */
    .player-center {
        width: 50%;
        gap: 2px;
        flex-direction: row;
        flex-shrink: 1;
    }

    .player-controls {
        width: 100%;
        gap: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .player-controls .control-btn {
        padding: 2px;
        font-size: 14px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .player-controls .play-pause-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
        flex-shrink: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--text-white);
        color: black;
        box-shadow: 0 3px 8px rgba(0,0,0,0.32);
    }

    /* Hide playback bar on ultra-small screens */
    .playback-bar {
        display: none !important;
    }

    /* Player right - minimal buttons */
    .player-right {
        width: 22%;
        gap: 2px;
        flex-shrink: 0;
    }

    .player-right .control-btn {
        padding: 2px;
        font-size: 14px;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* Hide volume container on ultra-small screens */
    #volume-container {
        display: none !important;
    }

    /* Song list - 2 column grid */
    .song-list-header,
    .song-row {
        grid-template-columns: 30px 1fr 30px;
        padding: 8px 10px;
        gap: 6px;
        font-size: 10px;
    }

    .song-list-header {
        padding: 8px 10px;
    }

    .song-list-header div:nth-child(3),
    .song-list-header div:nth-child(4),
    .song-row div:nth-child(3),
    .song-row div:nth-child(4) {
        display: none !important;
    }

    .song-index {
        font-size: 10px;
        width: 30px;
        text-align: center;
    }

    .song-info {
        display: flex;
        gap: 6px;
        align-items: center;
        min-width: 0;
        flex: 1;
    }

    .song-info img {
        width: 36px;
        height: 36px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    .song-info > div {
        display: flex;
        flex-direction: column;
        min-width: 0;
        flex: 1;
    }

    .song-title-text {
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .song-artist {
        font-size: 8px;
        color: #999;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .song-duration {
        display: none;
    }

    .song-actions {
        width: 30px;
        display: flex;
        gap: 0;
        justify-content: center;
    }

    .song-actions button {
        padding: 2px;
        font-size: 12px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Playlist cover adjustments */
    .playlist-cover-big {
        width: 120px;
        height: 120px;
        margin-bottom: 12px;
    }

    .playlist-info-big h1 {
        font-size: 1.5rem;
    }

    .playlist-actions {
        padding: 0;
        gap: 10px;
        width: 100%;
    }

    .action-play-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
    }

    /* Album grid adjustments */
    .band-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 0 10px;
    }

    .band-card {
        border-radius: 6px;
    }

    .band-card img {
        border-radius: 6px;
    }

    /* Overlay adjustments */
    .lt-container {
        width: 94%;
        padding: 16px 12px;
        max-height: 70vh;
    }

    .lt-header h2 {
        font-size: 18px;
    }

    .lt-header p {
        font-size: 11px;
    }

    .lt-btn,
    .lt-input {
        padding: 8px;
        font-size: 11px;
    }

    #queue-overlay {
        width: 100% !important;
        height: 50vh;
        bottom: 72px;
        right: 0 !important;
        border-left: none;
    }

    .queue-header {
        padding: 12px 10px;
    }

    .queue-title {
        font-size: 14px;
    }

    .queue-item {
        padding: 8px 10px;
        font-size: 10px;
        gap: 8px;
    }

    .queue-item img {
        width: 36px;
        height: 36px;
    }

    /* Modal adjustments */
    .modal {
        padding: 16px 12px;
        border-radius: 8px;
    }

    .modal h2 {
        font-size: 18px;
    }

    .modal label {
        font-size: 11px;
    }

    .modal input,
    .modal textarea {
        font-size: 11px;
        padding: 6px;
    }

    .modal button {
        padding: 8px 12px;
        font-size: 11px;
    }

    /* Text adjustments for readability */
    h1 { font-size: 20px; }
    h2 { font-size: 16px; }
    h3 { font-size: 14px; }

    /* Reduce sidebar width for small screens */
    .sidebar {
        width: 200px;
        padding: 12px 6px;
    }

    .nav-item {
        padding: 6px 10px;
        font-size: 12px;
    }

    .playlist-item {
        padding: 6px 10px;
        font-size: 11px;
    }
}

    /* Additional profile & media adjustments for tablets */
    .profile-hero-section {
        padding-top: 30px;
        gap: 12px;
    }

    .profile-avatar-lg {
        width: 120px;
        height: 120px;
    }

    .profile-name-large {
        font-size: 2rem;
    }

    .profile-stats {
        gap: 12px;
    }

    .profile-stat {
        font-size: 11px;
    }

    /* Video section adjustments */
    .video-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 0 12px;
    }

    .video-card {
        border-radius: 6px;
    }

    .video-card img {
        border-radius: 6px;
    }

    .video-title {
        font-size: 11px;
        padding: 6px;
    }

    /* Friend list adjustments */
    .friend-list {
        gap: 8px;
        padding: 0 12px;
    }

    .friend-card {
        padding: 10px;
    }

    .friend-avatar {
        width: 44px;
        height: 44px;
    }

    .friend-name {
        font-size: 12px;
    }

    .friend-status {
        font-size: 10px;
    }

    /* Text adjustments for better readability */
    h1 { font-size: 24px; }
    h2 { font-size: 18px; }
    h3 { font-size: 16px; }
    p { font-size: 12px; }

    /* Reduce gap in containers */
    .grid-container {
        gap: 10px;
    }

    /* Adjust card styles */
    .card {
        border-radius: 8px;
        padding: 10px;
    }

    /* Reduce button sizes */
    button {
        padding: 8px 12px;
        font-size: 12px;
        min-height: 40px;
    }

    /* Scrollbar adjustments */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-thumb {
        border-radius: 3px;
    }

    /* Safe area for notch devices */
    body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    }
}

/* Tambahkan di bagian CSS, sekitar line 350-400 */

/* Unread Messages Badge */
.friend-list-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: 0.2s;
    position: relative; /* Untuk badge positioning */
}

.unread-badge {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary-red);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% { transform: translateY(-50%) scale(1); }
    50% { transform: translateY(-50%) scale(1.1); }
}

/* REPLACE CSS yang ada untuk .playlist-modal-grid-profile dan #friend-public-playlists */
/* Sekitar line 450-550 */

/* Profile Public Playlists - UKURAN SAMA DENGAN HOME */
.playlist-modal-grid-profile {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 24px;
    padding: 0 32px 60px 32px;
}

.playlist-modal-grid-profile .song-card {
    background-color: var(--bg-card);
    padding: 16px;
    border-radius: 6px;
    transition: background-color 0.3s ease;
    cursor: pointer;
    position: relative;
}

.playlist-modal-grid-profile .song-card:hover {
    background-color: var(--bg-card-hover);
}

.playlist-modal-grid-profile .card-img-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* Force 1:1 aspect ratio */
    margin-bottom: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    border-radius: 4px;
    overflow: hidden;
    background-color: #222;
}

.playlist-modal-grid-profile .card-img-wrapper img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.playlist-modal-grid-profile .play-btn-overlay {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--primary-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 8px 8px rgba(0,0,0,0.3);
    opacity: 0;
    transform: translateY(8px);
    transition: all 0.3s ease;
    z-index: 5;
}

.playlist-modal-grid-profile .song-card:hover .play-btn-overlay {
    opacity: 1;
    transform: translateY(0);
}

.playlist-modal-grid-profile .card-title {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-white);
}

.playlist-modal-grid-profile .card-desc {
    font-size: 14px;
    color: var(--text-gray);
}

/* Friend Profile Playlists - EXACT SAME SIZE AS HOME (180x180px forced) */
#friend-public-playlists {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 24px;
    padding: 0 32px 60px 32px;
}

#friend-public-playlists .song-card {
    background-color: var(--bg-card);
    padding: 16px;
    border-radius: 6px;
    transition: background-color 0.3s ease;
    cursor: pointer;
    position: relative;
    max-width: 212px; /* 180px content + 32px padding */
}

#friend-public-playlists .song-card:hover {
    background-color: var(--bg-card-hover);
}

/* CRITICAL FIX: Wrapper dengan padding-bottom 100% */
#friend-public-playlists .card-img-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 100%; /*  INI YANG PENTING: Paksa rasio 1:1 */
    margin-bottom: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    border-radius: 4px;
    overflow: hidden;
    background-color: #222;
}

/* Image di dalam wrapper: absolute positioning */
#friend-public-playlists .card-img-wrapper img {
    position: absolute !important;  /*  HARUS absolute */
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;   /*  Prevent distortion */
    transition: transform 0.3s ease;
}

#friend-public-playlists .play-btn-overlay {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--primary-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 8px 8px rgba(0,0,0,0.3);
    opacity: 0;
    transform: translateY(8px);
    transition: all 0.3s ease;
    z-index: 5;
}

#friend-public-playlists .song-card:hover .play-btn-overlay {
    opacity: 1;
    transform: translateY(0);
}

#friend-public-playlists .card-title {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-white);
}

#friend-public-playlists .card-desc {
    font-size: 14px;
    color: var(--text-gray);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    #friend-public-playlists {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        padding: 0 16px 60px 16px;
    }
    
    #friend-public-playlists .song-card {
        padding: 12px;
        max-width: 164px; /* 140px + 24px padding */
    }
    
    #friend-public-playlists .card-title {
        font-size: 14px;
    }
    
    #friend-public-playlists .card-desc {
        font-size: 12px;
    }
}

/* Mobile Responsive untuk Profile Playlists */
@media (max-width: 768px) {
    .playlist-modal-grid-profile,
    #friend-public-playlists {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        padding: 0 16px 60px 16px;
    }
    
    .playlist-modal-grid-profile .song-card,
    #friend-public-playlists .song-card {
        padding: 12px;
    }
    
    .playlist-modal-grid-profile .card-title,
    #friend-public-playlists .card-title {
        font-size: 14px;
    }
    
    .playlist-modal-grid-profile .card-desc,
    #friend-public-playlists .card-desc {
        font-size: 12px;
    }
}

/* === ARTIST/BAND PROFILE OVERLAY (DESKTOP ONLY) === */
#artist-band-profile-overlay {
    position: fixed;
    top: 50%;
    left: calc(var(--sidebar-width) + 20px);
    transform: translateY(-50%) translateX(0);
    width: calc(100% - var(--sidebar-width) - 40px);
    max-width: 1000px;
    height: auto;
    max-height: 85vh;
    background: var(--bg-dark);
    z-index: 5000;
    display: none;
    flex-direction: column;
    overflow-y: auto;
    border-radius: 12px;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
}

#artist-band-profile-overlay.active {
    display: flex;
    opacity: 1;
    pointer-events: auto;
}

/* Backdrop semi-transparent */
#artist-band-profile-overlay::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: -1;
    cursor: pointer;
    border-radius: 0;
}

/* Only show on desktop (laptop) */
@media (max-width: 768px) {
    #artist-band-profile-overlay {
        left: 10px !important;
        right: 10px !important;
        width: calc(100% - 20px) !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        max-width: none !important;
    }
    
    #artist-band-profile-overlay::before {
        left: 0 !important;
        right: 0 !important;
    }
    
    /* Hide desktop language section on mobile */
    .desktop-language-section {
        display: none !important;
    }
    
    /* Show mobile language section on mobile */
    .mobile-language-section {
        display: block !important;
    }
}

/* Show desktop language section on desktop */
@media (min-width: 769px) {
    .desktop-language-section {
        display: block !important;
    }
    
    .mobile-language-section {
        display: none !important;
    }
}

.artist-band-overlay-header {
    display: flex;
    align-items: flex-end;
    padding: 20px 24px;
    background: linear-gradient(180deg, #530000 0%, var(--bg-dark) 100%);
    gap: 16px;
    border-bottom: none;
    flex-shrink: 0;
}

.artist-band-overlay-back {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
    border-radius: 50%;
    flex-shrink: 0;
}

.artist-band-overlay-back:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--primary-red);
}

.artist-band-overlay-title {
    flex: 1;
    font-size: 24px;
    font-weight: 900;
    color: white;
}

.artist-band-overlay-content {
    flex: 1;
    overflow: hidden;
    padding: 0;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 0;
    background: var(--bg-dark);
    max-height: calc(85vh - 100px);
}

.artist-band-overlay-left {
    padding: 24px;
    border-right: 1px solid var(--border-color);
    background: var(--bg-dark);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    overflow-y: auto;
    max-height: calc(85vh - 100px);
}

.artist-band-overlay-right {
    padding: 24px;
    background: var(--bg-dark);
    overflow-y: auto;
    max-height: calc(85vh - 100px);
}

.artist-band-overlay-cover {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}

.artist-band-overlay-info h2 {
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 8px;
    color: var(--text-white);
    word-break: break-word;
}

.artist-band-overlay-info p {
    font-size: 14px;
    color: var(--text-gray);
    margin-bottom: 8px;
}

.artist-band-overlay-stats {
    display: flex;
    gap: 16px;
    margin: 12px 0 0 0;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.artist-band-overlay-stat {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.artist-band-overlay-stat-value {
    font-size: 14px;
    font-weight: 900;
    color: var(--text-white);
}

.artist-band-overlay-stat-label {
    font-size: 12px;
    color: var(--text-gray);
    margin-top: 4px;
}

.artist-band-overlay-songs-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.artist-band-overlay-songs {
    display: flex;
    flex-direction: column;
    gap: 0;
    max-height: 100%;
    overflow-y: auto;
}

.artist-band-song-item {
    display: grid;
    grid-template-columns: 45px 4fr 3fr 1fr 160px;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    align-items: center;
    color: var(--text-gray);
    font-size: 13px;
    transition: 0.2s;
}

.artist-band-song-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.artist-band-song-item:hover button {
    color: var(--text-white) !important;
}

.artist-band-song-item:hover .overlay-like-btn.liked {
    color: var(--primary-red) !important;
}

.artist-band-song-item.playing {
    color: var(--primary-red);
    box-shadow: inset 4px 0 0 var(--primary-red);
    background: linear-gradient(90deg, rgba(229, 9, 20, 0.04), transparent 60%);
}

/* Overlay Like Button */
.overlay-like-btn {
    color: var(--text-gray) !important;
    transition: 0.2s !important;
}

.overlay-like-btn.liked {
    color: var(--primary-red) !important;
}

.artist-band-song-index {
    font-size: 14px;
    color: var(--text-gray);
    min-width: 20px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.artist-band-song-info {
    display: flex;
    align-items: center;
    gap: 12px;
    overflow: hidden;
}

.artist-band-song-cover {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    object-fit: cover;
    flex-shrink: 0;
}

.artist-band-song-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-white);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.artist-band-song-artist {
    font-size: 11px;
    color: var(--text-gray);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.artist-band-song-album {
    font-size: 13px;
    color: var(--text-gray);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.artist-band-song-duration {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.artist-band-song-play {
    background: none;
    border: none;
    color: var(--primary-red);
    cursor: pointer;
    font-size: 16px;
    padding: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.artist-band-song-play:hover {
    color: #ff4d5a;
}

/* Toast Notification */
.toast {
    background: linear-gradient(135deg, rgba(229, 9, 20, 0.95), rgba(229, 9, 20, 0.85));
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(229, 9, 20, 0.4);
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    font-weight: 600;
    animation: slideInToast 0.3s ease-out forwards;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes slideInToast {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutToast {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

.toast.exit {
    animation: slideOutToast 0.3s ease-out forwards;
}

.toast-icon {
    font-size: 20px;
    flex-shrink: 0;
}
.song-card.opening {
    opacity: 0.6;
    pointer-events: none;
}
    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="loading-screen">
        <div class="loading-center">
            <img src="assets/vidje-icon.jpg" alt="VIDJE" class="app-logo centered-logo">
        </div>
    </div>

    <!-- 2. AUTH VIEW -->
    <div id="auth-view" style="display: none;">
        <div class="auth-container">
            <div class="auth-box" id="login-box">
                <div class="auth-logo"><i class="ph-fill ph-play-circle"></i></div>
                <h2 data-i18n="login-title"></h2>
                <p data-i18n="login-subtitle"></p>
                <p class="error-msg" id="login-error" data-i18n="login-error-default"></p>
                <input type="email" id="login-email" class="auth-input" placeholder="Email">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="window.handleLogin()" data-i18n="login-button"></button>
                <div class="auth-switch">
                    <span data-i18n="login-no-account"></span> <span onclick="window.toggleAuthMode('signup')" data-i18n="login-link"></span>
                </div>
            </div>

            <div class="auth-box" id="signup-box" style="display: none;">
                <div class="auth-logo"><i class="ph-fill ph-user-plus"></i></div>
                <h2 data-i18n="signup-title"></h2>
                <p data-i18n="signup-subtitle"></p>
                <p class="error-msg" id="signup-error" data-i18n="signup-error-default"></p>
                <input type="text" id="signup-name" class="auth-input" placeholder="Nama Lengkap" data-i18n-placeholder="signup-fullname">
                <input type="email" id="signup-email" class="auth-input" placeholder="Email">
                <input type="password" id="signup-password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="window.handleSignup()" data-i18n="signup-button"></button>
                <div class="auth-switch">
                    <span data-i18n="signup-have-account"></span> <span onclick="window.toggleAuthMode('login')" data-i18n="signup-link"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. APP WRAPPER -->
    <div class="app-wrapper" id="app-wrapper" style="display: none;">
        
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="window.toggleSidebar()"></div>

        <div class="container">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="logo" onclick="window.switchView('home')">
                    <img src="assets/vidje-icon.jpg" alt="VIDJE" class="app-logo">
                    <span style="font-family: 'Montserrat', sans-serif; font-weight:700; font-size:20px; margin-left:8px;">VIDJE</span>
                </div>
                
                <ul class="nav-links">
                    <li><a href="#" onclick="window.switchView('home')" id="nav-home" class="nav-item active"><i class="ph ph-house"></i><span data-i18n="nav-home">Home</span></a></li>
                    <li><a href="#" onclick="window.switchView('search')" id="nav-search" class="nav-item"><i class="ph ph-magnifying-glass"></i><span data-i18n="nav-search">Search</span></a></li>
                    <li><a href="#" onclick="window.switchView('liked')" id="nav-liked" class="nav-item"><i class="ph ph-heart"></i><span data-i18n="nav-liked">Liked Songs</span></a></li>
                </ul>

                <div class="divider"></div>

                <div class="playlist-scroll">
                    <div class="playlist-title" data-i18n="playlist-title">Your Playlists</div>
                    
                    <div class="create-playlist-btn" onclick="window.openCreatePlaylistModal()">
                        <i class="ph ph-plus-square" style="font-size: 24px;"></i>
                        <span data-i18n="create-playlist">Create Playlist</span>
                    </div> 

                    <div class="import-music-btn" onclick="window.openImportMusicModal()">
                        <i class="ph ph-upload-simple" style="font-size: 24px;"></i>
                        <span data-i18n="import-music">Import Music</span>
                    </div>



                    <div id="sidebar-playlists-container" style="margin-top: 10px;"></div>

                    <!-- --- FITUR PERTEMANAN (SIDEBAR) --- -->
                    <div class="friend-section">
                        <div class="playlist-title" data-i18n="sidebar-friends">Friends</div>
                        
                        <div class="friend-search-container">
                            <input type="text" id="friend-search-input" class="friend-search-input" data-i18n-placeholder="search-friends-placeholder" placeholder="Search friends (Name/User ID)..." autocomplete="off">
                            <div id="friend-search-dropdown" class="friend-search-dropdown"></div>
                        </div>

                        <div class="playlist-title" style="font-size: 10px; margin-top: 10px;" data-i18n="friend-requests"></div>
                        <div id="friend-requests-container" style="margin-bottom: 10px;"></div>

                        <div class="playlist-title" style="font-size: 10px; margin-top: 10px;" data-i18n="friend-list"></div>
                        <div id="friend-list-container"></div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                <header>
                    <div class="header-left">
                        <button class="mobile-menu-toggle" onclick="window.toggleSidebar()">
                            <i class="ph ph-list"></i>
                        </button>
                    </div>
                    <div class="user-menu" onclick="window.switchView('profile')">
                        <img src="https://picsum.photos/seed/user123/50/50" alt="User Avatar" id="header-avatar">
                        <span id="header-username">Rizky</span>
                        <i class="ph ph-caret-down" style="font-size: 12px;"></i>
                    </div>
                </header>

                <div class="content-padding">
                    <!-- VIEW: BERANDA (HOME) -->
                    <div id="view-home" class="view-section active">
                        <!-- SEDANG TREN -->
                        <h2 data-i18n="my-playlists-section">Playlist Saya</h2>
                        <div class="card-grid" id="trending-container"></div>

                        <!-- BAND POPULER INDONESIA -->
                        <h2 data-i18n="popular-indonesian-bands">Band Populer Indonesia</h2>
                        <div class="card-grid" id="popular-bands-container"></div>

                        <!-- PENYANYI POPULER INDONESIA -->
                        <h2 data-i18n="popular-indonesian-artists">Penyanyi Populer Indonesia</h2>
                        <div class="card-grid" id="popular-artists-container"></div>

                        <!-- NEW: PENYANYI ASING POPULER -->
                        <h2 data-i18n="popular-foreign-artists">Penyanyi Asing Populer</h2>
                        <div class="card-grid" id="foreign-solo-container"></div>

                        <!-- NEW: BAND ASING POPULER -->
                        <h2 data-i18n="popular-foreign-bands">Band Asing Populer</h2>
                        <div class="card-grid" id="foreign-bands-container"></div>

                        <br><br><br>
                    </div>

                   <!-- VIEW: CARI (SEARCH) -->
<div id="view-search" class="view-section">
    <div class="search-container">
        <i class="ph ph-magnifying-glass search-icon-placeholder"></i>
        <input type="text" class="search-input" id="search-input" placeholder="Search songs, artists, playlists..." data-i18n-placeholder="search" oninput="window.handleSearch(this.value)">
    </div>

    <!-- Search Results Wrapper (Hidden by default, shown when typing) -->
    <div id="search-results-wrapper">
        <h3 class="results-section-title" data-i18n="search-results">Hasil Pencarian</h3>
        <!-- Bands/Artists Grid -->
        <div id="search-bands-container" class="card-grid" style="margin-bottom: 30px;"></div>

        <!-- Public Playlists Grid -->
        <h3 id="search-playlists-title" style="display:none; margin-bottom: 10px; font-size: 18px; font-weight: 700;" data-i18n="public-playlists">Playlist Publik</h3>
        <div id="search-playlists-container" class="card-grid" style="margin-bottom: 30px;"></div>
        
        <!-- Songs List -->
        <div id="search-songs-container"></div>
    </div>

    <!-- History Wrapper (Visible by default, hidden when typing) -->
    <div id="search-history-wrapper">
        <h3 class="history-section-title" id="search-history-title" data-i18n="recently-played"></h3>
        <div id="search-history-container"></div>
    </div>
</div>




<div id="view-playlist" class="view-section">
    <div class="playlist-header-view" id="playlist-header-bg" style="position: relative;">
        <button onclick="window.goBack()" class="back-button" title="Kembali" style="position: absolute; top: 8px; left: 12px; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px;">
            <i class="ph ph-arrow-left"></i>
        </button>
        <div class="playlist-cover-wrap">
            <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=300&q=80" class="playlist-cover-big playlist-cover-filtered" id="playlist-cover-view" onerror="this.src='https://picsum.photos/seed/vidje/300/300'">
            <button class="edit-cover-btn" onclick="document.getElementById('playlist-cover-input').click()">
                <i class="ph-fill ph-camera"></i>
            </button>
            <input type="file" id="playlist-cover-input" style="display: none;" accept="image/*" onchange="window.handlePlaylistCoverUpload(this)">
        </div>
        <div class="playlist-info-big">
            <span>PLAYLIST</span>
            <h1 id="playlist-title-view">Playlist Saya</h1>
            <div class="playlist-meta">
                <span style="color: white;" id="playlist-owner-display">Owner</span>  <span id="playlist-count">0 lagu</span>
            </div>
        </div>
    </div>

    <!-- TOMBOL SEKARANG DI BAWAH HEADER -->
    <div class="playlist-actions">
        <div class="action-play-btn" onclick="window.playFirstSongOfPlaylist()">
            <i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i>
        </div>
        
        <button class="share-btn" onclick="window.shareCurrentPlaylist()" title="Bagikan Playlist" style="background:none; border:none; color:var(--text-gray); cursor:pointer; font-size:32px; transition:0.2s;">
            <i class="ph ph-share-network"></i>
        </button>
        
        <button class="settings-btn" onclick="window.openPlaylistSettings()" title="Atur Playlist" style="background:none; border:none; color:var(--text-gray); cursor:pointer; font-size:32px; transition:0.2s;">
            <i class="ph ph-gear"></i>
        </button>
    </div>


<!-- Tambahkan Modal Pengaturan Playlist (sebelum closing body tag) -->
<div id="playlist-settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" data-i18n="playlist-settings">Pengaturan Playlist</div>
            <button class="close-modal-btn" onclick="window.closeModal('playlist-settings-modal')">
                <i class="ph ph-x"></i>
            </button>
        </div>
        
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 15px auto; cursor: pointer;" onclick="document.getElementById('settings-cover-input').click()">
                <img id="settings-cover-preview" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 0 0 8px 8px; color: white; font-size: 12px;">
                    <i class="ph ph-camera"></i> Ubah Foto
                </div>
            </div>
            <input type="file" id="settings-cover-input" style="display: none;" accept="image/*" onchange="window.handleSettingsCoverUpload(this)">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase; display: block; margin-bottom: 8px;">Nama Playlist</label>
            <input type="text" id="settings-playlist-name" class="modal-input" placeholder="Nama Playlist">
        </div>
        
        <button class="modal-btn" onclick="window.savePlaylistSettings()">Simpan Perubahan</button>
    </div>
</div>

                        

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="playlist-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- LOCAL ALBUMS (GHANI, REVAN, HANUNG, RARA) --- -->

                    <!-- VIEW: DETAIL ALBUM (GHANI'S ALBUM) -->
                    <div id="view-ghani-album" class="view-section">
                        <div style="padding: 16px 20px 0 20px;">
                            <button onclick="window.goBack()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:0.2s;" onmouseover="this.style.color='#e50914'" onmouseout="this.style.color='white'">
                                <i class="ph ph-arrow-left"></i>
                                <span style="font-size:14px;">Kembali</span>
                            </button>
                        </div>
                        
                        <div class="playlist-header-view" id="ghani-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ghani.jpg" class="playlist-cover-big" id="ghani-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="ghani-title-view">Ghani's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="ghani-count">10 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfGhani()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="ghani-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- VIEW: DETAIL ALBUM (REVAN'S ALBUM) -->
                    <div id="view-revan-album" class="view-section">
                        <div style="padding: 16px 20px 0 20px;">
                            <button onclick="window.goBack()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:0.2s;" onmouseover="this.style.color='#e50914'" onmouseout="this.style.color='white'">
                                <i class="ph ph-arrow-left"></i>
                                <span style="font-size:14px;">Kembali</span>
                            </button>
                        </div>
                        
                        <div class="playlist-header-view" id="revan-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/revan.jpg" class="playlist-cover-big" id="revan-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="revan-title-view">Revan's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="revan-count">10 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRevan()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="revan-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- HANUNG'S ALBUM -->
                    <div id="view-hanung-album" class="view-section">
                        <div class="playlist-header-view" id="hanung-header-bg" style="position: relative;">
                            <button onclick="window.goBack()" class="back-button" title="Kembali" style="position: absolute; top: 8px; left: 12px; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/pras.jpg" class="playlist-cover-big" id="hanung-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="hanung-title-view">Hanung's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="hanung-count">6 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfHanung()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="hanung-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- RARA'S ALBUM -->
                    <div id="view-rara-album" class="view-section">
                        <div class="playlist-header-view" id="rara-header-bg" style="position: relative;">
                            <button onclick="window.goBack()" class="back-button" title="Kembali" style="position: absolute; top: 8px; left: 12px; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/rara.jpg" class="playlist-cover-big" id="rara-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ALBUM</span>
                                <h1 id="rara-title-view">Rara's Album</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Vidje Originals</span>  <span id="rara-count">5 lagu</span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRara()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="rara-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- BAND POPULER INDONESIA VIEWS --- -->
                    <!-- 1. PERUNGGU -->
                    <div id="view-perunggu-album" class="view-section">
                        <div class="playlist-header-view" id="perunggu-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/perunggu.jpg" class="playlist-cover-big" id="perunggu-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="perunggu-title-view">Perunggu</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="perunggu-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfPerunggu()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="perunggu-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 2. NOAH / PETERPAN -->
                    <div id="view-noah-album" class="view-section">
                        <div class="playlist-header-view" id="noah-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/noah.jpg" class="playlist-cover-big" id="noah-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="noah-title-view">NOAH / Peterpan</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="noah-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfNoah()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="noah-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 3. DEWA 19 -->
                    <div id="view-dewa-album" class="view-section">
                        <div class="playlist-header-view" id="dewa-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/dewa19.png" class="playlist-cover-big" id="dewa-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="dewa-title-view">Dewa 19</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="dewa-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfDewa()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="dewa-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 4. SHEILA ON 7 -->
                    <div id="view-sheila-album" class="view-section">
                        <div class="playlist-header-view" id="sheila-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/so7.jpg" class="playlist-cover-big" id="sheila-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="sheila-title-view">Sheila On 7</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="sheila-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfSheila()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="sheila-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 5. KAHITNA -->
                    <div id="view-kahitna-album" class="view-section">
                        <div class="playlist-header-view" id="kahitna-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/kahitna.jpeg" class="playlist-cover-big" id="kahitna-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="kahitna-title-view">Kahitna</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="kahitna-count">12 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfKahitna()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="kahitna-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 6. HINDIA -->
                    <div id="view-hindia-album" class="view-section">
                        <div class="playlist-header-view" id="hindia-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/hindia.jpg" class="playlist-cover-big" id="hindia-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="hindia-title-view">Hindia</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Populer Indonesia</span>  <span id="hindia-count">11 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfHindia()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="hindia-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- PENYANYI POPULER INDONESIA VIEWS --- -->

                    <!-- 7. ASTRID -->
                    <div id="view-astrid-album" class="view-section">
                        <div class="playlist-header-view" id="astrid-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/astrid.webp" class="playlist-cover-big" id="astrid-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="astrid-title-view">Astrid</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="astrid-count">5 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfAstrid()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="astrid-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 8. AFGAN -->
                    <div id="view-afgan-album" class="view-section">
                        <div class="playlist-header-view" id="afgan-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/afgan.png" class="playlist-cover-big" id="afgan-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="afgan-title-view">Afgan</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="afgan-count">8 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfAfgan()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="afgan-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 9. TULUS -->
                    <div id="view-tulus-album" class="view-section">
                        <div class="playlist-header-view" id="tulus-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tulus.jpg" class="playlist-cover-big" id="tulus-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="tulus-title-view">Tulus</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="tulus-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTulus()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="tulus-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 10. MAHALINI -->
                    <div id="view-mahalini-album" class="view-section">
                        <div class="playlist-header-view" id="mahalini-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/mahalini.jpg" class="playlist-cover-big" id="mahalini-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="mahalini-title-view">Mahalini</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="mahalini-count">8 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfMahalini()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="mahalini-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- 11. TENXI -->
                    <div id="view-tenxi-album" class="view-section">
                        <div class="playlist-header-view" id="tenxi-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tenxi.jpg" class="playlist-cover-big" id="tenxi-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="tenxi-title-view">Tenxi</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Populer Indonesia</span>  <span id="tenxi-count">5 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTenxi()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="tenxi-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: PENYANYI ASING (SOLO) VIEWS --- -->

                    <!-- Taylor Swift -->
                    <div id="view-taylor-album" class="view-section">
                        <div class="playlist-header-view" id="taylor-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/taylor.jpg" class="playlist-cover-big" id="taylor-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="taylor-title-view">Taylor Swift</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="taylor-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfTaylor()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="taylor-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Justin Bieber -->
                    <div id="view-justin-album" class="view-section">
                        <div class="playlist-header-view" id="justin-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/justin.jpg" class="playlist-cover-big" id="justin-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="justin-title-view">Justin Bieber</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="justin-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfJustin()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="justin-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Ed Sheeran -->
                    <div id="view-ed-album" class="view-section">
                        <div class="playlist-header-view" id="ed-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ed.jpg" class="playlist-cover-big" id="ed-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="ed-title-view">Ed Sheeran</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="ed-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfEd()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="ed-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Bruno Mars -->
                    <div id="view-bruno-album" class="view-section">
                        <div class="playlist-header-view" id="bruno-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/bruno.jpg" class="playlist-cover-big" id="bruno-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="bruno-title-view">Bruno Mars</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="bruno-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfBruno()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="bruno-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Daniel Caesar -->
                    <div id="view-daniel-album" class="view-section">
                        <div class="playlist-header-view" id="daniel-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/daniel.jpg" class="playlist-cover-big" id="daniel-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>ARTIS</span>
                                <h1 id="daniel-title-view">Daniel Caesar</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Penyanyi Asing Populer</span>  <span id="daniel-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfDaniel()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="daniel-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: BAND ASING VIEWS --- -->

                    <!-- Coldplay -->
                    <div id="view-coldplay-album" class="view-section">
                        <div class="playlist-header-view" id="coldplay-header-bg" style="position: relative;">
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/coldplay.jpg" class="playlist-cover-big" id="coldplay-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="coldplay-title-view">Coldplay</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="coldplay-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfColdplay()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="coldplay-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- One Direction -->
                    <div id="view-onedirection-album" class="view-section">
                        <div class="playlist-header-view" id="onedirection-header-bg">
                            <button class="back-button" onclick="window.switchView('home')" style="position: absolute; left: 20px; top: 20px; z-index: 100;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/onedirection.jpg" class="playlist-cover-big" id="onedirection-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="onedirection-title-view">One Direction</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="onedirection-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfOnedirection()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="onedirection-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Green Day -->
                    <div id="view-greenday-album" class="view-section">
                        <div class="playlist-header-view" id="greenday-header-bg">
                            <button class="back-button" onclick="window.switchView('home')" style="position: absolute; left: 20px; top: 20px; z-index: 100;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/greenday.jpg" class="playlist-cover-big" id="greenday-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="greenday-title-view">Green Day</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="greenday-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfGreenday()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="greenday-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Oasis -->
                    <div id="view-oasis-album" class="view-section">
                        <div class="playlist-header-view" id="oasis-header-bg">
                            <button class="back-button" onclick="window.switchView('home')" style="position: absolute; left: 20px; top: 20px; z-index: 100;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/oasis.jpg" class="playlist-cover-big" id="oasis-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="oasis-title-view">Oasis</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="oasis-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfOasis()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="oasis-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- Radiohead -->
                    <div id="view-radiohead-album" class="view-section">
                        <div class="playlist-header-view" id="radiohead-header-bg">
                            <button class="back-button" onclick="window.switchView('home')" style="position: absolute; left: 20px; top: 20px; z-index: 100;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <div class="playlist-cover-wrap">
                                <img src="https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/radiohead.jpg" class="playlist-cover-big" id="radiohead-cover-view">
                            </div>
                            <div class="playlist-info-big">
                                <span>BAND</span>
                                <h1 id="radiohead-title-view">Radiohead</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;">Band Asing Populer</span>  <span id="radiohead-count">10 lagu</span>
                                </div>
                            </div>
                        </div>
                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfRadiohead()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>
                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="radiohead-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>


                    <!-- VIEW: LIKED SONGS -->
                    <div id="view-liked" class="view-section">
                        <div class="playlist-header-view" id="liked-header-bg">
                            <div class="playlist-cover-wrap">
                                <img src="https://picsum.photos/seed/liked/300/300" class="playlist-cover-big" id="liked-cover-view">
                                <button class="edit-cover-btn" onclick="document.getElementById('liked-cover-input').click()">
                                    <i class="ph-fill ph-camera"></i>
                                </button>
                                <input type="file" id="liked-cover-input" style="display: none;" accept="image/*" onchange="window.handleLikedCoverUpload(this)">
                            </div>
                            <div class="playlist-info-big">
                                <span data-i18n="liked-header">Liked</span>
                                <h1 id="liked-title-view" data-i18n="liked-header">Liked</h1>
                                <div class="playlist-meta">
                                    <span style="color: white;" data-i18n="song-collection">Song Collection</span>  <span id="liked-count">0 <span data-i18n="songs-label">songs</span></span>
                                </div>
                            </div>
                        </div>

                        <div class="playlist-actions">
                            <div class="action-play-btn" onclick="window.playFirstSongOfLiked()"><i class="ph-fill ph-play" style="font-size: 28px; color: black;"></i></div>
                        </div>

                        <div style="padding: 0 32px;">
                            <div class="song-list-header">
                                <div>#</div>
                                <div>Judul</div>
                                <div>Album</div>
                                <div><i class="ph ph-clock"></i></div>
                                <div></div>
                            </div>
                            <div id="liked-songs-container"></div>
                        </div>
                        <br><br><br>
                    </div>

                    <!-- --- NEW: PROFILE VIEW (SPOTIFY STYLE) --- -->
                    <div id="view-profile" class="view-section">
                        <div class="profile-hero-section" id="profile-hero-section" style="position: relative;">
                            <button onclick="window.goBack()" class="back-button" title="Kembali" style="position: absolute; top: 8px; left: 12px; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px;">
                                <i class="ph ph-arrow-left"></i>
                            </button>
                            <img src="" alt="Profile Avatar" class="profile-avatar-lg" id="profile-avatar-display">
                            <div class="profile-hero-content">
                                <div class="profile-type-label" data-i18n="profile-label">Profile</div>
                                <h1 class="profile-name-large" id="profile-name-display">Nama User</h1>
                                
                                <!-- USER ID DISPLAY -->
                                <div class="profile-userid-display" onclick="window.copyUserId()">
                                    <span id="profile-userid-text">User#0000</span>
                                    <i class="ph ph-copy copy-id-icon"></i>
                                </div>

                                <p class="profile-bio-display" id="profile-bio-display" data-i18n="profile-bio-placeholder"></p>
                            </div>
                        </div>

                        <div class="profile-actions">
                            <div class="btn-circle-blue"><i class="ph ph-check"></i></div> <!-- Mock Verified Icon -->
                            <button class="btn-pill" onclick="window.toggleProfileEdit()">
                                <i class="ph ph-pencil-simple"></i> <span data-i18n="edit-profile">Edit Profile</span>
                            </button>
                        </div>

                        <!-- Desktop Language Selector -->
                        <div style="padding: 24px 32px; position: relative; display: none;" class="desktop-language-section" id="desktop-language-section">
                            <button class="btn-pill" style="width: 100%; max-width: 280px; margin: 0 auto; display: flex; justify-content: space-between; padding: 12px 20px; background: linear-gradient(135deg, rgba(229, 9, 20, 0.15), rgba(229, 9, 20, 0.05)); border: 1px solid rgba(229, 9, 20, 0.3);" onclick="window.toggleLanguageDropdownDesktop()">
                                <span data-i18n="setting-language" style="font-weight: 600;">Setting Language</span>
                                <i class="ph ph-caret-down"></i>
                            </button>
                            <div class="language-dropdown" id="language-dropdown-desktop" style="display: none; position: absolute; top: 72px; left: 50%; transform: translateX(-50%); width: calc(100% - 64px); max-width: 280px; background: linear-gradient(135deg, #1a1a1a, #222222); border: 1px solid rgba(229, 9, 20, 0.4); border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);">
                                <button onclick="window.switchLanguage('id'); document.getElementById('language-dropdown-desktop').style.display='none';" class="active" id="lang-id-btn-desktop" style="padding: 14px 20px; border: none; background: transparent; color: white; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; width: 100%; border-radius: 10px 10px 0 0;">
                                    <i class="ph ph-check" style="margin-right: 12px; color: var(--primary-red); opacity: 1; transition: opacity 0.2s;"></i> <span>Bahasa Indonesia</span>
                                </button>
                                <div style="height: 1px; background: rgba(229, 9, 20, 0.2);"></div>
                                <button onclick="window.switchLanguage('en'); document.getElementById('language-dropdown-desktop').style.display='none';" id="lang-en-btn-desktop" style="padding: 14px 20px; border: none; background: transparent; color: white; cursor: pointer; text-align: left; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; width: 100%; border-radius: 0 0 10px 10px;">
                                    <i class="ph ph-check" style="margin-right: 12px; color: var(--primary-red); opacity: 0; transition: opacity 0.2s;"></i> <span>English</span>
                                </button>
                            </div>
                        </div>

                        <!-- Mobile Language Selector -->
                        <div style="padding: 16px 24px; position: relative; display: none;" id="mobile-language-section" class="mobile-language-section">
                            <button class="btn-pill" style="width: 100%; justify-content: space-between;" onclick="window.toggleLanguageDropdown()">
                                <span data-i18n="setting-language">Setting Language</span>
                                <i class="ph ph-caret-down"></i>
                            </button>
                            <div class="language-dropdown" id="language-dropdown">
                                <button onclick="window.switchLanguage('id'); window.toggleLanguageDropdown();" class="active" id="lang-id-btn">
                                    <i class="ph ph-check" style="margin-right: 8px; opacity: 1; transition: opacity 0.2s;"></i> Bahasa Indonesia
                                </button>
                                <button onclick="window.switchLanguage('en'); window.toggleLanguageDropdown();" id="lang-en-btn">
                                    <i class="ph ph-check" style="margin-right: 8px; opacity: 0; transition: opacity 0.2s;"></i> English
                                </button>
                            </div>
                        </div>

                        <!-- Edit Form Panel -->
                        <div class="profile-edit-panel" id="profile-edit-panel">
                            <div class="edit-grid">
                                <div class="edit-avatar-wrapper" onclick="document.getElementById('profile-avatar-input').click()">
                                    <img src="" id="edit-profile-img">
                                    <div class="edit-avatar-overlay">
                                        <i class="ph ph-camera" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <input type="file" id="profile-avatar-input" style="display: none;" accept="image/*" onchange="window.handleProfileAvatarUpload(this)">
                                
                                <div class="edit-form">
                                    <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;" data-i18n="profile-name-label">Name</label>
                                    <input type="text" id="edit-profile-name" class="edit-input">
                                    <small style="color: #aaa; font-size: 12px;" data-i18n="profile-id-note">User ID will automatically follow the new name.</small>
                                    
                                    <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase; margin-top: 16px;" data-i18n="profile-bio-label">Bio</label>
                                    <textarea id="edit-profile-bio" class="edit-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="edit-actions-row">
                                <button class="btn-cancel" onclick="window.toggleProfileEdit()" data-i18n="cancel">Cancel</button>
                                <button class="btn-save" onclick="window.saveProfileChanges()" data-i18n="save">Save</button>
                            </div>
                        </div>

                        <div class="section-title-profile" data-i18n="public-playlists"></div>
                        <div class="playlist-modal-grid-profile" id="profile-public-playlists">
                            <!-- Playlists generated by JS -->
                        </div>
                        
                        <br><br><br>
                    </div>

                </div>
            </main>
        </div>

        <!-- ARTIST/BAND PROFILE OVERLAY (DESKTOP ONLY) -->
        <div id="artist-band-profile-overlay">
            <div class="artist-band-overlay-header">
                <button class="artist-band-overlay-back" onclick="window.closeArtistBandOverlay()">
                    <i class="ph ph-arrow-left"></i>
                </button>
                <div class="artist-band-overlay-title" id="artist-band-overlay-title">Band/Artist Name</div>
            </div>
            <div class="artist-band-overlay-content">
                <div class="artist-band-overlay-left">
                    <img src="" id="artist-band-overlay-cover" class="artist-band-overlay-cover" alt="Artist/Band Cover">
                    <div class="artist-band-overlay-info">
                        <h2 id="artist-band-overlay-name">Artist/Band</h2>
                        <p id="artist-band-overlay-category">Kategori</p>
                        <p id="artist-band-overlay-description" style="margin-top: 12px; color: #999;"></p>
                        <div class="artist-band-overlay-stats">
                            <div class="artist-band-overlay-stat">
                                <div class="artist-band-overlay-stat-value" id="artist-band-overlay-song-count">0</div>
                                <div class="artist-band-overlay-stat-label">Lagu</div>
                            </div>
                            <div class="artist-band-overlay-stat">
                                <div class="artist-band-overlay-stat-value" id="artist-band-overlay-followers">--</div>
                                <div class="artist-band-overlay-stat-label">Pendengar</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="artist-band-overlay-right">
                    <div class="artist-band-overlay-songs-title" data-i18n="popular-songs">Lagu Populer</div>
                    <div class="artist-band-overlay-songs" id="artist-band-overlay-songs">
                        <!-- Songs will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-container" style="position: fixed; bottom: 110px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; max-width: 320px;"></div>

        <!-- Player Bar -->
        <footer class="player-bar">
            <div class="player-left">
                <img src="https://picsum.photos/seed/music/60/60" alt="Album Art" class="current-art" id="player-art">
                <div class="current-info">
                    <div class="current-title" id="player-title" data-i18n="select-song">Pilih Lagu</div>
                    <div class="current-artist" id="player-artist">...</div>
                </div>
                <button class="like-btn" id="like-btn" onclick="window.toggleCurrentSongLike()">
                    <i class="ph ph-heart"></i>
                </button>
            </div>

            <div class="player-center">
                <div class="player-controls">
                    <button class="control-btn" id="shuffle-btn" onclick="window.toggleShuffle()"><i class="ph ph-shuffle"></i></button>
                    <button class="control-btn" id="prev-btn" onclick="window.playPrevious()"><i class="ph ph-skip-back-fill"></i></button>
                    <button class="play-pause-btn" id="play-pause-btn"><i class="ph-fill ph-play"></i></button>
                    <button class="control-btn" id="next-btn" onclick="window.playNext()"><i class="ph ph-skip-forward-fill"></i></button>
                    <button class="control-btn" id="repeat-btn" onclick="window.toggleRepeat()"><i class="ph ph-repeat"></i></button>
                </div>
                <div class="playback-bar">
                    <span id="current-time">0:00</span>
                    <div class="progress-container" id="progress-container">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <span id="total-duration">0:00</span>
                </div>
            </div>

            <div class="player-right">
    <button class="control-btn" title="Lirik"><i class="ph ph-microphone-stage"></i></button>
    <button class="control-btn" title="Queue" onclick="window.toggleQueueOverlay()"><i class="ph ph-queue"></i></button>
    

    <button class="control-btn" id="vol-icon" title="Volume"><i class="ph ph-speaker-high"></i></button>
    <div class="volume-bar-container" id="volume-container">
        <div class="volume-fill" id="volume-fill"></div>
    </div>
</div>
        </footer>

        <!-- Mobile bottom navigation (visible on small screens) -->
        <nav class="mobile-bottom-nav" aria-label="Navigasi bawah">
            <a href="#" class="mb-nav-item" id="mb-nav-home" onclick="event.preventDefault(); window.switchView('home')">
                <i class="ph ph-house"></i>
                <span data-i18n="nav-home">Home</span>
            </a>
            <a href="#" class="mb-nav-item" id="mb-nav-search" onclick="event.preventDefault(); window.switchView('search')">
                <i class="ph ph-magnifying-glass"></i>
                <span data-i18n="nav-search">Search</span>
            </a>
            <a href="#" class="mb-nav-item" id="mb-nav-liked" onclick="event.preventDefault(); window.switchView('liked')">
                <i class="ph ph-heart"></i>
                <span data-i18n="nav-liked">Liked</span>
            </a>
        </nav>

        <!-- QUEUE OVERLAY -->
        <div id="queue-overlay">
            <div class="queue-header">
                <div class="queue-title" data-i18n="queue-title">Queue</div>
                <button class="queue-close-btn" onclick="window.toggleQueueOverlay()"><i class="ph ph-x"></i></button>
            </div>
            <div class="queue-list" id="queue-list-container">
                <!-- Queue items rendered here -->
                <div style="padding:20px; text-align:center; color:#666;" data-i18n="queue-empty">Queue is empty.</div>
            </div>
        </div>

    </div>

    <!-- OVERLAY PLAYER SCREEN -->
    <div id="overlay-player">
        <div class="overlay-bg" id="overlay-bg"></div>
        <div class="overlay-content">
            <button class="overlay-close-btn" onclick="window.closeOverlayPlayer()">
                <i class="ph ph-caret-down"></i>
            </button>
            <div class="overlay-art-wrapper">
                <img src="" id="overlay-art" alt="Album Art">
            </div>
            <div class="overlay-info">
                <h2 id="overlay-title">Title</h2>
                <p id="overlay-artist" onclick="window.openArtistProfileFromOverlay()" style="cursor: pointer; text-decoration: underline;">Artist</p>
            </div>
            
            <div class="overlay-progress-container" id="overlay-progress-container">
                <div class="overlay-progress-bar">
                    <div class="overlay-progress-fill" id="overlay-progress-fill"></div>
                </div>
                <div class="overlay-time">
                    <span id="overlay-current-time">0:00</span>
                    <span id="overlay-total-duration">0:00</span>
                </div>
            </div>

            <div class="overlay-controls">
                <button onclick="window.toggleShuffle()"><i class="ph ph-shuffle" id="overlay-shuffle-icon"></i></button>
                <button onclick="window.playPrevious()"><i class="ph-fill ph-skip-back"></i></button>
                <button class="overlay-play-btn" id="overlay-play-pause-btn" onclick="document.getElementById('play-pause-btn').click()">
                    <i class="ph-fill ph-play"></i>
                </button>
                <button onclick="window.playNext()"><i class="ph-fill ph-skip-forward"></i></button>
                <button onclick="window.toggleRepeat()"><i class="ph ph-repeat" id="overlay-repeat-icon"></i></button>
            </div>
        </div>
    </div>

    <!-- ARTIST PROFILE OVERLAY -->
    <div id="artist-profile-overlay" class="artist-profile-overlay-container">
        <div class="artist-profile-header-top">
            <button class="artist-profile-back-btn" onclick="window.closeArtistProfile()">
                <i class="ph ph-arrow-left"></i>
            </button>
        </div>
        <div class="playlist-header-view" id="artist-profile-header">
            <div class="playlist-cover-wrap">
                <img src="" class="playlist-cover-big" id="artist-profile-img">
            </div>
            <div class="playlist-info-big">
                <span>ARTIS</span>
                <h1 id="artist-profile-name">Nama Artis</h1>
                <div class="playlist-meta">
                    <span style="color: white;">Profil Artis</span>
                </div>
            </div>
        </div>
        <div class="artist-profile-content">
             <h3 class="artist-profile-section-title" data-i18n="popular-songs">Lagu Populer</h3>
             <div id="artist-profile-songs"></div>
        </div>
    </div>

    <!-- 4. MODALS -->

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Buat Playlist Baru</div>
                <button class="close-modal-btn" onclick="window.closeModal('create-playlist-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: #b3b3b3; font-size: 14px;">Gambar cover default akan diberikan secara otomatis.</p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;" data-i18n="playlist-name-label"></label>
                <input type="text" id="new-playlist-name" class="modal-input" placeholder="Contoh: Lagu Santai" data-i18n-placeholder="playlist-name-example" style="margin-top: 8px;">
            </div>
            <button class="modal-btn" onclick="window.submitCreatePlaylist()" data-i18n="create-button"></button>
        </div>
    </div>

    <!-- IMPORT MUSIC MODAL -->
<div id="import-music-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title" data-i18n="import-music">Import Music</div>
            <button class="close-modal-btn" onclick="window.closeModal('import-music-modal')">
                <i class="ph ph-x"></i>
            </button>
        </div>

        <div class="import-form-grid">
            <!-- File Preview -->
            <div class="import-file-preview" id="import-file-preview">
                <img src="https://picsum.photos/seed/default/100/100" 
                     class="import-cover-preview" 
                     id="import-cover-preview">
                <div class="import-file-info">
                    <div class="import-file-name" id="import-file-name" data-i18n="no-file-selected">
                        <span data-i18n="no-file-selected">No file selected</span>
                    </div>
                    <div class="import-file-size" id="import-file-size">
                        <span data-i18n="choose-mp3">Choose MP3 file</span>
                    </div>
                </div>
                <input type="file" 
                       id="import-music-file" 
                       accept="audio/mp3,audio/mpeg" 
                       style="display: none;" 
                       onchange="window.handleMusicFileSelect(this)">
                <button class="file-upload-btn" 
                        onclick="document.getElementById('import-music-file').click()">
                    <i class="ph ph-file-audio"></i> <span data-i18n="choose-mp3-btn">Choose MP3</span>
                </button>
            </div>

            <!-- Song Info -->
            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    <span data-i18n="song-title-label">Song Title</span>
                </label>
                <input type="text" 
                       id="import-song-title" 
                       class="modal-input" 
                       data-i18n-placeholder="song-title-placeholder" 
                       placeholder="e.g. Beautiful Day">
            </div>

            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    <span data-i18n="artist-label">Artist</span>
                </label>
                <input type="text" 
                       id="import-song-artist" 
                       class="modal-input" 
                       data-i18n-placeholder="artist-placeholder" 
                       placeholder="e.g. John Doe">
            </div>

            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    <span data-i18n="album-label">Album</span>
                </label>
                <input type="text" 
                       id="import-song-album" 
                       class="modal-input" 
                       data-i18n-placeholder="album-placeholder" 
                       placeholder="e.g. Greatest Hits">
            </div>

            <!-- Cover Photo Upload -->
            <div>
                <label style="font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase;">
                    <span data-i18n="cover-label">Album Cover (Optional)</span>
                </label>
                <input type="file" 
                       id="import-cover-file" 
                       accept="image/*" 
                       style="display: none;" 
                       onchange="window.handleCoverFileSelect(this)">
                <button class="file-upload-btn" 
                        onclick="document.getElementById('import-cover-file').click()" 
                        style="width: 100%; margin-top: 8px;">
                    <i class="ph ph-image"></i> <span data-i18n="choose-photo">Choose Photo</span>
                </button>
            </div>

            <!-- Privacy Toggle -->
            <div class="privacy-toggle">
                <label>
                    <i class="ph ph-lock-key" id="privacy-icon" style="margin-right: 5px;"></i>
                    <span id="privacy-label">Privat</span>
                                        <span id="privacy-label" data-i18n="privacy-label">Private</span>
                    <p style="font-size: 11px; color: #888; margin-top: 3px;">
                        <span data-i18n="privacy-desc">Only you can listen</span>
                    </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" 
                           id="import-privacy-toggle" 
                           onchange="window.updatePrivacyLabel(this)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Submit Button -->
            <button class="modal-btn" onclick="window.submitImportMusic()">
                <i class="ph ph-upload-simple"></i> <span data-i18n="import-music">Import Music</span>
            </button>
        </div>
    </div>
</div>

    <!-- Add Song to Playlist Modal -->
    <div id="add-song-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="add-to-playlist">Add to Playlist</div>
                <button class="close-modal-btn" onclick="window.closeModal('add-song-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div class="playlist-select-list" id="add-song-playlist-list"></div>
        </div>
    </div>

    <!-- Share to Friend Modal -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-i18n="share-to-friends"></div>
                <button class="close-modal-btn" onclick="window.closeModal('share-modal')"><i class="ph ph-x"></i></button>
            </div>
            <div class="playlist-select-list" id="share-friend-list" style="max-height: 300px;"></div>
            <p id="share-loading" style="text-align:center; color: #888; display:none;"><span data-i18n="loading"></span></p>
        </div>
    </div>

    <!-- --- NEW OVERLAYS --- -->

    <!-- Full Screen Chat Overlay -->
    <div id="chat-overlay">
        <div class="chat-header">
            <button class="chat-back-btn" onclick="window.closeChat()"><i class="ph ph-arrow-left"></i></button>
            <div class="chat-friend-info" onclick="window.openFriendProfileFromChat()">
                <img src="" class="chat-friend-avatar" id="chat-friend-avatar-display">
                <div>
                    <div class="chat-friend-name" id="chat-friend-name-display" data-i18n="friend-name"></div>
                    <div class="chat-status">Online</div>
                </div>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <!-- Messages injected here -->
        </div>
       <div class="chat-footer">
        <!-- Listen Together Button -->
        <button id="btn-open-listen-together" onclick="window.openListenTogether()" title="Dengar Bareng" style="background:none; border:none; color:#aaa; font-size:24px; cursor:pointer; margin-right:10px; display:flex; align-items:center; transition: color 0.2s;">
            <i class="ph ph-users-three"></i>
        </button>
    <input 
        type="text" 
        class="chat-input" 
        id="chat-input-box" 
        placeholder="Type a message..." 
        data-i18n-placeholder="chat-placeholder"
        onkeypress="if(event.key === 'Enter') window.sendChatMessage()"
        autocomplete="off"
    >
    <button 
    class="chat-send-btn" 
    onclick="window.sendChatMessage()" 
    title="Kirim Pesan"
    aria-label="Kirim Pesan"
>
    
</button>
</div>
    <!-- Friend Profile Overlay -->
    <div id="friend-profile-overlay">
        <div style="padding: 24px;">
            <button onclick="window.closeFriendProfile()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; margin-bottom:20px;"><i class="ph ph-arrow-left"></i> <span data-i18n="back">Back</span></button>
            <div class="profile-hero-section" id="friend-hero-section">
                <img src="" alt="Friend Avatar" class="profile-avatar-lg" id="friend-profile-avatar-display">
                <div class="profile-hero-content">
                    <div class="profile-type-label" data-i18n="friend-profile-label">Friend Profile</div>
                    <h1 class="profile-name-large" id="friend-profile-name-display">Friend Name</h1>
                    <!-- Friend ID Display -->
                    <div class="profile-userid-display" onclick="window.copyFriendUserId()" style="cursor:default;">
                        <span id="friend-profile-userid-text">Friend#0000</span>
                        <i class="ph ph-copy copy-id-icon"></i>
                    </div>
                    <p class="profile-bio-display" id="friend-profile-bio-display" data-i18n="friend-bio-placeholder"></p>
                </div>
            </div>
            <div class="section-title-profile" data-i18n="public-playlists">Public Playlists</div>
            <div class="playlist-modal-grid-profile" id="friend-public-playlists">
                <!-- Friend Playlists -->
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="ctx-item" onclick="window.ctxAction('copy')">Salin</div>
            <div class="ctx-item" onclick="window.ctxAction('copy')" data-i18n="context-copy">Copy</div>
        <div class="ctx-item" onclick="window.ctxAction('reply')">Balas</div>
            <div class="ctx-item" onclick="window.ctxAction('reply')" data-i18n="context-reply">Reply</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="window.ctxAction('delete')" style="color: var(--primary-red);">Hapus</div>
        <div class="ctx-item" onclick="window.ctxAction('delete')" style="color: var(--primary-red);" data-i18n="context-delete">Delete</div>
    </div>

    <audio id="audio-player"></audio>

    <!-- Listen Together Overlay (Moved to Body End) -->
    <div id="listen-together-overlay">
        <button class="lt-close" onclick="window.closeListenTogether()"><i class="ph ph-x"></i></button>
        <div class="lt-container">
            <div class="lt-header">
                <h2 data-i18n="listen-together-title"> Listen Together</h2>
                <p data-i18n="listen-together-desc">Enjoy music with friends in real-time</p>
            </div>
            <!-- Mode Selection -->
            <div id="lt-mode-section">
                <div class="lt-mode-selector">
                    <button class="lt-mode-btn" onclick="window.selectLTMode('host')">
                        <i class="ph ph-broadcast" style="font-size:32px; display:block; margin-bottom:10px;"></i>
                        <span data-i18n="listen-together-create">Create Session</span>
                    </button>
                    <button class="lt-mode-btn" onclick="window.selectLTMode('join')">
                        <i class="ph ph-sign-in" style="font-size:32px; display:block; margin-bottom:10px;"></i>
                        <span data-i18n="listen-together-join">Join Session</span>
                    </button>
                </div>
            </div>
            <!-- Host Section -->
            <div id="lt-host-section">
                <div class="lt-session-code">
                    <p style="color:#aaa; font-size:12px; margin:0 0 10px 0;" data-i18n="listen-together-your-code">Your Session Code:</p>
                    <div class="lt-code-display" id="lt-session-code">----</div>
                    <p style="color:#aaa; font-size:12px; margin:10px 0 0 0;" data-i18n="listen-together-share-code">Share this code with friends</p>
                </div>
                <button class="lt-btn" onclick="window.copySessionCode()">
                    <i class="ph ph-copy"></i> <span data-i18n="listen-together-copy">Copy Code</span>
                </button>
                <div class="lt-participants" id="lt-participants-list">
                    <p style="color:#666; text-align:center; font-size:13px; margin:0;" data-i18n="waiting-friends">Waiting for friends to join...</p>
                </div>
                <button class="lt-btn" style="background:#444;" onclick="window.endListenTogether()">
                    <span data-i18n="listen-together-end">End Session</span>
                </button>
            </div>
            <!-- Join Section -->
            <div id="lt-join-section">
                <input type="text" class="lt-input" id="lt-join-code" data-i18n-placeholder="listen-together-code-placeholder" placeholder="XXXX" maxlength="4">
                <button class="lt-btn" onclick="window.joinListenTogether()">
                    <i class="ph ph-arrow-right"></i> <span data-i18n="listen-together-join-btn">Join</span>
                </button>
                <p style="color:#aaa; font-size:12px; text-align:center; margin:0;" data-i18n="listen-together-join-desc">
                    Enter the 4-digit code from the host
                </p>
            </div>
        </div>
    </div>

    <!-- Active Session Badge -->
    <div class="session-badge" id="session-badge" style="z-index:999998;">
        <div class="session-badge-icon"></div>
        <span id="session-badge-text" data-i18n="listen-together-active">Listen Together Active</span>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";




        const firebaseConfig = {
            apiKey: "AIzaSyCEamepceiYZtcqlcRnRmFHe0smkGfu_A4",
            authDomain: "gochat-35172.firebaseapp.com",
            databaseURL: "https://gochat-35172-default-rtdb.asia-southeast1.firebasedatabase.app",
            id: "gochat-35172",
            storageBucket: "gochat-35172.firebasestorage.app",
            messagingSenderId: "206571646434",
            appId: "1:206571646434:web:c337d95ea3a6a121499dbb",
            measurementId: "G-XZ2K3PZ6ZK"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const db = getDatabase(app);
        // ===== SUPABASE CONFIGURATION =====
const SUPABASE_URL = 'https://qkruoywwqdpkdjlajbpl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrcnVveXd3cWRwa2RqbGFqYnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDY3OTcsImV4cCI6MjA4NTAyMjc5N30.6NQGI-d13SVih3VKOuSEvLYTeP5tf9QhEUyfi6mBEiA';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log(' Supabase initialized');

        // --- BASE SONGS (Original 1-20) ---
        const baseSongs = [
            { id: 1, title: "Sedia Aku Sebelum Ujan", artist: "Idgitaf", album: "Single", duration: "4:03", cover: "https://picsum.photos/seed/idgitaf/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/2.mp3" },
            { id: 2, title: "All Too Well (10 Minute Version)", artist: "Taylor Swift", album: "Red (Taylor's Version)", duration: "10:13", cover: "https://picsum.photos/seed/taylor/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/3.mp3" },
            { id: 3, title: "Di Sarankan Di Bandung", artist: "Dongker, Jason Ranti", album: "Single", duration: "3:45", cover: "https://picsum.photos/seed/dongker/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/1.mp3" },
            { id: 4, title: "Jatuh Suka", artist: "Tulus", album: "Manusia", duration: "3:50", cover: "https://picsum.photos/seed/tulus/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/10.mp3" },
            { id: 5, title: "I Love You, I'm Sorry", artist: "Gracie Abrams", album: "The Secret of Us", duration: "3:08", cover: "https://picsum.photos/seed/gracie/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/6.mp3" },
            { id: 6, title: "Die On This Hill", artist: "Sienna Spiro", album: "Single", duration: "3:12", cover: "https://picsum.photos/seed/sienna/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/4.mp3" },
            { id: 7, title: "33x", artist: "Perunggu", album: "Single", duration: "4:00", cover: "https://picsum.photos/seed/perunggu1/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/5.mp3" },
            { id: 8, title: "Gemilang", artist: "Perunggu", album: "Single", duration: "3:30", cover: "https://picsum.photos/seed/perunggu2/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/9.mp3" },
            { id: 9, title: "My Love", artist: "Westlife", album: "Coast to Coast", duration: "3:52", cover: "https://picsum.photos/seed/westlife/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/8.mp3" },
            { id: 10, title: "The Winner Takes It All", artist: "Abba", album: "Super Trouper", duration: "4:54", cover: "https://picsum.photos/seed/abba/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/7.mp3" },
            { id: 11, title: "Kengkuz Music", artist: "Biggy Do", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/biggydo/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/11.mp3" },
            { id: 12, title: "Man I Need", artist: "Olivia Dean", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/oliviadean/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/15.mp3" },
            { id: 13, title: "Berubah", artist: "Tenxi", album: "Single", duration: "3:21", cover: "https://picsum.photos/seed/tenxi/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/19.mp3" },
            { id: 14, title: "Mawar Merah", artist: "Slank", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/slank/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/16.mp3" },
            { id: 15, title: "Danza Kuduro", artist: "Don Omar", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/donomar/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/13.mp3" },
            { id: 16, title: "Raindance", artist: "Dave", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/dave/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/12.mp3" },
            { id: 17, title: "Mimosa 2000", artist: "Kobr", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/kobr/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/14.mp3" },
            { id: 18, title: "Snooze", artist: "SZA", album: "SOS", duration: "3:00", cover: "https://picsum.photos/seed/sza/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/17.mp3" },
            { id: 19, title: "Me & U", artist: "Tems", album: "For Broken Ears", duration: "3:00", cover: "https://picsum.photos/seed/tems/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/18.mp3" },
            { id: 20, title: "Jangan Calling", artist: "Ova Libeno", album: "Single", duration: "3:00", cover: "https://picsum.photos/seed/ovalibeno/300/300", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/20.mp3" }
        ];

        // --- MAIN LIST (ID 30-256) ---
        let mainListId = 30;

        function createMainListSong(title, artist, album, duration, cover) {
            const song = {
                id: mainListId,
                title: title,
                artist: artist,
                album: album,
                duration: duration || "3:30",
                cover: cover,
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${mainListId}.mp3`
            };
            mainListId++;
            return song;
        }

        const mainBandSongs = [];

        // 1. PERUNGGU
        const perungguRaw = [
            { title: "Kalibata 2012", src: "2012.mp3" },
            { title: "33x", src: "5.mp3" },
            { title: "Tapi", src: "tapi.mp3" },
            { title: "Ini Abadi", src: "abadi.mp3" },
            { title: "Berhasil", src: "berhasil.mp3" },
            { title: "Pastikan Riuh Akhiri Malammu", src: "riuh.mp3" },
            { title: "Ikhtiar", src: "baik.mp3" },
            { title: "Tarung Bebas", src: "tarung.mp3" },
            { title: "Menyala", src: "Menyala.mp3" }
        ];
        perungguRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 30 + i,
                title: item.title,
                artist: "Perunggu",
                album: "Single",
                duration: "3:45",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/perunggu.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 2. NOAH
        const noahRaw = [
            { title: "Separuh Aku", src: "separuh.mp3" },
            { title: "Yang Terdalam", src: "yang.mp3" },
            { title: "Tak Bisakah", src: "tak.mp3" },
            { title: "Menghapus Jejakmu", src: "jejak.mp3" },
            { title: "Semua Tentang Kita", src: "kita.mp3" },
            { title: "Mungkin Nanti", src: "nanti.mp3" },
            { title: "Ada Apa Denganmu", src: "apa.mp3" },
            { title: "Bintang di Surga", src: "bintang.mp3" },
            { title: "Walau Habis Terang", src: "terang.mp3" },
            { title: "Hidup Untukmu, Mati Tanpamu", src: "hidup.mp3" }
        ];
        noahRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 42 + i,
                title: item.title,
                artist: "NOAH / Peterpan",
                album: "Best of",
                duration: "4:10",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/noah.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 3. DEWA 19
        const dewaRaw = [
            { title: "Kangen", src: "kangen.mp3" },
            { title: "Separuh Nafas", src: "nafas.mp3" },
            { title: "Risalah Hati", src: "hati.mp3" },
            { title: "Pupus", src: "pupus.mp3" },
            { title: "Cinta Kan Membawamu Kembali", src: "kembali.mp3" },
            { title: "Aku Milikmu (Malam Ini)", src: "mu.mp3" },
            { title: "Roman Picisan", src: "roman.mp3" },
            { title: "Dewi", src: "dewi.mp3" },
            { title: "Arjuna", src: "arjuna.mp3" },
            { title: "Kamulah Satu-Satunya", src: "satu.mp3" },
            { title: "Cukup Siti Nurbaya", src: "cukup.mp3" },
            { title: "Takkan Ada Cinta Yang Lain", src: "takkan.mp3" },
            { title: "Mistikus Cinta", src: "mistikus.mp3" }
        ];
        dewaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 57 + i,
                title: item.title,
                artist: "Dewa 19",
                album: "Legends",
                duration: "4:20",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/dewa19.png",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 4. SHEILA ON 7
        const sheilaRaw = [
            { title: "Dan", src: "dan.mp3" },
            { title: "Sephia", src: "sephia.mp3" },
            { title: "Melompat Lebih Tinggi", src: "anugrah.mp3" },
            { title: "Anugrah Terindah Yang Pernah Kumiliki.", src: "kita.mp3" },
            { title: "Sahabat Sejati", src: "sahabat.mp3" },
            { title: "Seberapa Pantas", src: "seberapa.mp3" },
            { title: "Betapa", src: "betapa.mp3" },
            { title: "J.A.P", src: "jap.mp3" },
            { title: "Hari Bersamanya", src: "hari.mp3" },
            { title: "Bila Kau Tak di Sampingku", src: "bila.mp3" },
            { title: "Pemuja Rahasia", src: "pemuja.mp3" }
        ];
        sheilaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 72 + i,
                title: item.title,
                artist: "Sheila On 7",
                album: "Classic",
                duration: "3:50",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/so7.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 5. KAHITNA
        const kahitnaRaw = [
            { title: "Cantik", src: "kahitna.mp3" },
            { title: "Cerita Cinta", src: "cerita.mp3" },
            { title: "Titik Nadir", src: "titik.mp3" },
            { title: "Soulmate", src: "soulmate.mp3" },
            { title: "Mantan Terindah", src: "mantan.mp3" },
            { title: "Seribu Bulan", src: "seribu.mp3" },
            { title: "Aku, Dirimu, Dirinya", src: "dirimu.mp3" },
            { title: "Engga Ngerti", src: "engga.mp3" },
            { title: "Untukku", src: "untukku.mp3" },
            { title: "Sampai Nanti", src: "sampai.mp3" },
            { title: "Rahasia Cinta", src: "rahasia.mp3" }
        ];
        kahitnaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 87 + i,
                title: item.title,
                artist: "Kahitna",
                album: "Romance",
                duration: "4:05",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/kahitna.jpeg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 6. HINDIA
        const hindiaRaw = [
            { title: "Secukupnya", src: "secukupnya.mp3" },
            { title: "Evaluasi", src: "evaluasi.mp3" },
            { title: "Rumah Ke Rumah", src: "rumah.mp3" },
            { title: "Besok Mungkin Kita Sampai", src: "besok.mp3" },
            { title: "Dehidrasi", src: "dehidrrasi.mp3" },
            { title: "Membasuh", src: "membasuh.mp3" },
            { title: "Apapun Yang Terjadi", src: "apapun.mp3" },
            { title: "Untuk Apa / Untuk Apa?", src: "untukapa.mp3" },
            { title: "Jam Makan Siang", src: "jam.mp3" },
            { title: "Mata Air", src: "mata.mp3" },
            { title: "Cincin", src: "cincin.mp3" }
        ];
        hindiaRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 100 + i,
                title: item.title,
                artist: "Hindia",
                album: "Menari Dengan Bayangan",
                duration: "4:30",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/hindia.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/${item.src}`
            });
        });

        // 7. ASTRID
        const astridRaw = [
            { title: "Mendua", src: "mendua.mp3" },
            { title: "Tentang Rasa", src: "rasa.mp3" },
            { title: "Jadikan Aku Yang Kedua", src: "jadikan.mp3" },
            { title: "Aku Bisa Apa", src: "aku.mp3" },
            { title: "Tak Ingin Dicintai", src: "tak.mp3" }
        ];
        astridRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 112 + i,
                title: item.title,
                artist: "Astrid",
                album: "Single",
                duration: "3:55",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/astrid.webp",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/astrid/${item.src}`
            });
        });

        // 8. AFGAN
        const afganRaw = [
            { title: "Terima Kasih Cinta", src: "terimakasih.mp3" },
            { title: "Sadis", src: "sadis.mp3" },
            { title: "Bukan Cinta Biasa", src: "bukancinta.mp3" },
            { title: "Jodoh Pasti Bertemu", src: "jodoh.mp3" },
            { title: "Cinta Tanpa Syarat", src: "cinta.mp3" },
            { title: "Kamu Yang Kutunggu", src: "kamu.mp3" },
            { title: "Bawalah Cintaku", src: "bawalah.mp3" },
            { title: "Kacamata", src: "kacamata.mp3" }
        ];
        afganRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 122 + i,
                title: item.title,
                artist: "Afgan",
                album: "Single",
                duration: "4:00",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/afgan.png",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/afgan/${item.src}`
            });
        });

        // 9. TULUS
        const tulusRaw = [
            { title: "Sepatu", src: "sepatu.mp3" },
            { title: "Monokrom", src: "monokrom.mp3" },
            { title: "Teman Hidup", src: "temanhidup.mp3" },
            { title: "Pamit", src: "pamit.mp3" },
            { title: "1000 Tahun Lamanya", src: "1000.mp3" },
            { title: "Diri", src: "diri.mp3" },
            { title: "Hati-Hati di Jalan", src: "hati-hati.mp3" },
            { title: "Interaksi", src: "interaksi.mp3" },
            { title: "Jatuh Suka", src: "jatuh.mp3" },
            { title: "Tujuh Belas", src: "tujuh.mp3" }
        ];
        tulusRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 132 + i,
                title: item.title,
                artist: "Tulus",
                album: "Single",
                duration: "3:50",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tulus.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/tulus/${item.src}`
            });
        });

        // 10. MAHALINI
        const mahaliniRaw = [
            { title: "Melawan Restu", src: "melawan.mp3" },
            { title: "Sial", src: "sial.mp3" },
            { title: "Kisah Sempurna", src: "kisah.mp3" },
            { title: "Sisa Rasa", src: "sisa.mp3" },
            { title: "Mati-matian", src: "mati.mp3" },
            { title: "Bawa Dia Kembali", src: "bawa.mp3" },
            { title: "Sampai Menutup Mata", src: "sampai.mp3" },
            { title: "Mencintaimu", src: "mencintaimu.mp3" }
        ];
        mahaliniRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 142 + i,
                title: item.title,
                artist: "Mahalini",
                album: "Single",
                duration: "4:15",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/mahalini.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/mahalini/${item.src}`
            });
        });

        // 11. TENXI
        const tenxiRaw = [
            { title: "mejikuhibiniu", src: "mejikuhibiniu.mp3" },
            { title: "Kasih Aba Aba", src: "kasihaba.mp3" },
            { title: "Bintang 5", src: "bintang5.mp3" },
            { title: "Garam & Madu (Sakit Daduku)", src: "garam.mp3" },
            { title: "Berubah", src: "berubah.mp3" }
        ];
        tenxiRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 152 + i,
                title: item.title,
                artist: "Tenxi",
                album: "Single",
                duration: "3:21",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tenxi.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/tenxi/${item.src}`
            });
        });

        // 12. TAYLOR SWIFT
        const taylorRaw = [
            { title: "Love Story", src: "love.mp3" },
            { title: "You Belong With Me", src: "you.mp3" },
            { title: "Blank Space", src: "blank.mp3" },
            { title: "Shake It Off", src: "shake.mp3" },
            { title: "Bad Blood", src: "bad.mp3" },
            { title: "Delicate", src: "delicate.mp3" },
            { title: "Anti-Hero", src: "antihero.mp3" },
            { title: "Cruel Summer", src: "cruel.mp3" }
        ];
        taylorRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 157 + i,
                title: item.title,
                artist: "Taylor Swift",
                album: "Studio Albums",
                duration: "3:45",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/taylor.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/taylorswift/${item.src}`
            });
        });

        // 13. JUSTIN BIEBER
        const justinRaw = [
            { title: "Baby", src: "baby.mp3" },
            { title: "One Time", src: "one.mp3" },
            { title: "Sorry", src: "sorry.mp3" },
            { title: "Love Yourself", src: "love.mp3" },
            { title: "What Do You Mean?", src: "wdym.mp3" },
            { title: "Boyfriend", src: "boy.mp3" },
            { title: "Peaches", src: "peaches.mp3" },
            { title: "Stay", src: "stay.mp3" },
            { title: "Yummy", src: "yummy.mp3" },
            { title: "Never Say Never", src: "never.mp3" }
        ];
        justinRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 167 + i,
                title: item.title,
                artist: "Justin Bieber",
                album: "Studio Albums",
                duration: "3:30",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/justin.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/justinbieber/${item.src}`
            });
        });

        // 14. ED SHEERAN
        const edRaw = [
            { title: "Shape of You", src: "shape.mp3" },
            { title: "Perfect", src: "perfect.mp3" },
            { title: "Thinking Out Loud", src: "think.mp3" },
            { title: "Photograph", src: "photograph.mp3" },
            { title: "Castle on the Hill", src: "castle.mp3" },
            { title: "Bad Habits", src: "bad.mp3" },
            { title: "Galway Girl", src: "galway.mp3" },
            { title: "Shivers", src: "shivers.mp3" },
            { title: "The A Team", src: "the.mp3" },
            { title: "Happier", src: "happier.mp3" }
        ];
        edRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 177 + i,
                title: item.title,
                artist: "Ed Sheeran",
                album: "Studio Albums",
                duration: "4:00",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ed.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/edsheeran/${item.src}`
            });
        });

        // 15. BRUNO MARS
        const brunoRaw = [
            { title: "Just the Way You Are", src: "just.mp3" },
            { title: "Grenade", src: "grenade.mp3" },
            { title: "Talking to the Moon", src: "talking.mp3" },
            { title: "Locked Out of Heaven", src: "locked.mp3" },
            { title: "When I Was Your Man", src: "when.mp3" },
            { title: "Thats what I like", src: "thats.mp3" },
            { title: "Die With A Smile", src: "die.mp3" },
            { title: "It Will Rain", src: "it.mp3" },
            { title: "Versace on the Floor", src: "versace.mp3" },
            { title: "Leave the Door Open", src: "leave.mp3" }
        ];
        brunoRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 187 + i,
                title: item.title,
                artist: "Bruno Mars",
                album: "Studio Albums",
                duration: "3:50",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/bruno.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/brunomars/${item.src}`
            });
        });

        // 16. DANIEL CAESAR
        const danielRaw = [
            { title: "Best Part", src: "best.mp3" },
            { title: "Get You", src: "get.mp3" },
            { title: "Japanese Denim", src: "japanese.mp3" },
            { title: "Cyanide", src: "cyanide.mp3" },
            { title: "Love Again", src: "love.mp3" },
            { title: "Streetcar", src: "streetcar.mp3" },
            { title: "Who Hurt You?", src: "who.mp3" },
            { title: "Who Knows", src: "whoknows.mp3" },
            { title: "Blessed", src: "blessed.mp3" },
            { title: "Always", src: "always.mp3" } 
        ];
        danielRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 197 + i,
                title: item.title,
                artist: "Daniel Caesar",
                album: "Studio Albums",
                duration: "3:40",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/daniel.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/danielcaesar/${item.src}`
            });
        });

        // 17. COLDPLAY
        const coldplayRaw = [
            { title: "Yellow", src: "yellow.mp3" },
            { title: "Fix You", src: "fix.mp3" },
            { title: "Viva La Vida", src: "viva.mp3" },
            { title: "The Scientist", src: "the.mp3" },
            { title: "Paradise", src: "paradise.mp3" },
            { title: "Clocks", src: "clocks.mp3" },
            { title: "A Sky Full of Stars", src: "a.mp3" },
            { title: "Hymn for the Weekend", src: "hymn.mp3" },
            { title: "Sparks", src: "sparks.mp3" },
            { title: "Adventure of a Lifetime", src: "adventure.mp3" }
        ];
        coldplayRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 207 + i,
                title: item.title,
                artist: "Coldplay",
                album: "Studio Albums",
                duration: "4:10",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/coldplay.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/coldplay/${item.src}`
            });
        });

        // 18. ONE DIRECTION
        const onedirectionRaw = [
            { title: "What Makes You Beautiful", src: "what.mp3" },
            { title: "Story of My Life", src: "story.mp3" },
            { title: "One Thing", src: "one.mp3" },
            { title: "Night Changes", src: "night.mp3" },
            { title: "Best Song Ever", src: "best.mp3" },
            { title: "Kiss You", src: "kiss.mp3" },
            { title: "Drag Me Down", src: "drag.mp3" },
            { title: "Steal My Girl", src: "steal.mp3" },
            { title: "Little Things", src: "little.mp3" },
            { title: "Live While Were Young", src: "live.mp3" }
        ];
        onedirectionRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 217 + i,
                title: item.title,
                artist: "One Direction",
                album: "Studio Albums",
                duration: "3:20",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/onedirection.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/onedirection/${item.src}`
            });
        });

        // 19. GREEN DAY
        const greendayRaw = [
            { title: "American Idiot", src: "american.mp3" },
            { title: "Boulevard of Broken Dreams", src: "boulevard.mp3" },
            { title: "Wake Me Up When September Ends", src: "wake.mp3" },
            { title: "Holiday", src: "holiday.mp3" },
            { title: "21 Guns", src: "21.mp3" },
            { title: "Basket Case", src: "basket.mp3" },
            { title: "Good Riddance (Time of Your Life)", src: "good.mp3" },
            { title: "When I Come Around", src: "when.mp3" },
            { title: "Know Your Enemy", src: "know.mp3" },
            { title: "Jesus of Suburbia", src: "jesus.mp3" }
        ];
        greendayRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 227 + i,
                title: item.title,
                artist: "Green Day",
                album: "Studio Albums",
                duration: "3:00",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/greenday.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/greenday/${item.src}`
            });
        });

        // 20. OASIS
        const oasisRaw = [
            { title: "Wonderwall", src: "wonderwall.mp3" },
            { title: "Dont Look Back in Anger", src: "dont.mp3" },
            { title: "Champagne Supernova", src: "champagne.mp3" },
            { title: "Live Forever", src: "live.mp3" },
            { title: "Stop Crying Your Heart Out", src: "stop.mp3" },
            { title: "Supersonic", src: "super.mp3" },
            { title: "Stand by Me", src: "stand.mp3" },
            { title: "Whatever", src: "whatever.mp3" },
            { title: "Don't Go Away", src: "dontgo.mp3" },
            { title: "All Around The World", src: "all.mp3" }
        ];
        oasisRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 237 + i,
                title: item.title,
                artist: "Oasis",
                album: "Studio Albums",
                duration: "4:15",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/oasis.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/oasis/${item.src}`
            });
        });

        // 21. RADIOHEAD
        const radioheadRaw = [
            { title: "Creep", src: "creep.mp3" },
            { title: "No Surprises", src: "no.mp3" },
            { title: "Karma Police", src: "karma.mp3" },
            { title: "High and Dry", src: "high.mp3" },
            { title: "Fake Plastic Trees", src: "fake.mp3" },
            { title: "Paranoid Android", src: "paranoid.mp3" },
            { title: "Exit Music (For a Film)", src: "exit.mp3" },
            { title: "Lotus Flower", src: "lotus.mp3" },
            { title: "Street Spirit (Fade Out)", src: "street.mp3" },
            { title: "Let Down", src: "let.mp3" }
        ];
        radioheadRaw.forEach((item, i) => {
            mainBandSongs.push({
                id: 247 + i,
                title: item.title,
                artist: "Radiohead",
                album: "Studio Albums",
                duration: "4:20",
                cover: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/radiohead.jpg",
                src: `https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/radiohead/${item.src}`
            });
        });


        // --- HANUNG & RARA LOGIC (PRESERVED) ---
        let hanungId = 300;
        const hanungRawData = [
            { title: "Sedia Aku Sebelum Hujan", artist: "Idgitaf", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/2.mp3" },
            { title: "Titik Nadir", artist: "Kahitna", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/titik nadir.mp3" },
            { title: "Disarankan Di Bandung", artist: "Dongker, Jason Ranti", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/1.mp3" },
            { title: "Firasat", artist: "Marcell", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/Firasat.mp3" },
            { title: "33 Kali", artist: "Perunggu", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/5.mp3" },
            { title: "Kota Ini Tak Sama Tanpamu", artist: "Nadhif Basalamah", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/kotanadhif.mp3" }
        ];
        const hanungSongs = [];
        hanungRawData.forEach((item, index) => {
            hanungSongs.push({
                id: hanungId++,
                title: item.title,
                artist: item.artist,
                album: "Single",
                duration: "3:30",
                cover: `https://picsum.photos/seed/hanung${index + 100}/300/300`,
                src: item.src
            });
        });

        let raraId = 306;
        const raraRawData = [
            { title: "Its You", artist: "Ali Gatie", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/itsyou.mp3" },
            { title: "P.S. I Love You", artist: "Paul Partohap", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/psiloveyou.mp3" },
            { title: "Cant Take My Eyes Off You", artist: "Frankie Valli", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/myeyes.mp3" },
            { title: "Youre Still The One", artist: "Shania Twain", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/theone.mp3" },
            { title: "Soulmate", artist: "Kahitna", src: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/songs/soulmate.mp3" }
        ];
        const raraSongs = [];
        raraRawData.forEach((item, index) => {
            raraSongs.push({
                id: raraId++,
                title: item.title,
                artist: item.artist,
                album: "Single",
                duration: "3:30",
                cover: `https://picsum.photos/seed/rara${index + 200}/300/300`,
                src: item.src
            });
        });


        const songs = [...baseSongs, ...mainBandSongs, ...hanungSongs, ...raraSongs];

        // --- GLOBAL STATE ---
        let likedSongs = [];
        let currentSongIndex = 0;
        let isPlaying = false;
        let currentUserData = null;
        let currentPlaylistId = null;
        let searchTimeout; 
        let allPublicPlaylists = []; // Store all public playlists for search
        
        // --- QUEUE & HISTORY SYSTEM ---
        let songQueue = [];
        let playHistory = [];
        let isShuffle = false;
        let repeatMode = 0; // 0: Off, 1: All, 2: One
        
        // --- HISTORY / RECENTLY PLAYED ---
        let recentlyPlayed = []; // Stores {type: 'song'|'playlist', data: object, timestamp}
        
        // --- MASTER SEARCH INDEX FOR BANDS & ARTISTS ---
        const searchIndexArtists = [
            // Original Albums
            { name: "Ghani's Album", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ghani.jpg", fn: "window.openGhaniAlbum()" },
            { name: "Revan's Album", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/revan.jpg", fn: "window.openRevanAlbum()" },
            { name: "Hanung's Album", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/pras.jpg", fn: "window.openHanungAlbum()" },
            { name: "Rara's Album", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/rara.jpg", fn: "window.openRaraAlbum()" },
            // Bands & Artists
            { name: "Perunggu", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/perunggu.jpg", fn: "window.openPerungguAlbum()" },
            { name: "NOAH / Peterpan", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/noah.jpg", fn: "window.openNoahAlbum()" },
            { name: "Dewa 19", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/dewa19.png", fn: "window.openDewaAlbum()" },
            { name: "Sheila On 7", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/so7.jpg", fn: "window.openSheilaAlbum()" },
            { name: "Kahitna", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/kahitna.jpeg", fn: "window.openKahitnaAlbum()" },
            { name: "Hindia", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/hindia.jpg", fn: "window.openHindiaAlbum()" },
            { name: "Astrid", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/astrid.webp", fn: "window.openAstridAlbum()" },
            { name: "Afgan", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/afgan.png", fn: "window.openAfganAlbum()" },
            { name: "Tulus", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tulus.jpg", fn: "window.openTulusAlbum()" },
            { name: "Mahalini", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/mahalini.jpg", fn: "window.openMahaliniAlbum()" },
            { name: "Tenxi", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tenxi.jpg", fn: "window.openTenxiAlbum()" },
            { name: "Taylor Swift", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/taylor.jpg", fn: "window.openTaylorAlbum()" },
            { name: "Justin Bieber", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/justin.jpg", fn: "window.openJustinAlbum()" },
            { name: "Ed Sheeran", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ed.jpg", fn: "window.openEdAlbum()" },
            { name: "Bruno Mars", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/bruno.jpg", fn: "window.openBrunoAlbum()" },
            { name: "Daniel Caesar", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/daniel.jpg", fn: "window.openDanielAlbum()" },
            { name: "Coldplay", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/coldplay.jpg", fn: "window.openColdplayAlbum()" },
            { name: "One Direction", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/onedirection.jpg", fn: "window.openOnedirectionAlbum()" },
            { name: "Green Day", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/greenday.jpg", fn: "window.openGreendayAlbum()" },
            { name: "Oasis", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/oasis.jpg", fn: "window.openOasisAlbum()" },
            { name: "Radiohead", img: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/radiohead.jpg", fn: "window.openRadioheadAlbum()" }
        ];

        const audio = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const playerArt = document.getElementById('player-art');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const likeBtn = document.getElementById('like-btn');

        // --- CHAT & FRIENDS STATE ---
        let activeChatFriendUid = null;
        let activeChatFriendData = null;
        let activeChatId = null;
        let replyingToMsgId = null;

        // --- HELPER: EXTRACT DOMINANT COLOR ---
        window.applyCardColor = function(img) {
            try {
                // Ensure image is loaded
                if (!img.complete || img.naturalWidth === 0) return;
                
                const rgb = getAverageRGB(img);
                const card = img.closest('.song-card');
                
                if (card) {
                    // Create a subtle gradient from the dominant color to the card background
                    // Use low opacity (0.15) to keep it subtle and text readable
                    const colorStart = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`;
                    const colorEnd = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`;
                    
                    // Apply gradient background
                    card.style.background = `linear-gradient(180deg, ${colorStart} 0%, var(--bg-card) 100%)`;
                    
                    // Optional: Add a subtle border or glow
                    card.style.border = `1px solid rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                    
                    // Ensure transition for smooth effect
                    card.style.transition = 'background 0.5s ease, border 0.5s ease';
                }
            } catch(e) {
                console.log("Color extraction skipped", e);
            }
        };

        function getAverageRGB(imgEl) {
            var blockSize = 5, defaultRGB = {r:0,g:0,b:0}, canvas = document.createElement('canvas'), context = canvas.getContext && canvas.getContext('2d'), data, width, height, i = -4, length, rgb = {r:0,g:0,b:0}, count = 0;
            if (!context) return defaultRGB;
            height = canvas.height = imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
            width = canvas.width = imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;
            context.drawImage(imgEl, 0, 0);
            try { data = context.getImageData(0, 0, width, height); } catch(e) { return defaultRGB; }
            length = data.data.length;
            while ( (i += blockSize * 4) < length ) { ++count; rgb.r += data.data[i]; rgb.g += data.data[i+1]; rgb.b += data.data[i+2]; }
            rgb.r = ~~(rgb.r/count); rgb.g = ~~(rgb.g/count); rgb.b = ~~(rgb.b/count);
            return rgb;
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode(mode) {
            if(mode === 'signup') {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'block';
            } else {
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            }
        }

       async function handleSignup() {
    const name = document.getElementById('signup-name').value.trim();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const errorMsg = document.getElementById('signup-error');

    if (!name || !email || !password) {
        errorMsg.innerText = window.t('fill-all-fields');
        errorMsg.style.display = 'block';
        return;
    }

    try {
        // Generate User ID: Name_1234 (GANTI # dengan _)
        const cleanName = name.replace(/\s+/g, '');
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        const userId = `${cleanName}_${randomNum}`; //  UBAH DARI # ke _

        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log("User created in Auth:", user.uid);
        
        // Store Username Index for Search
        await set(ref(db, 'usernames/' + userId), user.uid);
        console.log("Username index saved");
        
        // Store User Data
        await set(ref(db, 'users/' + user.uid), {
            username: name,
            userId: userId,
            userIdSuffix: randomNum,
            email: email,
            bio: "Musisi sejati.",
            profile_picture: "https://picsum.photos/seed/" + name + "/200/200",
            likedCover: "https://picsum.photos/seed/liked/300/300",
            playlists: {}
        });
        
        console.log("User data saved to /users/" + user.uid);
        alert(" Akun berhasil dibuat! Silakan login.");
        
        toggleAuthMode('login');
        
    } catch (error) {
        console.error("Signup error:", error);
        errorMsg.innerText = "Error: " + error.message;
        errorMsg.style.display = 'block';
    }
}

  


        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {})
                .catch((error) => {
                    errorMsg.innerText = window.t('email-password-wrong');
                    errorMsg.style.display = 'block';
                });
        }

        function handleLogout() { signOut(auth); }

        // Export to Window for HTML onclick
        window.toggleAuthMode = toggleAuthMode;
        window.handleSignup = handleSignup;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;

        function loadPublicPlaylists() {
            // Fetch all users to find public playlists
            get(ref(db, 'users')).then(snapshot => {
                const users = snapshot.val() || {};
                allPublicPlaylists = []; // Reset global var
                
                Object.values(users).forEach(user => {
                    if (user.playlists) {
                        Object.keys(user.playlists).forEach(plId => {
                            const pl = user.playlists[plId];
                            if (pl.isPublic) {
                                allPublicPlaylists.push({
                                    id: plId,
                                    ...pl,
                                    ownerName: user.username,
                                    ownerId: user.userId
                                });
                            }
                        });
                    }
                });
                console.log("Public playlists loaded:", allPublicPlaylists.length);
            });
        }

       onAuthStateChanged(auth, (user) => {
    const loadingScreen = document.getElementById('loading-screen');
    const authView = document.getElementById('auth-view');
    const appWrapper = document.getElementById('app-wrapper');

    if (user) {
        loadingScreen.style.display = 'flex';
        authView.style.display = 'none';
        appWrapper.style.display = 'none';

        // Load Public Playlists for Search
        loadPublicPlaylists();

        const userRef = ref(db, 'users/' + user.uid);
        onValue(userRef, async (snapshot) => {
            const data = snapshot.val(); //  Ambil data dari snapshot
            if (data) {
                 const trendingContainer = document.getElementById('trending-container');
        if (trendingContainer) {
            // Clone node to remove all event listeners
            const newContainer = trendingContainer.cloneNode(false);
            trendingContainer.parentNode.replaceChild(newContainer, trendingContainer);
        }
                currentUserData = data;
                        document.getElementById('header-username').innerText = data.username;
                        document.getElementById('header-avatar').src = data.profile_picture || "https://picsum.photos/50/50";
                        
                        renderSidebarPlaylists(data.playlists || {});
                        renderTrending(); // Update Trending Section
                        setupFriendListeners(); // Start friend listeners
                        
                        const savedLiked = localStorage.getItem('likedSongs');
                        if (savedLiked) likedSongs = JSON.parse(savedLiked);

                        const savedHistory = localStorage.getItem('recentlyPlayed');
                        if (savedHistory) recentlyPlayed = JSON.parse(savedHistory);

                        // Mulai memuat lagu secara background tanpa menahan UI
                        const songsPromise = loadSongsFromSupabase();
                        const importedPromise = loadImportedSongs();

                        // Jika ada cache lagu, coba render segera untuk UX yang lebih cepat
                        try {
                            const cached = localStorage.getItem('cachedSongs');
                            if (cached) {
                                window._cachedSongs = JSON.parse(cached);
                                // Panggil render minimal agar tampilan terlihat responsif
                                renderTrending();
                                renderPopularBands();
                            }
                        } catch (e) {
                            console.warn('Unable to parse cachedSongs', e);
                        }

                        // Tampilkan app segera, sembunyikan loading overlay
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            appWrapper.style.display = 'flex';
                            switchView('home');
                        }, 50);

                        // Setelah data lagu selesai dimuat, lakukan full re-render
                        Promise.all([songsPromise, importedPromise]).then(() => {
                            console.log('Songs and imports loaded, re-rendering full UI');
                            try {
                                // Optional: simpan cache untuk akses cepat berikutnya
                                if (window.allSongs && Array.isArray(window.allSongs)) {
                                    try { localStorage.setItem('cachedSongs', JSON.stringify(window.allSongs)); } catch (e) {}
                                }
                            } catch (e) {}

                            renderTrending();
                            renderPopularBands();
                            renderPopularArtists();
                            renderForeignSoloArtists();
                            renderForeignBands();

                            // Defer any non-critical re-renders
                            if (window.requestIdleCallback) {
                                requestIdleCallback(() => {
                                    const homeView = document.getElementById('view-home');
                                    if (homeView && homeView.classList.contains('active')) {
                                        renderTrending();
                                        renderPopularBands();
                                    }
                                });
                            }
                        }).catch(err => console.error('Error loading songs:', err));
                    }
                });
            } else {
                currentUserData = null;
                loadingScreen.style.display = 'none';
                authView.style.display = 'flex';
                appWrapper.style.display = 'none';
            }
        });

        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        window.toggleSidebar = toggleSidebar;

        function renderSidebarPlaylists(playlists) {
            const container = document.getElementById('sidebar-playlists-container');
            let html = '';
            const playlistArray = Object.keys(playlists).map(key => ({
                id: key,
                ...playlists[key]
            }));
            
            if(playlistArray.length === 0) {
                container.innerHTML = '<div style="padding: 10px 12px; color: #666; font-size: 13px;">' + window.t('no-playlists') + '</div>';
                return;
            }

            playlistArray.forEach(pl => {
                const isPublic = pl.isPublic || false;
                const privacyIcon = isPublic ? '<i class="ph ph-globe" style="color:#1db954" title="Publik"></i>' : '<i class="ph ph-lock-key" style="color:#b3b3b3" title="Privat"></i>';
                
                html += `
                    <div class="playlist-item" onclick="window.openPlaylist('${pl.id}')">
                        <img src="${pl.cover}" class="playlist-thumb" alt="${pl.name}">
                        <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${pl.name}</span>
                        <button class="btn-icon-small" onclick="event.stopPropagation(); window.togglePlaylistPrivacy('${pl.id}')" style="font-size:16px; padding:5px;">${privacyIcon}</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.add('open');
            document.getElementById('new-playlist-name').value = '';
        }

        function submitCreatePlaylist() {
            const name = document.getElementById('new-playlist-name').value;
            if(!name) {
                alert("Nama playlist tidak boleh kosong!");
                return;
            }
            
            const userId = auth.currentUser.uid;
            const newPlaylistRef = push(ref(db, 'users/' + userId + '/playlists'));
            const playlistId = newPlaylistRef.key;

            const seed = name.replace(/\s/g, '') + Math.floor(Math.random() * 1000);
            const defaultCover = `https://picsum.photos/seed/${seed}/300/300`;

            set(newPlaylistRef, {
                name: name,
                cover: defaultCover,
                songs: {},
                isPublic: false // Default Private
            });

            closeModal('create-playlist-modal');
        }

        window.openCreatePlaylistModal = openCreatePlaylistModal;
        window.submitCreatePlaylist = submitCreatePlaylist;

        // --- FRIENDSHIP & CHAT LOGIC ---
        
        let unreadMessages = {}; // { friendUid: count }

function setupFriendListeners() {
    if(!auth.currentUser) return;
    const myUid = auth.currentUser.uid;

    // Listen Friend Requests
    onValue(ref(db, `users/${myUid}/friendRequests`), (snap) => {
        const reqs = snap.val() || {};
        const container = document.getElementById('friend-requests-container');
        let html = '';
        Object.keys(reqs).forEach(senderUid => {
            const r = reqs[senderUid];
            html += `
                <div class="friend-list-item">
                    <img src="${r.senderPic}" class="friend-avatar-small">
                    <span class="friend-name">${r.senderName}</span>
                    <div class="request-actions">
                        <button class="btn-icon-small btn-accept" onclick="window.respondFriendRequest('${senderUid}', true)"><i class="ph-fill ph-check"></i></button>
                        <button class="btn-icon-small btn-reject" onclick="window.respondFriendRequest('${senderUid}', false)"><i class="ph-fill ph-x"></i></button>
                    </div>
                </div>
            `;
        });
        if(!html) html = '<div style="padding:10px; color:#666; font-size:12px;">' + window.t('no-requests') + '</div>';
        container.innerHTML = html;
    });

    // Listen Friends
    onValue(ref(db, `users/${myUid}/friends`), (snap) => {
        const friends = snap.val() || {};
        const container = document.getElementById('friend-list-container');
        let html = '';
        
        Object.keys(friends).forEach(friendUid => {
            // Setup unread listener for each friend
            setupUnreadListener(friendUid);
            
            html += `
                <div class="friend-list-item" onclick="window.openChat('${friendUid}')" id="friend-item-${friendUid}">
                    <img src="https://picsum.photos/seed/${friendUid}/50/50" id="friend-img-${friendUid}" class="friend-avatar-small">
                    <span class="friend-name" id="friend-name-${friendUid}">Loading...</span>
                    <span class="unread-badge" id="unread-${friendUid}" style="display:none;">0</span>
                </div>
            `;
        });
        
        if(!html) html = `<div style="padding:10px; color:#666; font-size:12px;">${window.t('no-friends-message')}</div>`;
        container.innerHTML = html;
        
        // Fetch friend details
        Object.keys(friends).forEach(friendUid => {
           get(ref(db, `users/${friendUid}`)).then(uSnap => {
               const u = uSnap.val();
               if(u) {
                   const nameEl = document.getElementById(`friend-name-${friendUid}`);
                   const imgEl = document.getElementById(`friend-img-${friendUid}`);
                   if(nameEl) nameEl.innerText = u.username;
                   if(imgEl) imgEl.src = u.profile_picture;
               }
           });
        });
    });
}
       // GANTI KODE SEARCH INI DENGAN KODE YANG SUDAH DIPERBAIKI DI BAWAH
        document.getElementById('friend-search-input').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            const resContainer = document.getElementById('friend-search-dropdown');
            
            // Clear timeout sebelumnya untuk debouncing
            clearTimeout(searchTimeout);
            
            if(!query) {
                resContainer.style.display = 'none';
                resContainer.innerHTML = '';
                return;
            }

            // Tampilkan loading state
            resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">' + window.t('searching') + '</div>';
            resContainer.style.display = 'block';

            // Debouncing: tunggu 500ms setelah user berhenti mengetik
            searchTimeout = setTimeout(() => {
                performFriendSearch(query, resContainer);
            }, 500);
        });

        // === SETUP UNREAD MESSAGE LISTENER ===
function setupUnreadListener(friendUid) {
    const myUid = auth.currentUser.uid;
    const chatId = getChatId(myUid, friendUid);
    
    onValue(ref(db, `chats/${chatId}/messages`), (snap) => {
        const msgs = snap.val() || {};
        
        // Count unread messages (messages from friend that we haven't read)
        let unreadCount = 0;
        
        Object.values(msgs).forEach(msg => {
            // If message is from friend and we haven't marked as read
            if (msg.sender === friendUid && !msg.readBy?.[myUid]) {
                unreadCount++;
            }
        });
        
        unreadMessages[friendUid] = unreadCount;
        updateUnreadBadge(friendUid, unreadCount);
    });
}

// === UPDATE UNREAD BADGE ===
function updateUnreadBadge(friendUid, count) {
    const badge = document.getElementById(`unread-${friendUid}`);
    if (!badge) return;
    
    if (count > 0) {
        badge.innerText = count > 99 ? '99+' : count;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

// === MARK MESSAGES AS READ ===
function markMessagesAsRead(friendUid) {
    const myUid = auth.currentUser.uid;
    const chatId = getChatId(myUid, friendUid);
    
    get(ref(db, `chats/${chatId}/messages`)).then(snap => {
        const msgs = snap.val() || {};
        
        Object.keys(msgs).forEach(msgId => {
            const msg = msgs[msgId];
            // Mark message as read if it's from the friend
            if (msg.sender === friendUid) {
                update(ref(db, `chats/${chatId}/messages/${msgId}/readBy`), {
                    [myUid]: true
                });
            }
        });
    });
    
    // Reset unread count
    unreadMessages[friendUid] = 0;
    updateUnreadBadge(friendUid, 0);
}


// Export to window
window.openChat = openChat;

        // Update selectFriendResult untuk menampilkan info lebih jelas
        function selectFriendResult(uid, username, pic) {
            document.getElementById('friend-search-dropdown').style.display = 'none';
            document.getElementById('friend-search-input').value = '';
            
            // Tampilkan konfirmasi atau info (opsional)
            // Bisa langsung kirim request atau tampilkan profil
            console.log(`Selected: ${username} (${uid})`);
        }

        // Update sendFriendRequest dengan error handling
        async function sendFriendRequest(targetUid) {
            try {
                const myUid = auth.currentUser.uid;
                const myData = currentUserData;
                
                // Check if already friends
                const friendSnap = await get(ref(db, `users/${myUid}/friends/${targetUid}`));
                if(friendSnap.exists()) { 
                    showToast(window.t('already-friends'), "error"); 
                    return; 
                }
                
                // Check if request already sent
                const reqSnap = await get(ref(db, `users/${targetUid}/friendRequests/${myUid}`));
                if(reqSnap.exists()) { 
                    showToast(window.t('request-already-sent'), "error"); 
                    return; 
                }

                // Send Request
                await set(ref(db, `users/${targetUid}/friendRequests/${myUid}`), {
                    senderName: myData.username,
                    senderPic: myData.profile_picture,
                    timestamp: Date.now()
                });
                
                // Record sent request
                await set(ref(db, `users/${myUid}/sentRequests/${targetUid}`), true);
                
                showToast(" " + window.t('friend-request-sent'));
                
                // Clear search
                document.getElementById('friend-search-dropdown').style.display = 'none';
                document.getElementById('friend-search-input').value = '';
                
            } catch (error) {
                console.error('Error sending friend request:', error);
                showToast(" Gagal mengirim permintaan. Coba lagi.", "error");
            }
        }

        async function respondFriendRequest(senderUid, accept) {
    const myUid = auth.currentUser.uid;
    if(accept) {
        //  GUNAKAN set() UNTUK NILAI BOOLEAN
        await set(ref(db, `users/${myUid}/friends/${senderUid}`), true);
        await set(ref(db, `users/${senderUid}/friends/${myUid}`), true);
        showToast(window.t('friend-added'), "success");
    } else {
        showToast(window.t('request-declined'), "error");
    }
    // Remove request
    await remove(ref(db, `users/${myUid}/friendRequests/${senderUid}`));
}

        window.selectFriendResult = selectFriendResult;
        window.sendFriendRequest = sendFriendRequest;
        window.respondFriendRequest = respondFriendRequest;

        async function performFriendSearch(query, resContainer) {
            try {
                // Fetch semua username index
                const snapshot = await get(ref(db, 'usernames'));
                const users = snapshot.val() || {};
                
                if(!users || Object.keys(users).length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">' + window.t('no-users') + '</div>';
                    return;
                }

                // Filter user yang cocok dengan query
                const matchedUserIds = Object.keys(users).filter(userIdKey => 
                    userIdKey.toLowerCase().includes(query)
                );

                if(matchedUserIds.length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">' + window.t('no-results') + '</div>';
                    return;
                }

                // Fetch detail semua matched users secara parallel
                const userDetailsPromises = matchedUserIds.map(async (userIdKey) => {
                    const uid = users[userIdKey];
                    
                    // Skip jika ini adalah user sendiri
                    if(uid === auth.currentUser.uid) return null;
                    
                    const uSnap = await get(ref(db, `users/${uid}`));
                    const userData = uSnap.val();
                    
                    if(!userData) return null;
                    
                    return {
                        uid: uid,
                        username: userData.username,
                        userId: userData.userId,
                        profile_picture: userData.profile_picture
                    };
                });

                const userDetails = (await Promise.all(userDetailsPromises)).filter(u => u !== null);

                // Render hasil
                if(userDetails.length === 0) {
                    resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">' + window.t('no-results') + '</div>';
                    return;
                }

                let html = '';
                userDetails.forEach(u => {
                    html += `
                        <div class="friend-dropdown-item" onclick="window.selectFriendResult('${u.uid}', '${escapeHtml(u.username)}', '${u.profile_picture}')">
                            <img src="${u.profile_picture}" style="width:24px;height:24px;border-radius:50%;">
                            <div>
                                <div style="font-size:12px; font-weight:600; color:white;">${escapeHtml(u.username)}</div>
                                <div style="font-size:10px; color:#aaa;">${u.userId}</div>
                            </div>
                            <button class="btn-icon-small" style="margin-left:auto;" onclick="event.stopPropagation(); window.sendFriendRequest('${u.uid}')">
                                <i class="ph ph-user-plus"></i>
                            </button>
                        </div>
                    `;
                });
                
                resContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error searching friends:', error);
                resContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#ff4444;">' + window.t('error-search') + '</div>';
            }
        }

        // Helper function untuk escape HTML (prevent XSS)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // --- CHAT SYSTEM ---

        function getChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

    // === UPDATE openChat FUNCTION ===
// Ganti fungsi openChat yang lama dengan yang ini:
function openChat(friendUid) {
    activeChatFriendUid = friendUid;
    activeChatId = getChatId(auth.currentUser.uid, friendUid);
    
    document.getElementById('chat-overlay').classList.add('active');
    
    // Mark messages as read when opening chat
    markMessagesAsRead(friendUid);
    
    // Get Friend Data
    get(ref(db, `users/${friendUid}`)).then(snap => {
        const u = snap.val();
        activeChatFriendData = u;
        document.getElementById('chat-friend-name-display').innerText = u.username;
        document.getElementById('chat-friend-avatar-display').src = u.profile_picture;
    });

    renderMessages();
}

// Export to window
window.openChat = openChat;

        function closeChat() {
            document.getElementById('chat-overlay').classList.remove('active');
            activeChatFriendUid = null;
            activeChatId = null;
            // Detach listener if needed (onValue handles multiple detach usually, but good practice to clean up references if logic grows)
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input-box');
            const text = input.value.trim();
            if(!text || !activeChatId) return;

            const msg = {
                sender: auth.currentUser.uid,
                text: text,
                timestamp: Date.now(),
                replyTo: replyingToMsgId || null
            };

            push(ref(db, `chats/${activeChatId}/messages`), msg);
            input.value = '';
            replyingToMsgId = null;
        }

        function renderMessages() {
            const chatBody = document.getElementById('chat-body');
            chatBody.innerHTML = '';

            onValue(ref(db, 'chats/' + activeChatId + '/messages'), (snap) => {
                const msgs = snap.val() || {};
                chatBody.innerHTML = '';
                
                Object.keys(msgs).sort((a,b) => msgs[a].timestamp - msgs[b].timestamp).forEach(key => {
                    const m = msgs[key];
                    const isMe = m.sender === auth.currentUser.uid;
                    
                    let replyHtml = '';
                    if(m.replyTo) {
                        const origMsg = msgs[m.replyTo] || { text: 'Pesan dihapus' };
                        replyHtml = '<div class="msg-reply-indicator">Balas: ' + origMsg.text.substring(0, 30) + '...</div>';
                    }

                    // Check if shared content
                    let contentHtml = '<div>' + m.text + '</div>';
                    if(m.shareType) {
                        let cardHtml = '';
                        if(m.shareType === 'song') {
                            const s = m.shareContent;
                            cardHtml = `
                                <div class="chat-shared-card" onclick="window.playSpecificSong(${s.id}); window.closeChat();">
                                    <img src="${s.cover}" class="chat-shared-img" alt="Cover">
                                    <div class="chat-shared-info">
                                        <div class="chat-shared-title">${s.title}</div>
                                        <div class="chat-shared-sub">${s.artist}</div>
                                    </div>
                                </div>
                            `;
                        } else if (m.shareType === 'playlist') {
                            const pl = m.shareContent;
                            cardHtml = `
                                <div class="chat-shared-card" onclick="window.openFriendPlaylist('${pl.id}'); window.closeChat();">
                                    <img src="${pl.cover}" class="chat-shared-img" alt="Playlist Cover">
                                    <div class="chat-shared-info">
                                        <div class="chat-shared-title">${pl.name}</div>
                                        <div class="chat-shared-sub">Playlist</div>
                                    </div>
                                </div>
                            `;
                        }
                        contentHtml = cardHtml;
                    }

                    const el = document.createElement('div');
                    el.className = 'msg-bubble ' + (isMe ? 'msg-sent' : 'msg-received');
                    el.dataset.msgId = key;
                    el.innerHTML = replyHtml + contentHtml + '<div class="msg-time">' + new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</div>';
                    
                    // Swipe & Context Logic
                    addInteractions(el, key, m, isMe);
                    
                    chatBody.appendChild(el);
                });
                
                // Scroll to bottom
                chatBody.scrollTop = chatBody.scrollHeight;
            });
        }

        function addInteractions(el, msgId, msgData, isMe) {
            // Context Menu
            el.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, msgId);
            });

            // Swipe Logic (Touch)
            let touchStartX = 0;
            el.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
            }, {passive: true});

            el.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - touchStartX;
                
                // Threshold for swipe (50px)
                if (Math.abs(diff) > 50) {
                    if (isMe && diff < 0) {
                        // Swipe Left (My msg) -> Reply
                        triggerReply(msgId);
                    } else if (!isMe && diff > 0) {
                        // Swipe Right (Friend msg) -> Reply
                        triggerReply(msgId);
                    }
                }
            }, {passive: true});
        }

        function showContextMenu(x, y, msgId) {
            const menu = document.getElementById('context-menu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'flex';
            
            // Store current context target
            window.currentContextMsgId = msgId;
            
            // Close on click elsewhere
            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function ctxAction(action) {
            const msgId = window.currentContextMsgId;
            if(!msgId) return;
            
            if(action === 'copy') {
                // Mock copy
                alert("Pesan disalin!");
            } else if (action === 'reply') {
                triggerReply(msgId);
            } else if (action === 'delete') {
                // In real app, verify ownership, then delete from DB
                remove(ref(db, `chats/${activeChatId}/messages/${msgId}`));
            }
            document.getElementById('context-menu').style.display = 'none';
        }

        function triggerReply(msgId) {
            replyingToMsgId = msgId;
            const input = document.getElementById('chat-input-box');
            input.placeholder = "Membalas pesan...";
            input.focus();
        }

        window.openChat = openChat;
        window.closeChat = closeChat;
        window.sendChatMessage = sendChatMessage;
        window.ctxAction = ctxAction;

        // --- SHARE FEATURE ---
        
        function openShareModal(type, contentId) {
            if(!auth.currentUser) return;
            
            const modal = document.getElementById('share-modal');
            const list = document.getElementById('share-friend-list');
            const loading = document.getElementById('share-loading');
            
            modal.classList.add('open');
            list.innerHTML = '';
            loading.style.display = 'block';

            // Get Friend List
            get(ref(db, `users/${auth.currentUser.uid}/friends`)).then(snap => {
                loading.style.display = 'none';
                const friends = snap.val() || {};
                if(!Object.keys(friends).length) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:#888">' + window.t('no-you-have-friends') + '</div>';
                    return;
                }

                let html = '';
                Object.keys(friends).forEach(friendUid => {
                    // Fetch names
                    get(ref(db, `users/${friendUid}`)).then(uSnap => {
                        const u = uSnap.val();
                        html += `
                            <div class="playlist-select-item" onclick="window.executeShare('${type}', '${contentId}', '${friendUid}')">
                                <img src="${u.profile_picture}" style="width:40px;height:40px;border-radius:50%;">
                                <div>${u.username}</div>
                            </div>
                        `;
                        list.innerHTML = html;
                    });
                });
            });

            // Save share intent temporarily
            window.pendingShare = { type, id: contentId };
        }

        function executeShare(type, id, targetUid) {
            const myUid = auth.currentUser.uid;
            const chatId = getChatId(myUid, targetUid);
            let msgPayload = {
                sender: myUid,
                text: "Membagikan konten",
                timestamp: Date.now()
            };

            if(type === 'song') {
                const song = songs.find(s => s.id == id);
                msgPayload.shareType = 'song';
                msgPayload.shareContent = song;
            } else if (type === 'playlist') {
                let playlist = null;
                // 1. Try finding in my playlists
                if (currentUserData && currentUserData.playlists && currentUserData.playlists[id]) {
                    playlist = currentUserData.playlists[id];
                } 
                // 2. Try finding in public playlists
                else if (allPublicPlaylists) {
                    playlist = allPublicPlaylists.find(pl => pl.id === id);
                }

                if (!playlist) {
                    alert("Gagal membagikan playlist: Data playlist tidak ditemukan.");
                    return;
                }

                msgPayload.shareType = 'playlist';
                msgPayload.shareContent = { id: id, name: playlist.name, cover: playlist.cover };
            }

            push(ref(db, `chats/${chatId}/messages`), msgPayload);
            closeModal('share-modal');
            alert("Berhasil dibagikan!");
        }

        window.openShareModal = openShareModal;
        window.executeShare = executeShare;

        // --- FRIEND PROFILE & PLAYLIST VIEW ---

        let viewingFriendUid = null;

        function openFriendProfileFromChat() {
            if(!activeChatFriendUid) return;
            viewingFriendUid = activeChatFriendUid;
            loadFriendProfileData();
        }

        function loadFriendProfileData() {
            const uid = viewingFriendUid;
            const overlay = document.getElementById('friend-profile-overlay');
            overlay.classList.add('active');

            get(ref(db, `users/${uid}`)).then(snap => {
                const u = snap.val();
                if(!u) return;

                document.getElementById('friend-profile-avatar-display').src = u.profile_picture;
                document.getElementById('friend-profile-name-display').innerText = u.username;
                document.getElementById('friend-profile-userid-text').innerText = u.userId || "User#0000";
                document.getElementById('friend-profile-bio-display').innerText = u.bio || '';

                const avatar = document.getElementById('friend-profile-avatar-display');
                avatar.onload = function() {
                    const rgb = getAverageRGB(avatar);
                    const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                    document.getElementById('friend-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
                }

                renderFriendPlaylists(u.playlists || {});
            });
        }

       // Ganti fungsi renderFriendPlaylists (sekitar line 1400):

function renderFriendPlaylists(playlists) {
    const container = document.getElementById('friend-public-playlists');
    let html = '';
    
    Object.keys(playlists).forEach(key => {
        const pl = playlists[key];
        // Only show public playlists
        if(pl.isPublic) {
            html += `
                <div class="song-card" onclick="window.openFriendPlaylist('${key}')">
                    <div class="card-img-wrapper">
                        <img src="${pl.cover}" alt="${pl.name}">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${pl.name}</div>
                    <div class="card-desc">${window.t('public-playlists')}</div>
                </div>
            `;
        }
    });

    if(!html) html = `<div style="padding:0 32px; color:#666;">${window.t('friend-no-public-playlists')}</div>`;
    container.innerHTML = html;
}
   
      function openFriendPlaylist(playlistId) {
    if(!viewingFriendUid) return;
    
    get(ref(db, 'users/' + viewingFriendUid + '/playlists/' + playlistId)).then(snap => {
        const pl = snap.val();
        if(!pl) return;
        
        currentPlaylistId = playlistId;
        
        document.getElementById('playlist-title-view').innerText = pl.name;
        document.getElementById('playlist-cover-view').src = pl.cover;
        
        //  PERBAIKAN: Cek apakah elemen ada
        const friendName = document.getElementById('friend-profile-name-display');
        const ownerDisplay = document.getElementById('playlist-owner-display');
        if(friendName && ownerDisplay) {
            ownerDisplay.innerText = friendName.innerText;
        }
        
  
        
        const coverEl = document.getElementById('playlist-cover-view');
        coverEl.onload = function() {
            const rgb = getAverageRGB(coverEl);
            const color = 'rgb(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ')';
            document.getElementById('playlist-header-bg').style.background = 'linear-gradient(180deg, ' + color + ' 0%, var(--bg-dark) 100%)';
        };

        const plSongs = Object.values(pl.songs || {});
        const songDetails = plSongs
            .filter(sIdOrObj => sIdOrObj)
            .map(songIdOrObj => {
                const idToFind = (typeof songIdOrObj === 'object') ? songIdOrObj.id : songIdOrObj;
                return songs.find(s => s.id == idToFind);
            })
            .filter(s => s);

        document.getElementById('playlist-count').innerText = songDetails.length + ' ' + window.t('songs-label');
        renderSongList(songDetails, 'playlist-songs-container');
        
        const shareBtn = document.querySelector('#view-playlist .playlist-actions .share-btn');
        if(shareBtn) shareBtn.style.display = 'none';

        window.closeFriendProfile();
        window.switchView('playlist');
    });
}

        window.openFriendProfileFromChat = openFriendProfileFromChat;
        window.closeFriendProfile = () => document.getElementById('friend-profile-overlay').classList.remove('active');
        window.openFriendPlaylist = openFriendPlaylist;

        // --- COPY USER ID FUNCTIONS ---
        function copyUserId() {
            if(currentUserData && currentUserData.userId) {
                navigator.clipboard.writeText(currentUserData.userId).then(() => {
                    const el = document.getElementById('profile-userid-text');
                    const originalText = el.innerText;
                    el.innerText = "Disalin!";
                    setTimeout(() => el.innerText = originalText, 1500);
                });
            }
        }

        function copyFriendUserId() {
            const idText = document.getElementById('friend-profile-userid-text').innerText;
            navigator.clipboard.writeText(idText).then(() => {
                alert(`ID Teman (${idText}) disalin!`);
            });
        }

        window.copyUserId = copyUserId;
        window.copyFriendUserId = copyFriendUserId;

        // --- PLAYLIST PRIVACY & COVER ---
        
        function togglePlaylistPrivacy(playlistId) {
            const playlists = currentUserData.playlists || {};
            const pl = playlists[playlistId];
            if(!pl) return;
            
            const newState = !pl.isPublic; // Toggle
            update(ref(db, `users/${auth.currentUser.uid}/playlists/${playlistId}`), { isPublic: newState });
        }

        function handleLikedCoverUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const url = e.target.result;
                    document.getElementById('liked-cover-view').src = url;
                    update(ref(db, 'users/' + auth.currentUser.uid), { likedCover: url });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.togglePlaylistPrivacy = togglePlaylistPrivacy;
        window.handleLikedCoverUpload = handleLikedCoverUpload;

        // --- GENERAL UI ---
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        window.closeModal = closeModal;

        function switchView(viewName) {
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.add('active');
                document.querySelector('.main-content').scrollTop = 0;
                
                // Track history for non-main navigation views
                if (viewName === 'playlist' || viewName === 'profile' || viewName.includes('album')) {
                    pushToHistory(viewName);
                }
                
                if (viewName === 'profile') {
                    window.loadProfileData();
                }
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${viewName}`);
            if (activeNav) activeNav.classList.add('active');

            /* sync mobile bottom nav active state */
            document.querySelectorAll('.mb-nav-item').forEach(el => el.classList.remove('active'));
            const mbActive = document.getElementById(`mb-nav-${viewName}`);
            if (mbActive) mbActive.classList.add('active');

            if(viewName === 'liked') {
                openLikedView();
            }
            
            if(viewName === 'search') {
                document.getElementById('search-input').value = '';
                handleSearch(''); // Reset to history view
            }
        }

        window.switchView = switchView;

        // --- LANGUAGE SYSTEM ---
        let currentLanguage = localStorage.getItem('appLanguage') || 'id';
        console.log('Language initialized to:', currentLanguage);
        
        const translations = {
            id: {
                // Navbar
                'nav-home': 'Beranda',
                'nav-search': 'Cari',
                'nav-liked': 'Lagu Disukai',
                // Sidebar
                'playlist-title': 'Playlist Anda',
                'create-playlist': 'Buat Playlist',
                'import-music': 'Impor Musik',
                // Main content
                'no-history': 'Belum ada riwayat',
                'recently-played': 'Baru Diputar',
                'all-artists': 'Semua Artis',
                'play': 'Putar',
                'pause': 'Jeda',
                'liked-songs': 'Lagu Disukai',
                'profile': 'Profil',
                'logout': 'Keluar',
                'back': 'Kembali',
                'album': 'Album',
                'artist': 'Artis',
                'playlist': 'Playlist',
                'songs': 'Lagu',
                'search': 'Cari lagu, artis, playlist...',
                'home': 'Beranda',
                'liked': 'Lagu Disukai',
                'ok': 'OK',
                'cancel': 'Batal',
                'save': 'Simpan',
                'delete': 'Hapus',
                'edit': 'Edit',
                'add': 'Tambah',
                'remove': 'Hapus',
                'share': 'Bagikan',
                'loading': 'Memuat...',
                'no-playlists': 'Belum ada playlist',
                'all-playlists': 'Semua Playlist',
                'my-playlists': 'Playlist Saya',
                'public-playlists': 'Playlist Publik',
                'by': 'Oleh',
                'songs-count': 'lagu',
                'no-songs': 'Belum ada lagu',
                'add-to-playlist': 'Tambah ke Playlist',
                'remove-from-playlist': 'Hapus dari Playlist',
                'no-file-selected': 'Belum ada file dipilih',
                'no-friends': 'Belum ada teman',
                'no-results': 'Tidak ada hasil',
                'no-users': 'Tidak ada pengguna ditemukan',
                'no-songs-found': 'Tidak ada lagu ditemukan',
                'searching': 'Mencari...',
                'error-search': 'Error saat mencari',
                'empty-queue': 'Antrian kosong',
                'song-added-to-queue': 'Lagu ditambahkan ke antrian',
                'queue': 'Antrian',
                'no-public-playlists': 'Tidak ada playlist publik. Atur privasi di sidebar',
                'waiting-friends': 'Menunggu teman bergabung...',
                'waiting': 'Menunggu...',
                'no-active-playlist': 'Tidak ada playlist yang aktif',
                'no-you-have-friends': 'Anda belum punya teman',
                // Home page
                'my-playlists-section': 'Playlist Saya',
                'popular-indonesian-bands': 'Band Populer Indonesia',
                'popular-indonesian-artists': 'Penyanyi Populer Indonesia',
                'popular-foreign-artists': 'Penyanyi Asing Populer',
                'popular-foreign-bands': 'Band Asing Populer',
                'search-results': 'Hasil Pencarian',
                'public-playlists': 'Playlist Publik',
                'playlist-settings': 'Pengaturan Playlist',
                'share-to-friends': 'Bagikan ke Teman',
                'select-song': 'Pilih Lagu',
                'song-collection': 'Koleksi Lagu',
                'popular-songs': 'Lagu Populer',
                'owner': 'Owner',
                'songs-label': 'lagu',
                'sidebar-friends': 'Teman',
                'search-friends-placeholder': 'Cari Teman (User/Nama)',
                'friend-requests': 'Permintaan Pertemanan',
                'friend-list': 'Daftar Teman',
                'recently-played': 'Baru Diputar',
                'friend-no-public-playlists': 'Teman ini tidak memiliki playlist publik.',
                'already-friends': 'Sudah berteman dengan pengguna ini.',
                'request-already-sent': 'Permintaan sudah terkirim sebelumnya.',
                'friend-request-sent': 'Permintaan pertemanan berhasil dikirim!',
                'friend-added': 'Teman ditambahkan!',
                'request-declined': 'Permintaan ditolak.',
                'no-friends-message': 'Belum ada teman.',
                'band-popular-indonesia': 'Band Populer Indonesia',
                'artist-popular-indonesia': 'Penyanyi Populer Indonesia',
                'artist-foreign-popular': 'Penyanyi Asing Populer',
                'band-foreign-popular': 'Band Asing Populer',
                'my-playlists': 'Playlist Kamu',
                'friend-name': 'Nama Teman',
                'login-title': 'Masuk ke Vidje',
                'login-subtitle': 'Musik untuk semua orang.',
                'login-error-default': 'Email atau password salah.',
                'signup-title': 'Daftar Akun',
                'signup-subtitle': 'Bergabunglah dengan Vidje.',
                'signup-error-default': 'Gagal mendaftar.',
                'signup-fullname': 'Nama Lengkap',
                'signup-button': 'Daftar',
                'login-button': 'Masuk',
                'signup-have-account': 'Sudah punya akun?',
                'signup-link': 'Masuk',
                'login-no-account': 'Belum punya akun?',
                'login-link': 'Daftar Sekarang',
                'chat-placeholder': 'Ketik pesan...',
                'playlist-name-label': 'Nama Playlist',
                'playlist-name-example': 'Contoh: Lagu Santai',
                'create-button': 'Buat',
                'fill-all-fields': 'Mohon lengkapi semua kolom.',
                'email-password-wrong': 'Email atau password salah.',
                'settings-playlist-name': 'Nama Playlist',
                'profile-label': 'Profil',
                'profile-bio-placeholder': 'Bio pengguna akan muncul di sini.',
                'no-requests': 'Tidak ada permintaan baru',
                'edit-profile': 'Edit Profil',
                'profile-id-note': 'ID pengguna akan otomatis mengikuti nama baru.',
                'setting-language': 'Setting Bahasa',
                'friend-profile-label': 'Profil Teman',
                'friend-bio-placeholder': 'Bio teman akan muncul di sini.'
            },
            en: {
                // Navbar
                'nav-home': 'Home',
                'nav-search': 'Search',
                'nav-liked': 'Liked Songs',
                // Sidebar
                'playlist-title': 'Your Playlists',
                'create-playlist': 'Create Playlist',
                'import-music': 'Import Music',
                // Main content
                'no-history': 'No history',
                'recently-played': 'Recently Played',
                'all-artists': 'All Artists',
                'play': 'Play',
                'pause': 'Pause',
                'liked-songs': 'Liked Songs',
                'profile': 'Profile',
                'logout': 'Logout',
                'back': 'Back',
                'album': 'Album',
                'artist': 'Artist',
                'playlist': 'Playlist',
                'songs': 'Songs',
                'search': 'Search songs, artists, playlists...',
                'home': 'Home',
                'liked': 'Liked Songs',
                'ok': 'OK',
                'cancel': 'Cancel',
                'save': 'Save',
                'delete': 'Delete',
                'edit': 'Edit',
                'add': 'Add',
                'remove': 'Remove',
                'share': 'Share',
                'loading': 'Loading...',
                'no-playlists': 'No playlists yet',
                'all-playlists': 'All Playlists',
                'my-playlists': 'My Playlists',
                'public-playlists': 'Public Playlists',
                'by': 'By',
                'songs-count': 'songs',
                'no-songs': 'No songs',
                'add-to-playlist': 'Add to Playlist',
                'remove-from-playlist': 'Remove from Playlist',
                'no-file-selected': 'No file selected',
                'no-friends': 'No friends yet',
                'no-results': 'No results',
                'no-users': 'No users found',
                'no-songs-found': 'No songs found',
                'searching': 'Searching...',
                'error-search': 'Error searching',
                'empty-queue': 'Queue is empty',
                'song-added-to-queue': 'Song added to queue',
                'queue': 'Queue',
                'no-public-playlists': 'No public playlists. Adjust privacy in sidebar',
                'waiting-friends': 'Waiting for friends to join...',
                'waiting': 'Waiting...',
                'no-active-playlist': 'No active playlist',
                'no-you-have-friends': 'You don\'t have any friends yet',
                // Home page
                'my-playlists-section': 'My Playlists',
                'popular-indonesian-bands': 'Popular Indonesian Bands',
                'popular-indonesian-artists': 'Popular Indonesian Artists',
                'popular-foreign-artists': 'Popular Foreign Artists',
                'popular-foreign-bands': 'Popular Foreign Bands',
                'search-results': 'Search Results',
                'public-playlists': 'Public Playlists',
                'playlist-settings': 'Playlist Settings',
                'share-to-friends': 'Share to Friends',
                'select-song': 'Select Song',
                'song-collection': 'Song Collection',
                'popular-songs': 'Popular Songs',
                'owner': 'Owner',
                'songs-label': 'songs',
                'sidebar-friends': 'Friends',
                'search-friends-placeholder': 'Search Friends (Name/User)',
                'friend-requests': 'Friend Requests',
                'friend-list': 'Friend List',
                'recently-played': 'Recently Played',
                'friend-no-public-playlists': 'This friend has no public playlists.',
                'already-friends': 'Already friends with this user.',
                'request-already-sent': 'Friend request already sent.',
                'friend-request-sent': 'Friend request sent successfully!',
                'friend-added': 'Friend added!',
                'request-declined': 'Friend request declined.',
                'no-friends-message': 'No friends yet.',
                'band-popular-indonesia': 'Popular Indonesian Bands',
                'artist-popular-indonesia': 'Popular Indonesian Artists',
                'artist-foreign-popular': 'Popular Foreign Artists',
                'band-foreign-popular': 'Popular Foreign Bands',
                'my-playlists': 'My Playlists',
                'friend-name': 'Friend Name',
                'login-title': 'Login to Vidje',
                'login-subtitle': 'Music for everyone.',
                'login-error-default': 'Email or password is incorrect.',
                'signup-title': 'Create Account',
                'signup-subtitle': 'Join Vidje.',
                'signup-error-default': 'Sign up failed.',
                'signup-fullname': 'Full Name',
                'signup-button': 'Sign Up',
                'login-button': 'Login',
                'signup-have-account': 'Already have an account?',
                'signup-link': 'Login',
                'login-no-account': 'Don\'t have an account?',
                'login-link': 'Sign Up Now',
                'chat-placeholder': 'Type a message...',
                'playlist-name-label': 'Playlist Name',
                'playlist-name-example': 'e.g. Chill Songs',
                'create-button': 'Create',
                'fill-all-fields': 'Please fill in all fields.',
                'email-password-wrong': 'Email or password is incorrect.',
                'settings-playlist-name': 'Playlist Name',
                'profile-label': 'Profile',
                'profile-bio-placeholder': 'User bio will appear here.',
                'no-requests': 'No New Request',
                'edit-profile': 'Edit Profile',
                'profile-id-note': 'User ID will automatically follow the new name.',
                'setting-language': 'Setting Language',
                'friend-profile-label': 'Friend Profile',
                'friend-bio-placeholder': 'Friend bio will appear here.'
            }
        };
        
        function switchLanguage(lang) {
            if (!translations[lang]) lang = 'id'; // Fallback to Indonesian if invalid
            console.log('Switching language to:', lang);
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeLangBtn = document.querySelector(`[data-lang="${lang}"]`);
            if (activeLangBtn) activeLangBtn.classList.add('active');
            
            // Update mobile language dropdown state
            window.updateLanguageDropdownState(lang);
            
            // Update all text elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'INPUT') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
            
            // Update all elements with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            
            // Update placeholder for search input
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.placeholder = translations[lang]['search'] || 'Search...';
            }
            
            // Update friend requests container text
            const friendReqsContainer = document.getElementById('friend-requests-container');
            if (friendReqsContainer) {
                const existingContent = friendReqsContainer.innerHTML;
                // Check if it's showing the empty state (contains "Tidak ada permintaan" or "No New Request" or has color:#666)
                if (existingContent.includes('color:#666') || existingContent.includes('Tidak ada permintaan') || existingContent.includes('No New Request')) {
                    friendReqsContainer.innerHTML = '<div style="padding:10px; color:#666; font-size:12px;">' + window.t('no-requests') + '</div>';
                }
            }
        }
        
        window.switchLanguage = switchLanguage;
        
        // Toggle language dropdown (mobile)
        window.toggleLanguageDropdown = function() {
            const dropdown = document.getElementById('language-dropdown');
            if(dropdown) {
                dropdown.classList.toggle('active');
            }
        };
        
        // Toggle language dropdown (desktop)
        window.toggleLanguageDropdownDesktop = function() {
            const dropdown = document.getElementById('language-dropdown-desktop');
            if(dropdown) {
                if(dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            }
        };
        
        // Update language dropdown button active state
        window.updateLanguageDropdownState = function(lang) {
            // Mobile buttons
            const langIdBtn = document.getElementById('lang-id-btn');
            const langEnBtn = document.getElementById('lang-en-btn');
            const langIdCheckMobile = langIdBtn ? langIdBtn.querySelector('.ph-check') : null;
            const langEnCheckMobile = langEnBtn ? langEnBtn.querySelector('.ph-check') : null;
            
            // Desktop buttons
            const langIdBtnDesktop = document.getElementById('lang-id-btn-desktop');
            const langEnBtnDesktop = document.getElementById('lang-en-btn-desktop');
            const langIdCheckDesktop = langIdBtnDesktop ? langIdBtnDesktop.querySelector('.ph-check') : null;
            const langEnCheckDesktop = langEnBtnDesktop ? langEnBtnDesktop.querySelector('.ph-check') : null;
            
            if(lang === 'id') {
                // Mobile
                if(langIdBtn) langIdBtn.classList.add('active');
                if(langEnBtn) langEnBtn.classList.remove('active');
                if(langIdCheckMobile) langIdCheckMobile.style.opacity = '1';
                if(langEnCheckMobile) langEnCheckMobile.style.opacity = '0';
                
                // Desktop
                if(langIdBtnDesktop) langIdBtnDesktop.classList.add('active');
                if(langEnBtnDesktop) langEnBtnDesktop.classList.remove('active');
                if(langIdCheckDesktop) langIdCheckDesktop.style.opacity = '1';
                if(langEnCheckDesktop) langEnCheckDesktop.style.opacity = '0';
            } else {
                // Mobile
                if(langIdBtn) langIdBtn.classList.remove('active');
                if(langEnBtn) langEnBtn.classList.add('active');
                if(langIdCheckMobile) langIdCheckMobile.style.opacity = '0';
                if(langEnCheckMobile) langEnCheckMobile.style.opacity = '1';
                
                // Desktop
                if(langIdBtnDesktop) langIdBtnDesktop.classList.remove('active');
                if(langEnBtnDesktop) langEnBtnDesktop.classList.add('active');
                if(langIdCheckDesktop) langIdCheckDesktop.style.opacity = '0';
                if(langEnCheckDesktop) langEnCheckDesktop.style.opacity = '1';
            }
        };
        
        // Helper function to get translated text
        function t(key) {
            if (translations[currentLanguage] && translations[currentLanguage][key]) {
                return translations[currentLanguage][key];
            }
            if (translations['id'] && translations['id'][key]) {
                return translations['id'][key];
            }
            return key;
        }
        
        window.t = t;
        
        // Initialize with saved language
        window.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLanguage);
        });
        
        // If DOM is already loaded, call switchLanguage immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => switchLanguage(currentLanguage));
        } else {
            switchLanguage(currentLanguage);
        }

        // --- NAVIGATION HISTORY FOR BACK BUTTON ---
        let navigationHistory = ['home']; // Start with home
        
        function pushToHistory(viewName) {
            if (navigationHistory[navigationHistory.length - 1] !== viewName) {
                navigationHistory.push(viewName);
            }
        }
        
        function goBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Remove current
                const previousView = navigationHistory[navigationHistory.length - 1];
                switchView(previousView);
            } else {
                switchView('home');
            }
        }
        
        window.goBack = goBack;
        window.pushToHistory = pushToHistory;
        
        // --- INITIALIZE BACK BUTTONS ON ALBUM VIEWS ---
        function initializeAlbumBackButtons() {
            const albumViewIds = [
                'view-perunggu-album', 'view-noah-album', 'view-dewa-album', 'view-sheila-album',
                'view-kahitna-album', 'view-hindia-album', 'view-astrid-album', 'view-afgan-album',
                'view-tulus-album', 'view-mahalini-album', 'view-tenxi-album', 'view-taylor-album',
                'view-justin-album', 'view-ed-album', 'view-bruno-album', 'view-daniel-album', 'view-coldplay-album'
            ];
            
            albumViewIds.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view) {
                    const headerView = view.querySelector('.playlist-header-view');
                    if (headerView && !headerView.querySelector('.back-button')) {
                        const backBtn = document.createElement('button');
                        backBtn.onclick = function() { window.goBack(); };
                        backBtn.className = 'back-button';
                        backBtn.title = 'Kembali';
                        backBtn.style.cssText = 'position: absolute; top: 8px; left: 12px; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px;';
                        backBtn.innerHTML = '<i class="ph ph-arrow-left"></i>';
                        headerView.insertBefore(backBtn, headerView.firstChild);
                    }
                }
            });
        }
        
        // Call when DOM is ready
        window.addEventListener('load', initializeAlbumBackButtons);

        // --- RECENTLY PLAYED LOGIC ---
        function addToRecentlyPlayed(type, data) {
            // Remove duplicates of same ID
            recentlyPlayed = recentlyPlayed.filter(item => !(item.type === type && item.data.id === data.id));
            // Add new to front
            recentlyPlayed.unshift({ type, data, timestamp: Date.now() });
            // Limit to 20 items
            if(recentlyPlayed.length > 20) recentlyPlayed = recentlyPlayed.slice(0, 20);
            // Save to local storage
            localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
        }

        function handleSearch(query) {
    const resultsWrapper = document.getElementById('search-results-wrapper');
    const historyWrapper = document.getElementById('search-history-wrapper');
    const bandsContainer = document.getElementById('search-bands-container');
    const songsContainer = document.getElementById('search-songs-container');
    const playlistsContainer = document.getElementById('search-playlists-container');
    const playlistsTitle = document.getElementById('search-playlists-title');

    if (query.trim().length < 1) {
        resultsWrapper.style.display = 'none';
        bandsContainer.innerHTML = '';
        songsContainer.innerHTML = '';
        playlistsContainer.innerHTML = '';
        playlistsTitle.style.display = 'none';
        historyWrapper.style.display = 'block';
        renderRecentlyPlayedList();
        return;
    }

    const q = query.toLowerCase();
    historyWrapper.style.display = 'none';
    resultsWrapper.style.display = 'block';

    // 1. Search Bands/Artists
    const matchedBands = searchIndexArtists.filter(b => b.name.toLowerCase().includes(q));
    let bandsHTML = "";
    if (matchedBands.length > 0) {
        bandsHTML = matchedBands.map(b => `
            <div class="song-card" onclick="${b.fn}">
                <div class="card-img-wrapper">
                    <img src="${b.img}" alt="${b.name}">
                    <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                </div>
                <div class="card-title">${b.name}</div>
                <div class="card-desc">Penyanyi / Band</div>
            </div>
        `).join('');
    }
    bandsContainer.innerHTML = bandsHTML;

    // 2. Search Public Playlists
    const matchedPlaylists = allPublicPlaylists.filter(pl => pl.name.toLowerCase().includes(q));
    let playlistsHTML = "";
    if (matchedPlaylists.length > 0) {
        playlistsTitle.style.display = 'block';
        playlistsHTML = matchedPlaylists.map(pl => `
            <div class="song-card" onclick="window.openPlaylist('${pl.id}')">
                <div class="card-img-wrapper">
                    <img src="${pl.cover}" alt="${pl.name}">
                    <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                </div>
                <div class="card-title">${pl.name}</div>
                <div class="card-desc">Oleh ${pl.ownerName || 'User'}</div>
            </div>
        `).join('');
    } else {
        playlistsTitle.style.display = 'none';
    }
    playlistsContainer.innerHTML = playlistsHTML;

    // 3. Search ALL Songs (with Privacy Check)
    const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
    
    const matchedSongs = songs.filter(s => {
        // A. Match Query (Title, Artist, Album)
        const matchQuery = s.title.toLowerCase().includes(q) || 
                           s.artist.toLowerCase().includes(q) ||
                           s.album.toLowerCase().includes(q);
        
        if (!matchQuery) return false;

        // B. Privacy Check
        // If it's an imported song (check if it has 'uploadedBy' field)
        if (s.uploadedBy) {
            // Visible if: Public OR Owned by current user
            const isPublic = s.isPublic === true;
            const isMine = currentUserId && s.uploadedBy === currentUserId;
            return isPublic || isMine;
        }

        // Default static songs are always visible
        return true;
    });

    if (matchedSongs.length > 0) {
        // Create Header and Container for Songs
        const songsHeader = document.createElement('h3');
        songsHeader.innerText = 'Lagu';
        songsHeader.style.color = 'white';
        songsHeader.style.fontSize = '18px';
        songsHeader.style.marginBottom = '10px';
        songsHeader.style.marginTop = '20px';
        
        songsContainer.innerHTML = '';
        songsContainer.appendChild(songsHeader);
        
        const listDiv = document.createElement('div');
        listDiv.id = 'search-songs-list-inner';
        songsContainer.appendChild(listDiv);
        
        renderSongListCustom(matchedSongs, 'search-songs-list-inner', false);
    } else {
        songsContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">' + window.t('no-songs-found') + '</div>';
    }
}
        window.handleSearch = handleSearch;

       function renderRecentlyPlayedList() {
    const container = document.getElementById('search-history-container');            
    const title = document.getElementById('search-history-title');
    if (recentlyPlayed.length === 0) {
        container.innerHTML = '';
        title.style.display = 'none';
        return;
    }
    title.style.display = 'block';

    let html = '';
    recentlyPlayed.forEach((item, i) => {
        if (item.type === 'song') {
            const s = item.data;
            html += `
                <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
                    <div class="song-index">
                        <span class="index-num">${i + 1}</span>
                        <div class="playing-icon-container" style="display:none;">
                            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                        </div>
                    </div>
                    <div class="song-info">
                        <img src="${s.cover}" alt="art">
                        <div>
                            <div class="song-title-text">${s.title}</div>
                            <div class="song-artist">${s.artist}</div>
                        </div>
                    </div>
                    <div class="song-album">${s.album}</div>
                    <div class="song-duration">${s.duration}</div>
                    <div class="song-actions">
                        <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                            <i class="${likedSongs.includes(s.id) ? 'ph-fill ph-heart' : 'ph ph-heart'}"></i>
                        </button>
                        <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                            <i class="ph ph-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (item.type === 'playlist') {
            const pl = item.data;
            // PLAYLIST SEKARANG DITAMPILKAN SEPERTI LAGU (SONG-ROW FORMAT)
            html += `
                <div class="song-row" onclick="window.openPlaylist('${pl.id}')">
                    <div class="song-index">
                        <span class="index-num">${i + 1}</span>
                    </div>
                    <div class="song-info">
                        <img src="${pl.cover}" alt="playlist cover">
                        <div>
                            <div class="song-title-text">${pl.name}</div>
                            <div class="song-artist">Playlist</div>
                        </div>
                    </div>
                    <div class="song-album">-</div>
                    <div class="song-duration">-</div>
                    <div class="song-actions">
                        <button class="share-btn" onclick="event.stopPropagation(); window.openShareModal('playlist', '${pl.id}')" style="color:#b3b3b3;">
                            <i class="ph ph-share-network"></i>
                        </button>
                    </div>
                </div>
            `;
        }
    });
    container.innerHTML = html;
}

       function renderSongListCustom(data, containerId, isHistoryMode) {
    const container = document.getElementById(containerId);
    if(!data || data.length === 0) {
        if(containerId) container.innerHTML = '<div style="padding:20px; color:#666;">' + window.t('no-songs') + '</div>';
        return;
    }

    container.innerHTML = data.map((s, i) => {
        let actionButtonsHTML = '';

        if (isHistoryMode) {
            // History Mode - NO DROPDOWN
            actionButtonsHTML = `
                <button class="list-like-btn ${likedSongs.includes(s.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${s.id})" id="list-like-${s.id}">
                    <i class="${likedSongs.includes(s.id) ? 'ph-fill ph-heart' : 'ph ph-heart'}"></i>
                </button>
                <button class="more-btn" onclick="event.stopPropagation(); window.openAddSongModal(${s.id})">
                    <i class="ph ph-plus"></i>
                </button>
            `;
        } else {
            //  PERBAIKAN: HANYA 1 DROPDOWN MENU
            actionButtonsHTML = `
                <div class="song-actions-menu" style="position: relative;">
                    <button class="song-menu-btn" onclick="event.stopPropagation(); window.toggleSongMenu(${s.id})">
                        <i class="ph ph-dots-three-vertical"></i>
                    </button>
                    <div class="song-menu-dropdown" id="menu-${s.id}" style="display: none;">
                    
                        <button class="menu-item" onclick="event.stopPropagation(); window.toggleLike(${s.id}); window.toggleSongMenu(${s.id})" id="menu-like-${s.id}">
                            <i class="${likedSongs.includes(s.id) ? 'ph-fill ph-heart' : 'ph ph-heart'}"></i>
                            <span data-i18n="liked-songs">Liked Songs</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.addToQueue(${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-list-plus"></i>
                            <span data-i18n="queue">Queue</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.openAddSongModal(${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-plus"></i>
                            <span data-i18n="add-to-playlist">Add to Playlist</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.openShareModal('song', ${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-share-network"></i>
                            <span data-i18n="share">Share</span>
                        </button>
                    </div>
                </div>
            `;
        }

        return `
        <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
            <div class="song-index">
                <span class="index-num">${i + 1}</span>
                <div class="playing-icon-container" style="display:none;">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="song-info">
                <img src="${s.cover && s.cover.trim() ? s.cover : 'assets/vidje-icon.jpg'}" alt="art">
                <div>
                    <div class="song-title-text" onclick="event.stopPropagation(); window.playSpecificSong(${s.id}); window.openOverlayPlayer();">
                        ${s.title}
                    </div>
                    <div class="song-artist">${s.artist}</div>
                </div>
            </div>
            <div class="song-album">${s.album}</div>
            <div class="song-duration">${s.duration}</div>
            <div class="song-actions">
                ${actionButtonsHTML}
            </div>
        </div>
        `;
    }).join('');
}

        
       function renderSongList(data, containerId) {
    const container = document.getElementById(containerId);
    if(!data || data.length === 0) {
        if(containerId) container.innerHTML = '<div style="padding:20px; color:#666;">' + window.t('no-songs') + '</div>';
        return;
    }

    container.innerHTML = data.map((s, i) => {
        return `
        <div class="song-row" id="row-${s.id}" onclick="window.playSpecificSong(${s.id})">
            <div class="song-index">
                <span class="index-num">${i + 1}</span>
                <div class="playing-icon-container" style="display:none;">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="song-info">
                <img src="${s.cover}" alt="art">
                <div>
                    <div class="song-title-text">
                        ${s.title}
                    </div>
                    <div class="song-artist">${s.artist}</div>
                </div>
            </div>
            <div class="song-album">${s.album}</div>
            <div class="song-duration">${s.duration}</div>
            <div class="song-actions">
                <div class="song-actions-menu" style="position: relative;">
                    <button class="song-menu-btn" onclick="event.stopPropagation(); window.toggleSongMenu(${s.id})">
                        <i class="ph ph-dots-three-vertical"></i>
                    </button>
                    <div class="song-menu-dropdown" id="menu-${s.id}" style="display: none;">
                        <button class="menu-item" onclick="event.stopPropagation(); window.toggleLike(${s.id}); window.toggleSongMenu(${s.id})" id="menu-like-${s.id}">
                            <i class="${likedSongs.includes(s.id) ? 'ph-fill ph-heart' : 'ph ph-heart'}"></i>
                            <span data-i18n="liked-songs">Liked Songs</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.addToQueue(${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-list-plus"></i>
                            <span data-i18n="queue">Queue</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.openAddSongModal(${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-plus"></i>
                            <span data-i18n="add-to-playlist">Add to Playlist</span>
                        </button>
                        <button class="menu-item" onclick="event.stopPropagation(); window.openShareModal('song', ${s.id}); window.toggleSongMenu(${s.id})">
                            <i class="ph ph-share-network"></i>
                            <span data-i18n="share">Share</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

        // --- RENDERERS ---

       function renderSidebarPlaylistsUpdated(playlists) {
    const container = document.getElementById('sidebar-playlists-container');
    let html = '';
    const playlistArray = Object.keys(playlists).map(key => ({
        id: key,
        ...playlists[key]
    }));
    
    if(playlistArray.length === 0) {
        container.innerHTML = '<div style="padding: 10px 12px; color: #666; font-size: 13px;">' + window.t('no-playlists') + '</div>';
        return;
    }

    playlistArray.forEach(pl => {
        const isPublic = pl.isPublic || false;
        const privacyIcon = isPublic ? '<i class="ph ph-globe" title="Publik"></i>' : '<i class="ph ph-lock-key" title="Privat"></i>';
        const privacyClass = isPublic ? 'color:#1db954' : 'color:#b3b3b3';

        html += `
            <div class="playlist-item" onclick="window.openPlaylist('${pl.id}')">
                <img src="${pl.cover}" class="playlist-thumb" alt="${pl.name}">
                <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${pl.name}</span>
                <div style="display:flex; gap:5px; margin-left:auto;">
                    <button class="share-btn" style="font-size:16px;" onclick="event.stopPropagation(); window.openShareModal('playlist', '${pl.id}')" title="Bagikan"><i class="ph ph-share-network"></i></button>
                    <button class="btn-icon-small" style="font-size:16px; ${privacyClass}" onclick="event.stopPropagation(); window.togglePlaylistPrivacy('${pl.id}')" title="Ubah Privasi">${privacyIcon}</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}
        // Override previous render
        window.renderSidebarPlaylists = renderSidebarPlaylistsUpdated;


        function renderTrending() {
    const container = document.getElementById('trending-container');
    
    //  SAFETY CHECK 1: Container exists?
    if (!container) {
        console.error(' trending-container not found');
        return;
    }
    
    //  SAFETY CHECK 2: User data exists?
    if (!currentUserData || !currentUserData.playlists) {
        container.innerHTML = '<div style="padding:20px; color:#888;">' + 
            window.t('no-playlists') + '. Buat playlist baru yuk!</div>';
        return;
    }
    
    //  SAFETY CHECK 3: Convert to array safely
    let playlists = [];
    try {
        playlists = Object.keys(currentUserData.playlists)
            .filter(key => currentUserData.playlists[key]) // Filter null/undefined
            .map(key => ({
                id: key,
                ...currentUserData.playlists[key]
            }))
            .filter(pl => pl && pl.name && pl.cover); // Validate required fields
    } catch (error) {
        console.error(' Error converting playlists:', error);
        container.innerHTML = '<div style="padding:20px; color:#888;">Error loading playlists</div>';
        return;
    }

    // Take top 4
    const topPlaylists = playlists.slice(0, 4);
    
    if (topPlaylists.length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#888;">' + 
            window.t('no-playlists') + '. Buat playlist baru yuk!</div>';
        return;
    }

    //  FIX: Clear container first
    container.innerHTML = '';
    
    //  FIX: Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    
    topPlaylists.forEach(pl => {
        if (!pl || !pl.id) {
            console.warn(' Invalid playlist data:', pl);
            return;
        }
        
        const card = document.createElement('div');
        card.className = 'song-card';
        card.dataset.playlistId = pl.id; // Store ID in data attribute
        
        //  FIX: Use event listener instead of inline onclick
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const playlistId = this.dataset.playlistId;
            
            //  DEFENSIVE: Double-check playlist exists before opening
            if (!playlistId) {
                console.error(' No playlist ID');
                showToast(' Error: Playlist ID not found', 'error');
                return;
            }
            
            //  DEFENSIVE: Check if playlist still exists in data
            if (!currentUserData?.playlists?.[playlistId]) {
                console.error(' Playlist no longer exists:', playlistId);
                showToast(' Playlist tidak ditemukan', 'error');
                return;
            }
            
            //  DEBOUNCE: Prevent double-tap
            if (this.classList.contains('opening')) {
                console.log(' Already opening...');
                return;
            }
            
            this.classList.add('opening');
            
            setTimeout(() => {
                try {
                    window.openPlaylist(playlistId);
                } catch (error) {
                    console.error(' Error opening playlist:', error);
                    showToast(' Error: ' + error.message, 'error');
                } finally {
                    this.classList.remove('opening');
                }
            }, 100);
        });
        
        card.innerHTML = `
            <div class="card-img-wrapper">
                <img src="${pl.cover || 'https://picsum.photos/seed/default/300/300'}" 
                     alt="${pl.name || 'Playlist'}" 
                     onerror="this.src='https://picsum.photos/seed/default/300/300'">
                <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
            </div>
            <div class="card-title">${pl.name || 'Untitled Playlist'}</div>
            <div class="card-desc">${window.t('my-playlists')}</div>
        `;
        
        fragment.appendChild(card);
    });
    
    container.appendChild(fragment);
    
    console.log(' renderTrending completed:', topPlaylists.length, 'playlists');
}

        function renderPopularBands() {
            const bands = [
                { name: "Perunggu", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/perunggu.jpg", onclick: "window.openPerungguAlbum()" },
                { name: "NOAH / Peterpan", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/noah.jpg", onclick: "window.openNoahAlbum()" },
                { name: "Dewa 19", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/dewa19.png", onclick: "window.openDewaAlbum()" },
                { name: "Sheila On 7", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/so7.jpg", onclick: "window.openSheilaAlbum()" },
                { name: "Kahitna", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/kahitna.jpeg", onclick: "window.openKahitnaAlbum()" },
                { name: "Hindia", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/hindia.jpg", onclick: "window.openHindiaAlbum()" }
            ];
            const container = document.getElementById('popular-bands-container');
            let html = bands.map(band => `
                <div class="song-card" onclick="${band.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${band.image}" alt="${band.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${band.name}</div>
                    <div class="card-desc">${window.t('band-popular-indonesia')}</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function renderPopularArtists() {
            const artists = [
                { name: "Astrid", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/astrid.webp", onclick: "window.openAstridAlbum()" },
                { name: "Afgan", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/afgan.png", onclick: "window.openAfganAlbum()" },
                { name: "Tulus", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tulus.jpg", onclick: "window.openTulusAlbum()" },
                { name: "Mahalini", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/mahalini.jpg", onclick: "window.openMahaliniAlbum()" },
                { name: "Tenxi", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tenxi.jpg", onclick: "window.openTenxiAlbum()" }
            ];
            const container = document.getElementById('popular-artists-container');
            let html = artists.map(artist => `
                <div class="song-card" onclick="${artist.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${artist.image}" alt="${artist.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${artist.name}</div>
                    <div class="card-desc">${window.t('artist-popular-indonesia')}</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        // --- NEW RENDERERS: FOREIGN ARTISTS & BANDS ---
        function renderForeignSoloArtists() {
            const artists = [
                { name: "Taylor Swift", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/taylor.jpg", onclick: "window.openTaylorAlbum()" },
                { name: "Justin Bieber", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/justin.jpg", onclick: "window.openJustinAlbum()" },
                { name: "Ed Sheeran", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ed.jpg", onclick: "window.openEdAlbum()" },
                { name: "Bruno Mars", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/bruno.jpg", onclick: "window.openBrunoAlbum()" },
                { name: "Daniel Caesar", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/daniel.jpg", onclick: "window.openDanielAlbum()" }
            ];
            const container = document.getElementById('foreign-solo-container');
            let html = artists.map(artist => `
                <div class="song-card" onclick="${artist.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${artist.image}" alt="${artist.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${artist.name}</div>
                    <div class="card-desc">${window.t('artist-foreign-popular')}</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function renderForeignBands() {
            const bands = [
                { name: "Coldplay", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/coldplay.jpg", onclick: "window.openColdplayAlbum()" },
                { name: "One Direction", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/onedirection.jpg", onclick: "window.openOnedirectionAlbum()" },
                { name: "Green Day", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/greenday.jpg", onclick: "window.openGreendayAlbum()" },
                { name: "Oasis", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/oasis.jpg", onclick: "window.openOasisAlbum()" },
                { name: "Radiohead", image: "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/radiohead.jpg", onclick: "window.openRadioheadAlbum()" }
            ];
            const container = document.getElementById('foreign-bands-container');
            let html = bands.map(band => `
                <div class="song-card" onclick="${band.onclick}">
                    <div class="card-img-wrapper">
                        <img src="${band.image}" alt="${band.name}" onload="window.applyCardColor(this)">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${band.name}</div>
                    <div class="card-desc">${window.t('band-foreign-popular')}</div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        window.playFirstSongOfPlaylist = () => {
             const playlist = currentUserData.playlists[currentPlaylistId];
             const playlistSongs = playlist && Object.values(playlist.songs || {});
             if(playlistSongs && playlistSongs.length > 0) {
                 const firstSong = (typeof playlistSongs[0] === 'object') ? playlistSongs[0].id : playlistSongs[0];
                 window.playSpecificSong(firstSong);
             } else {
                 window.playSpecificSong(songs[0].id);
             }
        };

        // --- ALBUM/ARTIST VIEW LOGIC (DYNAMIC BACKGROUND) ---
        function setupGenericAlbumView(artistName, coverPath, songStartId, songEndId, viewName, titleElemId, coverElemId, bgElemId, countElemId, containerId) {
            const songList = songs.filter(s => s.id >= songStartId && s.id <= songEndId);
            document.getElementById(titleElemId).innerText = artistName;
            const coverEl = document.getElementById(coverElemId);
            coverEl.src = coverPath;
            
            // --- DYNAMIC BACKGROUND EXTRACTOR ---
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById(bgElemId).style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            document.getElementById(countElemId).innerText = `${songList.length} ${window.t('songs-label')}`;
            renderSongList(songList, containerId);
            switchView(viewName);
        }

        function openPlaylist(playlistId) {
    console.log(' Opening playlist:', playlistId);
    
    //  VALIDATION 1: Check playlistId
    if (!playlistId) {
        console.error(' Invalid playlist ID:', playlistId);
        showToast(' ID playlist tidak valid', 'error');
        return;
    }
    
    try {
        let playlist = null;
        let isOwner = false;

        //  VALIDATION 2: Check if user's playlist
        if (currentUserData?.playlists?.[playlistId]) {
            playlist = currentUserData.playlists[playlistId];
            isOwner = true;
            console.log(' Found in user playlists');
        } 
        // Check Public Playlists
        else if (allPublicPlaylists) {
            playlist = allPublicPlaylists.find(pl => pl.id === playlistId);
            console.log(' Found in public playlists');
        }

        //  VALIDATION 3: Playlist must exist
        if (!playlist) {
            console.error(' Playlist not found:', playlistId);
            showToast(' Playlist tidak ditemukan', 'error');
            
            //  AUTO-FIX: Refresh data and try again
            if (isOwner) {
                console.log(' Attempting to refresh user data...');
                // Trigger data refresh
                get(ref(db, 'users/' + auth.currentUser.uid)).then(snap => {
                    if (snap.exists()) {
                        currentUserData = snap.val();
                        renderTrending(); // Re-render
                        showToast(' Data diperbarui, silakan coba lagi', 'info');
                    }
                });
            }
            return;
        }

        currentPlaylistId = playlistId;

        //  VALIDATION 4: Check required DOM elements
        const requiredElements = {
            'playlist-title-view': 'Title element',
            'playlist-cover-view': 'Cover element',
            'playlist-count': 'Count element',
            'playlist-songs-container': 'Songs container',
            'playlist-header-bg': 'Header background'
        };

        for (const [id, name] of Object.entries(requiredElements)) {
            if (!document.getElementById(id)) {
                console.error(` Required element not found: ${name} (${id})`);
                showToast(' Error: Halaman belum siap', 'error');
                return;
            }
        }

        // Set playlist info
        document.getElementById('playlist-title-view').innerText = playlist.name || 'Untitled';
        const coverEl = document.getElementById('playlist-cover-view');
        coverEl.src = playlist.cover || 'https://picsum.photos/seed/default/300/300';
        
        // Set Owner Name
        const ownerDisplay = document.getElementById('playlist-owner-display');
        if(ownerDisplay) {
            ownerDisplay.innerText = isOwner ? 
                (currentUserData?.username || 'You') : 
                (playlist.ownerName || 'Unknown User');
        }

        // Show/Hide Edit Controls
        const editCoverBtn = document.querySelector('#view-playlist .edit-cover-btn');
        const settingsBtn = document.querySelector('#view-playlist .settings-btn');
        const shareBtn = document.querySelector('#view-playlist .share-btn');
        
        if(editCoverBtn) editCoverBtn.style.display = isOwner ? 'flex' : 'none';
        if(settingsBtn) settingsBtn.style.display = isOwner ? 'block' : 'none';
        if(shareBtn) shareBtn.style.display = 'block';
        
        // Dynamic Background
        coverEl.onerror = function() {
            this.src = 'https://picsum.photos/seed/default/300/300';
        };
        
        coverEl.onload = function() {
            try {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                const headerBg = document.getElementById('playlist-header-bg');
                if (headerBg) {
                    headerBg.style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
                }
            } catch (e) {
                console.warn(' Failed to set background:', e);
            }
        };
        
        //  VALIDATION 5: Filter songs safely
        const playlistSongs = Object.values(playlist.songs || {});
        
        const validSongDetails = playlistSongs
            .filter(songIdOrObj => {
                if (songIdOrObj === undefined || songIdOrObj === null) {
                    console.warn(' Null/undefined song in playlist');
                    return false;
                }
                return true;
            })
            .map(songIdOrObj => {
                const idToFind = (typeof songIdOrObj === 'object') ? songIdOrObj.id : songIdOrObj;
                const found = songs.find(s => s && s.id == idToFind);
                if (!found) {
                    console.warn(' Song not found in library:', idToFind);
                }
                return found;
            })
            .filter(song => song !== undefined && song !== null); 

        document.getElementById('playlist-count').innerText = `${validSongDetails.length} ${window.t('songs-label')}`;
        
        //  CLEAR + DELAY: Ensure clean render
        const songsContainer = document.getElementById('playlist-songs-container');
        songsContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading...</div>';
      
        setTimeout(() => {
            renderSongList(validSongDetails, 'playlist-songs-container');
            console.log(' Playlist rendered successfully');
        }, 100);
        
        // Add to recently played
        addToRecentlyPlayed('playlist', { 
            id: playlistId, 
            name: playlist.name || 'Untitled', 
            cover: playlist.cover || 'https://picsum.photos/seed/default/300/300'
        });
        
        switchView('playlist');
        
    } catch (error) {
        console.error(' Critical error in openPlaylist:', error);
        console.error('Stack trace:', error.stack);
        showToast(' Error: ' + error.message, 'error');
        
        //  FALLBACK: Go back to home
        setTimeout(() => {
            switchView('home');
        }, 2000);
    }
}

        // <--- TAMBAHKAN BARIS INI DI SINI --- >
           window.openPlaylist = openPlaylist;

        function handlePlaylistCoverUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const url = e.target.result;
                    document.getElementById('playlist-cover-view').src = url;
                    update(ref(db, 'users/' + auth.currentUser.uid + '/playlists/' + currentPlaylistId), { cover: url });
                    setTimeout(() => openPlaylist(currentPlaylistId), 100); 
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Existing Ghani/Revan logic
        function openGhaniAlbum() {
            const ghaniSongs = songs.slice(0, 10); 
            document.getElementById('ghani-title-view').innerText = "Ghani's Album";
            const coverEl = document.getElementById('ghani-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('ghani-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('ghani-count').innerText = `${ghaniSongs.length} ${window.t('songs-label')}`;
            renderSongList(ghaniSongs, 'ghani-songs-container');
            switchView('ghani-album');
        }
        window.openGhaniAlbum = openGhaniAlbum;
        window.playFirstSongOfGhani = () => window.playSpecificSong(1);

        function openRevanAlbum() {
            const revanSongs = songs.slice(10, 20);
            document.getElementById('revan-title-view').innerText = "Revan's Album";
            const coverEl = document.getElementById('revan-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('revan-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('revan-count').innerText = `${revanSongs.length} ${window.t('songs-label')}`;
            renderSongList(revanSongs, 'revan-songs-container');
            switchView('revan-album');
        }
        window.openRevanAlbum = openRevanAlbum;
        window.playFirstSongOfRevan = () => window.playSpecificSong(11);

        // Hanung & Rara
        window.openHanungAlbum = () => {
            const hanungSongs = songs.filter(s => s.id >= 300 && s.id <= 305);
            document.getElementById('hanung-title-view').innerText = "Hanung's Album";
            const coverEl = document.getElementById('hanung-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('hanung-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('hanung-count').innerText = `${hanungSongs.length} ${window.t('songs-label')}`;
            renderSongList(hanungSongs, 'hanung-songs-container');
            switchView('hanung-album');
        };
        window.playFirstSongOfHanung = () => window.playSpecificSong(300);

        window.openRaraAlbum = () => {
            const raraSongs = songs.filter(s => s.id >= 306 && s.id <= 310);
            document.getElementById('rara-title-view').innerText = "Rara's Album";
            const coverEl = document.getElementById('rara-cover-view');
            
            // DYNAMIC BG
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('rara-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('rara-count').innerText = `${raraSongs.length} ${window.t('songs-label')}`;
            renderSongList(raraSongs, 'rara-songs-container');
            switchView('rara-album');
        };
        window.playFirstSongOfRara = () => window.playSpecificSong(306);

        // Helper function to handle band/artist opening (desktop overlay OR mobile view)
        function handleArtistBandClick(name, cover, startId, endId, category, description) {
            if (window.innerWidth >= 769) {
                // Desktop: open overlay
                const songsList = songs.filter(s => s.id >= startId && s.id <= endId);
                const artistData = {
                    name,
                    cover,
                    category,
                    description: description || `Popular ${category}`
                };
                window.openArtistBandOverlay(artistData, songsList);
            } else {
                // Mobile: use regular switchView
                // This would need the appropriate view ID which we'll keep the old behavior for now
                console.log('Mobile view for', name);
            }
        }

        // Bands Indonesia (Using Generic Helper for consistency)
        window.openPerungguAlbum = () => {
            setupGenericAlbumView("Perunggu", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/perunggu.jpg", 30, 39, "perunggu-album", "perunggu-title-view", "perunggu-cover-view", "perunggu-header-bg", "perunggu-count", "perunggu-songs-container");
        };
        window.playFirstSongOfPerunggu = () => window.playSpecificSong(30);

        window.openNoahAlbum = () => {
            setupGenericAlbumView("NOAH / Peterpan", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/noah.jpg", 42, 51, "noah-album", "noah-title-view", "noah-cover-view", "noah-header-bg", "noah-count", "noah-songs-container");
        };
        window.playFirstSongOfNoah = () => window.playSpecificSong(42);

        window.openDewaAlbum = () => {
            setupGenericAlbumView("Dewa 19", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/dewa19.png", 57, 68, "dewa-album", "dewa-title-view", "dewa-cover-view", "dewa-header-bg", "dewa-count", "dewa-songs-container");
        };
        window.playFirstSongOfDewa = () => window.playSpecificSong(57);

        window.openSheilaAlbum = () => {
            setupGenericAlbumView("Sheila On 7", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/so7.jpg", 72, 83, "sheila-album", "sheila-title-view", "sheila-cover-view", "sheila-header-bg", "sheila-count", "sheila-songs-container");
        };
        window.playFirstSongOfSheila = () => window.playSpecificSong(72);

        window.openKahitnaAlbum = () => {
            setupGenericAlbumView("Kahitna", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/kahitna.jpeg", 87, 97, "kahitna-album", "kahitna-title-view", "kahitna-cover-view", "kahitna-header-bg", "kahitna-count", "kahitna-songs-container");
        };
        window.playFirstSongOfKahitna = () => window.playSpecificSong(87);

        window.openHindiaAlbum = () => {
            setupGenericAlbumView("Hindia", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/hindia.jpg", 100, 110, "hindia-album", "hindia-title-view", "hindia-cover-view", "hindia-header-bg", "hindia-count", "hindia-songs-container");
        };
        window.playFirstSongOfHindia = () => window.playSpecificSong(100);

        // Artists Indonesia
        window.openAstridAlbum = () => {
            setupGenericAlbumView("Astrid", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/astrid.webp", 112, 116, "astrid-album", "astrid-title-view", "astrid-cover-view", "astrid-header-bg", "astrid-count", "astrid-songs-container");
        };
        window.playFirstSongOfAstrid = () => window.playSpecificSong(112);

        window.openAfganAlbum = () => {
            setupGenericAlbumView("Afgan", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/afgan.png", 122, 129, "afgan-album", "afgan-title-view", "afgan-cover-view", "afgan-header-bg", "afgan-count", "afgan-songs-container");
        };
        window.playFirstSongOfAfgan = () => window.playSpecificSong(122);

        window.openTulusAlbum = () => {
            setupGenericAlbumView("Tulus", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tulus.jpg", 132, 141, "tulus-album", "tulus-title-view", "tulus-cover-view", "tulus-header-bg", "tulus-count", "tulus-songs-container");
        };
        window.playFirstSongOfTulus = () => window.playSpecificSong(132);

        window.openMahaliniAlbum = () => {
            setupGenericAlbumView("Mahalini", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/mahalini.jpg", 142, 149, "mahalini-album", "mahalini-title-view", "mahalini-cover-view", "mahalini-header-bg", "mahalini-count", "mahalini-songs-container");
        };
        window.playFirstSongOfMahalini = () => window.playSpecificSong(142);

        window.openTenxiAlbum = () => {
            setupGenericAlbumView("Tenxi", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/tenxi.jpg", 152, 156, "tenxi-album", "tenxi-title-view", "tenxi-cover-view", "tenxi-header-bg", "tenxi-count", "tenxi-songs-container");
        };
        window.playFirstSongOfTenxi = () => window.playSpecificSong(152);

        // Foreign Artists & Bands
        window.openTaylorAlbum = () => {
            setupGenericAlbumView("Taylor Swift", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/taylor.jpg", 157, 164, "taylor-album", "taylor-title-view", "taylor-cover-view", "taylor-header-bg", "taylor-count", "taylor-songs-container");
        };
        window.playFirstSongOfTaylor = () => window.playSpecificSong(157);

        window.openJustinAlbum = () => {
            setupGenericAlbumView("Justin Bieber", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/justin.jpg", 167, 176, "justin-album", "justin-title-view", "justin-cover-view", "justin-header-bg", "justin-count", "justin-songs-container");
        };
        window.playFirstSongOfJustin = () => window.playSpecificSong(167);

        window.openEdAlbum = () => {
            setupGenericAlbumView("Ed Sheeran", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/ed.jpg", 177, 186, "ed-album", "ed-title-view", "ed-cover-view", "ed-header-bg", "ed-count", "ed-songs-container");
        };
        window.playFirstSongOfEd = () => window.playSpecificSong(177);

        window.openBrunoAlbum = () => {
            setupGenericAlbumView("Bruno Mars", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/bruno.jpg", 187, 196, "bruno-album", "bruno-title-view", "bruno-cover-view", "bruno-header-bg", "bruno-count", "bruno-songs-container");
        };
        window.playFirstSongOfBruno = () => window.playSpecificSong(187);

        window.openDanielAlbum = () => {
            setupGenericAlbumView("Daniel Caesar", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/daniel.jpg", 197, 206, "daniel-album", "daniel-title-view", "daniel-cover-view", "daniel-header-bg", "daniel-count", "daniel-songs-container");
        };
        window.playFirstSongOfDaniel = () => window.playSpecificSong(197);

        window.openColdplayAlbum = () => {
            setupGenericAlbumView("Coldplay", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/coldplay.jpg", 207, 216, "coldplay-album", "coldplay-title-view", "coldplay-cover-view", "coldplay-header-bg", "coldplay-count", "coldplay-songs-container");
        };
        window.playFirstSongOfColdplay = () => window.playSpecificSong(207);

        window.openOnedirectionAlbum = () => {
            setupGenericAlbumView("One Direction", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/onedirection.jpg", 217, 226, "onedirection-album", "onedirection-title-view", "onedirection-cover-view", "onedirection-header-bg", "onedirection-count", "onedirection-songs-container");
        };
        window.playFirstSongOfOnedirection = () => window.playSpecificSong(217);

        window.openGreendayAlbum = () => {
            setupGenericAlbumView("Green Day", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/greenday.jpg", 227, 236, "greenday-album", "greenday-title-view", "greenday-cover-view", "greenday-header-bg", "greenday-count", "greenday-songs-container");
        };
        window.playFirstSongOfGreenday = () => window.playSpecificSong(227);

        window.openOasisAlbum = () => {
            setupGenericAlbumView("Oasis", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/oasis.jpg", 237, 246, "oasis-album", "oasis-title-view", "oasis-cover-view", "oasis-header-bg", "oasis-count", "oasis-songs-container");
        };
        window.playFirstSongOfOasis = () => window.playSpecificSong(237);

        window.openRadioheadAlbum = () => {
            setupGenericAlbumView("Radiohead", "https://qkruoywwqdpkdjlajbpl.supabase.co/storage/v1/object/public/vidje/albumphoto/radiohead.jpg", 247, 256, "radiohead-album", "radiohead-title-view", "radiohead-cover-view", "radiohead-header-bg", "radiohead-count", "radiohead-songs-container");
        };
        window.playFirstSongOfRadiohead = () => window.playSpecificSong(247);

        // --- LIKED SONGS LOGIC ---
        function openLikedView() {
            const likedSongsList = songs.filter(s => likedSongs.includes(s.id));
            document.getElementById('liked-title-view').innerText = window.t('liked');
            const coverEl = document.getElementById('liked-cover-view');
            
            // Use custom liked cover if exists
            let coverUrl = "https://picsum.photos/seed/liked/300/300";
            if(currentUserData && currentUserData.likedCover) {
                coverUrl = currentUserData.likedCover;
            } else if (likedSongsList.length > 0) {
                coverUrl = likedSongsList[0].cover;
            }
            
            coverEl.src = coverUrl;
            coverEl.onload = function() {
                const rgb = getAverageRGB(coverEl);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('liked-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            };
            
            document.getElementById('liked-count').innerText = `${likedSongsList.length} ${window.t('songs-label')}`;
            renderSongList(likedSongsList, 'liked-songs-container');
        }
        
        window.openLikedView = openLikedView;
        window.playFirstSongOfLiked = () => {
            if(likedSongs.length > 0) {
                window.playSpecificSong(likedSongs[0]);
            } else {
                alert(window.t('no-songs'));
            }
        };

        // --- PROFILE VIEW LOGIC ---
        function openProfileView() {
            if(!currentUserData) return;
            
            document.getElementById('profile-name-display').innerText = currentUserData.username;
            document.getElementById('profile-bio-display').innerText = currentUserData.bio || '';
            const avatarDisplay = document.getElementById('profile-avatar-display');
            avatarDisplay.src = currentUserData.profile_picture;
            document.getElementById('profile-userid-text').innerText = currentUserData.userId || "User_0000"; //  PERBAIKAN

            avatarDisplay.onload = function() {
                const rgb = getAverageRGB(avatarDisplay);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('profile-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            document.getElementById('edit-profile-name').value = currentUserData.username;
            document.getElementById('edit-profile-bio').value = currentUserData.bio || '';
            document.getElementById('edit-profile-img').src = currentUserData.profile_picture;

            document.getElementById('profile-edit-panel').classList.remove('active');
            renderProfilePublicPlaylists();
        }
        
        function toggleProfileEdit() {
            document.getElementById('profile-edit-panel').classList.toggle('active');
        }

       // Ganti fungsi renderProfilePublicPlaylists yang lama (sekitar line 1800):

function renderProfilePublicPlaylists() {
    const playlists = currentUserData.playlists || {};
    const container = document.getElementById('profile-public-playlists');
    let html = '';
    
    Object.keys(playlists).forEach(key => {
        const pl = playlists[key];
        // ONLY SHOW PUBLIC PLAYLISTS
        if(pl.isPublic) {
            html += `
                <div class="song-card" onclick="window.openPlaylist('${key}')">
                    <div class="card-img-wrapper">
                        <img src="${pl.cover}" alt="${pl.name}">
                        <div class="play-btn-overlay"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="card-title">${pl.name}</div>
                    <div class="card-desc">Playlist</div>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = '<p style="color:#666; font-style:italic; padding: 0 32px;">' + window.t('no-public-playlists') + '</p>';
    }

    container.innerHTML = html;
}
    
    
        function handleProfileAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-profile-img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfileChanges() {
    const newName = document.getElementById('edit-profile-name').value.trim();
    const newBio = document.getElementById('edit-profile-bio').value;
    const newAvatarSrc = document.getElementById('edit-profile-img').src;

    const currentSuffix = currentUserData.userIdSuffix || Math.floor(1000 + Math.random() * 9000);
    const cleanName = newName.replace(/\s+/g, '');
    
    // GANTI # dengan _ di sini juga
    const newUserId = `${cleanName}_${currentSuffix}`; //  UBAH DARI # ke _

    const updates = {
        username: newName,
        userId: newUserId,
        userIdSuffix: currentSuffix,
        bio: newBio,
        profile_picture: newAvatarSrc
    };

    update(ref(db, 'users/' + auth.currentUser.uid), updates)
        .then(() => {
            const oldUserId = currentUserData.userId;
            remove(ref(db, 'usernames/' + oldUserId));
            set(ref(db, 'usernames/' + newUserId), auth.currentUser.uid);

            document.getElementById('header-username').innerText = newName;
            document.getElementById('header-avatar').src = newAvatarSrc;
            document.getElementById('profile-name-display').innerText = newName;
            document.getElementById('profile-bio-display').innerText = newBio;
            document.getElementById('profile-userid-text').innerText = newUserId;
            document.getElementById('profile-avatar-display').src = newAvatarSrc;
            
            const avatarDisplay = document.getElementById('profile-avatar-display');
            avatarDisplay.onload = function() {
                const rgb = getAverageRGB(avatarDisplay);
                const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('profile-hero-section').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
            }

            currentUserData = { ...currentUserData, ...updates };

            toggleProfileEdit(); 
            alert("Profil berhasil disimpan! User ID Anda sekarang: " + newUserId);
        })
        .catch((err) => {
            console.error(err);
            alert("Gagal menyimpan profil.");
        });
}

        // Expose profile functions
        window.toggleProfileEdit = toggleProfileEdit;
        window.handleProfileAvatarUpload = handleProfileAvatarUpload;
        window.saveProfileChanges = saveProfileChanges;
        window.loadProfileData = openProfileView;

        // --- ADD SONG MODAL ---
        function openAddSongModal(songId) {
            const list = document.getElementById('add-song-playlist-list');
            const playlists = currentUserData.playlists || {};
            let html = '';
            Object.keys(playlists).forEach(key => {
                const pl = playlists[key];
                html += `<div class="playlist-select-item" onclick="window.addSongTo('${key}', '${songId}')">
                    <img src="${pl.cover}" style="width:40px;height:40px;border-radius:4px;">
                    <div>${pl.name}</div>
                </div>`;
            });
            if(Object.keys(playlists).length === 0) html = '<p style="text-align:center;color:#888">' + window.t('no-playlists') + '</p>';
            list.innerHTML = html;
            document.getElementById('add-song-modal').classList.add('open');
        }

        function addSongTo(playlistId, songId) {
            const songData = songs.find(s => s.id == songId);
            if(!songData) return;
            const userId = auth.currentUser.uid;
            update(ref(db, 'users/' + userId + '/playlists/' + playlistId + '/songs/' + songId), songData);
            closeModal('add-song-modal');
            addToLiked(songId);
        }

        window.openAddSongModal = openAddSongModal;
        window.addSongTo = addSongTo;
        
        function addToLiked(id) {
            if (!likedSongs.includes(id)) {
                likedSongs.push(id);
                localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
                const currentSong = songs[currentSongIndex];
                if(currentSong && currentSong.id === id) {
                    updatePlayerLikeIcon(id);
                }
            }
        }

        function toggleCurrentSongLike() {
            const currentSong = songs[currentSongIndex];
            if (currentSong) {
                toggleLike(currentSong.id);
            }
        }

        function toggleLike(id) {
            const index = likedSongs.indexOf(id);
            let isLiked = false;
            
            if(index > -1) {
                likedSongs.splice(index, 1);
            } else {
                likedSongs.push(id);
                isLiked = true;
            }
            localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
            
            const currentSong = songs[currentSongIndex];
            if(currentSong && currentSong.id === id) {
                updatePlayerLikeIcon(id);
            }
            updateListLikeIcon(id);
            updateMenuLikeIcon(id);
            updateSongTitleIndicator(id);
            
            // Show toast notification
            if(isLiked) {
                window.showToast('Lagu disukai', 'info');
            }
        }

        function updatePlayerLikeIcon(id) {
            const btn = document.getElementById('like-btn');
            const icon = btn.querySelector('i');
            
            if(likedSongs.includes(id)) {
                icon.className = 'ph-fill ph-heart';
                btn.classList.add('liked');
            } else {
                icon.className = 'ph ph-heart';
                btn.classList.remove('liked');
            }
        }

        function updateListLikeIcon(id) {
            // Update list-like button
            const btn = document.getElementById(`list-like-${id}`);
            if(btn) {
                const icon = btn.querySelector('i');
                if(likedSongs.includes(id)) {
                    if(icon) icon.className = 'ph-fill ph-heart';
                    btn.classList.add('liked');
                    btn.style.color = 'var(--primary-red)';
                } else {
                    if(icon) icon.className = 'ph ph-heart';
                    btn.classList.remove('liked');
                    btn.style.color = 'var(--text-gray)';
                }
            }
            
            // Update overlay-like button
            const overlayBtn = document.getElementById(`overlay-like-${id}`);
            if(overlayBtn) {
                const overlayIcon = overlayBtn.querySelector('i');
                if(likedSongs.includes(id)) {
                    if(overlayIcon) overlayIcon.className = 'ph-fill ph-heart';
                    overlayBtn.classList.add('liked');
                } else {
                    if(overlayIcon) overlayIcon.className = 'ph ph-heart';
                    overlayBtn.classList.remove('liked');
                }
            }
        }

        function updateMenuLikeIcon(id) {
            // Update menu-like button in dropdown
            const menuBtn = document.getElementById(`menu-like-${id}`);
            if(menuBtn) {
                const icon = menuBtn.querySelector('i');
                if(likedSongs.includes(id)) {
                    if(icon) icon.className = 'ph-fill ph-heart';
                } else {
                    if(icon) icon.className = 'ph ph-heart';
                }
            }
        }

        function updateSongTitleIndicator(id) {
            const row = document.getElementById(`row-${id}`);
            if(!row) return;
            const titleEl = row.querySelector('.song-title-text');
            if(!titleEl) return;
            // remove any existing heart icons next to title
            titleEl.querySelectorAll('i.ph-heart, i.ph-fill.ph-heart, i.ph-heart-fill').forEach(n => n.remove());
            if(likedSongs.includes(id)) {
                const heart = document.createElement('i');
                heart.className = 'ph-fill ph-heart';
                heart.style.fontSize = '14px';
                heart.style.color = 'var(--primary-red)';
                heart.style.marginLeft = '6px';
                heart.style.verticalAlign = 'middle';
                titleEl.appendChild(heart);
            }
        }

        // Fallback renderer for icons inserted dynamically (helps mobile where icons may not render)
        window.applyIconFallback = function(root = document) {
            const icons = (root.querySelectorAll ? root.querySelectorAll('i') : []);
            icons.forEach(i => {
                if(i.dataset.fallbackApplied) return;
                const cls = (i.className || '').toLowerCase();
                let ch = '';
                if(cls.includes('ph-dots-three-vertical')) ch = '';
                else if(cls.includes('ph-list-plus')) ch = '';
                else if(cls.includes('ph-plus')) ch = '';
                else if(cls.includes('ph-share-network')) ch = '';
                else if(cls.includes('ph-heart')) ch = (cls.includes('ph-fill')) ? '' : '';
                else ch = '';

                // Only apply fallback if icon is not visible, empty, atau sudah tidak ada fallback
                const style = window.getComputedStyle(i);
                const alreadyHasFallback = i.innerHTML.includes('icon-fallback');
                const iconVisible = style.display !== 'none' && style.visibility !== 'hidden' && style.width !== '0px' && style.height !== '0px';
                // Hanya tambahkan fallback jika icon tidak tampil dan belum ada fallback
                if(!iconVisible && !alreadyHasFallback) {
                    i.innerHTML = `<span class="icon-fallback">${ch}</span>`;
                    i.style.lineHeight = '1';
                }
                i.dataset.fallbackApplied = '1';
            });
        };

        window.toggleLike = toggleLike;
        window.addToLiked = addToLiked;
        window.toggleCurrentSongLike = toggleCurrentSongLike;

        // Toggle Song Action Menu
        window.toggleSongMenu = function(songId) {
            const menu = document.getElementById(`menu-${songId}`);
            if(!menu) return;
            // Close all other menus
            document.querySelectorAll('.song-menu-dropdown').forEach(m => {
                if(m !== menu) {
                    m.style.display = 'none';
                    m.classList.remove('active-slide');
                }
            });
            // Toggle current menu
            if(menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                menu.classList.add('active-slide');
            } else {
                menu.style.display = 'none';
                menu.classList.remove('active-slide');
            }
        };

        // Close dropdown saat menu item diklik
        document.addEventListener('click', function(e) {
            var menuItem = e.target.closest('.menu-item');
            if(menuItem) {
                var dropdown = menuItem.closest('.song-menu-dropdown');
                if(dropdown) {
                    dropdown.style.display = 'none';
                    dropdown.classList.remove('active-slide');
                }
            }
            // Close dropdown saat klik di area lain (bukan menu atau button)
            else if(!e.target.closest('.song-actions-menu')) {
                document.querySelectorAll('.song-menu-dropdown').forEach(menu => {
                    menu.style.display = 'none';
                    menu.classList.remove('active-slide');
                });
            }
        });

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if(!event.target.closest('.song-actions-menu')) {
                document.querySelectorAll('.song-menu-dropdown').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        // --- QUEUE SYSTEM LOGIC ---

        function toggleQueueOverlay() {
            const overlay = document.getElementById('queue-overlay');
            overlay.classList.toggle('open');
            renderQueue();
        }

        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = '<i class="ph ph-check-circle" style="font-size: 20px;"></i>';
            if(type === 'queue') {
                icon = '<i class="ph ph-plus-circle" style="font-size: 20px;"></i>';
            } else if(type === 'error') {
                icon = '<i class="ph ph-warning-circle" style="font-size: 20px;"></i>';
            }
            
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function addToQueue(songId) {
            const song = songs.find(s => s.id === songId);
            if(song) {
                songQueue.push(song);
                renderQueue();
                // Show toast notification
                window.showToast(window.t('song-added-to-queue'), 'queue');
            }
        }

        function removeFromQueue(index) {
            songQueue.splice(index, 1);
            renderQueue();
        }

        function playFromQueue(index) {
            const song = songQueue[index];
            if(song) {
                // If it's not first one, we might want to reorder, but for now let's just play it
                // Usually playing from queue implies that becomes current and we remove previous from queue?
                // Let's just play it and remove it from queue after or before?
                // Standard behavior: Play it, remove played ones before it.
                
                // For simplicity: Play this specific song immediately.
                playSpecificSong(song.id);
                
                // Remove items up to and including this index from queue
                songQueue.splice(0, index + 1);
                renderQueue();
            }
        }
        
        // --- DRAG AND DROP QUEUE LOGIC ---
        let dragStartIndex;

        function handleDragStart(e) {
            dragStartIndex = +this.closest('.queue-item').dataset.index;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const container = document.getElementById('queue-list-container');
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('dragging');
            // Reorder array based on DOM
            const newOrder = [];
            document.querySelectorAll('.queue-item').forEach(item => {
                const idx = parseInt(item.dataset.index);
                newOrder.push(songQueue[idx]);
            });
            songQueue = newOrder;
            
            // Re-render to fix indices
            renderQueue();
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.queue-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function renderQueue() {
            const container = document.getElementById('queue-list-container');
            if(songQueue.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">' + window.t('empty-queue') + '</div>';
                return;
            }

            let html = '';
            songQueue.forEach((song, index) => {
                html += `
                    <div class="queue-item" draggable="true" data-index="${index}">
                        <img src="${song.cover}" class="queue-img">
                        <div class="queue-info">
                            <div class="queue-title">${song.title}</div>
                            <div class="queue-artist">${song.artist}</div>
                        </div>
                        <button class="queue-remove" onclick="window.removeFromQueue(${index})"><i class="ph ph-x"></i></button>
                    </div>
                `;
            });
            container.innerHTML = html;

            // Attach Drag Events
            const items = container.querySelectorAll('.queue-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver); // On container usually, but here items
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            });
        }

        window.toggleQueueOverlay = toggleQueueOverlay;
        window.addToQueue = addToQueue;
        window.showToast = showToast;
        window.removeFromQueue = removeFromQueue;
        window.playFromQueue = playFromQueue;

        // --- PLAYER LOGIC (FIXED ANIMATION & QUEUE/REPEAT) ---
        
        // --- OVERLAY PLAYER LOGIC ---
        function checkMarquee(el, text) {
            if(!el) return;
            el.innerHTML = text; // Reset
            el.classList.remove('marquee-container');
            
            // Check overflow
            if(el.scrollWidth > el.clientWidth && el.clientWidth > 0) {
                el.classList.add('marquee-container');
                el.innerHTML = `<div class="marquee-content"><span>${text}</span><span>${text}</span></div>`;
            }
        }

        function openOverlayPlayer() {
            document.getElementById('overlay-player').classList.add('active');
            // Check marquee when opening
            if(songs[currentSongIndex]) {
                const s = songs[currentSongIndex];
                checkMarquee(document.getElementById('overlay-title'), s.title);
                checkMarquee(document.getElementById('overlay-artist'), s.artist);
            }
        }

        function closeOverlayPlayer() {
            document.getElementById('overlay-player').classList.remove('active');
        }
        
        window.openOverlayPlayer = openOverlayPlayer;
        window.closeOverlayPlayer = closeOverlayPlayer;

       // Ganti seluruh fungsi openArtistBandOverlay (sekitar line 2400-2500)
function openArtistBandOverlay(artistData, songsList) {
    // Check if desktop (min-width 769px)
    if (window.innerWidth < 769) {
        // Switch to the regular view on mobile
        window.switchView(artistData.viewId);
        return;
    }

    //  CRITICAL DEBUG: Check what's being passed
    console.log('%c===== CRITICAL DEBUG =====', 'background: red; color: white; font-weight: bold; font-size: 14px;');
    console.log('Artist:', artistData.name);
    console.log('songsList param length:', songsList.length);
    console.log('songsList[0]:', songsList[0]);
    console.log('songsList[songsList.length-1]:', songsList[songsList.length-1]);
    console.log('Global songs.length:', songs.length);
    console.log('Global songs[0]:', songs[0]);
    console.log('Global songs[29]:', songs[29]);
    console.log('Global songs[30]:', songs[30]);
    console.log('%c=====  =====', 'background: red; color: white; font-weight: bold; font-size: 14px;');

    //  DEKLARASI OVERLAY DI AWAL
    const overlay = document.getElementById('artist-band-profile-overlay');
    
    document.getElementById('artist-band-overlay-title').innerText = artistData.name;
    document.getElementById('artist-band-overlay-name').innerText = artistData.name;
    document.getElementById('artist-band-overlay-category').innerText = artistData.category;
    document.getElementById('artist-band-overlay-cover').src = artistData.cover;
    document.getElementById('artist-band-overlay-song-count').innerText = songsList.length;
    document.getElementById('artist-band-overlay-description').innerText = artistData.description || '';

    // Render songs - SIMPLE APPROACH FIRST
    const songsContainer = document.getElementById('artist-band-overlay-songs');
    songsContainer.innerHTML = '';
    
    songsList.forEach((song, index) => {
        console.log(`Rendering song ${index}:`, song);
        const songEl = document.createElement('div');
        songEl.className = 'artist-band-song-item';
        songEl.id = `overlay-song-${song.id}`;
        
        //  SIMPLE RENDER - use song directly without reconstruction
        songEl.innerHTML = `
            <div class="artist-band-song-index">
                <span class="index-num">${index + 1}</span>
                <div class="playing-icon-container" style="display:none;">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="artist-band-song-info">
                <img src="${song.cover || ''}" class="artist-band-song-cover" alt="${song.title}">
                <div style="flex: 1; overflow: hidden; min-width: 0;">
                    <div class="artist-band-song-title">${song.title}</div>
                    <div class="artist-band-song-artist">${song.artist}</div>
                </div>
            </div>
            <div class="artist-band-song-album">${song.album || ''}</div>
            <div class="artist-band-song-duration">${song.duration || '0:00'}</div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; padding-right: 8px; align-items: center;">
                <button class="overlay-like-btn ${likedSongs && likedSongs.includes(song.id) ? 'liked' : ''}" onclick="event.stopPropagation(); window.toggleLike(${song.id})" id="overlay-like-${song.id}" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 18px; transition: 0.2s;">
                    <i class="${likedSongs && likedSongs.includes(song.id) ? 'ph-fill ph-heart' : 'ph ph-heart'}"></i>
                </button>
                <button onclick="event.stopPropagation(); window.openShareModal('song', ${song.id})" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 18px; transition: 0.2s;">
                    <i class="ph ph-share-network"></i>
                </button>
                <button onclick="event.stopPropagation(); window.addToQueue(${song.id})" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 18px; transition: 0.2s;" title="Tambah Antrian">
                    <i class="ph ph-list-plus"></i>
                </button>
                <button onclick="event.stopPropagation(); window.openAddSongModal(${song.id})" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 18px; transition: 0.2s;" title="Tambah ke Playlist">
                    <i class="ph ph-plus"></i>
                </button>
            </div>
        `;
        
        songEl.style.cursor = 'pointer';
        songEl.addEventListener('click', () => {
            console.log(' Clicked song:', song.id, song.title);
            const track = songs.find(s => s.id === song.id);
            if (track) {
                console.log(' Found in global array:', track.title, 'by', track.artist);
                window.loadSong(track);
                window.playAudio();
            } else {
                console.error(' NOT FOUND in global array!', song.id);
            }
            
            // Update visualizer
            document.querySelectorAll('.artist-band-song-item').forEach(el => {
                el.classList.remove('playing');
                const eq = el.querySelector('.playing-icon-container');
                const num = el.querySelector('.index-num');
                if(eq) eq.style.display = 'none';
                if(num) num.style.display = 'block';
            });
            
            songEl.classList.add('playing');
            const eq = songEl.querySelector('.playing-icon-container');
            const num = songEl.querySelector('.index-num');
            if(eq) {
                eq.style.display = 'flex';
                eq.style.animationPlayState = 'running';
            }
            if(num) num.style.display = 'none';
        });
        songsContainer.appendChild(songEl);
    });

    overlay.classList.add('active');
    
    //  SYNC VISUALIZER JIKA LAGU SEDANG DIPUTAR
    setTimeout(() => {
        const currentSong = songs[currentSongIndex];
        if(currentSong) {
            const activeOverlayRow = document.getElementById(`overlay-song-${currentSong.id}`);
            if(activeOverlayRow) {
                activeOverlayRow.classList.add('playing');
                const eq = activeOverlayRow.querySelector('.playing-icon-container');
                const num = activeOverlayRow.querySelector('.index-num');
                if(eq) {
                    eq.style.display = 'flex';
                    eq.style.animationPlayState = isPlaying ? 'running' : 'paused';
                }
                if(num) num.style.display = 'none';
            }
        }
    }, 100);
}

        function closeArtistBandOverlay() {
            document.getElementById('artist-band-profile-overlay').classList.remove('active');
        }

        window.openArtistBandOverlay = openArtistBandOverlay;
        window.closeArtistBandOverlay = closeArtistBandOverlay;

        // Add click-outside to close artist-band overlay
        document.getElementById('artist-band-profile-overlay').addEventListener('click', (e) => {
            // Close only if clicking on the overlay itself (not content inside)
            if (e.target.id === 'artist-band-profile-overlay') {
                window.closeArtistBandOverlay();
            }
        });

        // Player Bar Click to Open Overlay
        document.querySelector('.player-bar').addEventListener('click', (e) => {
            // Jangan buka jika yang diklik adalah tombol kontrol
            if(e.target.closest('button') || e.target.closest('.volume-bar-container')) return;
            openOverlayPlayer();
        });

        // Overlay Progress Bar Click
        document.getElementById('overlay-progress-container').addEventListener('click', (e) => {
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            audio.currentTime = (x / width) * audio.duration;
        });

        function loadSong(song) {
    //  PERBAIKAN: Update semua elemen UI dengan data lagu yang benar
    
    // 1. Update Player Bar
    checkMarquee(document.getElementById('player-title'), song.title);
    checkMarquee(document.getElementById('player-artist'), song.artist);
    playerArt.src = song.cover;
    
    // 2. Update Audio Source
    audio.src = song.src;
    
    // 3.  PERBAIKAN OVERLAY - SELALU UPDATE (tidak peduli overlay buka/tutup)
    const overlayTitle = document.getElementById('overlay-title');
    const overlayArtist = document.getElementById('overlay-artist');
    const overlayArt = document.getElementById('overlay-art');
    const overlayBg = document.getElementById('overlay-bg');
    
    // Reset classes dulu
    if(overlayTitle) {
        overlayTitle.classList.remove('marquee-container');
        overlayTitle.innerHTML = ''; // Clear existing content
        overlayTitle.innerText = song.title; // Set fresh text
    }
    
    if(overlayArtist) {
        overlayArtist.classList.remove('marquee-container');
        overlayArtist.innerHTML = ''; // Clear existing content
        overlayArtist.innerText = song.artist; // Set fresh text
    }
    
    if(overlayArt) overlayArt.src = song.cover;
    if(overlayBg) overlayBg.style.backgroundImage = `url(${song.cover})`;
    
    // Apply marquee jika text overflow (setelah render selesai)
    setTimeout(() => {
        if(overlayTitle) checkMarquee(overlayTitle, song.title);
        if(overlayArtist) checkMarquee(overlayArtist, song.artist);
    }, 100);
    
    // 4. Update Like Button State
    updatePlayerLikeIcon(song.id);
    
    // 5. Update Visualizers - Hide All
    document.querySelectorAll('.song-row').forEach(r => {
        r.classList.remove('playing');
        const eqContainer = r.querySelector('.playing-icon-container');
        const num = r.querySelector('.index-num');
        if(eqContainer) {
            eqContainer.style.display = 'none';
            eqContainer.style.animationPlayState = 'paused'; 
        }
        if(num) num.style.display = 'block';
    });
    
    // 6. Show Visualizer for Current Song
    const active = document.getElementById(`row-${song.id}`);
    if(active) {
        active.classList.add('playing');
        const eq = active.querySelector('.playing-icon-container');
        if(eq) {
            eq.style.display = 'flex';
            if(isPlaying) eq.style.animationPlayState = 'running';
        }
        if(active.querySelector('.index-num')) active.querySelector('.index-num').style.display = 'none';
    }
    
    // 7.  PERBAIKAN: Force update Media Session Metadata
    if ('mediaSession' in navigator && navigator.mediaSession) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: song.title,
            artist: song.artist,
            album: song.album || 'Vidje',
            artwork: [
                { src: song.cover, sizes: '96x96', type: 'image/png' },
                { src: song.cover, sizes: '512x512', type: 'image/png' }
            ]
        });
    }
}
        // --- ARTIST PROFILE LOGIC ---
        function openArtistProfile(artistName, fallbackImg) {
            const overlay = document.getElementById('artist-profile-overlay');
            const nameEl = document.getElementById('artist-profile-name');
            const imgEl = document.getElementById('artist-profile-img');
            const songsContainer = document.getElementById('artist-profile-songs');

            // Find artist in static index
            const artistData = searchIndexArtists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
            
            nameEl.innerText = artistName;
            
            if (artistData) {
                imgEl.src = artistData.img;
            } else {
                imgEl.src = fallbackImg || 'https://picsum.photos/seed/artist/300/300';
            }

            // Filter songs by this artist
            const artistSongs = songs.filter(s => s.artist.toLowerCase() === artistName.toLowerCase());
            renderSongListCustom(artistSongs, 'artist-profile-songs', false);
            
            // Add padding so player bar doesn't cover last song
            songsContainer.style.paddingBottom = '120px';

            overlay.classList.add('active');
        }

        function closeArtistProfile() {
            document.getElementById('artist-profile-overlay').classList.remove('active');
        }

        window.openArtistProfile = openArtistProfile;
        window.closeArtistProfile = closeArtistProfile;
        window.loadSong = loadSong;

        // Simple play audio wrapper
        window.playAudio = function() {
            if (!audio.src || audio.src === window.location.href) {
                console.warn(" Audio source is empty, cannot play.");
                return; 
            }
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    isPlaying = true;
                    updatePlayBtn();
                }).catch(error => {
                    // Handle AbortError (interrupted by pause)
                    if (error.name === 'AbortError') {
                        console.log(" Play was interrupted by pause");
                    } else {
                        console.warn(" Play error:", error);
                    }
                });
            }
        };

        // Helper to open from Overlay
        window.openArtistProfileFromOverlay = function() {
            const artistName = document.getElementById('overlay-artist').innerText;
            const currentImg = document.getElementById('overlay-art').src;
            closeOverlayPlayer(); // Close player overlay first? Or keep it open underneath? 
            // User asked "munculkan overlay lagi", let's stack it.
            // But if we want to go back, stacking is better.
            openArtistProfile(artistName, currentImg);
        };

        // Add Click Event to Player Bar Artist
        document.getElementById('player-artist').addEventListener('click', (e) => {
            e.stopPropagation();
            const artistName = e.target.innerText;
            const currentImg = document.getElementById('player-art').src;
            openArtistProfile(artistName, currentImg);
        });
        // Make it look clickable
        document.getElementById('player-artist').style.cursor = 'pointer';
        document.getElementById('player-artist').style.textDecoration = 'underline';


        function playSpecificSong(id) {
            // Push to history (avoid duplicates)
            const currentSong = songs[currentSongIndex];
            if(currentSong && currentSong.id !== id) {
                playHistory.push(currentSong);
            }

            const idx = songs.findIndex(s => s.id === id);
            if (idx !== -1) {
                currentSongIndex = idx;
                loadSong(songs[currentSongIndex]);
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isPlaying = true;
                        updatePlayBtn();
                    }).catch(error => {
                        if (error.name === 'AbortError') {
                            console.log(" Play was interrupted");
                        } else {
                            console.error(" Play error:", error);
                        }
                    });
                } else {
                    isPlaying = true;
                    updatePlayBtn();
                }
                
                // Add to Recently Played
                addToRecentlyPlayed('song', songs[currentSongIndex]);
                
                // Broadcast to Listen Together if Host
                if(listenTogetherSession.active && listenTogetherSession.isHost) {
                    broadcastState();
                }
            }
        }
        window.playSpecificSong = playSpecificSong;

        function playNext() {
            // Logic: Check Queue -> Check Repeat -> Next Song
            
            if(repeatMode === 2) {
                // Repeat One
                audio.currentTime = 0;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        if (error.name !== 'AbortError') {
                            console.error(" Play error:", error);
                        }
                    });
                }
                return;
            }

            // Check Queue First
            if(songQueue.length > 0) {
                const nextQueued = songQueue.shift(); // Remove from front
                playSpecificSong(nextQueued.id);
                renderQueue(); // Update UI to show removal
                return;
            }

            // Normal Playback
            if(repeatMode === 1 && currentSongIndex === songs.length - 1) {
                // Repeat All & Last song -> Go to 0
                currentSongIndex = 0;
            } else {
                // Default Next
                currentSongIndex = (currentSongIndex + 1) % songs.length;
            }
            
            loadSong(songs[currentSongIndex]); 
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    updatePlayBtn();
                }).catch(error => {
                    if (error.name !== 'AbortError') {
                        console.error(" Play error:", error);
                    }
                });
            } else {
                isPlaying = true;
                updatePlayBtn();
            }
        }

        function playPrevious() {
            // Logic: Check History > 5s? -> Else Prev in list
            if(audio.currentTime > 3) {
                audio.currentTime = 0;
                return;
            }

            if(playHistory.length > 0) {
                const prevSong = playHistory.pop();
                playSpecificSong(prevSong.id);
                return;
            }

            currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            loadSong(songs[currentSongIndex]); 
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    updatePlayBtn();
                }).catch(error => {
                    if (error.name !== 'AbortError') {
                        console.error(" Play error:", error);
                    }
                });
            } else {
                isPlaying = true;
                updatePlayBtn();
            }
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3; // 0: Off, 1: All, 2: One
            const btn = document.getElementById('repeat-btn');
            const icon = btn.querySelector('i');
            
            icon.className = 'ph ph-repeat'; // Reset base class
            
            if(repeatMode === 0) {
                btn.classList.remove('active');
            } else if (repeatMode === 1) {
                btn.classList.add('active');
                // Add a small dot or text if needed, but color change is fine
            } else {
                btn.classList.add('active');
                icon.className = 'ph ph-repeat-once'; // Ideally a specific icon, but we reuse here
                // Or we can modify content to "1"
            }
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffle-btn');
            if(isShuffle) btn.classList.add('active');
            else btn.classList.remove('active');
            // Implementation of shuffle logic is complex with current array structure, 
            // toggling state is enough for UI requirements.
        }

        audio.addEventListener('ended', () => {
            document.getElementById('next-btn').click();
        });

        playPauseBtn.addEventListener('click', () => {
            // Perbaikan: Cek apakah audio punya source yang valid sebelum play
            if (!audio.src || audio.src === window.location.href) {
                console.warn(" Audio source is empty, cannot play.");
                return; 
            }

            // Perbaikan: Handle Promise play() untuk menangkap error NotSupportedError
            if (isPlaying) { 
                audio.pause(); 
                isPlaying = false; 
                updatePlayBtn();
            } else { 
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Playback started successfully
                        isPlaying = true;
                        updatePlayBtn();
                    })
                    .catch(error => {
                        // Handle AbortError (interrupted by pause or source change)
                        if (error.name === 'AbortError') {
                            console.log(" Play was interrupted");
                            isPlaying = false;
                        } else {
                            console.error(" Audio Play Error:", error);
                            // Jika error karena source tidak valid/kosong
                            isPlaying = false;
                        }
                        updatePlayBtn();
                    });
                }
            }
            
            // --- FIX ANIMATION PAUSE/RUN ---
            const state = isPlaying ? 'running' : 'paused';
            document.querySelectorAll('.playing-icon-container').forEach(el => {
                el.style.animationPlayState = state;
            });
            
            // Broadcast to Listen Together if Host
            if(listenTogetherSession.active && listenTogetherSession.isHost) {
                broadcastState();
            }
        });

        function updatePlayBtn() {
            const overlayIcon = document.querySelector('#overlay-play-pause-btn i');
            if(isPlaying) { 
                playPauseIcon.classList.remove('ph-play'); 
                playPauseIcon.classList.add('ph-pause'); 
                if(overlayIcon) { overlayIcon.classList.remove('ph-play'); overlayIcon.classList.add('ph-pause'); }
            } else { 
                playPauseIcon.classList.remove('ph-pause'); 
                playPauseIcon.classList.add('ph-play'); 
                if(overlayIcon) { overlayIcon.classList.remove('ph-pause'); overlayIcon.classList.add('ph-play'); }
            }

            // Sync visualizer animation state for currently playing rows
            const state = isPlaying ? 'running' : 'paused';
            document.querySelectorAll('.song-row.playing .playing-icon-container').forEach(el => {
                el.style.animationPlayState = state;
                // ensure visibility matches playing state
                el.style.display = isPlaying ? 'flex' : 'none';
            });
        }

        document.getElementById('prev-btn').addEventListener('click', playPrevious);
        document.getElementById('next-btn').addEventListener('click', playNext);
        document.getElementById('repeat-btn').addEventListener('click', toggleRepeat);
        document.getElementById('shuffle-btn').addEventListener('click', toggleShuffle);

        // Desktop: toggle play/pause with Space (ignore when typing in inputs)
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' || e.key === ' ') {
                // Ignore on mobile devices / small screens
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
                if (isMobile) return;

                const ae = document.activeElement;
                const tag = ae && ae.tagName && ae.tagName.toLowerCase();
                if (tag === 'input' || tag === 'textarea' || (ae && ae.isContentEditable)) return;
                e.preventDefault();
                const btn = document.getElementById('play-pause-btn');
                if (btn) btn.click();
            }
        });

        // Export ke window agar bisa dipanggil dari HTML onclick
window.playNext = playNext;
window.playPrevious = playPrevious;
window.toggleRepeat = toggleRepeat;
window.toggleShuffle = toggleShuffle;

        audio.addEventListener('timeupdate', (e) => {
            const { duration, currentTime } = e.srcElement;
            if (isNaN(duration)) return;
            const pct = (currentTime / duration) * 100;
            
            // Footer Player
            document.getElementById('progress-fill').style.width = `${pct}%`;
            
            const fmt = t => {
                const m = Math.floor(t/60);
                const s = Math.floor(t%60);
                return `${m}:${s<10?'0'+s:s}`;
            };
            document.getElementById('current-time').innerText = fmt(currentTime);
            document.getElementById('total-duration').innerText = fmt(duration);
            
            // Overlay Player Sync
            const overlayFill = document.getElementById('overlay-progress-fill');
            if(overlayFill) {
                overlayFill.style.width = `${pct}%`;
                document.getElementById('overlay-current-time').innerText = fmt(currentTime);
                document.getElementById('overlay-total-duration').innerText = fmt(duration);
            }
        });

        document.getElementById('progress-container').addEventListener('click', (e) => {
            const w = e.currentTarget.clientWidth;
            const x = e.offsetX;
            audio.currentTime = (x / w) * audio.duration;
        });

        const volContainer = document.getElementById('volume-container');
        const volFill = document.getElementById('volume-fill');
        const volIcon = document.getElementById('vol-icon');
        audio.volume = 0.7; 

        volContainer.addEventListener('click', (e) => {
            const rect = volContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            let vol = Math.max(0, Math.min(1, x / width));
            audio.volume = vol;
            volFill.style.width = `${vol * 100}%`;
            
            volIcon.classList.remove('ph-speaker-high', 'ph-speaker-low', 'ph-speaker-slash');
            if (vol === 0) volIcon.classList.add('ph-speaker-slash');
            else if (vol < 0.5) volIcon.classList.add('ph-speaker-low');
            else volIcon.classList.add('ph-speaker-high');
        });





// Deteksi Mobile Device
const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

if (isMobileDevice) {
    // === MODE MOBILE: GUNAKAN KONTROL VOLUME HP ===
    audio.volume = 1.0; // Set ke max, biar kontrol HP yang atur
    volContainer.style.display = 'none'; // Sembunyikan slider custom
    volIcon.style.display = 'none'; // Sembunyikan ikon volume juga
    
    // Listener untuk perubahan volume dari HP
    audio.addEventListener('volumechange', () => {
        // Sinkronisasi jika ada perubahan dari kontrol HP
        console.log('Volume HP:', audio.volume);
    });
} else {
    // === MODE DESKTOP: GUNAKAN SLIDER CUSTOM ===
    audio.volume = 0.7; // Default 70%
    volFill.style.width = '70%';
    
    volContainer.addEventListener('click', (e) => {
        const rect = volContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const width = rect.width;
        let vol = Math.max(0, Math.min(1, x / width));
        audio.volume = vol;
        volFill.style.width = `${vol * 100}%`;
        
        // Update icon berdasarkan volume
        volIcon.classList.remove('ph-speaker-high', 'ph-speaker-low', 'ph-speaker-slash');
        if (vol === 0) volIcon.classList.add('ph-speaker-slash');
        else if (vol < 0.5) volIcon.classList.add('ph-speaker-low');
        else volIcon.classList.add('ph-speaker-high');
    });
}

// === DISABLE LISTEN TOGETHER KHUSUS DESKTOP ===
if(window.innerWidth > 768) {
    // Hide overlay immediately
    const ltOverlay = document.getElementById('listen-together-overlay');
    if(ltOverlay) {
        ltOverlay.style.display = 'none !important';
        ltOverlay.style.visibility = 'hidden';
        ltOverlay.style.position = 'fixed';
        ltOverlay.style.width = '0';
        ltOverlay.style.height = '0';
    }
    
    // Hide button immediately
    const ltBtn = document.getElementById('btn-open-listen-together');
    if(ltBtn) {
        ltBtn.style.display = 'none !important';
        ltBtn.style.visibility = 'hidden';
        ltBtn.style.width = '0';
        ltBtn.style.height = '0';
    }
    
    // Hide session badge immediately
    const sessionBadge = document.getElementById('session-badge');
    if(sessionBadge) {
        sessionBadge.style.display = 'none !important';
        sessionBadge.style.visibility = 'hidden';
        sessionBadge.style.width = '0';
        sessionBadge.style.height = '0';
    }
}

// === LISTEN TOGETHER STATE ===
let listenTogetherSession = {
    active: false,
    isHost: false,
    sessionCode: null,
    participants: []
};

// === OPEN LISTEN TOGETHER (PERBAIKAN: NO REGENERATE) ===
window.openListenTogether = function() {
    // Disable completely on desktop
    if(window.innerWidth > 768) {
        return;
    }
    
    try {
        console.log('Open Listen Together Clicked');
        const overlay = document.getElementById('listen-together-overlay');
        
        if(!overlay) {
            alert('Error: Overlay element not found!');
            return;
        }

        // Show overlay using classList
        overlay.classList.add('active');

        // Reset sections
        const modeSec = document.getElementById('lt-mode-section');
        const hostSec = document.getElementById('lt-host-section');
        const joinSec = document.getElementById('lt-join-section');

        // Default state: Show Mode, Hide others
        if(modeSec) modeSec.classList.remove('hidden');
        if(hostSec) hostSec.classList.add('hidden');
        if(joinSec) joinSec.classList.add('hidden');

        // Safety check for session object
        if(typeof listenTogetherSession === 'undefined') {
            console.warn('listenTogetherSession undefined, initializing...');
            window.listenTogetherSession = { active: false, isHost: false, sessionCode: null, participants: [] };
        }

        if(listenTogetherSession.active) {
            // JIKA SUDAH ADA SESI
            if(modeSec) modeSec.classList.add('hidden'); // Hide mode selection
            
            if(listenTogetherSession.isHost) {
                if(hostSec) hostSec.classList.remove('hidden');
                const codeEl = document.getElementById('lt-session-code');
                if(codeEl) codeEl.innerText = listenTogetherSession.sessionCode;
            } else {
                // Guest: Show Join/Mode options
                if(modeSec) modeSec.classList.remove('hidden');
                if(joinSec) joinSec.classList.remove('hidden');
            }
        }
    } catch (e) {
        console.error('Error opening Listen Together:', e);
        alert('Terjadi kesalahan: ' + e.message);
    }
};

window.closeListenTogether = function() {
    const overlay = document.getElementById('listen-together-overlay');
    if(overlay) {
        overlay.classList.remove('active');
    }
};

// === SELECT MODE ===
window.selectLTMode = function(mode) {
    document.getElementById('lt-mode-section').classList.add('hidden');
    document.getElementById('lt-host-section').classList.remove('hidden');
    document.getElementById('lt-join-section').classList.remove('hidden');
    
    if(mode === 'host') {
        document.getElementById('lt-join-section').classList.add('hidden');
        startHostSession();
    } else {
        document.getElementById('lt-host-section').classList.add('hidden');
    }
};

// === START HOST SESSION (PERBAIKAN LOGIC) ===
function startHostSession() {
    // Cek apakah sudah ada sesi aktif? Kalau iya, jangan generate code baru
    if(listenTogetherSession.active && listenTogetherSession.isHost) {
        document.getElementById('lt-host-section').classList.remove('hidden');
        document.getElementById('lt-session-code').innerText = listenTogetherSession.sessionCode;
        return;
    }

    const code = generateSessionCode();
    listenTogetherSession.sessionCode = code;
    listenTogetherSession.isHost = true;
    listenTogetherSession.active = true;
    
    document.getElementById('lt-session-code').innerText = code;
    document.getElementById('lt-host-section').classList.remove('hidden');
    
    // Save to Firebase
    set(ref(db, `sessions/${code}`), {
        host: auth.currentUser.uid,
        hostName: currentUserData.username,
        hostPic: currentUserData.profile_picture,
        currentSong: songs[currentSongIndex].id,
        currentTime: audio.currentTime,
        isPlaying: isPlaying,
        timestamp: Date.now(),
        participants: {
            [auth.currentUser.uid]: {
                name: currentUserData.username,
                pic: currentUserData.profile_picture,
                role: 'host'
            }
        }
    });
    
    // Listen for participants
    listenToParticipants(code);
    
    // Show badge
    document.getElementById('session-badge').classList.add('active');
    document.getElementById('session-badge-text').innerText = `Session: ${code}`;
}

// === JOIN SESSION ===
window.joinListenTogether = async function() {
    const code = document.getElementById('lt-join-code').value.toUpperCase().trim();
    if(code.length !== 4) {
        alert("Kode harus 4 karakter!");
        return;
    }
    
    // Check if session exists
    const sessionSnap = await get(ref(db, `sessions/${code}`));
    if(!sessionSnap.exists()) {
        alert("Session tidak ditemukan!");
        return;
    }
    
    listenTogetherSession.sessionCode = code;
    listenTogetherSession.isHost = false;
    listenTogetherSession.active = true;
    
    // Add self to participants
    update(ref(db, `sessions/${code}/participants/${auth.currentUser.uid}`), {
        name: currentUserData.username,
        pic: currentUserData.profile_picture,
        role: 'guest'
    });
    
    // Sync with host
    syncWithSession(code);
    
    document.getElementById('session-badge').classList.add('active');
    document.getElementById('session-badge-text').innerText = `Joined: ${code}`;
    
    closeListenTogether();
};

// === SYNC WITH SESSION (FIXED: SINKRONISASI LAGU) ===
function syncWithSession(code) {
    onValue(ref(db, `sessions/${code}`), (snap) => {
        const session = snap.val();
        if(!session) {
            endListenTogether();
            return;
        }
        
        // Sync playback HANYA JIKA GUEST
        if(!listenTogetherSession.isHost) {
            const songId = session.currentSong;
            const time = session.currentTime;
            const playing = session.isPlaying;
            
            // Cari index lagu
            const idx = songs.findIndex(s => s.id == songId);
            
            // Jika lagunya beda, ganti lagu
            if(idx !== -1 && idx !== currentSongIndex) {
                 loadSong(songs[idx]);
                 currentSongIndex = idx;
                 // Putar dulu untuk memuat buffer, lalu seek
                 audio.play().then(() => {
                     audio.currentTime = time;
                     if(!playing) audio.pause();
                     // Update UI Play/Pause
                     isPlaying = playing;
                     updatePlayBtn();
                     
                     // Update Visualizer
                     const state = isPlaying ? 'running' : 'paused';
                     document.querySelectorAll('.playing-icon-container').forEach(el => {
                        el.style.animationPlayState = state;
                    });
                 });
            } else if (Math.abs(audio.currentTime - time) > 2) {
                // Jika lagu sama tapi beda waktu (drift > 2 detik)
                audio.currentTime = time;
            }
            
            // Sinkronisasi Play/Pause
            if(playing && audio.paused) {
                audio.play();
                isPlaying = true;
                updatePlayBtn();
                document.querySelectorAll('.playing-icon-container').forEach(el => el.style.animationPlayState = 'running');
            } else if(!playing && !audio.paused) {
                audio.pause();
                isPlaying = false;
                updatePlayBtn();
                document.querySelectorAll('.playing-icon-container').forEach(el => el.style.animationPlayState = 'paused');
            }
        }
    });
}

// === BROADCAST STATE (HOST) ===
function broadcastState() {
    if(!listenTogetherSession.active || !listenTogetherSession.isHost) return;
    
    update(ref(db, `sessions/${listenTogetherSession.sessionCode}`), {
        currentSong: songs[currentSongIndex].id,
        currentTime: audio.currentTime,
        isPlaying: isPlaying,
        timestamp: Date.now()
    });
}

// Hook into audio events untuk auto-broadcast saat lagu berakhir/next
if(listenTogetherSession.active && listenTogetherSession.isHost) {
    // Broadcast saat seek (opsional, bisa berat jika tiap frame)
    // Kita broadcast saat Play/Pause/Skip saja sudah cukup.
}

// === LISTEN TO PARTICIPANTS ===
function listenToParticipants(code) {
    onValue(ref(db, `sessions/${code}/participants`), (snap) => {
        const participants = snap.val() || {};
        const list = document.getElementById('lt-participants-list');
        
        let html = '';
        Object.keys(participants).forEach(uid => {
            const p = participants[uid];
            html += `
                <div class="lt-participant">
                    <img src="${p.pic}" alt="${p.name}">
                    <span>${p.name}</span>
                    ${p.role === 'host' ? '<span class="lt-host-badge">HOST</span>' : ''}
                </div>
            `;
        });
        
        list.innerHTML = html || '<p style="color:#666; text-align:center;">' + window.t('waiting') + '</p>';
    });
}

// === END SESSION ===
window.endListenTogether = function() {
    if(listenTogetherSession.isHost) {
        // Remove from Firebase
        remove(ref(db, `sessions/${listenTogetherSession.sessionCode}`));
    } else {
        // Remove self from participants
        remove(ref(db, `sessions/${listenTogetherSession.sessionCode}/participants/${auth.currentUser.uid}`));
    }
    
    listenTogetherSession = { active: false, isHost: false, sessionCode: null, participants: [] };
    document.getElementById('session-badge').classList.remove('active');
    closeListenTogether();
    
    // Reset UI
    document.getElementById('lt-mode-section').classList.remove('hidden');
    document.getElementById('lt-host-section').classList.add('hidden');
    document.getElementById('lt-join-section').classList.add('hidden');
};

// === COPY SESSION CODE ===
window.copySessionCode = function() {
    const code = document.getElementById('lt-session-code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        alert(`Kode ${code} disalin!`);
    });
};

// === GENERATE SESSION CODE ===
function generateSessionCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for(let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

// ===== GLOBAL VARIABLES FOR IMPORT =====
let selectedMusicFile = null;
let selectedCoverFile = null;
let importedSongsStartId = 10000;

// ===== IMPORT MUSIC FUNCTIONS =====

window.openImportMusicModal = function() {
    document.getElementById('import-music-modal').classList.add('open');
    // Reset form
    selectedMusicFile = null;
    selectedCoverFile = null;
    document.getElementById('import-file-name').innerText = window.t('no-file-selected');
    document.getElementById('import-file-size').innerText = 'Pilih file MP3';
    document.getElementById('import-song-title').value = '';
    document.getElementById('import-song-artist').value = '';
    document.getElementById('import-song-album').value = '';
    document.getElementById('import-privacy-toggle').checked = false;
    document.getElementById('import-cover-preview').src = 'https://picsum.photos/seed/default/100/100';
    document.getElementById('import-file-preview').classList.remove('active');
    updatePrivacyLabel(document.getElementById('import-privacy-toggle'));
};

window.handleMusicFileSelect = function(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate MP3
        if (!file.type.match('audio/mpeg') && !file.type.match('audio/mp3')) {
            showToast(' Hanya file MP3 yang didukung!', 'error');
            return;
        }

        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showToast(' Ukuran file maksimal 10MB!', 'error');
            return;
        }

        selectedMusicFile = file;
        document.getElementById('import-file-name').innerText = file.name;
        document.getElementById('import-file-size').innerText = formatFileSize(file.size);
        document.getElementById('import-file-preview').classList.add('active');

        // Auto-fill title from filename
        const filename = file.name.replace('.mp3', '').replace('.MP3', '');
        if (!document.getElementById('import-song-title').value) {
            document.getElementById('import-song-title').value = filename;
        }
    }
};

window.handleCoverFileSelect = function(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate image
        if (!file.type.match('image.*')) {
            showToast(' Hanya file gambar yang didukung!', 'error');
            return;
        }

        selectedCoverFile = file;
        
        // Preview cover
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('import-cover-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        showToast(' Foto cover berhasil dipilih!', 'success');
    }
};

window.updatePrivacyLabel = function(checkbox) {
    const icon = document.getElementById('privacy-icon');
    const label = document.getElementById('privacy-label');
    const desc = label.nextElementSibling;
    
    if (checkbox.checked) {
        icon.className = 'ph ph-globe';
        label.innerText = 'Publik';
        desc.innerText = 'Semua orang bisa mendengarkan';
    } else {
        icon.className = 'ph ph-lock-key';
        label.innerText = 'Privat';
        desc.innerText = 'Hanya Anda yang bisa mendengarkan';
    }
};

window.submitImportMusic = async function() {
    if (!auth.currentUser) {
        showToast(' Anda harus login terlebih dahulu!', 'error');
        return;
    }

    if (!selectedMusicFile) {
        showToast(' Pilih file MP3 terlebih dahulu!', 'error');
        return;
    }

    const title = document.getElementById('import-song-title').value.trim();
    const artist = document.getElementById('import-song-artist').value.trim();
    const album = document.getElementById('import-song-album').value.trim() || 'Single';
    const isPublic = document.getElementById('import-privacy-toggle').checked;

    if (!title || !artist) {
        showToast(' Nama lagu dan penyanyi harus diisi!', 'error');
        return;
    }

    try {
        showToast(' Memproses musik... Mohon tunggu', 'info');

        const userId = auth.currentUser.uid;
        const songId = 10000 + Date.now();

        // Get audio duration
        const audioDuration = await getAudioDuration(selectedMusicFile);

        // Create data URL for music (base64)
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        let musicUrl = `data:audio/mpeg;base64,${await fileToBase64(selectedMusicFile)}`;
        
        // If file is too large for data URL, use Object URL
        if (selectedMusicFile.size > 5 * 1024 * 1024) {
            musicUrl = URL.createObjectURL(selectedMusicFile);
            console.warn(' Using Object URL (temporary) for large file');
        }

        // Cover URL - use placeholder
        let coverUrl = `https://picsum.photos/seed/${songId}/300/300`;

        // Save to Firebase only
        console.log(' Saving to Firebase...');
        showToast(' Menyimpan metadata lagu...', 'info');
        
        const songData = {
            id: songId,
            title: title,
            artist: artist,
            album: album,
            duration: audioDuration || '3:30',
            cover: coverUrl,
            src: musicUrl,
            uploadedBy: userId,
            uploaderName: currentUserData?.username || 'Unknown',
            isPublic: isPublic,
            timestamp: Date.now(),
            storage: 'firebase'
        };

        console.log(' songData saved');
        
        try {
            await set(ref(db, `importedSongs/${userId}/${songId}`), songData);
            console.log(' importedSongs saved');
        } catch (dbErr) {
            console.error(' Failed to write importedSongs:', dbErr);
            showToast(' Gagal menyimpan metadata: ' + (dbErr.message || dbErr), 'error');
            throw dbErr;
        }

        if (isPublic) {
            try {
                await set(ref(db, `publicImportedSongs/${songId}`), songData);
                console.log(' publicImportedSongs saved');
            } catch (pubErr) {
                console.error(' Failed to write publicImportedSongs:', pubErr);
            }
        }

        // Add to local songs array
        if (!songs.find(s => s.id === songId)) {
            songs.push(songData);
        }
        
        showToast(' Musik berhasil diimpor!', 'success');
        closeModal('import-music-modal');
        renderTrending();

    } catch (error) {
        console.error(' Error:', error);
        showToast(' Gagal mengimpor musik: ' + (error?.message || error), 'error');
    }
};


// Helper: Convert file to Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            console.log('FileReader loaded, data length:', reader.result.length);
            resolve(reader.result);
        };
        reader.onerror = (error) => {
            console.error('FileReader error:', error);
            reject(error);
        };
        reader.readAsDataURL(file);
    });
}

// Helper function: Get audio duration
async function getAudioDuration(file) {
    return new Promise((resolve) => {
        const audio = new Audio();
        audio.onloadedmetadata = () => {
            const minutes = Math.floor(audio.duration / 60);
            const seconds = Math.floor(audio.duration % 60);
            resolve(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);
        };
        audio.onerror = () => resolve('3:30'); // Default if failed
        audio.src = URL.createObjectURL(file);
    });
}

// Helper function: Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function loadImportedSongs() {
    if (!auth.currentUser) {
        console.log(' No user logged in, skipping import load');
        return;
    }

    const userId = auth.currentUser.uid;

    try {
        console.log(' Loading imported songs for user:', userId);
        
        //  Load user's own imported songs (PUBLIK + PRIVAT)
        const userSongsSnap = await get(ref(db, `importedSongs/${userId}`));
        if (userSongsSnap.exists()) {
            const userSongs = Object.values(userSongsSnap.val());
            console.log(' User songs loaded:', userSongs.length);
            
            userSongs.forEach(song => {
                if (!songs.find(s => s.id === song.id)) {
                    songs.push(song);
                    console.log('   Added own song:', song.title);
                }
            });
        }

        //  Load public songs dari SEMUA user (kecuali milik sendiri)
        const publicSongsSnap = await get(ref(db, 'publicImportedSongs'));
        if (publicSongsSnap.exists()) {
            const publicSongs = Object.values(publicSongsSnap.val())
                .filter(song => song.uploadedBy !== userId); // Kecuali punya sendiri
            
            console.log(' Public songs from others:', publicSongs.length);
            
            publicSongs.forEach(song => {
                if (!songs.find(s => s.id === song.id)) {
                    songs.push(song);
                    console.log('   Added public song:', song.title, 'by', song.uploaderName);
                }
            });
        }

        console.log(' Total songs in library:', songs.length);

    } catch (error) {
        console.error(' Error loading imported songs:', error);
    }
}



        // --- INITIALIZATION ---
        renderTrending();
        renderPopularBands();
        renderPopularArtists();
        renderForeignSoloArtists();
        renderForeignBands();
        loadSong(songs[0]);

        //  TAMBAHKAN: Load imported songs saat user login
onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log(' User logged in:', user.email);
        
        //  DETACH old listener first
        if (activeListeners.user) {
            activeListeners.user();
            activeListeners.user = null;
        }
        
        const userRef = ref(db, 'users/' + user.uid);
        
        //  Store the unsubscribe function
        activeListeners.user = onValue(userRef, async (snapshot) => {
            const data = snapshot.val();
            if (data) {
                currentUserData = data;
                likedSongs = data.likedSongs || [];
                
                // Render UI
                renderSidebarPlaylists();
                renderTrending();
                await loadPublicPlaylists();
                await loadImportedSongs();
                
                console.log(' User data updated');
            }
        }, (error) => {
            console.error(' User data listener error:', error);
            if (error.code === 'PERMISSION_DENIED') {
                showToast(' Database quota exceeded. Please try again later.', 'error');
                detachAllListeners(); // Stop all listeners to save quota
            }
        });
        
        // ... rest of code
    } else {
        console.log(' User logged out');
        detachAllListeners(); //  Cleanup on logout
        currentUserData = null;
    }
});

//  FUNGSI BARU: Listen perubahan lagu publik secara real-time
function setupPublicSongsListener() {
    const publicSongsRef = ref(db, 'publicImportedSongs');
    
    onValue(publicSongsRef, (snapshot) => {
        const publicSongs = snapshot.val();
        if (!publicSongs) return;
        
        Object.values(publicSongs).forEach(song => {
            // Skip lagu sendiri & lagu yang sudah ada
            if (song.uploadedBy === auth.currentUser.uid) return;
            if (songs.find(s => s.id === song.id)) return;
            
            // Tambahkan lagu publik baru
            songs.push(song);
            console.log(' New public song added:', song.title, 'by', song.uploaderName);
        });
    });
}





// ===== REGISTER SERVICE WORKER =====
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => {
            console.log(' Service Worker Registered:', reg);
        })
        .catch(err => {
            console.error(' Service Worker Registration Failed:', err);
        });
}

        // ===== MEDIA SESSION API (UNTUK NOTIFIKASI MUSIK) =====
        if ('mediaSession' in navigator) {
            const audio = document.getElementById('audio-player');
            
            // Setup controls di notifikasi (Play/Pause/Next/Previous)
            navigator.mediaSession.setActionHandler('play', () => {
                audio.play();
                isPlaying = true;
                updatePlayBtn();
            });
            
            navigator.mediaSession.setActionHandler('pause', () => {
                audio.pause();
                isPlaying = false;
                updatePlayBtn();
            });
            
            navigator.mediaSession.setActionHandler('nexttrack', () => {
                window.playNext();
            });
            
            navigator.mediaSession.setActionHandler('previoustrack', () => {
                window.playPrevious();
            });
            
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                audio.currentTime = Math.max(audio.currentTime - 10, 0);
            });
            
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                audio.currentTime = Math.min(audio.currentTime + 10, audio.duration);
            });
            
            // Update metadata lagu di notifikasi
            audio.addEventListener('loadedmetadata', () => {
                const song = songs[currentSongIndex];
                if (song && navigator.mediaSession) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title || 'Pilih Lagu',
                        artist: song.artist || 'Vidje',
                        album: song.album || 'Music Platform',
                        artwork: [
                            { src: song.cover, sizes: '96x96', type: 'image/png' },
                            { src: song.cover, sizes: '128x128', type: 'image/png' },
                            { src: song.cover, sizes: '192x192', type: 'image/png' },
                            { src: song.cover, sizes: '256x256', type: 'image/png' },
                            { src: song.cover, sizes: '384x384', type: 'image/png' },
                            { src: song.cover, sizes: '512x512', type: 'image/png' }
                        ]
                    });
                    
                    // Set playback state
                    navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
                }
            });
            
            // Update playback state saat play/pause
            audio.addEventListener('play', () => {
                if (navigator.mediaSession) {
                    navigator.mediaSession.playbackState = 'playing';
                }
            });
            
            audio.addEventListener('pause', () => {
                if (navigator.mediaSession) {
                    navigator.mediaSession.playbackState = 'paused';
                }
            });
            
            // Update position state (untuk seek bar di notifikasi)
            audio.addEventListener('timeupdate', () => {
                if ('setPositionState' in navigator.mediaSession && !isNaN(audio.duration)) {
                    navigator.mediaSession.setPositionState({
                        duration: audio.duration,
                        playbackRate: audio.playbackRate,
                        position: audio.currentTime
                    });
                }
            });
        }
        
        // ===== PWA INSTALL PROMPT =====
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log(' PWA Install Prompt Available');
            e.preventDefault();
            deferredPrompt = e;

            // Create install button
            const btn = document.createElement('button');
            btn.id = 'pwa-install-btn';
            btn.innerHTML = ' Download App';
            btn.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 99999;
                padding: 12px 20px;
                background: #e50914;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;

            btn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const choice = await deferredPrompt.userChoice;
                    console.log('Installation choice:', choice.outcome);
                    deferredPrompt = null;
                    btn.remove();
                }
            };

            document.body.appendChild(btn);
            console.log(' Install button added to page');
        });

        window.addEventListener('appinstalled', () => {
            console.log(' App installed successfully!');
            deferredPrompt = null;
        });

        // Tambahkan fungsi-fungsi ini di bagian JavaScript (sebelum closing script tag)

// SHARE CURRENT PLAYLIST
window.shareCurrentPlaylist = function() {
    if(!currentPlaylistId) {
        showToast(' ' + window.t('no-active-playlist'), 'error');
        return;
    }
    window.openShareModal('playlist', currentPlaylistId);
};

// OPEN PLAYLIST SETTINGS
window.openPlaylistSettings = function() {
    if(!currentPlaylistId || !currentUserData || !currentUserData.playlists) {
        showToast(' Tidak dapat membuka pengaturan', 'error');
        return;
    }
    
    const playlist = currentUserData.playlists[currentPlaylistId];
    if(!playlist) {
        showToast(' Playlist tidak ditemukan', 'error');
        return;
    }
    
    // Set current values
    document.getElementById('settings-playlist-name').value = playlist.name;
    document.getElementById('settings-cover-preview').src = playlist.cover;
    
    // Open modal
    document.getElementById('playlist-settings-modal').classList.add('open');
};

// HANDLE COVER UPLOAD IN SETTINGS
window.handleSettingsCoverUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('settings-cover-preview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// SAVE PLAYLIST SETTINGS
window.savePlaylistSettings = function() {
    if(!currentPlaylistId || !auth.currentUser) {
        showToast(' Gagal menyimpan', 'error');
        return;
    }
    
    const newName = document.getElementById('settings-playlist-name').value.trim();
    const newCover = document.getElementById('settings-cover-preview').src;
    
    if(!newName) {
        showToast(' Nama playlist tidak boleh kosong', 'error');
        return;
    }
    
    // Update to Firebase
    update(ref(db, `users/${auth.currentUser.uid}/playlists/${currentPlaylistId}`), {
        name: newName,
        cover: newCover
    }).then(() => {
        showToast(' Playlist berhasil diperbarui!', 'success');
        
        // Update UI immediately
        document.getElementById('playlist-title-view').innerText = newName;
        document.getElementById('playlist-cover-view').src = newCover;
        
        // Update background gradient
        const coverEl = document.getElementById('playlist-cover-view');
        coverEl.onload = function() {
            const rgb = getAverageRGB(coverEl);
            const color = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            document.getElementById('playlist-header-bg').style.background = `linear-gradient(180deg, ${color} 0%, var(--bg-dark) 100%)`;
        };
        
        // Close modal
        closeModal('playlist-settings-modal');
        
        // Reload sidebar to reflect changes
        setTimeout(() => {
            if(currentUserData && currentUserData.playlists) {
                renderSidebarPlaylists(currentUserData.playlists);
            }
        }, 300);
    }).catch(error => {
        console.error('Error updating playlist:', error);
        showToast(' Gagal menyimpan perubahan', 'error');
    });
};

// === FINAL SAFEGUARD: SETUP LISTEN TOGETHER LISTENER ===
// Pastikan listener terpasang meskipun onclick inline gagal
document.addEventListener('DOMContentLoaded', function() {
    console.log(' DOMContentLoaded: Setting up Listen Together button...');
    const ltBtn = document.getElementById('btn-open-listen-together');
    
    if (ltBtn) {
        console.log(' Button Listen Together ditemukan!');
        ltBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log(' Tombol Dengar Bareng diklik (Event Listener)!');
            if (typeof window.openListenTogether === 'function') {
                window.openListenTogether();
            } else {
                alert('CRITICAL ERROR: Fungsi openListenTogether belum dimuat!');
            }
        });
    } else {
        console.error(' Button Listen Together TIDAK DITEMUKAN');
    }
});

// ===== DIAGNOSTIC TOOLS =====
async function checkBucketAccess() {
    console.log(" Checking Supabase bucket access...");
    // Try to access a known public file (album cover)
    const { data } = supabase.storage.from('vidje').getPublicUrl('albumphoto/afgan.png');
    
    try {
        const response = await fetch(data.publicUrl, { method: 'HEAD' });
        console.log(` Bucket Check: ${data.publicUrl} -> Status: ${response.status}`);
        
        if (response.status === 403 || response.status === 400) {
            console.error(" ACCESS DENIED! Supabase Read Policy is missing.");
            alert(" PERHATIAN: Lagu dan Gambar tidak muncul karena Policy 'SELECT' belum aktif di Supabase.\n\nSilakan jalankan perintah SQL 'CREATE POLICY... FOR SELECT' di Supabase Dashboard.");
        } else if (response.status === 404) {
             console.warn(" File check 404 (Mungkin file belum ada, tapi akses publik mungkin OK)");
        } else if (response.status === 200) {
            console.log(" Bucket public access is OK.");
        }
    } catch (e) {
        console.error(" Network check failed:", e);
    }
}

// ===== LOAD SONGS FROM SUPABASE STORAGE (AUTO-DETECT ALL FOLDERS) =====
async function loadSongsFromSupabase() {
    try {
        console.log(' Loading songs from Supabase storage...');
        
        // Step 1: List all folders in vidje bucket
        const { data: folders, error: folderError } = await supabase.storage
            .from('vidje')
            .list('', {
                limit: 100,
                offset: 0
            });

        if (folderError) {
            console.error(' Error listing folders:', folderError);
            return 0;
        }

        console.log(' Found folders:', folders.map(f => f.name).join(', '));

        let loadedCount = 0;
        let currentId = 20000; // Start ID for Supabase songs

        // Step 2: Loop through each folder
        for (const folder of folders) {
            // Skip if it's a file (not a folder)
            if (!folder.id || folder.name.includes('.')) continue;
            
            const folderName = folder.name;
            
            // Skip non-music folders
            if (folderName === 'album photo' || folderName === 'albumphoto' || folderName === 'songs') {
                console.log(` Skipping: ${folderName}`);
                continue;
            }

            console.log(` Processing folder: ${folderName}`);
            
            // Step 3: List all files in this folder
            const { data: musicFiles, error: musicError } = await supabase.storage
                .from('vidje')
                .list(folderName, {
                    limit: 100,
                    offset: 0,
                    sortBy: { column: 'name', order: 'asc' }
                });

            if (musicError) {
                console.error(` Error listing ${folderName}:`, musicError);
                continue;
            }

            if (!musicFiles || musicFiles.length === 0) {
                console.log(` No files in ${folderName}`);
                continue;
            }

            // Step 4: Detect artist name from folder
            const artistName = detectArtistName(folderName);
            
            // Step 5: Get default cover for this artist
            const defaultCover = getDefaultCover(folderName);

            // Step 6: Process each MP3 file
            for (const file of musicFiles) {
                if (!file.name.endsWith('.mp3') && !file.name.endsWith('.MP3')) continue;

                const songId = currentId++;
                
                // Get public URL for music
                const { data: musicUrl } = supabase.storage
                    .from('vidje')
                    .getPublicUrl(`${folderName}/${file.name}`);

                // Extract song title from filename
                const songTitle = cleanSongTitle(file.name);

                // Check for corresponding cover image
                let coverUrl = defaultCover;
                
                const coverFileName = file.name.replace(/\.mp3$/i, '.jpg');
                const { data: coverCheck } = await supabase.storage
                    .from('vidje')
                    .list(folderName);

                if (coverCheck && coverCheck.find(f => f.name.toLowerCase() === coverFileName.toLowerCase())) {
                    const { data: coverUrlData } = supabase.storage
                        .from('vidje')
                        .getPublicUrl(`${folderName}/${coverFileName}`);
                    coverUrl = coverUrlData.publicUrl;
                }

                // Create song object
                const songData = {
                    id: songId,
                    title: songTitle,
                    artist: artistName,
                    album: 'Studio Albums',
                    duration: '3:30',
                    cover: coverUrl,
                    src: musicUrl.publicUrl,
                    storage: 'supabase',
                    isPublic: true
                };

                // Add to songs array if not exists
                if (!songs.find(s => s.src === musicUrl.publicUrl)) {
                    songs.push(songData);
                    loadedCount++;
                    console.log(`   ${songTitle}`);
                }
            }
        }

        console.log(` Successfully loaded ${loadedCount} songs from Supabase!`);
        console.log(` Total songs in library: ${songs.length}`);
        
        return loadedCount;

    } catch (error) {
        console.error(' Error loading songs from Supabase:', error);
        return 0;
    }
}

// Helper: Detect artist name from folder name
function detectArtistName(folderName) {
    const artistMap = {
        'afgan': 'Afgan',
        'astrid': 'Astrid',
        'brunomars': 'Bruno Mars',
        'coldplay': 'Coldplay',
        'danielcaesar': 'Daniel Caesar',
        'edsheeran': 'Ed Sheeran',
        'greenday': 'Green Day',
        'justinbieber': 'Justin Bieber',
        'mahalini': 'Mahalini',
        'oasis': 'Oasis',
        'onedirection': 'One Direction',
        'radiohead': 'Radiohead',
        'taylorswift': 'Taylor Swift',
        'tenxi': 'Tenxi',
        'tulus': 'Tulus'
    };

    return artistMap[folderName.toLowerCase()] || 
           folderName.charAt(0).toUpperCase() + folderName.slice(1);
}

// Helper: Get default cover for artist
function getDefaultCover(folderName) {
    // Perbaikan: Gunakan 'albumphoto' (tanpa spasi) sesuai format URL yang diinginkan user
    // dan generate Full Public URL dari Supabase
    const coverMap = {
        'afgan': 'albumphoto/afgan.png',
        'astrid': 'albumphoto/astrid.webp',
        'brunomars': 'albumphoto/bruno.jpg',
        'coldplay': 'albumphoto/coldplay.jpg',
        'danielcaesar': 'albumphoto/daniel.jpg',
        'edsheeran': 'albumphoto/ed.jpg',
        'greenday': 'albumphoto/greenday.jpg',
        'justinbieber': 'albumphoto/justin.jpg',
        'mahalini': 'albumphoto/mahalini.jpg',
        'oasis': 'albumphoto/oasis.jpg',
        'onedirection': 'albumphoto/onedirection.jpg',
        'radiohead': 'albumphoto/radiohead.jpg',
        'taylorswift': 'albumphoto/taylor.jpg',
        'tenxi': 'albumphoto/tenxi.jpg',
        'tulus': 'albumphoto/tulus.jpg'
    };

    const path = coverMap[folderName.toLowerCase()];
    
    if (path) {
        const { data } = supabase.storage
            .from('vidje')
            .getPublicUrl(path);
        return data.publicUrl;
    }

    return `https://picsum.photos/seed/${folderName}/300/300`;
}

// Helper: Clean song title from filename
function cleanSongTitle(filename) {
    return filename
        .replace(/\.mp3$/i, '')
        .replace(/\.MP3$/i, '')
        .replace(/_/g, ' ')
        .replace(/-/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        // Capitalize first letter of each word
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

function attachSongMenuListeners(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Remove old listeners (cleanup)
    const oldListeners = container.__songMenuListeners;
    if (oldListeners) {
        oldListeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
    }
    
    const listeners = [];
    
    // Menu toggle buttons
    container.querySelectorAll('.song-menu-btn').forEach(btn => {
        const handler = function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            window.toggleSongMenu(songId);
        };
        btn.addEventListener('click', handler);
        listeners.push({ element: btn, event: 'click', handler });
    });
    
    // Like buttons
    container.querySelectorAll('.menu-like-item').forEach(btn => {
        const handler = function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            window.toggleLike(songId);
            window.toggleSongMenu(songId);
        };
        btn.addEventListener('click', handler);
        listeners.push({ element: btn, event: 'click', handler });
    });
    
    // Queue buttons
    container.querySelectorAll('.menu-queue-item').forEach(btn => {
        const handler = function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            window.addToQueue(songId);
            window.toggleSongMenu(songId);
        };
        btn.addEventListener('click', handler);
        listeners.push({ element: btn, event: 'click', handler });
    });
    
    // Add to playlist buttons
    container.querySelectorAll('.menu-add-item').forEach(btn => {
        const handler = function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            window.openAddSongModal(songId);
            window.toggleSongMenu(songId);
        };
        btn.addEventListener('click', handler);
        listeners.push({ element: btn, event: 'click', handler });
    });
    
    // Share buttons
    container.querySelectorAll('.menu-share-item').forEach(btn => {
        const handler = function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            window.openShareModal('song', songId);
            window.toggleSongMenu(songId);
        };
        btn.addEventListener('click', handler);
        listeners.push({ element: btn, event: 'click', handler });
    });
    
    // Store listeners untuk cleanup nanti
    container.__songMenuListeners = listeners;
}

window.debugPlaylist = function(playlistId) {
    console.log('=== DEBUG PLAYLIST ===');
    console.log('Playlist ID:', playlistId);
    console.log('Current User Data:', currentUserData);
    console.log('Playlist exists in user data?', currentUserData?.playlists?.[playlistId]);
    console.log('Playlist data:', currentUserData?.playlists?.[playlistId]);
    console.log('Songs in playlist:', Object.keys(currentUserData?.playlists?.[playlistId]?.songs || {}));
    console.log('======================');
};

// Global listener tracker
const activeListeners = {
    user: null,
    playlists: {},
    songs: {}
};

// Cleanup function
function detachAllListeners() {
    console.log(' Detaching all Firebase listeners...');
    
    // Detach user listener
    if (activeListeners.user) {
        activeListeners.user();
        activeListeners.user = null;
    }
    
    // Detach playlist listeners
    Object.keys(activeListeners.playlists).forEach(key => {
        if (activeListeners.playlists[key]) {
            activeListeners.playlists[key]();
            delete activeListeners.playlists[key];
        }
    });
    
    // Detach song listeners
    Object.keys(activeListeners.songs).forEach(key => {
        if (activeListeners.songs[key]) {
            activeListeners.songs[key]();
            delete activeListeners.songs[key];
        }
    });
    
    console.log(' All listeners detached');
}

// Call on logout
function logout() {
    detachAllListeners();
    signOut(auth);
    // ... rest of logout code
}

// Call on page unload
window.addEventListener('beforeunload', () => {
    detachAllListeners();
});



//  GOOD: Load only user's own + on-demand
async function loadUserImportedSongs() {
    if (!auth.currentUser) return;
    
    const userId = auth.currentUser.uid;
    
    try {
        // Load only user's own imported songs
        const userSongsSnap = await get(ref(db, `importedSongs/${userId}`));
        if (userSongsSnap.exists()) {
            const userSongs = Object.values(userSongsSnap.val());
            userSongs.forEach(song => {
                if (!songs.find(s => s.id === song.id)) {
                    songs.push(song);
                }
            });
            console.log(' Loaded user imported songs:', userSongs.length);
        }
    } catch (error) {
        console.error(' Error loading user songs:', error);
    }
}

// Load specific public song only when needed
async function loadPublicImportedSong(songId) {
    if (songs.find(s => s.id === songId)) {
        return songs.find(s => s.id === songId); // Already loaded
    }
    
    try {
        const songSnap = await get(ref(db, `publicImportedSongs/${songId}`));
        if (songSnap.exists()) {
            const song = songSnap.val();
            songs.push(song);
            return song;
        }
    } catch (error) {
        console.error(' Error loading public song:', error);
    }
    return null;
}



async function uploadProfilePicture(file) {
    try {
        const storage = getStorage();
        const fileRef = storageRef(storage, `profilePictures/${auth.currentUser.uid}`);
        
        // Upload to Storage (separate quota)
        await uploadBytes(fileRef, file);
        
        // Get URL
        const url = await getDownloadURL(fileRef);
        
        // Save only URL to Database (tiny!)
        await set(ref(db, `users/${auth.currentUser.uid}/profilePictureUrl`), url);
        
        console.log(' Profile picture uploaded:', url);
        return url;
    } catch (error) {
        console.error(' Upload failed:', error);
    }
}

// Cache data in localStorage to reduce Firebase reads
const DataCache = {
    set(key, data, ttl = 3600000) { // Default 1 hour
        const item = {
            data: data,
            expiry: Date.now() + ttl
        };
        localStorage.setItem(key, JSON.stringify(item));
    },
    
    get(key) {
        const itemStr = localStorage.getItem(key);
        if (!itemStr) return null;
        
        const item = JSON.parse(itemStr);
        if (Date.now() > item.expiry) {
            localStorage.removeItem(key);
            return null;
        }
        
        return item.data;
    },
    
    clear() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('vidje_cache_')) {
                localStorage.removeItem(key);
            }
        });
    }
};


// Global error handler
function handleFirebaseError(error, context) {
    console.error(` Firebase error in ${context}:`, error);
    
    if (error.code === 'PERMISSION_DENIED' || 
        error.message?.includes('quota') || 
        error.message?.includes('exceeded')) {
        
        // Quota exceeded!
        showToast(' Database quota exceeded. Some features may be limited.', 'error');
        
        // Stop all listeners to save quota
        detachAllListeners();
        
        // Show modal to user
        showQuotaExceededModal();
        
        return true; // Handled
    }
    
    return false; // Not quota error
}

function showQuotaExceededModal() {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                    justify-content: center; z-index: 9999;">
            <div style="background: var(--bg-dark); padding: 30px; border-radius: 12px; 
                        max-width: 400px; text-align: center;">
                <h2> Database Limit Reached</h2>
                <p style="margin: 20px 0; color: #aaa;">
                    Vidje has reached the free database quota for this month. 
                    Some features may not work properly.
                </p>
                <p style="color: #888; font-size: 14px;">
                    Quota resets on the 1st of next month.
                </p>
                <button onclick="this.closest('div').parentElement.remove()" 
                        style="margin-top: 20px; padding: 10px 20px; background: var(--primary-color); 
                               border: none; border-radius: 8px; color: white; cursor: pointer;">
                    OK
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
  
    </script>
</body>
</html> 

